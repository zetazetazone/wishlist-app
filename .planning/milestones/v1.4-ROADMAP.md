# Milestone v1.4: Friends System

**Status:** SHIPPED 2026-02-10
**Phases:** 23-28
**Total Plans:** 12

## Overview

Enable users to build a friends network outside of groups, discover friends via phone contacts, and see friends' birthdays and custom dates in their calendar.

## Phases

### Phase 23: Database Foundation
**Goal**: Database schema for friends, friend requests, and public dates with bidirectional relationship handling and friend-visibility RLS patterns
**Depends on**: Phase 22
**Plans**: 1 plan

Plans:
- [x] 23-01-PLAN.md -- Complete v1.4 database foundation (tables, RLS, helper functions, RPC)

**Details:**
- Created `friends` table with ordered bidirectional constraint (`user_a_id < user_b_id`)
- Created `friend_requests` table with status enum (pending/accepted/rejected/blocked)
- Created `public_dates` table with month/day columns for annual recurrence
- Added `phone` column to users table with E.164 format
- Created `are_friends()` SECURITY DEFINER helper function for RLS
- Created `accept_friend_request()` atomic RPC

### Phase 24: Friend Core Services & Tab
**Goal**: Core friend CRUD operations and Friends tab navigation with friend list display
**Depends on**: Phase 23
**Plans**: 1 plan

Plans:
- [x] 24-01-PLAN.md -- Friend service library, FriendCard component, Friends tab screen, navigation integration

**Details:**
- Friends service library with bidirectional friendship queries
- FriendCard component matching MemberCard visual pattern
- Friends tab screen with gradient header and empty state
- Friends tab integrated in navigation between Groups and Celebrations

### Phase 25: Friend Requests Flow
**Goal**: Complete friend request lifecycle with send/accept/decline, pending requests view, and real-time notifications
**Depends on**: Phase 24
**Plans**: 3 plans

Plans:
- [x] 25-01-PLAN.md -- Database notification triggers and friend request service layer
- [x] 25-02-PLAN.md -- Pending requests screen with incoming/outgoing tabs
- [x] 25-03-PLAN.md -- Integration: Friends tab header link and member profile Add Friend button

**Details:**
- Push notification triggers for friend request sent and accepted events
- FriendRequestCard component with accept/decline/cancel actions
- Requests screen with incoming/outgoing segment control tabs
- Relationship-aware Add Friend button on member profiles
- Block option in decline flow

### Phase 26: Contact Import & Discovery
**Goal**: Import phone contacts to discover users who have the app, with proper permission handling for iOS and Android
**Depends on**: Phase 25
**Plans**: 3 plans

Plans:
- [x] 26-01-PLAN.md -- Dependencies (expo-contacts, libphonenumber-js) and RPC functions (match_phones, search_users)
- [x] 26-02-PLAN.md -- Service libraries (lib/contacts.ts, lib/discovery.ts) with permission handling and matching
- [x] 26-03-PLAN.md -- UI: MatchedContactCard component, discover.tsx screen, Friends tab Find Friends button

**Details:**
- expo-contacts SDK with iOS NSContactsUsageDescription and Android READ_CONTACTS permission
- libphonenumber-js for E.164 phone normalization
- iOS 18 limited access handling via accessPrivileges property
- User search by name/email with match quality ordering
- Find Friends screen with contact matching and debounced search

### Phase 27: Public Dates Management
**Goal**: Users can create, edit, and delete custom public dates that friends can see (anniversaries, special events)
**Depends on**: Phase 23
**Plans**: 2 plans

Plans:
- [x] 27-01-PLAN.md -- Service layer (lib/publicDates.ts) and PublicDateCard component
- [x] 27-02-PLAN.md -- Public dates screen, navigation integration, and verification

**Details:**
- Public dates CRUD service with month/day storage for annual recurrence
- PublicDateCard component with calendar heart icon
- Management screen with inline collapsible form
- Platform-specific DateTimePicker (iOS inline, Android modal)
- Double-tap prevention via guard clause

### Phase 28: Calendar Integration
**Goal**: Friend birthdays and public dates appear in in-app calendar with device sync support
**Depends on**: Phases 24, 27
**Plans**: 2 plans

Plans:
- [x] 28-01-PLAN.md -- Friend dates service and calendar integration (FCAL-01, FCAL-02, FCAL-03)
- [x] 28-02-PLAN.md -- Source indicator UI and device sync extension (FCAL-04, FCAL-05)

**Details:**
- Friend dates service with bidirectional query and teal color (#0D9488)
- BirthdayCalendar extended to accept and display friend dates
- Parallel loading of group birthdays and friend dates
- CountdownCard with type guard for source indicator ("Friend" vs "Group")
- Combined device calendar sync for both group and friend events

---

## Milestone Summary

**Key Decisions:**
- Ordered bidirectional constraint (`user_a_id < user_b_id`) prevents duplicate friendship rows
- `are_friends()` SECURITY DEFINER helper centralizes bidirectional query logic for RLS
- E.164 phone normalization via libphonenumber-js for reliable cross-platform matching
- Friend dates use distinct teal color (#0D9488) in calendar
- Month/day storage for public dates enables annual recurrence queries

**Issues Resolved:**
- iOS 18 limited contact access handled via accessPrivileges property check
- RPC parameter naming mismatch fixed (user_a/user_b -> p_user_a/p_user_b)
- Header sync button clipping fixed with flex layout properties
- Double-tap duplicate entries fixed with guard clause

**Issues Deferred:**
- Instagram friend discovery (OAuth complexity)
- Suggested friends based on mutual connections
- Friend birthday reminders (separate from calendar)

**Technical Debt Incurred:**
- None significant

---

*For current project status, see .planning/PROJECT.md*
