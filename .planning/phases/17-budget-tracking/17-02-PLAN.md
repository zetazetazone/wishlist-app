---
phase: 17-budget-tracking
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - components/groups/BudgetSettingsSection.tsx
  - app/group/[id]/settings.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can set budget approach (per-gift, monthly, or yearly) in group settings"
    - "Admin can set budget amount for any approach with a dollar input"
    - "Admin can remove budget entirely (set approach to none)"
    - "Switching budget approach shows confirmation dialog"
    - "Budget settings section only visible in gifts mode"
    - "Non-admin members cannot see budget settings"
  artifacts:
    - path: "components/groups/BudgetSettingsSection.tsx"
      provides: "Budget approach selector and amount input component"
      exports: ["BudgetSettingsSection"]
    - path: "app/group/[id]/settings.tsx"
      provides: "Settings screen with budget section integrated"
  key_links:
    - from: "components/groups/BudgetSettingsSection.tsx"
      to: "utils/groups.ts"
      via: "updateGroupBudget call on save"
      pattern: "updateGroupBudget"
    - from: "app/group/[id]/settings.tsx"
      to: "components/groups/BudgetSettingsSection.tsx"
      via: "import and render within ScrollView"
      pattern: "BudgetSettingsSection"
---

<objective>
Add budget settings UI to the group settings screen so admins can configure budget approach and amount.

Purpose: Enables BUDG-01 (admin sets budget approach) and BUDG-02 (admin sets budget amount). This is the admin configuration interface that controls what the budget progress indicator displays.

Output: `BudgetSettingsSection.tsx` component and integration into `settings.tsx`.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-budget-tracking/17-CONTEXT.md
@.planning/phases/17-budget-tracking/17-RESEARCH.md
@.planning/phases/17-budget-tracking/17-01-SUMMARY.md
@app/group/[id]/settings.tsx
@components/groups/CreateGroupModal.tsx
@utils/groups.ts
@constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BudgetSettingsSection component</name>
  <files>components/groups/BudgetSettingsSection.tsx</files>
  <action>
    Create a new component `BudgetSettingsSection.tsx` in `components/groups/` that provides budget configuration UI for group admins.

    **Component interface:**
    ```typescript
    interface BudgetSettingsSectionProps {
      currentApproach: 'per_gift' | 'monthly' | 'yearly' | null;
      currentAmount: number | null;  // in cents from DB
      groupId: string;
      onBudgetUpdated: (approach: string | null, amount: number | null) => void;
    }
    ```

    **UI structure - Card-based approach selector (matches CreateGroupModal pattern from Phase 13):**
    - Three touchable cards in a column layout, each with radio-style indicator, title, and description:
      - "Per Gift" - "Suggested spending limit for each birthday" - icon: gift-outline
      - "Monthly" - "Pool budget for all birthdays in a month" - icon: calendar-month
      - "Yearly" - "Annual budget for all group celebrations" - icon: calendar-clock
    - Cards are toggleable (tap active card to deselect = remove budget approach)
    - Active card uses green highlighting (green background + green border) matching the CreateGroupModal budget cards pattern (Phase 13-02 decision)
    - Inactive cards use neutral cream/gray

    **Budget amount input:**
    - Shown below cards when any approach is selected
    - Dollar input field with "$" prefix label
    - Placeholder text varies by approach: "50" for per_gift, "100" for monthly, "500" for yearly
    - Helper text below: per_gift="Suggested limit per birthday gift", monthly="Total budget for all birthdays each month", yearly="Total annual budget for all celebrations"
    - `keyboardType="decimal-pad"`

    **Confirmation dialog (CONTEXT decision: always show on approach switch):**
    - When tapping a different approach card (not deselecting), show Alert.alert:
      - Title: "Change Budget Approach?"
      - Message: "This will change how your group's budget is tracked. All spending history will be preserved."
      - Buttons: "Cancel" (cancel style) and "Change" (default style)
    - When deselecting (tapping active card), show Alert.alert:
      - Title: "Remove Budget?"
      - Message: "Budget tracking will be turned off for this group."
      - Buttons: "Cancel" and "Remove" (destructive style)

    **Save behavior:**
    - Save button appears when there are unsaved changes (compare current state to props)
    - On save, call `updateGroupBudget(groupId, { approach, amount })` from utils/groups.ts (from Plan 17-01)
    - Amount input is in dollars; convert to cents before calling updateGroupBudget (Math.round(parseFloat(value) * 100))
    - Show Alert.alert on success ("Saved", "Budget settings updated")
    - Show Alert.alert on error ("Error", "Failed to update budget settings")
    - Call onBudgetUpdated callback after successful save

    **Styling:**
    - Use theme imports: colors, spacing, borderRadius, shadows from constants/theme
    - Card active state: backgroundColor colors.success + '1A' (10% opacity green), borderColor colors.success
    - Card inactive state: backgroundColor colors.white, borderColor colors.cream[300]
    - Active card text: color colors.success for icon and title
    - Follow settingsStyles pattern from settings.tsx (fieldContainer, fieldLabel, textInput)
    - StyleSheet.create for all styles

    **Do NOT:**
    - Create a separate save endpoint; use updateGroupBudget from utils/groups.ts
    - Show budget section in greetings mode (parent controls visibility)
    - Block saving when amount is empty for per_gift (per_gift amount is optional/suggested)
  </action>
  <verify>
    - File exists at components/groups/BudgetSettingsSection.tsx
    - Component exports BudgetSettingsSection
    - Three approach cards render with correct labels and icons
    - Cards are toggleable (tap to select, tap again to deselect)
    - Amount input shows only when approach is selected
    - Confirmation dialog shows on approach change
    - TypeScript compiles without errors
  </verify>
  <done>BudgetSettingsSection renders three approach cards with toggle behavior, amount input, confirmation dialogs, and save functionality using updateGroupBudget</done>
</task>

<task type="auto">
  <name>Task 2: Integrate BudgetSettingsSection into settings screen</name>
  <files>app/group/[id]/settings.tsx</files>
  <action>
    Modify `app/group/[id]/settings.tsx` to add the budget settings section.

    **Changes to GroupDetails interface:**
    Add budget fields to the existing GroupDetails interface at the top of the file:
    ```typescript
    interface GroupDetails {
      name: string;
      description: string | null;
      photo_url: string | null;
      mode: string | null;
      invite_code: string | null;
      budget_approach: string | null;   // ADD
      budget_amount: number | null;     // ADD (cents)
    }
    ```

    **Changes to loadSettingsData query:**
    Update the group select query to include budget fields:
    ```
    .select('name, description, photo_url, mode, invite_code, budget_approach, budget_amount')
    ```

    **Add import:**
    ```typescript
    import { BudgetSettingsSection } from '../../../components/groups/BudgetSettingsSection';
    ```

    **Add Budget Settings section in the ScrollView:**
    Place it AFTER the Group Mode section and BEFORE the Members section.
    - Wrap in MotiView with staggered animation (delay: isAdmin ? 200 : skip)
    - Wrap in SettingsSection with title="Budget" icon="cash-multiple"
    - Only render if:
      1. `isAdmin` is true (admin-only section)
      2. `(group.mode || 'gifts') === 'gifts'` (only in gifts mode, matching Phase 16-01 decision)
    - Pass props:
      - currentApproach={group.budget_approach as any}
      - currentAmount={group.budget_amount}
      - groupId={id!}
      - onBudgetUpdated={(approach, amount) => setGroup(prev => prev ? { ...prev, budget_approach: approach, budget_amount: amount } : prev)}

    **Adjust animation delays:**
    After inserting the budget section, increase the delay values for Members, Invite Code, and Danger Zone sections by 100ms to maintain stagger sequence.
    - Members: isAdmin ? 300 : 200 (was 250 : 200)
    - Invite Code: isAdmin ? 400 : 300 (was 350 : 300)
    - Danger Zone: isAdmin ? 500 : 400 (was 450 : 400)

    **Do NOT:**
    - Change any existing section behavior
    - Add budget section for non-admin users
    - Show budget section when mode is greetings
  </action>
  <verify>
    - Budget section appears after Mode section and before Members section in settings
    - Budget section only visible when isAdmin AND mode is gifts
    - GroupDetails interface includes budget_approach and budget_amount
    - Query fetches budget fields
    - onBudgetUpdated callback updates local group state
    - Animation delays maintain smooth stagger sequence
    - TypeScript compiles without errors
  </verify>
  <done>Settings screen displays budget configuration section for admin users in gifts mode, positioned between Mode and Members sections with proper animation stagger</done>
</task>

</tasks>

<verification>
- Open group settings as admin in gifts mode -> Budget section visible between Mode and Members
- Switch to greetings mode -> Budget section disappears
- As non-admin member -> Budget section not shown
- Tap Per Gift card -> card highlights green, amount input appears
- Tap Per Gift card again -> confirmation to remove, card deselects
- Tap Monthly while Per Gift active -> confirmation to change approach
- Enter amount and save -> success alert, data persists on screen refresh
- TypeScript compilation passes
</verification>

<success_criteria>
- BudgetSettingsSection.tsx exists with card-based approach selector
- Budget section integrated into settings.tsx (admin-only, gifts-mode-only)
- Three approaches selectable with toggle behavior
- Confirmation dialogs on approach switch and removal
- Budget amount saved correctly (dollars -> cents conversion)
- Visual consistency with existing settings sections
</success_criteria>

<output>
After completion, create `.planning/phases/17-budget-tracking/17-02-SUMMARY.md`
</output>
