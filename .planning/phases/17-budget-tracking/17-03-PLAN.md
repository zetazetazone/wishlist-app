---
phase: 17-budget-tracking
plan: 03
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - components/groups/BudgetProgressBar.tsx
  - app/group/[id]/index.tsx
autonomous: true

must_haves:
  truths:
    - "Monthly pooled budget tracks all birthdays in a month against one pool"
    - "Yearly budget tracks total annual spend against set amount"
    - "Budget progress indicator shows spent vs available amounts"
    - "Per-gift approach shows suggested limit as text (no progress bar)"
    - "Budget section visible to all group members (not admin-only)"
    - "Budget hidden in greetings mode"
  artifacts:
    - path: "components/groups/BudgetProgressBar.tsx"
      provides: "Horizontal progress bar with traffic-light coloring"
      exports: ["BudgetProgressBar"]
    - path: "app/group/[id]/index.tsx"
      provides: "Group view with budget section"
  key_links:
    - from: "app/group/[id]/index.tsx"
      to: "lib/budget.ts"
      via: "getGroupBudgetStatus call in useEffect"
      pattern: "getGroupBudgetStatus"
    - from: "app/group/[id]/index.tsx"
      to: "components/groups/BudgetProgressBar.tsx"
      via: "import and render in ScrollView"
      pattern: "BudgetProgressBar"
    - from: "components/groups/BudgetProgressBar.tsx"
      to: "lib/budget.ts"
      via: "BudgetStatus type for props"
      pattern: "BudgetStatus"
---

<objective>
Create the budget progress bar component and integrate budget display into the group view screen.

Purpose: Delivers the user-facing budget visibility (BUDG-03, BUDG-04, BUDG-05). All group members see budget progress in the group view. Monthly and yearly approaches show a progress bar with traffic-light coloring. Per-gift approach shows a simple text reference.

Output: `BudgetProgressBar.tsx` component and modified `app/group/[id]/index.tsx` with budget section.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-budget-tracking/17-CONTEXT.md
@.planning/phases/17-budget-tracking/17-RESEARCH.md
@.planning/phases/17-budget-tracking/17-01-SUMMARY.md
@app/group/[id]/index.tsx
@components/celebrations/ContributionProgress.tsx
@components/groups/GroupViewHeader.tsx
@lib/budget.ts
@constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BudgetProgressBar component</name>
  <files>components/groups/BudgetProgressBar.tsx</files>
  <action>
    Create `components/groups/BudgetProgressBar.tsx` - a horizontal progress bar with traffic-light color coding for budget tracking.

    **Component interface:**
    ```typescript
    import { BudgetStatus } from '../../lib/budget';

    interface BudgetProgressBarProps {
      status: BudgetStatus;
    }
    ```

    **Rendering logic based on approach:**

    **For 'monthly' and 'yearly' approaches (pool tracking with progress bar):**
    - White card container with rounded corners, padding, and light shadow (matches existing card patterns)
    - Section header row: MaterialCommunityIcons "cash-multiple" icon + "Budget" title in burgundy[800]
    - Period label below header: status.periodLabel in cream[600], font size 12
    - Horizontal progress bar:
      - Full-width container: height 10px, backgroundColor cream[200], borderRadius 5
      - Fill View inside: percentage width based on status.percentage (capped at 100% for display), borderRadius 5
      - Fill color based on thresholdLevel:
        - 'normal' (< 75%): colors.success (#2D7A4F)
        - 'warning' (75-89%): colors.warning (#F59E0B)
        - 'danger' (90-99%): colors.error (#DC2626)
        - 'over' (>= 100%): colors.error (#DC2626)
    - Amount text row below bar:
      - Left: "$X spent" in bold (formatted to 2 decimal places)
      - Right: "of $Y" in cream[600]
      - If over budget: show "Over budget by $Z" in colors.error font size 12, below the amount row
    - Over-budget visual: When isOverBudget, progress bar fill is 100% width in red, and a small "Over budget" label appears with exclamation icon

    **For 'per_gift' approach (no pool, just reference text):**
    - Same white card container
    - Section header: "Budget" with cash-multiple icon
    - Simple text display: "Suggested limit: $X per gift" in cream[700], fontSize 15
    - No progress bar, no period label
    - Subtle info text: "This is a guideline, not a hard limit" in cream[500], fontSize 12, italic

    **Empty/null state:**
    - If status is somehow invalid, return null (parent handles null budget)

    **Styling:**
    - Use theme imports: colors, spacing, borderRadius, shadows
    - Card: backgroundColor white, borderRadius.lg, padding spacing.lg, ...shadows.sm
    - Follow ContributionProgress.tsx visual pattern for the progress bar (nested Views)
    - Entrance animation: wrap in MotiView with from={{ opacity: 0, translateY: 15 }}

    **Currency formatting:**
    - Helper function formatBudgetAmount(amount: number): string
    - Returns "$X.XX" for amounts with cents, "$X" for whole dollar amounts
    - Example: 120.50 -> "$120.50", 500 -> "$500"
  </action>
  <verify>
    - File exists at components/groups/BudgetProgressBar.tsx
    - Component exports BudgetProgressBar
    - Monthly/yearly: renders progress bar with color based on threshold
    - Per-gift: renders text-only display without progress bar
    - Over-budget state renders correctly (100% fill, red, label)
    - TypeScript compiles without errors
  </verify>
  <done>BudgetProgressBar renders horizontal progress bar with traffic-light coloring for monthly/yearly and text-only display for per-gift, with proper over-budget visual treatment</done>
</task>

<task type="auto">
  <name>Task 2: Integrate budget display into group view</name>
  <files>app/group/[id]/index.tsx</files>
  <action>
    Modify `app/group/[id]/index.tsx` to show budget information in the group detail screen.

    **Add imports:**
    ```typescript
    import { getGroupBudgetStatus, BudgetStatus } from '../../../lib/budget';
    import { BudgetProgressBar } from '../../../components/groups/BudgetProgressBar';
    ```

    **Add budget state:**
    ```typescript
    const [budgetStatus, setBudgetStatus] = useState<BudgetStatus | null>(null);
    ```

    **Load budget data:**
    Add a useEffect that calls getGroupBudgetStatus when group loads:
    ```typescript
    useEffect(() => {
      if (!group?.id) return;
      // Only load budget in gifts mode
      if ((group.mode || 'gifts') !== 'gifts') {
        setBudgetStatus(null);
        return;
      }
      getGroupBudgetStatus(group.id)
        .then(setBudgetStatus)
        .catch(err => {
          console.error('Failed to load budget status:', err);
          setBudgetStatus(null);
        });
    }, [group?.id, group?.mode]);
    ```

    **Add budget section in ScrollView:**
    Place AFTER the action buttons (Share Invite Code / View Invite Code) and BEFORE the Members section.

    Conditional rendering:
    - Only show if `budgetStatus !== null` (budget is configured)
    - Only show if `(group.mode || 'gifts') === 'gifts'` (gifts mode only - Phase 16 decision)

    ```jsx
    {/* Budget Section */}
    {budgetStatus && (group.mode || 'gifts') === 'gifts' && (
      <View style={{ marginBottom: spacing.lg }}>
        <BudgetProgressBar status={budgetStatus} />
      </View>
    )}
    ```

    No MotiView wrapper needed - BudgetProgressBar has its own entrance animation.

    **Compact budget summary in GroupViewHeader (CONTEXT decision: header shows compact one-liner):**
    Add an optional `budgetSummary` prop to GroupViewHeader usage. However, to keep file ownership clean with this plan, instead add a small inline budget summary line directly in the group view index.tsx, just below where GroupViewHeader is rendered and above the ScrollView action buttons.

    Actually, based on the context decision, the header compact one-liner is a nice-to-have but the dedicated section below is the primary display. To keep this plan focused and within scope, implement ONLY the dedicated budget section (not the header compact line). The dedicated section already serves both BUDG-03 (monthly tracking), BUDG-04 (yearly tracking), and BUDG-05 (progress indicator). A header compact line can be added as a follow-up if needed.

    **Do NOT:**
    - Modify GroupViewHeader.tsx (not in files_modified)
    - Show budget in greetings mode
    - Block UI while loading budget (load async after group loads)
    - Show loading indicator for budget (it loads fast, just show nothing until ready)
  </action>
  <verify>
    - Group view in gifts mode with budget configured -> BudgetProgressBar visible between action buttons and Members
    - Group view in gifts mode without budget -> no budget section shown
    - Group view in greetings mode -> no budget section regardless of budget config
    - Budget data loads asynchronously after group loads
    - Monthly budget shows calendar month spending progress
    - Yearly budget shows anniversary period spending progress
    - Per-gift shows text-only suggested limit
    - TypeScript compiles without errors
  </verify>
  <done>Group view displays budget progress section visible to all members in gifts mode, showing monthly/yearly progress bars or per-gift suggestion, positioned between action buttons and member list</done>
</task>

</tasks>

<verification>
- Navigate to group in gifts mode with monthly budget set -> see progress bar with current month spending
- Navigate to group in gifts mode with yearly budget set -> see progress bar with annual spending
- Navigate to group in gifts mode with per-gift budget -> see text "Suggested limit: $X per gift"
- Navigate to group in gifts mode with no budget -> no budget section shown
- Navigate to group in greetings mode -> no budget section regardless
- Progress bar colors: green for < 75%, yellow for 75-89%, red for 90%+
- Over-budget state: red bar at 100%, "Over budget" label visible
- All members (not just admin) can see the budget section
- TypeScript compilation passes
</verification>

<success_criteria>
- BudgetProgressBar.tsx exists with traffic-light progress bar for monthly/yearly and text display for per-gift
- Group view index.tsx integrates BudgetProgressBar between action buttons and Members section
- Budget loads asynchronously, hidden when null or in greetings mode
- Color thresholds: green (normal), yellow (warning), red (danger/over)
- Over-budget visual indicator with amount shown
- Visible to all group members
</success_criteria>

<output>
After completion, create `.planning/phases/17-budget-tracking/17-03-SUMMARY.md`
</output>
