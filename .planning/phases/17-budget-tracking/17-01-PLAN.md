---
phase: 17-budget-tracking
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/budget.ts
  - utils/groups.ts
autonomous: true

must_haves:
  truths:
    - "Budget service calculates monthly spending from contribution data within calendar month boundaries"
    - "Budget service calculates yearly spending from contribution data within group anniversary boundaries"
    - "Per-gift approach returns suggested limit without pool tracking"
    - "Currency conversion between contribution dollars and budget cents is correct"
    - "Admin can update budget approach and amount via updateGroupBudget()"
  artifacts:
    - path: "lib/budget.ts"
      provides: "Budget calculation service"
      exports: ["getGroupBudgetStatus", "BudgetStatus"]
    - path: "utils/groups.ts"
      provides: "updateGroupBudget function"
      exports: ["updateGroupBudget"]
  key_links:
    - from: "lib/budget.ts"
      to: "celebration_contributions table"
      via: "supabase query through celebrations join"
      pattern: "from.*celebration.*contributions"
    - from: "lib/budget.ts"
      to: "groups table"
      via: "supabase query for budget_approach/budget_amount/created_at"
      pattern: "from.*groups"
    - from: "utils/groups.ts"
      to: "groups table"
      via: "supabase update for budget columns"
      pattern: "update.*budget"
---

<objective>
Create the budget calculation service and data update function for group budget tracking.

Purpose: Foundation layer that all budget UI depends on. Must correctly derive spending from existing contribution data, handle period boundaries (monthly = calendar month, yearly = group creation anniversary), and convert between dollars (contributions) and cents (budget_amount).

Output: `lib/budget.ts` with `getGroupBudgetStatus()` and `BudgetStatus` type, plus `updateGroupBudget()` in `utils/groups.ts`.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-budget-tracking/17-CONTEXT.md
@.planning/phases/17-budget-tracking/17-RESEARCH.md
@lib/contributions.ts
@utils/groups.ts
@supabase/migrations/20260202000005_celebrations.sql
@supabase/migrations/20260205000001_v1.2_groups_schema.sql
@constants/theme.ts
</context>

<feature>
  <name>Budget Calculation Service</name>
  <files>lib/budget.ts, utils/groups.ts</files>
  <behavior>
    Budget calculation derives spending from `celebration_contributions` joined through `celebrations`.

    **Critical currency note:** `celebration_contributions.amount` is NUMERIC in DOLLARS. `groups.budget_amount` is INTEGER in CENTS. The service must convert budget_amount from cents to dollars for comparison (divide by 100).

    **BudgetStatus type:**
    ```typescript
    interface BudgetStatus {
      approach: 'per_gift' | 'monthly' | 'yearly' | null;
      budgetAmount: number;       // in dollars (converted from cents)
      spent: number;              // in dollars (sum of contributions)
      remaining: number;          // budgetAmount - spent (can be negative)
      percentage: number;         // spent / budgetAmount * 100 (capped at 100 for bar, actual for display)
      periodLabel: string;        // e.g. "January 2026", "Feb 2025 - Feb 2026"
      isOverBudget: boolean;      // spent > budgetAmount
      thresholdLevel: 'normal' | 'warning' | 'danger' | 'over';  // green/yellow/red/red
    }
    ```

    **Cases:**

    1. `getGroupBudgetStatus(groupId)` with approach=null -> returns null (no budget configured)
    2. `getGroupBudgetStatus(groupId)` with approach='per_gift' -> returns BudgetStatus with budgetAmount from budget_amount, spent=0, periodLabel='Per gift suggestion'
    3. `getGroupBudgetStatus(groupId)` with approach='monthly' -> queries contributions for current calendar month (startOfMonth to endOfMonth), returns totals
    4. `getGroupBudgetStatus(groupId)` with approach='yearly' -> queries contributions from group created_at anniversary to next anniversary, returns totals
    5. Threshold levels: percentage < 75 = 'normal', 75-89 = 'warning', 90-99 = 'danger', >= 100 = 'over'
    6. `updateGroupBudget(groupId, { approach, amount })` -> updates groups table, returns updated group

    **Data flow for monthly/yearly:**
    1. Query groups table for budget_approach, budget_amount, created_at
    2. Calculate date range based on approach
    3. Query celebrations for the group within date range -> get celebration IDs
    4. Query celebration_contributions for those celebration IDs -> sum amounts
    5. Return BudgetStatus with calculated values

    **Monthly period:** `startOfMonth(now)` to `endOfMonth(now)` using date-fns
    **Yearly period:** Find most recent anniversary of `groups.created_at`. Period is `[anniversaryN, anniversaryN+1)`.
  </behavior>
  <implementation>
    **lib/budget.ts:**
    - Import supabase, date-fns (startOfMonth, endOfMonth, addYears, isBefore, format)
    - Export BudgetStatus interface
    - Export async function getGroupBudgetStatus(groupId: string): Promise<BudgetStatus | null>
    - Internal helper: getDateRange(approach, createdAt) returns { start: Date, end: Date, label: string }
    - Internal helper: getSpendingInRange(groupId, start, end) returns number (dollars)
    - Internal helper: getThresholdLevel(percentage) returns threshold level string

    **utils/groups.ts - add updateGroupBudget:**
    - Export async function updateGroupBudget(groupId, { approach, amount })
    - approach can be null (remove budget), 'per_gift', 'monthly', 'yearly'
    - amount is in cents (matches database column), can be null for per_gift or when removing
    - Uses supabase.from('groups').update() pattern matching existing updateGroupInfo/updateGroupMode
  </implementation>
</feature>

<verification>
- TypeScript compiles without errors: `npx tsc --noEmit lib/budget.ts` (or project-level check)
- BudgetStatus type exports correctly
- getGroupBudgetStatus returns null for no-budget groups
- getGroupBudgetStatus returns per_gift status without spending calculation
- Monthly date range uses calendar month boundaries
- Yearly date range uses group creation anniversary
- Currency conversion: budget_amount cents / 100 = dollars for comparison with contribution amounts
- updateGroupBudget updates database and returns result
</verification>

<success_criteria>
- lib/budget.ts exists with getGroupBudgetStatus and BudgetStatus exports
- utils/groups.ts has updateGroupBudget function
- All threshold levels computed correctly (normal < 75%, warning 75-89%, danger 90-99%, over >= 100%)
- Date boundary calculations use date-fns (startOfMonth, endOfMonth, addYears)
- Two-step query pattern: get celebration IDs first, then sum contributions
- Cents-to-dollars conversion applied when reading budget_amount
</success_criteria>

<output>
After completion, create `.planning/phases/17-budget-tracking/17-01-SUMMARY.md`
</output>
