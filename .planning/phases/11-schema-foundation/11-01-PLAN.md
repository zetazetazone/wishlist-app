---
phase: 11-schema-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260205000001_v1.2_groups_schema.sql
  - types/database.types.ts
autonomous: true

must_haves:
  truths:
    - "Groups table supports mode column with greetings/gifts values and default 'gifts'"
    - "Groups table supports budget_approach column with per_gift/monthly/yearly values"
    - "Groups table supports budget_amount column for pooled budgets (nullable, positive)"
    - "Groups table supports description column for group taglines"
    - "Groups table supports photo_url column for group photos"
    - "Existing groups remain functional with mode='gifts' after migration"
  artifacts:
    - path: "supabase/migrations/20260205000001_v1.2_groups_schema.sql"
      provides: "Schema migration adding 5 columns to groups table"
      contains: "ALTER TABLE public.groups"
    - path: "types/database.types.ts"
      provides: "Updated TypeScript types for groups table"
      contains: "mode: 'greetings' | 'gifts'"
  key_links:
    - from: "supabase/migrations/20260205000001_v1.2_groups_schema.sql"
      to: "types/database.types.ts"
      via: "npx supabase gen types"
      pattern: "budget_approach.*per_gift.*monthly.*yearly"
---

<objective>
Extend the groups table to support v1.2 Group Experience features: group modes (greetings vs gifts), budget approaches (per-gift/monthly/yearly), budget amounts for pooled budgets, descriptions, and photo URLs.

Purpose: This provides the database foundation for all v1.2 features including Create Group Enhancement (Phase 13), Group View Redesign (Phase 14), Group Settings (Phase 15), Mode System (Phase 16), and Budget Tracking (Phase 17).

Output: Migration file with 5 new columns and updated TypeScript types.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-schema-foundation/11-RESEARCH.md

# Reference for CHECK constraint pattern
@supabase/migrations/20260202000011_schema_foundation.sql

# Current groups table structure
@supabase/migrations/20260201000001_initial_schema.sql

# Current TypeScript types
@types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create v1.2 groups schema migration</name>
  <files>supabase/migrations/20260205000001_v1.2_groups_schema.sql</files>
  <action>
Create a migration file that adds 5 new columns to the groups table:

1. **mode** (TEXT, NOT NULL, DEFAULT 'gifts')
   - CHECK constraint: mode IN ('greetings', 'gifts')
   - Every group needs a mode; default maintains backward compatibility

2. **budget_approach** (TEXT, nullable)
   - CHECK constraint: budget_approach IN ('per_gift', 'monthly', 'yearly')
   - Nullable because groups can use existing budget_limit_per_gift

3. **budget_amount** (INTEGER, nullable)
   - CHECK constraint: budget_amount > 0
   - Stores amount in cents for monthly/yearly approaches
   - Nullable for per_gift approach

4. **description** (TEXT, nullable)
   - Optional group description/tagline
   - No constraints needed

5. **photo_url** (TEXT, nullable)
   - Storage path to group photo (will use avatars bucket)
   - Store paths only, not full URLs

Add cross-column constraint:
- budget_amount requires monthly/yearly approach
- budget_amount must be NULL for per_gift approach
- Both NULL is valid (no budget tracking)

Use IF NOT EXISTS for idempotency. Add COMMENT statements for documentation.

Follow Phase 6 pattern exactly: CHECK constraints (not ENUMs), single ALTER TABLE with multiple ADD COLUMN clauses for atomicity.

DO NOT:
- Use ENUM types (cannot remove values safely)
- Add NOT NULL without DEFAULT on optional fields
- Add indexes on these columns (not queried frequently enough to warrant index overhead)
  </action>
  <verify>
Run: `npx supabase db diff` to see pending changes (or `npx supabase migration list` to confirm migration file exists).

If local Supabase is running, apply with: `npx supabase db reset`

Manual verification: Open the migration file and confirm:
- 5 ADD COLUMN statements with IF NOT EXISTS
- CHECK constraints on mode, budget_approach, budget_amount
- Cross-column constraint budget_amount_requires_approach
- COMMENT statements on all new columns
  </verify>
  <done>
Migration file exists at supabase/migrations/20260205000001_v1.2_groups_schema.sql with all 5 columns, CHECK constraints, cross-column constraint, and documentation comments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Regenerate TypeScript types</name>
  <files>types/database.types.ts</files>
  <action>
Update the groups type definition in types/database.types.ts to include the new columns:

For groups.Row:
- mode: 'greetings' | 'gifts' (required, always has value)
- budget_approach: 'per_gift' | 'monthly' | 'yearly' | null
- budget_amount: number | null
- description: string | null
- photo_url: string | null

For groups.Insert:
- mode?: 'greetings' | 'gifts' (optional due to DEFAULT)
- budget_approach?: 'per_gift' | 'monthly' | 'yearly' | null
- budget_amount?: number | null
- description?: string | null
- photo_url?: string | null

For groups.Update:
- mode?: 'greetings' | 'gifts'
- budget_approach?: 'per_gift' | 'monthly' | 'yearly' | null
- budget_amount?: number | null
- description?: string | null
- photo_url?: string | null

If Supabase CLI is available and local instance running, prefer:
`npx supabase gen types typescript --local > types/database.types.ts`

Otherwise, manually update the types file following the existing pattern.

DO NOT:
- Change any existing type definitions
- Remove any fields
- Modify the Json type or other tables
  </action>
  <verify>
Run: `npx tsc --noEmit` to verify TypeScript compiles without errors.

Grep for new fields:
```bash
grep -E "mode.*greetings|budget_approach|budget_amount|description.*string|photo_url" types/database.types.ts
```

Expected: Multiple matches showing the new fields in Row, Insert, and Update types.
  </verify>
  <done>
types/database.types.ts contains updated groups type with mode, budget_approach, budget_amount, description, and photo_url fields in Row, Insert, and Update sections.
  </done>
</task>

</tasks>

<verification>
Phase-level verification:

1. **Migration file syntax**: Open the migration and verify valid SQL syntax
2. **TypeScript compilation**: `npx tsc --noEmit` passes
3. **Type coverage**: grep confirms all 5 new fields exist in groups type
4. **Backward compatibility**: mode has DEFAULT 'gifts', all other fields nullable

If local Supabase is running:
- `npx supabase db reset` applies migration without errors
- Query `SELECT mode, budget_approach FROM groups LIMIT 1` works (even if table is empty)
</verification>

<success_criteria>
1. Migration file `supabase/migrations/20260205000001_v1.2_groups_schema.sql` exists with:
   - 5 ADD COLUMN statements (mode, budget_approach, budget_amount, description, photo_url)
   - CHECK constraints on mode and budget_approach
   - Cross-column constraint budget_amount_requires_approach
   - COMMENT statements for documentation

2. TypeScript types updated in `types/database.types.ts`:
   - groups.Row has all 5 new fields
   - groups.Insert has all 5 new fields (optional)
   - groups.Update has all 5 new fields (optional)

3. `npx tsc --noEmit` compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-schema-foundation/11-01-SUMMARY.md`
</output>
