---
phase: 13-create-group-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - components/groups/CreateGroupModal.tsx
autonomous: true

must_haves:
  truths:
    - "User can select group mode (Greetings or Gifts) during creation"
    - "User can select budget approach (per-gift/monthly/yearly) when Gifts mode selected"
    - "Budget fields only visible when mode is Gifts"
  artifacts:
    - path: "components/groups/CreateGroupModal.tsx"
      provides: "Mode selector and conditional budget fields"
      contains: "mode.*greetings|RadioGroup|budget_approach|budgetAmount"
  key_links:
    - from: "components/groups/CreateGroupModal.tsx"
      to: "utils/groups.ts"
      via: "createGroup call with mode and budget params"
      pattern: "createGroup.*mode|budget_approach"
---

<objective>
Add mode selector (Greetings/Gifts) and conditional budget configuration to Create Group form

Purpose: Enable users to choose between Greetings-only mode and full Gifts coordination mode during group creation, with budget approach selection for Gifts mode. Fulfills CRGRP-03 and CRGRP-04.

Output: CreateGroupModal with mode radio selector showing descriptions, conditional budget approach selector (per-gift/monthly/yearly), and budget amount input. Budget fields only appear when Gifts mode selected.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-create-group-enhancement/13-RESEARCH.md
@.planning/phases/13-create-group-enhancement/13-01-SUMMARY.md
@components/groups/CreateGroupModal.tsx
@utils/groups.ts
@types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mode selector with Greetings/Gifts options</name>
  <files>components/groups/CreateGroupModal.tsx</files>
  <action>
Add mode selection radio buttons with descriptions to CreateGroupModal.

1. Add state for mode (default to 'gifts' matching database DEFAULT):
```typescript
const [mode, setMode] = useState<'greetings' | 'gifts'>('gifts');
```

2. Add mode selector section after description textarea:
```typescript
{/* Mode Selection */}
<View style={{ marginBottom: 20 }}>
  <Text style={{ fontSize: 14, fontWeight: '600', color: '#374151', marginBottom: 12 }}>
    Group Mode
  </Text>

  {/* Gifts Option */}
  <TouchableOpacity
    style={{
      flexDirection: 'row',
      alignItems: 'flex-start',
      padding: 12,
      backgroundColor: mode === 'gifts' ? '#EFF6FF' : '#F9FAFB',
      borderRadius: 12,
      borderWidth: 2,
      borderColor: mode === 'gifts' ? '#3B82F6' : 'transparent',
      marginBottom: 8,
    }}
    onPress={() => setMode('gifts')}
    disabled={loading}
  >
    <View style={{
      width: 20,
      height: 20,
      borderRadius: 10,
      borderWidth: 2,
      borderColor: mode === 'gifts' ? '#3B82F6' : '#9CA3AF',
      alignItems: 'center',
      justifyContent: 'center',
      marginRight: 12,
      marginTop: 2,
    }}>
      {mode === 'gifts' && (
        <View style={{
          width: 10,
          height: 10,
          borderRadius: 5,
          backgroundColor: '#3B82F6',
        }} />
      )}
    </View>
    <View style={{ flex: 1 }}>
      <Text style={{ fontSize: 16, fontWeight: '600', color: '#111827' }}>
        Gifts
      </Text>
      <Text style={{ fontSize: 13, color: '#6B7280', marginTop: 2 }}>
        Coordinate gifts with budget tracking and wishlists
      </Text>
    </View>
  </TouchableOpacity>

  {/* Greetings Option */}
  <TouchableOpacity
    style={{
      flexDirection: 'row',
      alignItems: 'flex-start',
      padding: 12,
      backgroundColor: mode === 'greetings' ? '#EFF6FF' : '#F9FAFB',
      borderRadius: 12,
      borderWidth: 2,
      borderColor: mode === 'greetings' ? '#3B82F6' : 'transparent',
    }}
    onPress={() => setMode('greetings')}
    disabled={loading}
  >
    <View style={{
      width: 20,
      height: 20,
      borderRadius: 10,
      borderWidth: 2,
      borderColor: mode === 'greetings' ? '#3B82F6' : '#9CA3AF',
      alignItems: 'center',
      justifyContent: 'center',
      marginRight: 12,
      marginTop: 2,
    }}>
      {mode === 'greetings' && (
        <View style={{
          width: 10,
          height: 10,
          borderRadius: 5,
          backgroundColor: '#3B82F6',
        }} />
      )}
    </View>
    <View style={{ flex: 1 }}>
      <Text style={{ fontSize: 16, fontWeight: '600', color: '#111827' }}>
        Greetings Only
      </Text>
      <Text style={{ fontSize: 13, color: '#6B7280', marginTop: 2 }}>
        Collect digital birthday greetings without gifts
      </Text>
    </View>
  </TouchableOpacity>
</View>
```

3. Clear budget fields when switching to 'greetings' mode:
```typescript
// When mode changes, clear budget fields if switching to greetings
useEffect(() => {
  if (mode === 'greetings') {
    setBudgetApproach(null);
    setBudgetAmount('');
  }
}, [mode]);
```
  </action>
  <verify>
TypeScript compilation passes:
```bash
cd /home/zetaz/wishlist-app && npx tsc --noEmit 2>&1 | head -20
```
  </verify>
  <done>Mode selector with Gifts and Greetings options displayed with radio buttons and descriptions. Gifts selected by default.</done>
</task>

<task type="auto">
  <name>Task 2: Add conditional budget approach selector and amount input</name>
  <files>components/groups/CreateGroupModal.tsx</files>
  <action>
Add budget configuration fields that only appear when mode='gifts'.

1. Add state for budget fields:
```typescript
const [budgetApproach, setBudgetApproach] = useState<'per_gift' | 'monthly' | 'yearly' | null>(null);
const [budgetAmount, setBudgetAmount] = useState('');
```

2. Add conditional budget section after mode selector (only when mode='gifts'):
```typescript
{/* Budget Settings - Only for Gifts mode */}
{mode === 'gifts' && (
  <View style={{ marginBottom: 20 }}>
    <Text style={{ fontSize: 14, fontWeight: '600', color: '#374151', marginBottom: 12 }}>
      Budget Approach
    </Text>

    {/* Per Gift Option */}
    <TouchableOpacity
      style={{
        flexDirection: 'row',
        alignItems: 'center',
        padding: 12,
        backgroundColor: budgetApproach === 'per_gift' ? '#F0FDF4' : '#F9FAFB',
        borderRadius: 12,
        borderWidth: 2,
        borderColor: budgetApproach === 'per_gift' ? '#22C55E' : 'transparent',
        marginBottom: 8,
      }}
      onPress={() => setBudgetApproach('per_gift')}
      disabled={loading}
    >
      <View style={{
        width: 20,
        height: 20,
        borderRadius: 10,
        borderWidth: 2,
        borderColor: budgetApproach === 'per_gift' ? '#22C55E' : '#9CA3AF',
        alignItems: 'center',
        justifyContent: 'center',
        marginRight: 12,
      }}>
        {budgetApproach === 'per_gift' && (
          <View style={{
            width: 10,
            height: 10,
            borderRadius: 5,
            backgroundColor: '#22C55E',
          }} />
        )}
      </View>
      <View style={{ flex: 1 }}>
        <Text style={{ fontSize: 15, fontWeight: '500', color: '#111827' }}>
          Per Gift
        </Text>
        <Text style={{ fontSize: 12, color: '#6B7280' }}>
          Set a budget for each birthday gift
        </Text>
      </View>
    </TouchableOpacity>

    {/* Monthly Option */}
    <TouchableOpacity
      style={{
        flexDirection: 'row',
        alignItems: 'center',
        padding: 12,
        backgroundColor: budgetApproach === 'monthly' ? '#F0FDF4' : '#F9FAFB',
        borderRadius: 12,
        borderWidth: 2,
        borderColor: budgetApproach === 'monthly' ? '#22C55E' : 'transparent',
        marginBottom: 8,
      }}
      onPress={() => setBudgetApproach('monthly')}
      disabled={loading}
    >
      <View style={{
        width: 20,
        height: 20,
        borderRadius: 10,
        borderWidth: 2,
        borderColor: budgetApproach === 'monthly' ? '#22C55E' : '#9CA3AF',
        alignItems: 'center',
        justifyContent: 'center',
        marginRight: 12,
      }}>
        {budgetApproach === 'monthly' && (
          <View style={{
            width: 10,
            height: 10,
            borderRadius: 5,
            backgroundColor: '#22C55E',
          }} />
        )}
      </View>
      <View style={{ flex: 1 }}>
        <Text style={{ fontSize: 15, fontWeight: '500', color: '#111827' }}>
          Monthly
        </Text>
        <Text style={{ fontSize: 12, color: '#6B7280' }}>
          Pool budget for all birthdays in a month
        </Text>
      </View>
    </TouchableOpacity>

    {/* Yearly Option */}
    <TouchableOpacity
      style={{
        flexDirection: 'row',
        alignItems: 'center',
        padding: 12,
        backgroundColor: budgetApproach === 'yearly' ? '#F0FDF4' : '#F9FAFB',
        borderRadius: 12,
        borderWidth: 2,
        borderColor: budgetApproach === 'yearly' ? '#22C55E' : 'transparent',
        marginBottom: 8,
      }}
      onPress={() => setBudgetApproach('yearly')}
      disabled={loading}
    >
      <View style={{
        width: 20,
        height: 20,
        borderRadius: 10,
        borderWidth: 2,
        borderColor: budgetApproach === 'yearly' ? '#22C55E' : '#9CA3AF',
        alignItems: 'center',
        justifyContent: 'center',
        marginRight: 12,
      }}>
        {budgetApproach === 'yearly' && (
          <View style={{
            width: 10,
            height: 10,
            borderRadius: 5,
            backgroundColor: '#22C55E',
          }} />
        )}
      </View>
      <View style={{ flex: 1 }}>
        <Text style={{ fontSize: 15, fontWeight: '500', color: '#111827' }}>
          Yearly
        </Text>
        <Text style={{ fontSize: 12, color: '#6B7280' }}>
          Set annual budget for all group celebrations
        </Text>
      </View>
    </TouchableOpacity>

    {/* Budget Amount Input - only show when approach selected */}
    {budgetApproach && (
      <View style={{ marginTop: 16 }}>
        <Text style={{ fontSize: 14, fontWeight: '600', color: '#374151', marginBottom: 8 }}>
          Budget Amount ($)
        </Text>
        <TextInput
          style={{
            backgroundColor: '#F3F4F6',
            borderRadius: 12,
            paddingHorizontal: 16,
            paddingVertical: 14,
            fontSize: 16,
            color: '#111827',
          }}
          placeholder={budgetApproach === 'per_gift' ? '50' : budgetApproach === 'monthly' ? '100' : '500'}
          placeholderTextColor="#9CA3AF"
          value={budgetAmount}
          onChangeText={setBudgetAmount}
          keyboardType="decimal-pad"
          editable={!loading}
        />
        <Text style={{ fontSize: 12, color: '#6B7280', marginTop: 4 }}>
          {budgetApproach === 'per_gift'
            ? 'Spending limit per birthday gift'
            : budgetApproach === 'monthly'
            ? 'Total budget for all birthdays each month'
            : 'Total annual budget for all celebrations'}
        </Text>
      </View>
    )}
  </View>
)}
```

3. Add useEffect import at top if not already present:
```typescript
import { useState, useEffect } from 'react';
```

4. Update form reset to include new fields:
```typescript
// Reset form
setName('');
setDescription('');
setPhotoUri(null);
setMode('gifts');
setBudgetApproach(null);
setBudgetAmount('');
```
  </action>
  <verify>
TypeScript compilation passes:
```bash
cd /home/zetaz/wishlist-app && npx tsc --noEmit 2>&1 | head -20
```
  </verify>
  <done>Budget approach selector (per_gift/monthly/yearly) appears only when Gifts mode selected. Budget amount input appears when approach selected.</done>
</task>

<task type="auto">
  <name>Task 3: Wire mode and budget fields to createGroup</name>
  <files>components/groups/CreateGroupModal.tsx</files>
  <action>
Update handleCreate to pass mode and budget fields to createGroup function.

1. Add validation for budget when in gifts mode with approach selected:
```typescript
const handleCreate = async () => {
  if (!name.trim()) {
    Alert.alert('Error', 'Please enter a group name');
    return;
  }

  // Validate budget if gifts mode with approach selected
  if (mode === 'gifts' && budgetApproach) {
    const budgetNum = parseFloat(budgetAmount);
    if (isNaN(budgetNum) || budgetNum <= 0) {
      Alert.alert('Error', 'Please enter a valid budget amount');
      return;
    }
  }

  setLoading(true);

  // Calculate budget in cents (database stores cents as INTEGER)
  const budgetCents = mode === 'gifts' && budgetApproach && budgetAmount
    ? Math.round(parseFloat(budgetAmount) * 100)
    : null;

  // Create group with all fields
  const { data: group, error } = await createGroup({
    name: name.trim(),
    description: description.trim() || null,
    mode,
    budget_approach: mode === 'gifts' ? budgetApproach : null,
    budget_amount: budgetCents,
  });

  if (error || !group) {
    setLoading(false);
    const errorMessage = error instanceof Error
      ? error.message
      : 'Failed to create group. Please try again.';
    Alert.alert('Error', errorMessage);
    return;
  }

  // Upload photo if selected (after group creation)
  if (photoUri) {
    const path = await uploadGroupPhoto(group.id);
    if (path) {
      // Update group with photo path
      await supabase
        .from('groups')
        .update({ photo_url: path })
        .eq('id', group.id);
    }
  }

  setLoading(false);

  // Reset form
  setName('');
  setDescription('');
  setPhotoUri(null);
  setMode('gifts');
  setBudgetApproach(null);
  setBudgetAmount('');

  Alert.alert('Success!', `Group "${name}" created successfully`);
  onSuccess();
  onClose();
};
```

2. Add supabase import if not present (for direct update after photo upload):
```typescript
import { supabase } from '../../lib/supabase';
```

Note: The photo_url update uses direct supabase call because createGroup returns the group object and we need to update it after photo upload.
  </action>
  <verify>
1. TypeScript compilation passes:
```bash
cd /home/zetaz/wishlist-app && npx tsc --noEmit 2>&1 | head -20
```

2. Lint passes (if configured):
```bash
cd /home/zetaz/wishlist-app && npm run lint 2>&1 | head -20 || echo "No lint script"
```
  </verify>
  <done>handleCreate passes mode, budget_approach, and budget_amount (in cents) to createGroup. Budget validation enforced when approach selected.</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. TypeScript compiles without errors
2. CreateGroupModal displays:
   - Mode selector with Gifts (default) and Greetings options
   - Both options have radio buttons and descriptions
   - Gifts selected shows budget approach options
   - Greetings selected hides budget section
3. Budget flow:
   - Selecting budget approach shows amount input
   - Amount placeholder varies by approach type
   - Help text explains budget meaning
4. Creating a group:
   - Greetings mode: Creates with mode='greetings', null budget fields
   - Gifts mode without budget: Creates with mode='gifts', null budget fields
   - Gifts mode with budget: Creates with mode='gifts', approach and amount in cents
5. Validation:
   - Budget amount required if approach selected
   - Invalid/negative budget rejected
</verification>

<success_criteria>
- CRGRP-03 satisfied: User can select group mode (Greetings/Gifts) during creation
- CRGRP-04 satisfied: User can select budget approach when Gifts mode selected
- Budget fields conditionally visible (Gifts mode only)
- Budget amount stored in cents (INTEGER) matching database schema
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-create-group-enhancement/13-02-SUMMARY.md`
</output>
