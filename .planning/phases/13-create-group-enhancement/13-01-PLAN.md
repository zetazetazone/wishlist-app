---
phase: 13-create-group-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - utils/groups.ts
  - components/groups/CreateGroupModal.tsx
autonomous: true

must_haves:
  truths:
    - "User can add a photo when creating a group (optional)"
    - "User can add a description when creating a group (optional)"
    - "Group displays generated avatar when no photo is set"
  artifacts:
    - path: "utils/groups.ts"
      provides: "Extended createGroup function accepting new fields"
      contains: "description|photo_url|mode|budget"
    - path: "components/groups/CreateGroupModal.tsx"
      provides: "Enhanced form with photo upload and description"
      contains: "GroupAvatar|Textarea|uploadGroupPhoto"
  key_links:
    - from: "components/groups/CreateGroupModal.tsx"
      to: "utils/groups.ts"
      via: "createGroup call with extended params"
      pattern: "createGroup\\("
    - from: "components/groups/CreateGroupModal.tsx"
      to: "lib/storage.ts"
      via: "uploadGroupPhoto for photo upload"
      pattern: "uploadGroupPhoto\\("
    - from: "components/groups/CreateGroupModal.tsx"
      to: "components/groups/GroupAvatar.tsx"
      via: "Avatar preview display"
      pattern: "GroupAvatar"
---

<objective>
Enhance the Create Group form with photo upload and description fields

Purpose: Enable users to personalize their groups with photos and descriptions during creation, fulfilling CRGRP-01, CRGRP-02, and CRGRP-05.

Output: Updated CreateGroupModal with photo upload section (using GroupAvatar preview), description textarea with character counter, and extended createGroup function supporting all new database fields.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-create-group-enhancement/13-RESEARCH.md
@.planning/phases/12-group-photo-storage/12-01-SUMMARY.md
@components/groups/CreateGroupModal.tsx
@utils/groups.ts
@lib/storage.ts
@components/groups/GroupAvatar.tsx
@types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend createGroup function for new fields</name>
  <files>utils/groups.ts</files>
  <action>
Extend the createGroup function to accept all new database fields from Phase 11 schema.

1. Update function signature to accept options object instead of positional params:
```typescript
interface CreateGroupOptions {
  name: string;
  description?: string | null;
  photo_url?: string | null;
  mode?: 'greetings' | 'gifts';
  budget_approach?: 'per_gift' | 'monthly' | 'yearly' | null;
  budget_amount?: number | null;  // in cents
}

export async function createGroup(options: CreateGroupOptions)
```

2. Keep backward compatibility: if just name passed, use defaults (mode='gifts', budget_approach=null)

3. Insert all fields to groups table:
```typescript
const { data: group, error: groupError } = await supabase
  .from('groups')
  .insert({
    name: options.name,
    created_by: user.id,
    budget_limit_per_gift: 50,  // legacy field, keep default
    description: options.description || null,
    photo_url: options.photo_url || null,
    mode: options.mode || 'gifts',
    budget_approach: options.budget_approach || null,
    budget_amount: options.budget_amount || null,
  })
  .select()
  .single();
```

4. Remove the legacy budgetLimit parameter - Phase 11 schema uses budget_approach/budget_amount instead

Note: Keep budget_limit_per_gift as 50 default for legacy compatibility (existing code may reference it).
  </action>
  <verify>
TypeScript compilation passes:
```bash
cd /home/zetaz/wishlist-app && npx tsc --noEmit 2>&1 | head -20
```
  </verify>
  <done>createGroup function accepts CreateGroupOptions object with all v1.2 fields and inserts them correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add photo upload and description to CreateGroupModal</name>
  <files>components/groups/CreateGroupModal.tsx</files>
  <action>
Enhance CreateGroupModal with photo upload section and description textarea.

1. Add imports:
```typescript
import { ScrollView } from 'react-native';
import { GroupAvatar } from './GroupAvatar';
import { uploadGroupPhoto, getGroupPhotoUrl } from '../../lib/storage';
```

2. Add state for new fields:
```typescript
const [description, setDescription] = useState('');
const [photoUri, setPhotoUri] = useState<string | null>(null);  // Local preview URI
const [photoPath, setPhotoPath] = useState<string | null>(null); // Storage path (set after upload)
```

3. Add photo upload handler (uploads immediately after picker, stores path):
```typescript
const handlePhotoUpload = async () => {
  // Generate temp UUID for upload path (will be replaced with real groupId after creation)
  // Actually, per research: upload AFTER group creation to avoid orphaned files
  // For preview, just store the local URI from picker
  const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
  if (status !== 'granted') {
    Alert.alert('Permission needed', 'Please grant photo library access');
    return;
  }

  const result = await ImagePicker.launchImageLibraryAsync({
    mediaTypes: 'images',
    allowsEditing: true,
    aspect: [16, 9],
    quality: 0.85,
  });

  if (!result.canceled) {
    setPhotoUri(result.assets[0].uri);
  }
};
```

4. Add photo upload section (centered avatar with tap to upload):
```typescript
{/* Photo Upload Section */}
<View style={{ alignItems: 'center', marginBottom: 20 }}>
  <TouchableOpacity onPress={handlePhotoUpload} disabled={loading}>
    {photoUri ? (
      <View style={{
        width: 120,
        height: 67,  // 16:9 aspect
        borderRadius: 12,
        overflow: 'hidden',
        backgroundColor: '#E5E7EB'
      }}>
        <Image
          source={{ uri: photoUri }}
          style={{ width: '100%', height: '100%' }}
        />
      </View>
    ) : (
      <GroupAvatar
        group={{ name: name || 'New Group', photo_url: null }}
        size="xl"
      />
    )}
  </TouchableOpacity>
  <TouchableOpacity onPress={handlePhotoUpload} disabled={loading}>
    <Text style={{ color: '#0EA5E9', marginTop: 8, fontSize: 14 }}>
      {photoUri ? 'Change Photo' : 'Add Photo (Optional)'}
    </Text>
  </TouchableOpacity>
</View>
```

5. Add description textarea with character counter:
```typescript
const MAX_DESCRIPTION = 500;

{/* Description */}
<View style={{ marginBottom: 20 }}>
  <Text style={{ fontSize: 14, fontWeight: '600', color: '#374151', marginBottom: 8 }}>
    Description (Optional)
  </Text>
  <TextInput
    style={{
      backgroundColor: '#F3F4F6',
      borderRadius: 12,
      paddingHorizontal: 16,
      paddingVertical: 14,
      fontSize: 16,
      color: '#111827',
      minHeight: 100,
      textAlignVertical: 'top',
    }}
    placeholder="What's this group about?"
    placeholderTextColor="#9CA3AF"
    value={description}
    onChangeText={setDescription}
    multiline
    numberOfLines={4}
    maxLength={MAX_DESCRIPTION}
    editable={!loading}
  />
  <Text style={{ fontSize: 12, color: '#6B7280', marginTop: 4 }}>
    {description.length} / {MAX_DESCRIPTION} characters
  </Text>
</View>
```

6. Update handleCreate to:
   a. Create group first with basic data
   b. If photoUri exists, upload using uploadGroupPhoto with actual groupId
   c. Update group with photo_url if upload succeeds
```typescript
const handleCreate = async () => {
  if (!name.trim()) {
    Alert.alert('Error', 'Please enter a group name');
    return;
  }

  setLoading(true);

  // Create group first (without photo)
  const { data: group, error } = await createGroup({
    name: name.trim(),
    description: description.trim() || null,
    mode: 'gifts',  // Default, will be configurable in Plan 02
    budget_approach: null,
    budget_amount: null,
  });

  if (error || !group) {
    setLoading(false);
    Alert.alert('Error', 'Failed to create group. Please try again.');
    return;
  }

  // Upload photo if selected
  if (photoUri) {
    const path = await uploadGroupPhoto(group.id);
    if (path) {
      // Update group with photo path
      await supabase
        .from('groups')
        .update({ photo_url: path })
        .eq('id', group.id);
    }
  }

  setLoading(false);

  // Reset form
  setName('');
  setDescription('');
  setPhotoUri(null);

  Alert.alert('Success!', `Group "${name}" created successfully`);
  onSuccess();
  onClose();
};
```

7. Wrap form content in ScrollView for keyboard handling:
```typescript
<ScrollView showsVerticalScrollIndicator={false}>
  {/* All form fields */}
</ScrollView>
```

8. Remove legacy budget field (will be replaced by mode-aware budget in Plan 02)

9. Add Image import from react-native for photo preview
  </action>
  <verify>
1. TypeScript compilation passes:
```bash
cd /home/zetaz/wishlist-app && npx tsc --noEmit 2>&1 | head -20
```

2. App loads without error (manual check)
  </verify>
  <done>CreateGroupModal shows photo upload section with GroupAvatar preview and description textarea with character counter. Photo uploads after group creation to avoid orphaned files.</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. TypeScript compiles without errors
2. CreateGroupModal displays:
   - Photo upload section with GroupAvatar (shows initials when no photo)
   - Tappable to select photo from gallery
   - Description textarea with character counter
   - Group name field (existing)
3. Creating a group with photo:
   - Group created first
   - Photo uploaded to storage
   - Group updated with photo_url
4. Creating a group without photo:
   - Group created with null photo_url
   - GroupAvatar shows initials fallback
</verification>

<success_criteria>
- CRGRP-01 satisfied: User can add photo when creating group
- CRGRP-02 satisfied: User can add description when creating group
- CRGRP-05 satisfied: GroupAvatar shows initials when no photo set
- createGroup function extended for all v1.2 fields
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-create-group-enhancement/13-01-SUMMARY.md`
</output>
