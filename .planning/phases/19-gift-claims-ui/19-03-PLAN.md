---
phase: 19-gift-claims-ui
plan: 03
type: execute
wave: 3
depends_on: ["19-02"]
files_modified:
  - app/(app)/celebration/[id].tsx
autonomous: true

must_haves:
  truths:
    - "Non-celebrant can see Claim button on unclaimed standard items"
    - "Non-celebrant can tap Claim button and see loading spinner then claimed state"
    - "Non-celebrant can see claimer avatar on items claimed by others"
    - "Non-celebrant can tap claimer avatar to see claimer name popup"
    - "Non-celebrant sees Your claim indicator on their own claimed items"
    - "Non-celebrant can tap Unclaim on their own claimed items"
    - "Celebrant does NOT see claim buttons or claimer avatars on their wishlist"
    - "Claimed items sort to bottom of wishlist"
  artifacts:
    - path: "app/(app)/celebration/[id].tsx"
      provides: "Celebration page with claim integration"
  key_links:
    - from: "app/(app)/celebration/[id].tsx"
      to: "lib/claims"
      via: "import"
      pattern: "import.*from.*lib/claims"
    - from: "app/(app)/celebration/[id].tsx"
      to: "claimItem"
      via: "function call"
      pattern: "claimItem\\("
    - from: "app/(app)/celebration/[id].tsx"
      to: "unclaimItem"
      via: "function call"
      pattern: "unclaimItem\\("
---

<objective>
Integrate claim functionality into the celebration detail page. Non-celebrant users can claim/unclaim items, see who claimed what, and identify their own claims. Claimed items sort to bottom of list.

Purpose: This is the primary claim interaction surface where group members coordinate gift buying.
Output: celebration/[id].tsx with full claim integration for the wishlist section.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-gift-claims-ui/19-CONTEXT.md
@.planning/phases/19-gift-claims-ui/19-RESEARCH.md
@.planning/phases/19-gift-claims-ui/19-02-SUMMARY.md

# Source files
@app/(app)/celebration/[id].tsx
@lib/claims.ts
@components/wishlist/LuxuryWishlistCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add claims state and data fetching</name>
  <files>app/(app)/celebration/[id].tsx</files>
  <action>
Add imports at the top of the file:
```typescript
import {
  getClaimsForItems,
  claimItem,
  unclaimItem,
  type ClaimWithUser,
} from '../../../lib/claims';
import { Alert } from 'react-native';  // If not already imported
```

Add state variables for claims (near other state declarations):
```typescript
// Claims state
const [claims, setClaims] = useState<ClaimWithUser[]>([]);
const [claimsLoading, setClaimsLoading] = useState(false);
const [claimingItemId, setClaimingItemId] = useState<string | null>(null);
```

Create a loadClaims function:
```typescript
const loadClaims = useCallback(async () => {
  if (!celebrantItems.length) return;

  setClaimsLoading(true);
  try {
    const itemIds = celebrantItems.map(item => item.id);
    const claimsData = await getClaimsForItems(itemIds);
    setClaims(claimsData);
  } catch (err) {
    console.error('Failed to load claims:', err);
  } finally {
    setClaimsLoading(false);
  }
}, [celebrantItems]);
```

Call loadClaims after celebrantItems are loaded:
```typescript
useEffect(() => {
  if (celebrantItems.length > 0) {
    loadClaims();
  }
}, [celebrantItems, loadClaims]);
```

Create helper to get claim for an item:
```typescript
const getClaimForItem = useCallback((itemId: string): ClaimWithUser | null => {
  return claims.find(c => c.wishlist_item_id === itemId) || null;
}, [claims]);
```
  </action>
  <verify>
Imports compile: `npx tsc --noEmit 2>&1 | grep celebration || echo "No errors"`
State variables added: `grep -E "(claims|claimsLoading|claimingItemId)" app/\(app\)/celebration/\[id\].tsx`
  </verify>
  <done>
Claims state initialized.
loadClaims fetches claims when celebrant items load.
Helper function to get claim for specific item.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement claim and unclaim handlers with confirmation dialogs</name>
  <files>app/(app)/celebration/[id].tsx</files>
  <action>
Add claim handler with confirmation dialog (per CONTEXT: "Modal confirmation before claiming"):
```typescript
const handleClaimItem = useCallback(async (item: WishlistItem) => {
  // Confirmation dialog
  Alert.alert(
    'Claim this item?',
    `You are about to claim "${item.title}". This lets others know you'll get this gift.`,
    [
      { text: 'Cancel', style: 'cancel' },
      {
        text: 'Claim',
        onPress: async () => {
          setClaimingItemId(item.id);
          try {
            const result = await claimItem(item.id, 'full');
            if (!result.success) {
              // Handle race condition gracefully
              if (result.error?.includes('already claimed') || result.error?.includes('unique')) {
                Alert.alert('Already Claimed', 'Someone else just claimed this item. Refreshing list...');
              } else {
                Alert.alert('Unable to Claim', result.error || 'Please try again.');
              }
            }
            // Refresh claims regardless
            await loadClaims();
          } catch (error) {
            Alert.alert('Error', 'Failed to claim item. Please try again.');
          } finally {
            setClaimingItemId(null);
          }
        },
      },
    ],
    { cancelable: true }
  );
}, [loadClaims]);
```

Add unclaim handler with confirmation:
```typescript
const handleUnclaimItem = useCallback(async (item: WishlistItem, claimId: string) => {
  Alert.alert(
    'Unclaim this item?',
    `Release your claim on "${item.title}"? Someone else will be able to claim it.`,
    [
      { text: 'Keep Claim', style: 'cancel' },
      {
        text: 'Unclaim',
        style: 'destructive',
        onPress: async () => {
          setClaimingItemId(item.id);
          try {
            const result = await unclaimItem(claimId);
            if (!result.success) {
              Alert.alert('Unable to Unclaim', result.error || 'Please try again.');
            }
            await loadClaims();
          } catch (error) {
            Alert.alert('Error', 'Failed to unclaim item. Please try again.');
          } finally {
            setClaimingItemId(null);
          }
        },
      },
    ],
    { cancelable: true }
  );
}, [loadClaims]);
```
  </action>
  <verify>
Handlers exist: `grep -E "handleClaimItem|handleUnclaimItem" app/\(app\)/celebration/\[id\].tsx`
Alert.alert usage: `grep -c "Alert.alert" app/\(app\)/celebration/\[id\].tsx`
  </verify>
  <done>
handleClaimItem shows confirmation then calls claimItem with loading state.
handleUnclaimItem shows confirmation then calls unclaimItem.
Race condition errors show friendly "Already Claimed" message.
Both handlers refresh claims list after operation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update wishlist rendering with claim props and sorting</name>
  <files>app/(app)/celebration/[id].tsx</files>
  <action>
Update sortedCelebrantItems to push claimed items to bottom (per CONTEXT: "Claimed items move to bottom"):
```typescript
const sortedCelebrantItems = useMemo(() => {
  const isCelebrant = currentUserId === celebration?.celebrant_id;

  return [...celebrantItems].sort((a, b) => {
    // Favorite always first
    if (a.id === celebrantFavoriteId) return -1;
    if (b.id === celebrantFavoriteId) return 1;

    // For non-celebrant: claimed items to bottom
    if (!isCelebrant) {
      const aIsClaimed = claims.some(c => c.wishlist_item_id === a.id);
      const bIsClaimed = claims.some(c => c.wishlist_item_id === b.id);
      if (aIsClaimed && !bIsClaimed) return 1;
      if (!aIsClaimed && bIsClaimed) return -1;
    }

    // Within same category, sort by priority
    return (b.priority || 0) - (a.priority || 0);
  });
}, [celebrantItems, celebrantFavoriteId, claims, currentUserId, celebration?.celebrant_id]);
```

Update the LuxuryWishlistCard rendering in the wishlist section to pass claim props.
Find the existing map over sortedCelebrantItems and update:
```typescript
{sortedCelebrantItems.map((item, index) => {
  const claim = getClaimForItem(item.id);
  const isYourClaim = claim?.claimed_by === currentUserId;
  const isCelebrant = currentUserId === celebration?.celebrant_id;
  const isStandardItem = item.item_type === 'standard' || !item.item_type;

  return (
    <LuxuryWishlistCard
      key={item.id}
      item={item}
      index={index}
      favoriteGroups={item.id === celebrantFavoriteId ? [{ groupId: celebration.group_id, groupName: '' }] : []}
      showFavoriteHeart={false}
      // Claim props (only for non-celebrant view)
      claimable={!isCelebrant && !claim && isStandardItem}
      onClaim={() => handleClaimItem(item)}
      onUnclaim={() => claim && handleUnclaimItem(item, claim.id)}
      claiming={claimingItemId === item.id}
      claim={!isCelebrant ? claim : null}  // Don't pass claim to celebrant
      isYourClaim={isYourClaim}
    />
  );
})}
```

Note: Do NOT pass isTaken or dimmed here - those are for celebrant's My Wishlist view (Plan 04).
  </action>
  <verify>
Sorting uses claims: `grep -E "aIsClaimed|bIsClaimed" app/\(app\)/celebration/\[id\].tsx`
Card receives claim props: `grep -E "claimable=|onClaim=|onUnclaim=" app/\(app\)/celebration/\[id\].tsx`
  </verify>
  <done>
Claimed items sort to bottom of wishlist (unclaimed stay visible).
Non-celebrant sees Claim button on unclaimed standard items.
Non-celebrant sees claimer avatar on items claimed by others.
Non-celebrant sees Your claim indicator on their own claims.
Celebrant view does not receive claim props (no claim UI visible).
  </done>
</task>

</tasks>

<verification>
Claims integration working:
```bash
grep -E "import.*claims" app/\(app\)/celebration/\[id\].tsx
grep -E "claimItem|unclaimItem|getClaimsForItems" app/\(app\)/celebration/\[id\].tsx
grep -E "claimable.*=.*!isCelebrant" app/\(app\)/celebration/\[id\].tsx
```

TypeScript clean:
```bash
npx tsc --noEmit
```
</verification>

<success_criteria>
- Claims fetched when celebrant items load
- Non-celebrant can claim unclaimed standard items (with confirmation dialog)
- Non-celebrant can unclaim their own claims (with confirmation dialog)
- Non-celebrant sees claimer avatar on items claimed by others
- Non-celebrant sees "Your claim" indicator on their own claims
- Claimed items sort to bottom, unclaimed stay at top
- Celebrant viewing their celebration does NOT see claim UI
- Loading spinner shows during claim operations
- Race condition errors show friendly message
</success_criteria>

<output>
After completion, create `.planning/phases/19-gift-claims-ui/19-03-SUMMARY.md`
</output>
