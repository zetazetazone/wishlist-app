---
phase: 19-gift-claims-ui
plan: 04
type: execute
wave: 3
depends_on: ["19-02"]
files_modified:
  - app/(app)/(tabs)/wishlist-luxury.tsx
  - components/wishlist/TakenCounter.tsx
autonomous: true

must_haves:
  truths:
    - "Celebrant sees gift icon badge on claimed items in My Wishlist"
    - "Celebrant sees claimed items dimmed/faded"
    - "Celebrant does NOT see claimer identity (name or avatar)"
    - "Celebrant sees X of Y items taken counter in header"
    - "Claimed items sort to bottom of celebrant's wishlist"
  artifacts:
    - path: "app/(app)/(tabs)/wishlist-luxury.tsx"
      provides: "My Wishlist with celebrant taken view"
    - path: "components/wishlist/TakenCounter.tsx"
      provides: "X of Y items taken counter component"
      exports: ["TakenCounter"]
  key_links:
    - from: "app/(app)/(tabs)/wishlist-luxury.tsx"
      to: "lib/claims"
      via: "import"
      pattern: "import.*getItemClaimStatus.*from.*lib/claims"
    - from: "app/(app)/(tabs)/wishlist-luxury.tsx"
      to: "components/wishlist/TakenCounter"
      via: "import"
      pattern: "import.*TakenCounter"
---

<objective>
Implement celebrant's "taken" view in My Wishlist screen. Celebrant sees which items are claimed (as "taken" with gift icon) but NOT who claimed them. Counter shows anticipation-building "X of Y items taken" text.

Purpose: Celebrant knows gift coordination is happening without spoiling the surprise of who's getting what.
Output: My Wishlist screen with taken badges, dimmed styling, counter, and proper sorting.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-gift-claims-ui/19-CONTEXT.md
@.planning/phases/19-gift-claims-ui/19-RESEARCH.md
@.planning/phases/19-gift-claims-ui/19-02-SUMMARY.md

# Source files
@app/(app)/(tabs)/wishlist-luxury.tsx
@lib/claims.ts
@components/wishlist/LuxuryWishlistCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TakenCounter component</name>
  <files>components/wishlist/TakenCounter.tsx</files>
  <action>
Create TakenCounter.tsx following 19-RESEARCH.md Example 5:
```typescript
import { View, Text } from 'react-native';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import { colors, spacing, borderRadius } from '../../constants/theme';

interface TakenCounterProps {
  takenCount: number;
  totalCount: number;
}

export function TakenCounter({ takenCount, totalCount }: TakenCounterProps) {
  // Don't render if no items
  if (totalCount === 0) return null;

  return (
    <View style={{
      flexDirection: 'row',
      alignItems: 'center',
      backgroundColor: colors.gold[50],
      paddingHorizontal: spacing.sm,
      paddingVertical: spacing.xs,
      borderRadius: borderRadius.sm,
    }}>
      <MaterialCommunityIcons name="gift" size={16} color={colors.gold[600]} />
      <Text style={{
        marginLeft: spacing.xs,
        color: colors.gold[700],
        fontSize: 13,
        fontWeight: '600',
      }}>
        {takenCount} of {totalCount} items taken
      </Text>
    </View>
  );
}
```

Per CONTEXT: "Show count: X of Y items taken visible to celebrant - builds anticipation"
  </action>
  <verify>
File exists: `ls components/wishlist/TakenCounter.tsx`
Export present: `grep "export.*TakenCounter" components/wishlist/TakenCounter.tsx`
  </verify>
  <done>
TakenCounter component displays "X of Y items taken" with gift icon.
Uses theme colors (gold background, gold icon and text).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate claim status into My Wishlist screen</name>
  <files>app/(app)/(tabs)/wishlist-luxury.tsx</files>
  <action>
Add imports:
```typescript
import { getItemClaimStatus, type ItemClaimStatus } from '../../../lib/claims';
import { TakenCounter } from '../../../components/wishlist/TakenCounter';
```

Add state for claim status (after other state variables):
```typescript
const [claimStatuses, setClaimStatuses] = useState<Map<string, boolean>>(new Map());
```

Add function to fetch claim statuses:
```typescript
const fetchClaimStatuses = async (itemIds: string[]) => {
  if (itemIds.length === 0) return;

  try {
    const statuses = await getItemClaimStatus(itemIds);
    const statusMap = new Map<string, boolean>();
    statuses.forEach(s => statusMap.set(s.wishlist_item_id, s.is_claimed));
    setClaimStatuses(statusMap);
  } catch (err) {
    console.error('Failed to fetch claim statuses:', err);
  }
};
```

Call fetchClaimStatuses after items are loaded (in useEffect or after fetchWishlistItems):
```typescript
// After setting items, fetch claim statuses
useEffect(() => {
  if (items.length > 0) {
    fetchClaimStatuses(items.map(i => i.id));
  }
}, [items]);
```

Also call it in handleRefresh:
```typescript
const handleRefresh = async () => {
  setRefreshing(true);
  await fetchWishlistItems();
  // Statuses will be fetched via the items useEffect
  setRefreshing(false);
};
```

Calculate taken count for counter:
```typescript
const takenCount = Array.from(claimStatuses.values()).filter(Boolean).length;
```

Sort items with taken at bottom:
```typescript
const sortedItems = useMemo(() => {
  return [...items].sort((a, b) => {
    const aIsTaken = claimStatuses.get(a.id) || false;
    const bIsTaken = claimStatuses.get(b.id) || false;

    // Unclaimed items first
    if (aIsTaken && !bIsTaken) return 1;
    if (!aIsTaken && bIsTaken) return -1;

    // Within same status, preserve creation order (or sort by priority)
    return (b.priority || 0) - (a.priority || 0);
  });
}, [items, claimStatuses]);
```
  </action>
  <verify>
Imports present: `grep -E "getItemClaimStatus|TakenCounter" app/\(app\)/\(tabs\)/wishlist-luxury.tsx`
State added: `grep "claimStatuses" app/\(app\)/\(tabs\)/wishlist-luxury.tsx`
  </verify>
  <done>
Claim statuses fetched when items load.
Statuses stored in Map for quick lookup.
sortedItems computed with taken items at bottom.
takenCount calculated for counter.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update UI rendering with taken badges and counter</name>
  <files>app/(app)/(tabs)/wishlist-luxury.tsx</files>
  <action>
Add TakenCounter to the header area (below the item count text):
```typescript
{/* In the header section, after the "X gifts" text */}
<View style={{ flexDirection: 'row', alignItems: 'center', gap: spacing.sm }}>
  <Text style={{ fontSize: 16, color: colors.gold[200], fontWeight: '400' }}>
    {items.length} {items.length === 1 ? 'gift' : 'gifts'}
  </Text>
  {takenCount > 0 && (
    <TakenCounter takenCount={takenCount} totalCount={items.length} />
  )}
</View>
```

Update the items.map to use sortedItems and pass isTaken/dimmed props:
```typescript
{sortedItems.map((item, index) => {
  const isTaken = claimStatuses.get(item.id) || false;

  return (
    <LuxuryWishlistCard
      key={item.id}
      item={item}
      onDelete={handleDeleteItem}
      index={index}
      // Celebrant taken view props
      isTaken={isTaken}
      dimmed={isTaken}  // Per CONTEXT: "Taken items appear dimmed/faded"
    />
  );
})}
```

Note: Do NOT pass claimable, onClaim, onUnclaim, claim, or isYourClaim - those are for non-celebrant view in celebration screen.

Per CONTEXT decisions:
- "Taken indicated by gift/present icon" - handled by TakenBadge in card
- "Taken items appear dimmed/faded" - handled by dimmed prop
- "Show count: X of Y items taken visible to celebrant" - handled by TakenCounter
  </action>
  <verify>
TakenCounter rendered: `grep "TakenCounter" app/\(app\)/\(tabs\)/wishlist-luxury.tsx`
Card receives isTaken: `grep "isTaken=" app/\(app\)/\(tabs\)/wishlist-luxury.tsx`
Card receives dimmed: `grep "dimmed=" app/\(app\)/\(tabs\)/wishlist-luxury.tsx`
Uses sortedItems: `grep "sortedItems.map" app/\(app\)/\(tabs\)/wishlist-luxury.tsx`
  </verify>
  <done>
TakenCounter shows in header when items are taken.
Cards show TakenBadge (gift icon) when isTaken is true.
Cards appear dimmed when taken.
Taken items sort to bottom of list.
Celebrant does NOT see claimer identity.
  </done>
</task>

</tasks>

<verification>
Integration complete:
```bash
grep -E "getItemClaimStatus|TakenCounter|isTaken|dimmed" app/\(app\)/\(tabs\)/wishlist-luxury.tsx
```

TakenCounter component exists:
```bash
ls components/wishlist/TakenCounter.tsx
```

TypeScript clean:
```bash
npx tsc --noEmit
```
</verification>

<success_criteria>
- TakenCounter component created and displays "X of Y items taken"
- My Wishlist fetches claim statuses via getItemClaimStatus
- Taken items show TakenBadge (gift icon) on cards
- Taken items appear dimmed/faded
- Taken items sort to bottom of list
- Celebrant sees NO claimer identity (no avatar, no name)
- Counter appears in header area when items are taken
- Counter builds anticipation without revealing details
</success_criteria>

<output>
After completion, create `.planning/phases/19-gift-claims-ui/19-04-SUMMARY.md`
</output>
