---
phase: 22-secret-notes
plan: 03
type: execute
wave: 3
depends_on: ["22-02"]
files_modified:
  - app/(app)/member/[id].tsx
  - app/(app)/celebration/[id].tsx
autonomous: false

must_haves:
  truths:
    - "Member profile screen shows notes section for non-subject viewers"
    - "Celebration page shows notes about celebrant for non-celebrant viewers"
    - "Notes section is completely hidden from the profile owner"
    - "Group context is correctly passed to notes operations"
  artifacts:
    - path: "app/(app)/member/[id].tsx"
      provides: "Member profile with notes section"
      contains: "MemberNotesSection"
    - path: "app/(app)/celebration/[id].tsx"
      provides: "Celebration page with celebrant notes"
      contains: "MemberNotesSection"
  key_links:
    - from: "app/(app)/member/[id].tsx"
      to: "components/notes/MemberNotesSection"
      via: "import and render with groupId prop"
      pattern: "MemberNotesSection.*groupId"
    - from: "app/(app)/celebration/[id].tsx"
      to: "components/notes/MemberNotesSection"
      via: "import and render with celebration.group_id"
      pattern: "celebration\\.group_id"
---

<objective>
Integrate MemberNotesSection into member profile screen and celebration detail page.

Purpose: Makes secret notes accessible from the two natural viewing contexts - member profiles (for group-level browsing) and celebration pages (for gift coordination). Completes NOTE-01 through NOTE-05 by providing user entry points.

Output: Updated member profile and celebration screens with notes sections
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-secret-notes/22-RESEARCH.md

# Components to integrate (from 22-02)
@components/notes/MemberNotesSection.tsx

# Screens to modify
@app/(app)/member/[id].tsx
@app/(app)/celebration/[id].tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notes section to member profile screen</name>
  <files>app/(app)/member/[id].tsx</files>
  <action>
Modify `app/(app)/member/[id].tsx` to include MemberNotesSection:

1. **Add groupId to route params:**
   - Update `useLocalSearchParams` to extract `groupId` alongside `id`:
   ```typescript
   const { id, groupId } = useLocalSearchParams<{ id: string; groupId?: string }>();
   ```
   - The groupId is optional because member profile can be accessed from different contexts

2. **Check if current user is the subject:**
   - Add state for current user ID: `const [currentUserId, setCurrentUserId] = useState<string | null>(null);`
   - In `loadMemberData`, fetch current user and store ID
   - Compute `isSubject = id === currentUserId`

3. **Import MemberNotesSection:**
   ```typescript
   import { MemberNotesSection } from '@/components/notes/MemberNotesSection';
   ```

4. **Render notes section below PersonalDetailsReadOnly:**
   - Only render if `groupId` is provided (notes are group-scoped)
   - Pass all required props:
   ```jsx
   {groupId && (
     <MemberNotesSection
       groupId={groupId}
       aboutUserId={id}
       aboutUserName={memberProfile?.display_name || 'Member'}
       isSubject={isSubject}
     />
   )}
   ```

5. **If no groupId provided, optionally show info message:**
   - If user navigated without group context, notes section won't appear
   - This is expected behavior - notes are per-group

Ensure the notes section appears BELOW the personal details section in the scroll view.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Navigate to member profile from a group context and verify notes section appears.</verify>
  <done>Member profile screen shows notes section when accessed with groupId, hidden for subject users.</done>
</task>

<task type="auto">
  <name>Task 2: Add notes section to celebration detail page</name>
  <files>app/(app)/celebration/[id].tsx</files>
  <action>
Modify `app/(app)/celebration/[id].tsx` to include MemberNotesSection:

1. **Import MemberNotesSection:**
   ```typescript
   import { MemberNotesSection } from '../../../components/notes/MemberNotesSection';
   ```

2. **Compute isCelebrant:**
   - Current code already has `currentUserId` state
   - Compute: `const isCelebrant = currentUserId === celebration?.celebrant?.id;`

3. **Add notes section in the info view:**
   - Place BELOW the celebrant header card but ABOVE the wishlist section
   - Only show when celebration is loaded and group_id is available:
   ```jsx
   {celebration && celebration.group_id && (
     <MemberNotesSection
       groupId={celebration.group_id}
       aboutUserId={celebration.celebrant.id}
       aboutUserName={celebration.celebrant.display_name || 'Celebrant'}
       isSubject={isCelebrant}
     />
   )}
   ```

4. **Section placement:**
   - Should appear when `viewMode === 'info'`
   - Place in the ScrollView content, between header card and wishlist section
   - Wrap in a container with marginBottom for spacing

5. **Handle mode visibility:**
   - Notes section should respect group mode (notes make sense for both greetings and gifts modes)
   - No additional mode check needed - notes are gift-coordination intelligence

The notes section will be hidden from the celebrant (via isSubject check), showing only to other group members for gift-giving context.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Navigate to a celebration and verify notes section appears for non-celebrant, hidden for celebrant.</verify>
  <done>Celebration detail page shows notes about celebrant for non-celebrant viewers, hidden from celebrant themselves.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete secret notes feature with UI integration in member profile and celebration screens</what-built>
  <how-to-verify>
    1. **Test from member profile:**
       - Navigate to a group, tap on a member's card to view their profile
       - Verify you see "Notes" section below personal details
       - Add a note about the member (test 280-char limit)
       - Verify the note appears with your avatar and name
       - Edit the note (inline edit mode)
       - Delete the note (confirm dialog)

    2. **Test from celebration page:**
       - Navigate to an upcoming celebration for another member
       - Verify you see "Notes" section below celebrant header
       - Add a note about the celebrant
       - Verify the note is visible

    3. **Test subject exclusion:**
       - Navigate to YOUR OWN celebration page
       - Verify you do NOT see the notes section at all
       - Navigate to your own member profile (if accessible)
       - Verify notes section is hidden or shows different content

    4. **Test per-group scoping (NOTE-04):**
       - Add a note about a member in Group A
       - If the same member is in Group B, navigate to their profile from Group B
       - Verify the note from Group A is NOT visible in Group B context
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Member profile screen imports and renders MemberNotesSection
3. Celebration detail screen imports and renders MemberNotesSection
4. Notes section hidden from profile owner/celebrant
5. Notes section requires group context (groupId)
6. All NOTE-* requirements addressed
</verification>

<success_criteria>
- `npx tsc --noEmit` succeeds
- Member profile shows notes section when accessed with groupId
- Celebration page shows notes about celebrant
- Subject exclusion works: profile owner/celebrant cannot see notes section
- Notes are group-scoped (different notes per group)
- Full CRUD operations work: add, view, edit, delete
</success_criteria>

<output>
After completion, create `.planning/phases/22-secret-notes/22-03-SUMMARY.md`
</output>
