---
phase: 22-secret-notes
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - components/notes/NoteCard.tsx
  - components/notes/AddNoteSheet.tsx
  - components/notes/MemberNotesSection.tsx
autonomous: true

must_haves:
  truths:
    - "Note card displays author avatar, name, content, and timestamp"
    - "Note card shows edit/delete buttons only for author's own notes"
    - "Add note sheet validates 280-character limit with counter"
    - "Notes section shows list of notes or empty state prompt"
  artifacts:
    - path: "components/notes/NoteCard.tsx"
      provides: "Single note display with author info and actions"
      min_lines: 60
    - path: "components/notes/AddNoteSheet.tsx"
      provides: "Bottom sheet for note creation with character counter"
      min_lines: 80
    - path: "components/notes/MemberNotesSection.tsx"
      provides: "Container with notes list and add button"
      min_lines: 100
  key_links:
    - from: "components/notes/MemberNotesSection.tsx"
      to: "lib/memberNotes"
      via: "import { getNotesAboutUser, createNote, updateNote, deleteNote }"
      pattern: "getNotesAboutUser"
    - from: "components/notes/AddNoteSheet.tsx"
      to: "lib/memberNotes"
      via: "createNote function call"
      pattern: "createNote\\("
---

<objective>
Create UI components for displaying, creating, and managing secret notes about group members.

Purpose: Provides the visual interface for NOTE-01 (add note), NOTE-03 (view notes), and NOTE-05 (edit/delete). NOTE-02 (hidden from subject) is enforced by RLS + isSubject prop.

Output: Three new components in components/notes/ directory
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-secret-notes/22-RESEARCH.md

# Service layer (extended in 22-01)
@lib/memberNotes.ts

# UI patterns to follow
@components/profile/PersonalDetailsReadOnly.tsx
@components/wishlist/AddItemBottomSheet.tsx
@constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NoteCard component</name>
  <files>components/notes/NoteCard.tsx</files>
  <action>
Create `components/notes/NoteCard.tsx` for displaying a single note:

```typescript
/**
 * NoteCard Component
 * Displays a single secret note with author info and optional actions
 *
 * Shows author avatar, name, timestamp, and note content.
 * Edit/delete buttons shown only if isAuthor is true.
 */

import React, { useState } from 'react';
import { View, Text, Pressable, StyleSheet, TextInput, Alert } from 'react-native';
import { HStack, Avatar, AvatarImage, AvatarFallbackText } from '@gluestack-ui/themed';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import { formatDistanceToNow } from 'date-fns';
import type { NoteWithAuthor } from '@/lib/memberNotes';
import { colors, spacing, borderRadius, shadows } from '@/constants/theme';

interface NoteCardProps {
  note: NoteWithAuthor;
  isAuthor: boolean;
  onEdit?: (noteId: string, newContent: string) => Promise<void>;
  onDelete?: (noteId: string) => Promise<void>;
}
```

Implementation requirements:
1. Display author row with Avatar (sm size), display_name, and relative timestamp using `formatDistanceToNow`
2. Display note content below author row
3. If `isAuthor` is true, show edit (pencil) and delete (trash) icons in a row at bottom
4. Support inline editing mode:
   - When edit pressed, replace content Text with TextInput
   - Show character counter (280 max) and Save/Cancel buttons
   - Call `onEdit` with noteId and new content on save
5. When delete pressed, show Alert.alert confirmation before calling `onDelete`
6. Use theme colors: burgundy for author name, cream[600] for timestamp, burgundy[500] for edit icon, warning color for delete icon
7. Card styling: white background, borderRadius.lg, padding spacing.md, shadows.sm

Follow `PersonalDetailsReadOnly.tsx` for timestamp formatting pattern.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Component renders without errors when imported.</verify>
  <done>NoteCard displays note with author info, shows edit/delete actions for author, supports inline editing with character counter.</done>
</task>

<task type="auto">
  <name>Task 2: Create AddNoteSheet and MemberNotesSection</name>
  <files>components/notes/AddNoteSheet.tsx, components/notes/MemberNotesSection.tsx</files>
  <action>
**1. Create `components/notes/AddNoteSheet.tsx`:**

Bottom sheet modal for creating a new note. Follow `AddItemBottomSheet.tsx` pattern.

```typescript
/**
 * AddNoteSheet Component
 * Bottom sheet for creating a new secret note about a member
 */

import React, { useState, useRef, useCallback } from 'react';
import { View, Text, TextInput, Pressable, StyleSheet, Keyboard } from 'react-native';
import BottomSheet, { BottomSheetBackdrop, BottomSheetView } from '@gorhom/bottom-sheet';
import { colors, spacing, borderRadius } from '@/constants/theme';

interface AddNoteSheetProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (content: string) => Promise<void>;
  memberName: string;  // For display: "Add note about {memberName}"
}
```

Requirements:
- BottomSheet with snapPoints ['50%']
- Header: "Add Note" title with X close button
- Subtitle: "About {memberName}" in cream[600]
- TextInput: multiline, placeholder "What would help others pick the perfect gift?", max 280 chars
- Character counter: "{remaining}" showing characters left, turns warning color when < 20, error when negative
- Submit button: "Add Note" in burgundy, disabled when content empty or over 280 chars
- Handle loading state during submission
- Close and reset on successful submit

**2. Create `components/notes/MemberNotesSection.tsx`:**

Container component that manages notes state and renders NoteCard list.

```typescript
/**
 * MemberNotesSection Component
 * Displays secret notes about a member with add/edit/delete functionality
 *
 * SECURITY: This component should NOT be rendered if isSubject is true.
 * RLS prevents the subject from seeing notes, but we hide the UI entirely.
 */

interface MemberNotesSectionProps {
  groupId: string;
  aboutUserId: string;
  aboutUserName: string;
  isSubject: boolean;  // true if current user IS the about_user
}
```

Requirements:
- Return `null` if `isSubject` is true (don't render anything for subject)
- Fetch notes on mount using `getNotesAboutUser(groupId, aboutUserId)`
- Get current user ID from `supabase.auth.getUser()` for `isAuthor` checks
- Section header: "Notes" with "Add" button (+ icon) on right
- If notes empty, show prompt: "Be the first to add a note!" with "Add Note" button
- Map notes to NoteCard components, passing `isAuthor: note.author_id === currentUserId`
- Handle create via AddNoteSheet: call `createNote`, prepend to notes list
- Handle edit: call `updateNote`, update in notes list
- Handle delete: call `deleteNote`, remove from notes list
- Use optimistic updates with rollback on error (follow existing app patterns)

Style the section card similar to PersonalDetailsReadOnly sections: white background, border, padding.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Both components export correctly.</verify>
  <done>AddNoteSheet handles note creation with validation. MemberNotesSection fetches/displays notes, handles CRUD operations, and enforces subject exclusion in UI.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. All three component files exist in components/notes/
3. NoteCard handles display and inline editing
4. AddNoteSheet handles creation with 280-char limit
5. MemberNotesSection returns null for isSubject=true
6. MemberNotesSection handles fetch, create, update, delete operations
</verification>

<success_criteria>
- `components/notes/NoteCard.tsx` exists and exports NoteCard
- `components/notes/AddNoteSheet.tsx` exists and exports AddNoteSheet
- `components/notes/MemberNotesSection.tsx` exists and exports MemberNotesSection
- `npx tsc --noEmit` succeeds
- Components follow existing UI patterns (theme tokens, bottom sheet, avatar)
</success_criteria>

<output>
After completion, create `.planning/phases/22-secret-notes/22-02-SUMMARY.md`
</output>
