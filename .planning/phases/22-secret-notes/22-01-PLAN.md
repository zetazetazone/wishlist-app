---
phase: 22-secret-notes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260209000001_member_notes_update_policy.sql
  - lib/memberNotes.ts
  - types/database.types.ts
autonomous: true

must_haves:
  truths:
    - "Note author can update their own note content"
    - "Note updated_at timestamp reflects last modification"
    - "Service layer provides updateNote function"
  artifacts:
    - path: "supabase/migrations/20260209000001_member_notes_update_policy.sql"
      provides: "UPDATE policy and updated_at column"
      contains: "CREATE POLICY"
    - path: "lib/memberNotes.ts"
      provides: "updateNote function"
      exports: ["updateNote"]
    - path: "types/database.types.ts"
      provides: "updated_at field in MemberNote"
      contains: "updated_at"
  key_links:
    - from: "lib/memberNotes.ts"
      to: "member_notes table"
      via: "supabase.from('member_notes').update()"
      pattern: "\\.update\\("
---

<objective>
Add UPDATE capability to member_notes table and extend service layer with updateNote function.

Purpose: NOTE-05 requires note authors to edit their own notes, but current schema (from Phase 18) was designed as delete-only with no UPDATE policy. This plan adds the missing database policy and service function.

Output: Migration file, updated service library, updated TypeScript types
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-secret-notes/22-RESEARCH.md

# Existing implementation to extend
@lib/memberNotes.ts
@types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for UPDATE policy and updated_at column</name>
  <files>supabase/migrations/20260209000001_member_notes_update_policy.sql</files>
  <action>
Create a new migration file that:

1. Adds UPDATE policy for author-only editing:
```sql
CREATE POLICY "Authors can update own notes"
  ON public.member_notes FOR UPDATE
  USING (author_id = (SELECT auth.uid()))
  WITH CHECK (author_id = (SELECT auth.uid()));
```

2. Adds `updated_at` column with default:
```sql
ALTER TABLE public.member_notes
ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();
```

3. Creates trigger for automatic updated_at maintenance (reuse existing `handle_updated_at` function):
```sql
CREATE TRIGGER set_member_notes_updated_at
  BEFORE UPDATE ON public.member_notes
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();
```

4. Backfill existing rows by setting updated_at = created_at:
```sql
UPDATE public.member_notes SET updated_at = created_at WHERE updated_at IS NULL;
```

Follow existing migration patterns from `supabase/migrations/` directory. Use idempotent statements where possible (IF NOT EXISTS).
  </action>
  <verify>Run `npx supabase db push` successfully. Verify policy exists with `\dp member_notes` in psql or via Supabase dashboard.</verify>
  <done>UPDATE policy on member_notes allows authors to modify their own notes. The `updated_at` column exists and auto-updates on modification.</done>
</task>

<task type="auto">
  <name>Task 2: Add updateNote function and update types</name>
  <files>lib/memberNotes.ts, types/database.types.ts</files>
  <action>
1. In `types/database.types.ts`, add `updated_at` to member_notes types:
   - In `member_notes.Row`: add `updated_at: string`
   - In `member_notes.Insert`: add `updated_at?: string`
   - In `member_notes.Update`: add `updated_at?: string`

2. In `lib/memberNotes.ts`:
   - Update file header comment to remove "no editing" note
   - Add `updateNote` export function following existing `createNote` pattern:

```typescript
/**
 * Update an existing note (author only)
 *
 * RLS enforces author-only update. Content max 280 characters.
 *
 * @param noteId - UUID of the note to update
 * @param content - New note text (max 280 characters)
 */
export async function updateNote(
  noteId: string,
  content: string
): Promise<NoteWithAuthor> {
  // Get current user
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    throw new Error('Not authenticated');
  }

  // Client-side validation
  const trimmedContent = content.trim();
  if (!trimmedContent) {
    throw new Error('Note content cannot be empty');
  }
  if (trimmedContent.length > 280) {
    throw new Error('Note content cannot exceed 280 characters');
  }

  const { data: note, error } = await supabase
    .from('member_notes')
    .update({ content: trimmedContent })
    .eq('id', noteId)
    .select()
    .single();

  if (error) {
    console.error('Failed to update member note:', error);
    throw new Error(`Failed to update note: ${error.message}`);
  }

  // Fetch author profile for return type
  const { data: profile } = await supabase
    .from('user_profiles')
    .select('id, display_name, avatar_url')
    .eq('id', user.id)
    .single();

  return {
    ...note,
    author: profile ? {
      id: profile.id,
      display_name: profile.display_name,
      avatar_url: profile.avatar_url,
    } : undefined,
  };
}
```

Maintain existing error handling patterns and JSDoc comment style.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`. The `updateNote` function is exported from `lib/memberNotes.ts`.</verify>
  <done>Service layer exports `updateNote` function. TypeScript types include `updated_at` field for MemberNote.</done>
</task>

</tasks>

<verification>
1. Migration applies cleanly: `npx supabase db push`
2. TypeScript compiles: `npx tsc --noEmit`
3. UPDATE policy exists on member_notes table
4. `updated_at` column exists and has trigger
5. `updateNote` function exported from lib/memberNotes.ts
</verification>

<success_criteria>
- Migration file exists at `supabase/migrations/20260209000001_member_notes_update_policy.sql`
- `npx supabase db push` succeeds
- `npx tsc --noEmit` succeeds
- `lib/memberNotes.ts` exports `updateNote`, `createNote`, `deleteNote`, `getNotesAboutUser`
- `types/database.types.ts` includes `updated_at` in member_notes Row/Insert/Update
</success_criteria>

<output>
After completion, create `.planning/phases/22-secret-notes/22-01-SUMMARY.md`
</output>
