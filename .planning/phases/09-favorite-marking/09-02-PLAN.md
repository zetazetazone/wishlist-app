---
phase: 09-favorite-marking
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - components/wishlist/LuxuryWishlistCard.tsx
  - app/(app)/(tabs)/wishlist.tsx
autonomous: false

must_haves:
  truths:
    - "User can tap heart icon to mark an item as favorite"
    - "Tapping heart on another item automatically replaces the old favorite"
    - "Tapping filled heart removes favorite status"
    - "Favorite item appears pinned at top of wishlist"
    - "Favorite item has accent-colored border"
    - "Favorite item displays Most Wanted badge"
    - "Favorite persists across app refresh"
  artifacts:
    - path: "components/wishlist/LuxuryWishlistCard.tsx"
      provides: "Wishlist card with favorite support"
      contains: "FavoriteHeart"
    - path: "app/(app)/(tabs)/wishlist.tsx"
      provides: "My Wishlist screen with favorite state management"
      contains: "favoriteItemId"
  key_links:
    - from: "app/(app)/(tabs)/wishlist.tsx"
      to: "lib/favorites.ts"
      via: "import and call setFavorite/removeFavorite"
      pattern: "import.*from.*favorites"
    - from: "components/wishlist/LuxuryWishlistCard.tsx"
      to: "components/wishlist/FavoriteHeart.tsx"
      via: "renders FavoriteHeart component"
      pattern: "<FavoriteHeart"
    - from: "components/wishlist/LuxuryWishlistCard.tsx"
      to: "components/wishlist/MostWantedBadge.tsx"
      via: "renders MostWantedBadge when favorite"
      pattern: "<MostWantedBadge"
---

<objective>
Integrate favorite marking into the My Wishlist screen with visual distinction and pinned positioning.

Purpose: Wire the foundation components from Plan 01 into the actual wishlist UI, enabling users to mark favorites with full visual treatment and list reordering.

Output: Working "Most Wanted" feature on My Wishlist screen - users can tap hearts, see visual highlights, and favorites pin to top.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-favorite-marking/09-CONTEXT.md
@.planning/phases/09-favorite-marking/09-RESEARCH.md
@.planning/phases/09-favorite-marking/09-01-SUMMARY.md
@components/wishlist/LuxuryWishlistCard.tsx
@app/(app)/(tabs)/wishlist.tsx
@constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update LuxuryWishlistCard for favorite support</name>
  <files>components/wishlist/LuxuryWishlistCard.tsx</files>
  <action>
Extend LuxuryWishlistCard to support favorite display and heart toggle:

**1. Update Props Interface:**
```typescript
interface LuxuryWishlistCardProps {
  item: WishlistItem;
  onDelete?: (id: string) => void;
  index: number;
  isFavorite?: boolean;           // NEW: whether this item is the favorite
  onToggleFavorite?: () => void;  // NEW: callback when heart is tapped
  showFavoriteHeart?: boolean;    // NEW: whether to show heart (only on owner's view)
}
```

**2. Add Imports:**
```typescript
import { FavoriteHeart } from './FavoriteHeart';
import { MostWantedBadge } from './MostWantedBadge';
```

**3. Update getCardBorderColor function:**
If isFavorite is true AND item is NOT a special item, return colors.gold[400] for stronger gold border.
Otherwise keep existing logic (special items keep their borders).

**4. Update Header Row (where delete button is):**
Replace the delete button section with conditional rendering:
- If showFavoriteHeart is true, render FavoriteHeart component instead of delete button:
  ```tsx
  {showFavoriteHeart && (
    <FavoriteHeart
      isFavorite={isFavorite || false}
      onPress={() => onToggleFavorite?.()}
    />
  )}
  {!showFavoriteHeart && onDelete && (
    // existing delete button code
  )}
  ```

**5. Add MostWantedBadge above title (when favorite):**
Inside the View containing the title, add before the item type badge:
```tsx
{isFavorite && <MostWantedBadge />}
{isSpecialItem && (
  <ItemTypeBadge ... />
)}
```

This stacks badges vertically: Most Wanted above, then item type badge if special item.

**6. Update View container for accent border:**
Modify the outer View's borderWidth to 2 when isFavorite (instead of 1):
```typescript
borderWidth: isFavorite ? 2 : 1,
```
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit components/wishlist/LuxuryWishlistCard.tsx`
2. Props interface includes isFavorite, onToggleFavorite, showFavoriteHeart
3. FavoriteHeart and MostWantedBadge are imported and used
  </verify>
  <done>
- Card shows FavoriteHeart in top-right when showFavoriteHeart=true
- Card shows MostWantedBadge when isFavorite=true
- Card has gold[400] border with 2px width when favorite
- Badges stack vertically (Most Wanted above item type)
- Delete button hidden when heart is shown
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire favorites into My Wishlist screen</name>
  <files>app/(app)/(tabs)/wishlist.tsx</files>
  <action>
Integrate favorite state management and sorting into the wishlist screen:

**1. Add Imports:**
```typescript
import { setFavorite, removeFavorite, getFavoriteForGroup } from '../../../lib/favorites';
```

**2. Add State:**
```typescript
const [favoriteItemId, setFavoriteItemId] = useState<string | null>(null);
const [activeGroupId, setActiveGroupId] = useState<string | null>(null);
```

Note: For MVP, we need a groupId. Since wishlist items are currently not group-scoped in the fetch, we'll use a placeholder approach. For now, fetch the user's first group and use that as the "active" group for favorites. This aligns with the context decision that different groups can have different favorites.

**3. Load user's group and favorite on mount:**
Add to the existing getCurrentUser function or create separate effect:
```typescript
// After getting userId, fetch user's first group
const { data: membership } = await supabase
  .from('group_members')
  .select('group_id')
  .eq('user_id', user.id)
  .limit(1)
  .single();

if (membership) {
  setActiveGroupId(membership.group_id);
  // Load favorite for this group
  const favId = await getFavoriteForGroup(user.id, membership.group_id);
  setFavoriteItemId(favId);
}
```

**4. Create handleToggleFavorite function:**
```typescript
const handleToggleFavorite = async (itemId: string) => {
  if (!userId || !activeGroupId) return;

  // Store previous for rollback
  const previousFavorite = favoriteItemId;

  // Optimistic update
  if (itemId === favoriteItemId) {
    setFavoriteItemId(null); // Unfavoriting
  } else {
    setFavoriteItemId(itemId); // Favoriting (auto-replaces old)
  }

  try {
    if (itemId === previousFavorite) {
      // Unfavoriting
      await removeFavorite(userId, activeGroupId);
    } else {
      // Favoriting (upsert handles replacement)
      await setFavorite(userId, activeGroupId, itemId);
    }
  } catch (error) {
    // Rollback on error
    console.error('Failed to toggle favorite:', error);
    setFavoriteItemId(previousFavorite);
    Alert.alert('Error', 'Failed to update favorite');
  }
};
```

**5. Sort items with favorite pinned:**
Before rendering, sort items so favorite appears first:
```typescript
// In render, before mapping items
const sortedItems = [...items].sort((a, b) => {
  if (a.id === favoriteItemId) return -1;
  if (b.id === favoriteItemId) return 1;
  // Then by priority (stars) descending
  return (b.priority || 0) - (a.priority || 0);
});
```

**6. Update LuxuryWishlistCard usage:**
Replace the items.map with sortedItems.map and pass new props:
```tsx
{sortedItems.map((item, index) => (
  <LuxuryWishlistCard
    key={item.id}
    item={item}
    onDelete={handleDeleteItem}
    index={index}
    isFavorite={item.id === favoriteItemId}
    onToggleFavorite={() => handleToggleFavorite(item.id)}
    showFavoriteHeart={true}  // Owner's view shows heart
  />
))}
```

**7. Refresh favorite on pull-to-refresh:**
Update handleRefresh to also reload the favorite:
```typescript
const handleRefresh = async () => {
  setRefreshing(true);
  await fetchWishlistItems();
  if (userId && activeGroupId) {
    const favId = await getFavoriteForGroup(userId, activeGroupId);
    setFavoriteItemId(favId);
  }
  setRefreshing(false);
};
```
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit app/\(app\)/\(tabs\)/wishlist.tsx`
2. favoriteItemId state is declared
3. handleToggleFavorite function exists
4. sortedItems sorts favorite to top
5. LuxuryWishlistCard receives isFavorite and onToggleFavorite props
  </verify>
  <done>
- favoriteItemId state tracks current favorite
- Tapping heart calls handleToggleFavorite
- Optimistic update with rollback on error
- Favorite item sorted to top of list
- Pull-to-refresh reloads favorite state
- Cards show heart icon with proper favorite state
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete "Most Wanted" favorite feature on My Wishlist screen:
- Heart icon in top-right of each wishlist card
- Tap heart to mark as favorite (fills gold, shows pulse animation)
- Favorite item shows "MOST WANTED" badge
- Favorite item has gold border
- Favorite pins to top of list
- Tap heart again to unfavorite
- Tap different item's heart to auto-replace favorite
  </what-built>
  <how-to-verify>
1. Open the app and navigate to "My Wishlist" tab
2. Verify each card has a heart icon (outline) in top-right corner
3. Tap a heart icon:
   - Heart should pulse and fill with gold color
   - Card should get gold border
   - "MOST WANTED" badge should appear above title
   - Card should move to top of list
4. Tap the same filled heart:
   - Heart should unfill (outline)
   - Gold border should revert to normal
   - Badge should disappear
   - Card should return to normal position (sorted by priority)
5. With a favorite set, tap a different card's heart:
   - Old favorite should unfill
   - New favorite should fill and move to top
6. Pull to refresh:
   - Favorite state should persist
7. Close app, reopen, go to My Wishlist:
   - Favorite should still be set and pinned to top

**For special items (Surprise Me, Mystery Box):**
- Verify heart works the same way
- Verify "MOST WANTED" badge stacks above item type badge
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete and checkpoint approved:
1. LuxuryWishlistCard accepts and uses favorite props
2. wishlist.tsx manages favorite state with optimistic updates
3. Visual treatment correct: gold border, badge, filled heart
4. Sorting correct: favorite always first
5. Persistence correct: survives refresh and app restart
</verification>

<success_criteria>
- User can mark one item as favorite per group
- Favorite has distinct visual treatment (gold border, badge, filled heart)
- Favorite pins to top of list
- Auto-replace: new favorite unfavorites old one
- Favorite persists across refresh
- Visual checkpoint approved by user
</success_criteria>

<output>
After completion, create `.planning/phases/09-favorite-marking/09-02-SUMMARY.md`
</output>
