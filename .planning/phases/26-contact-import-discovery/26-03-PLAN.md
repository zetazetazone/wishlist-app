---
phase: 26-contact-import-discovery
plan: 03
type: execute
wave: 3
depends_on: ["26-02"]
files_modified:
  - components/discovery/MatchedContactCard.tsx
  - app/(app)/discover.tsx
  - app/(app)/(tabs)/friends.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to Find Friends screen from Friends tab"
    - "Find Friends screen shows permission request UI if contacts not granted"
    - "After permission granted, screen shows matched contacts from phone"
    - "Matched contacts display with contact name, app username, and relationship status"
    - "User can search for users by name or email"
    - "Matched/searched users show Add Friend / Request Sent / Accept / Friends status"
    - "iOS 18 limited access shows banner explaining how to grant more access"
  artifacts:
    - path: "components/discovery/MatchedContactCard.tsx"
      provides: "Card component for matched contacts with status"
      exports: ["MatchedContactCard"]
    - path: "app/(app)/discover.tsx"
      provides: "Find Friends screen with contact matching and search"
      min_lines: 150
    - path: "app/(app)/(tabs)/friends.tsx"
      provides: "Updated Friends tab with Find Friends button"
      contains: "router.push('/discover')"
  key_links:
    - from: "app/(app)/(tabs)/friends.tsx"
      to: "/discover"
      via: "TouchableOpacity onPress router.push"
      pattern: "router\\.push\\('/discover'\\)"
    - from: "app/(app)/discover.tsx"
      to: "lib/contacts.ts"
      via: "import"
      pattern: "from '.*lib/contacts'"
    - from: "app/(app)/discover.tsx"
      to: "lib/discovery.ts"
      via: "import"
      pattern: "from '.*lib/discovery'"
---

<objective>
Create Find Friends UI: MatchedContactCard component, discover screen with contact matching and user search, and update Friends tab with Find Friends navigation button.

Purpose: Enables users to import phone contacts to find existing app users and search for users by name/email. Completes DISC-01 through DISC-06 and FTAB-04 requirements.

Output: New MatchedContactCard component, new discover.tsx screen, updated friends.tsx with navigation button
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/26-contact-import-discovery/26-RESEARCH.md
@.planning/phases/26-contact-import-discovery/26-02-SUMMARY.md
@app/(app)/(tabs)/friends.tsx
@components/friends/FriendCard.tsx
@lib/contacts.ts
@lib/discovery.ts
@lib/friends.ts
@constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MatchedContactCard component</name>
  <files>components/discovery/MatchedContactCard.tsx</files>
  <action>
Create components/discovery/MatchedContactCard.tsx following FriendCard.tsx patterns:

**Imports:**
```typescript
import React from 'react';
import { View, Text, TouchableOpacity, StyleSheet, Image, Alert } from 'react-native';
import { MotiView } from 'moti';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import { colors, spacing, borderRadius, shadows } from '../../constants/theme';
import { MatchedUser } from '../../lib/contacts';
import { sendFriendRequest, acceptFriendRequest } from '../../lib/friends';
```

**Props interface:**
```typescript
interface MatchedContactCardProps {
  user: MatchedUser;
  onStatusChange: () => void;
  index?: number;
}
```

**Component structure:**
- MotiView wrapper with staggered fade-in (from={{ opacity: 0, translateY: 20 }})
- White card with shadow (shadow.sm from theme)
- Left: Avatar (Image or initials fallback with burgundy background)
- Middle: Two lines - contactName (from device, smaller text), displayName (app name, larger)
- Right: Status-aware action button

**Action button states:**
- `'none'`: "Add" button (teal), onPress calls sendFriendRequest(user.userId) then onStatusChange()
- `'pending_outgoing'`: "Sent" text (gold background, disabled style)
- `'pending_incoming'`: "Accept" button (teal), onPress calls acceptFriendRequest (need to get request ID)
- `'friends'`: "Friends" text with check icon (green)

For pending_incoming: Since MatchedUser doesn't have requestId, the Accept button should navigate to /requests screen instead (or show Alert saying "Check Requests tab to accept").

**Error handling:** Wrap sendFriendRequest in try/catch, show Alert.alert on error.

**Styling:** Match FriendCard styling - 16px rounded corners, white background, gold[100] border, proper padding.
  </action>
  <verify>
- File exists at components/discovery/MatchedContactCard.tsx
- Exports MatchedContactCard component
- Displays contactName and displayName
- Shows different buttons based on relationshipStatus
- Has moti animation for staggered entrance
- Follows FriendCard visual patterns
  </verify>
  <done>
MatchedContactCard component exists with contact name + app username display, status-aware action buttons (Add/Sent/Accept/Friends), moti stagger animations, and FriendCard-consistent styling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create discover.tsx - Find Friends screen</name>
  <files>app/(app)/discover.tsx</files>
  <action>
Create app/(app)/discover.tsx with contact matching and user search:

**Imports:**
- React hooks (useState, useEffect, useCallback)
- RN components (View, Text, ScrollView, RefreshControl, TextInput, TouchableOpacity, ActivityIndicator, Alert, StatusBar, Linking, StyleSheet)
- expo-router (useRouter, Stack)
- expo-linear-gradient (LinearGradient)
- moti (MotiView)
- MaterialCommunityIcons
- lib/contacts (checkContactPermission, requestContactPermission, expandContactAccess, matchContacts, MatchedUser)
- lib/discovery (searchUsers, SearchResult)
- components/discovery/MatchedContactCard
- constants/theme

**State:**
```typescript
const [permission, setPermission] = useState<'loading' | 'denied' | 'limited' | 'granted'>('loading');
const [matchedContacts, setMatchedContacts] = useState<MatchedUser[]>([]);
const [searchResults, setSearchResults] = useState<SearchResult[]>([]);
const [searchQuery, setSearchQuery] = useState('');
const [loading, setLoading] = useState(true);
const [searching, setSearching] = useState(false);
const [refreshing, setRefreshing] = useState(false);
```

**Initial load (useEffect):**
1. Check permission with checkContactPermission()
2. If granted or limited: call matchContacts() and set matchedContacts
3. Set permission state accordingly
4. Set loading = false

**Search (debounced useEffect on searchQuery):**
1. If query.length >= 2: setSearching(true), call searchUsers(query), setSearchResults, setSearching(false)
2. If query.length < 2: clear searchResults

**Screen layout:**

1. **Stack.Screen** with headerShown: false (using custom gradient header)

2. **Header (LinearGradient):**
   - Same gradient as Friends tab (burgundy[800] to burgundy[600])
   - Back button (arrow-left icon) that calls router.back()
   - Title "Find Friends"
   - Subtitle based on state: "Search or import contacts" / "{N} matches found"

3. **Search input section:**
   - TextInput with placeholder "Search by name or email"
   - Search icon on left
   - Clear button (X) on right when query exists
   - White background, rounded corners

4. **Content area (ScrollView with RefreshControl):**

   **If permission === 'loading':** Show ActivityIndicator

   **If permission === 'denied':**
   Show permission request UI:
   - Icon (contacts-outline)
   - Title "Import Your Contacts"
   - Subtitle explaining benefit ("Find friends who already use Wishlist")
   - "Allow Access" button calling requestContactPermission()
   - "Open Settings" link (uses Linking.openSettings())

   **If permission === 'limited':**
   Show limited access banner at top:
   - Yellow/gold background
   - "Limited Access" text
   - "You've granted access to some contacts. Tap to add more."
   - onPress calls expandContactAccess() then reloads

   **If searching:** Show ActivityIndicator in content area

   **If searchQuery.length >= 2 (search mode):**
   - Show searchResults using MatchedContactCard
   - Empty state if no results: "No users found matching [query]"

   **If no search query (contact mode):**
   - Show matchedContacts using MatchedContactCard
   - Empty state if no matches: "No contacts found on Wishlist yet"

**Refresh handler:**
- Re-fetch matchContacts and update matchedContacts

**Status change handler:**
- Passed to MatchedContactCard
- Re-fetches both matchContacts and repeats current search if active

**Styling:**
- Match Friends tab styling
- Search input with proper padding, icons
- Cards with stagger animation
  </action>
  <verify>
- File exists at app/(app)/discover.tsx
- Has permission check on mount
- Shows permission request UI when denied
- Shows limited access banner when iOS 18 limited
- Has search input with debounced search
- Shows matched contacts when no search query
- Shows search results when searching
- Has pull-to-refresh on contact matches
- Uses MatchedContactCard for both lists
  </verify>
  <done>
discover.tsx screen exists with contact permission handling (including iOS 18 limited banner), contact matching display, user search functionality, proper empty states, and MatchedContactCard integration
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Find Friends button to Friends tab</name>
  <files>app/(app)/(tabs)/friends.tsx</files>
  <action>
Update app/(app)/(tabs)/friends.tsx to add "Find Friends" button in header:

**Add to header section (inside LinearGradient, near the requests link):**

Add a "Find Friends" TouchableOpacity next to the existing requests link:
- Position: absolute, left side of header (to balance the right-side requests icon)
- Icon: MaterialCommunityIcons "account-search" or "magnify" (24px, white)
- onPress: router.push('/discover')

OR alternatively, add it as a second icon on the right side:
- Add between the title and the requests icon
- Use "account-plus" icon

**Recommended placement:** Add as a floating action button style in the bottom-right corner of the screen, OR as an icon button in the header left of the requests link.

Let's go with header placement for consistency:
- Add to the header area, positioned to the LEFT of the requests icon
- Icon: "account-search" (24px, white)
- Same style as requestsLink but positioned differently

**Implementation:**
1. Add a new TouchableOpacity before or after requestsLink
2. Use similar styling (absolute positioning or row layout)
3. Navigate to '/discover' on press

**Alternative - simpler approach:**
Add a row with two buttons above the title in the header:
```jsx
<View style={styles.headerActions}>
  <TouchableOpacity onPress={() => router.push('/discover')}>
    <MaterialCommunityIcons name="account-search" size={24} color={colors.white} />
  </TouchableOpacity>
  <TouchableOpacity onPress={() => router.push('/requests')}>
    <MaterialCommunityIcons name="account-clock" size={24} color={colors.white} />
    {pendingCount > 0 && <Badge count={pendingCount} />}
  </TouchableOpacity>
</View>
```

Choose whichever fits best with the existing header design. The key requirement is FTAB-04: Friends tab has link to find friends (contact import).
  </action>
  <verify>
- friends.tsx has TouchableOpacity that navigates to '/discover'
- Icon visible in header area
- router.push('/discover') called on press
- Styling consistent with existing header elements
  </verify>
  <done>
Friends tab has Find Friends button in header that navigates to /discover screen when tapped, styled consistently with existing requests link
  </done>
</task>

</tasks>

<verification>
1. Navigation works: Tap Find Friends in Friends tab -> opens discover screen
2. Permission flow: First visit shows permission request (if not granted)
3. Contact matching: After permission grant, shows matched contacts
4. Search works: Type 2+ characters, shows search results
5. Status buttons work: Add Friend sends request, updates UI
6. iOS 18 limited: Shows banner offering to expand access
7. TypeScript: No type errors in new components
</verification>

<success_criteria>
- MatchedContactCard displays contact name, app name, and appropriate status button
- discover.tsx handles all permission states (loading/denied/limited/granted)
- discover.tsx shows matched contacts and supports user search
- Friends tab has Find Friends button navigating to /discover
- Status buttons (Add/Sent/Accept/Friends) work correctly
- Pull-to-refresh reloads contact matches
- Search debounced and shows results for 2+ character queries
</success_criteria>

<output>
After completion, create `.planning/phases/26-contact-import-discovery/26-03-SUMMARY.md`
</output>
