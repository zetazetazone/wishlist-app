---
phase: 26-contact-import-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - app.json
  - supabase/migrations/20260212000001_contact_matching.sql
autonomous: true

must_haves:
  truths:
    - "Supabase has match_phones RPC function that returns users matching phone numbers"
    - "Supabase has search_users RPC function that returns users by name/email"
    - "expo-contacts plugin is configured for iOS and Android permission strings"
    - "libphonenumber-js is available for E.164 normalization"
  artifacts:
    - path: "supabase/migrations/20260212000001_contact_matching.sql"
      provides: "RPC functions for phone matching and user search"
      contains: "CREATE OR REPLACE FUNCTION public.match_phones"
    - path: "app.json"
      provides: "expo-contacts plugin configuration"
      contains: "expo-contacts"
    - path: "package.json"
      provides: "libphonenumber-js dependency"
      contains: "libphonenumber-js"
  key_links:
    - from: "supabase/migrations/20260212000001_contact_matching.sql"
      to: "public.users"
      via: "Phone column lookup"
      pattern: "u\\.phone = ANY\\(p_phone_numbers\\)"
---

<objective>
Create foundation for contact import: database RPC functions for phone matching and user search, plus install and configure expo-contacts and libphonenumber-js dependencies.

Purpose: Enables the discovery screen to match device contacts against registered users using E.164 normalized phone numbers, and search for users by name/email. Also sets up contact permission strings for iOS and Android.

Output: Database migration with RPC functions, updated package.json with dependencies, updated app.json with expo-contacts plugin
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-contact-import-discovery/26-RESEARCH.md
@supabase/migrations/20260210000001_v1.4_friends_system_foundation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure expo-contacts plugin</name>
  <files>package.json, app.json</files>
  <action>
Install expo-contacts and libphonenumber-js:
```bash
npx expo install expo-contacts
npm install libphonenumber-js
```

Update app.json to add expo-contacts plugin with permission strings:

1. Add to plugins array:
```json
[
  "expo-contacts",
  {
    "contactsPermission": "Allow Wishlist to find friends who already use the app"
  }
]
```

2. Add to ios.infoPlist:
```json
"NSContactsUsageDescription": "Allow Wishlist to find friends who already use the app"
```

3. Add to android.permissions array:
```json
"android.permission.READ_CONTACTS"
```

The permission string should be user-friendly and explain WHY the app needs contact access (to find friends), not just what it accesses.
  </action>
  <verify>
- `npm ls expo-contacts` shows version installed
- `npm ls libphonenumber-js` shows version installed
- `cat app.json | grep -A3 expo-contacts` shows plugin configuration
- `cat app.json | grep NSContactsUsageDescription` shows iOS permission string
- `cat app.json | grep READ_CONTACTS` shows Android permission
  </verify>
  <done>
expo-contacts 15.x and libphonenumber-js 1.x installed, app.json has plugin configuration with iOS NSContactsUsageDescription and Android READ_CONTACTS permission
  </done>
</task>

<task type="auto">
  <name>Task 2: Create contact matching RPC functions migration</name>
  <files>supabase/migrations/20260212000001_contact_matching.sql</files>
  <action>
Create migration file with two RPC functions:

**match_phones(p_phone_numbers TEXT[]):**
- RETURNS TABLE (user_id UUID, phone TEXT, display_name TEXT, avatar_url TEXT)
- SECURITY DEFINER with SET search_path = ''
- Requires authentication (RAISE EXCEPTION if auth.uid() IS NULL)
- Matches p_phone_numbers array against users.phone column
- Excludes:
  - Current user (u.id != v_user_id)
  - Blocked users (check friend_requests.status = 'blocked' in both directions)
- Uses the existing idx_users_phone index for performance

**search_users(p_query TEXT):**
- RETURNS TABLE (user_id UUID, display_name TEXT, email TEXT, avatar_url TEXT)
- SECURITY DEFINER with SET search_path = ''
- Requires authentication
- Uses ILIKE for case-insensitive partial matching on full_name OR email
- Escape special ILIKE characters (%, _, \) using regexp_replace
- Add wildcards: '%' || escaped_query || '%'
- Excludes:
  - Current user
  - Blocked users (both directions)
- ORDER BY match quality: exact match first, starts-with second, contains third
- LIMIT 20 for performance

Both functions:
- GRANT EXECUTE to authenticated role
- Add COMMENT explaining purpose

Pattern for blocked user check (from existing RPC):
```sql
AND NOT EXISTS (
  SELECT 1 FROM public.friend_requests fr
  WHERE fr.status = 'blocked'
    AND (
      (fr.from_user_id = v_user_id AND fr.to_user_id = u.id)
      OR (fr.to_user_id = v_user_id AND fr.from_user_id = u.id)
    )
)
```

Include completion notice at end using DO $$ ... RAISE NOTICE ... END $$;
  </action>
  <verify>
- File exists at supabase/migrations/20260212000001_contact_matching.sql
- Contains CREATE OR REPLACE FUNCTION public.match_phones
- Contains CREATE OR REPLACE FUNCTION public.search_users
- Contains SECURITY DEFINER for both functions
- Contains blocked user exclusion for both functions
- Contains GRANT EXECUTE to authenticated for both functions
  </verify>
  <done>
Migration file exists with match_phones() accepting TEXT[] and returning matched users with phone/name/avatar, and search_users() accepting TEXT query and returning users matching name or email with ILIKE, both excluding self and blocked users
  </done>
</task>

</tasks>

<verification>
1. Dependencies installed: `npm ls expo-contacts libphonenumber-js`
2. Plugin configured: `cat app.json | grep -A5 expo-contacts`
3. Migration syntax valid: No SQL syntax errors in migration file
4. RPC functions follow existing patterns (compare to accept_friend_request RPC)
</verification>

<success_criteria>
- expo-contacts and libphonenumber-js packages installed
- app.json has expo-contacts plugin with iOS and Android permission strings
- Migration file contains match_phones and search_users RPC functions
- RPC functions exclude self and blocked users
- RPC functions use SECURITY DEFINER pattern
</success_criteria>

<output>
After completion, create `.planning/phases/26-contact-import-discovery/26-01-SUMMARY.md`
</output>
