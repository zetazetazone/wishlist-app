---
phase: 26-contact-import-discovery
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - lib/contacts.ts
  - lib/discovery.ts
autonomous: true

must_haves:
  truths:
    - "App can check and request contact permission with iOS 18 limited access support"
    - "App can normalize phone numbers to E.164 format using libphonenumber-js"
    - "App can fetch contacts from device with phone numbers"
    - "App can match contacts against registered users via match_phones RPC"
    - "App can search users by name/email via search_users RPC"
    - "Matched users include relationship status (none/pending_incoming/pending_outgoing/friends)"
  artifacts:
    - path: "lib/contacts.ts"
      provides: "Contact permission handling, phone normalization, contact fetching"
      exports: ["checkContactPermission", "requestContactPermission", "normalizeToE164", "getContactsWithPhones", "matchContacts"]
    - path: "lib/discovery.ts"
      provides: "User discovery service"
      exports: ["searchUsers"]
  key_links:
    - from: "lib/contacts.ts"
      to: "expo-contacts"
      via: "import"
      pattern: "import \\* as Contacts from 'expo-contacts'"
    - from: "lib/contacts.ts"
      to: "libphonenumber-js/mobile"
      via: "import"
      pattern: "import parsePhoneNumber from 'libphonenumber-js/mobile'"
    - from: "lib/contacts.ts"
      to: "supabase.rpc('match_phones'"
      via: "function call"
      pattern: "supabase\\.rpc\\('match_phones'"
    - from: "lib/discovery.ts"
      to: "supabase.rpc('search_users'"
      via: "function call"
      pattern: "supabase\\.rpc\\('search_users'"
---

<objective>
Create service libraries for contact import and user discovery: lib/contacts.ts for device contact access and phone matching, lib/discovery.ts for user search functionality.

Purpose: Provides the data layer for the Find Friends screen, enabling contact permission handling, E.164 phone normalization, device contact fetching, contact-to-user matching, and name/email search with relationship status enrichment.

Output: Two new service library files following existing lib/*.ts patterns
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/26-contact-import-discovery/26-RESEARCH.md
@.planning/phases/26-contact-import-discovery/26-01-SUMMARY.md
@lib/friends.ts
@lib/supabase.ts
@lib/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/contacts.ts - Contact import and phone normalization</name>
  <files>lib/contacts.ts</files>
  <action>
Create lib/contacts.ts following patterns from existing lib/friends.ts:

**Imports:**
```typescript
import * as Contacts from 'expo-contacts';
import parsePhoneNumber from 'libphonenumber-js/mobile';
import type { CountryCode } from 'libphonenumber-js/types';
import { supabase } from './supabase';
import { getRelationshipStatus } from './friends';
import { getAvatarUrl } from './storage';
```

**Types (export all):**
```typescript
export interface ContactPermissionResult {
  granted: boolean;
  accessLevel: 'all' | 'limited' | 'none';
}

export interface ImportedContact {
  id: string;
  name: string;
  phoneNumbers: string[];
  image?: string;
}

export interface MatchedUser {
  userId: string;
  displayName: string;
  avatarUrl: string | null;
  contactName: string;
  matchedPhone: string;
  relationshipStatus: 'none' | 'pending_incoming' | 'pending_outgoing' | 'friends';
}
```

**Functions:**

1. `checkContactPermission(): Promise<ContactPermissionResult>` - Check current permission
   - Use Contacts.getPermissionsAsync()
   - Return accessLevel from accessPrivileges (iOS 18) or 'all' if undefined (older iOS/Android)

2. `requestContactPermission(): Promise<ContactPermissionResult>` - Request permission
   - Use Contacts.requestPermissionsAsync()
   - Same accessLevel logic as check

3. `expandContactAccess(): Promise<string[]>` - iOS 18 limited access picker
   - Try Contacts.presentAccessPickerAsync()
   - Catch and return [] if not supported

4. `normalizeToE164(phoneNumber: string, defaultCountry: CountryCode = 'US'): string | null`
   - Parse with parsePhoneNumber(phoneNumber, defaultCountry)
   - Return parsed.number if valid, null otherwise
   - Wrap in try/catch for invalid inputs

5. `normalizeContactPhones(phoneNumbers: string[], defaultCountry: CountryCode = 'US'): string[]`
   - Map through and normalize each
   - Filter out nulls
   - Remove duplicates with Set

6. `getContactsWithPhones(): Promise<ImportedContact[]>`
   - Use Contacts.getContactsAsync with fields: PhoneNumbers, Name, Image
   - Filter to contacts with at least one phone number
   - Map to ImportedContact format
   - Handle phone.number ?? phone.digits ?? '' for phone extraction

7. `matchContacts(defaultCountry: CountryCode = 'US'): Promise<MatchedUser[]>`
   - Fetch contacts with getContactsWithPhones()
   - Build phone -> contactName map
   - Normalize all phones to E.164
   - Batch in chunks of 100 for API performance
   - Call supabase.rpc('match_phones', { p_phone_numbers: batch })
   - For each match, call getRelationshipStatus(match.user_id)
   - Return MatchedUser[] with all fields populated
   - Use getAvatarUrl for avatar conversion

Add JSDoc comments explaining iOS 18 limited access behavior and E.164 normalization purpose.
  </action>
  <verify>
- File exists at lib/contacts.ts
- Exports ContactPermissionResult, ImportedContact, MatchedUser types
- Exports checkContactPermission, requestContactPermission, expandContactAccess functions
- Exports normalizeToE164, normalizeContactPhones functions
- Exports getContactsWithPhones, matchContacts functions
- Uses parsePhoneNumber from libphonenumber-js/mobile (smaller bundle)
- Uses batch size of 100 for phone matching
- Calls getRelationshipStatus for each matched user
  </verify>
  <done>
lib/contacts.ts exists with complete contact permission handling (including iOS 18 limited access), E.164 phone normalization via libphonenumber-js, device contact fetching, and matchContacts function that returns users with relationship status
  </done>
</task>

<task type="auto">
  <name>Task 2: Create lib/discovery.ts - User search service</name>
  <files>lib/discovery.ts</files>
  <action>
Create lib/discovery.ts for user search by name/email:

**Imports:**
```typescript
import { supabase } from './supabase';
import { getRelationshipStatus } from './friends';
import { getAvatarUrl } from './storage';
```

**Types (export):**
```typescript
export interface SearchResult {
  userId: string;
  displayName: string;
  email: string;
  avatarUrl: string | null;
  relationshipStatus: 'none' | 'pending_incoming' | 'pending_outgoing' | 'friends';
}
```

**Functions:**

1. `searchUsers(query: string): Promise<SearchResult[]>`
   - Early return [] if query.length < 2 (too short to search)
   - Call supabase.rpc('search_users', { p_query: query })
   - Handle error by logging and returning []
   - For each result, call getRelationshipStatus(user.user_id)
   - Use getAvatarUrl for avatar conversion
   - Return SearchResult[] array

Add JSDoc explaining minimum query length and that results are limited to 20 by the RPC.
  </action>
  <verify>
- File exists at lib/discovery.ts
- Exports SearchResult type
- Exports searchUsers function
- Has minimum query length check (2 characters)
- Calls supabase.rpc('search_users')
- Calls getRelationshipStatus for each result
  </verify>
  <done>
lib/discovery.ts exists with searchUsers function that queries users by name/email and returns results with relationship status, minimum 2-character query enforced, avatar URLs converted for display
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit lib/contacts.ts lib/discovery.ts`
2. All exports present: Check that types and functions are exported
3. Follows existing patterns: Compare structure to lib/friends.ts
4. Uses correct imports: parsePhoneNumber from libphonenumber-js/mobile (not default)
</verification>

<success_criteria>
- lib/contacts.ts exports contact permission, normalization, and matching functions
- lib/discovery.ts exports user search function
- Both use existing getRelationshipStatus for status enrichment
- Both use getAvatarUrl for avatar URL conversion
- Phone normalization uses E.164 via libphonenumber-js/mobile bundle
- Contact matching batches in chunks of 100
</success_criteria>

<output>
After completion, create `.planning/phases/26-contact-import-discovery/26-02-SUMMARY.md`
</output>
