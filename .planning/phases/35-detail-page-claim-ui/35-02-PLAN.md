# Plan 35-02: Claim UI Integration

## Goal

Add claim/unclaim UI and split contribution functionality to the item detail screen.

## Success Criteria

- [ ] Group members (except celebrant) can claim items from detail page
- [ ] Claimer can unclaim their claimed items
- [ ] Split contribution progress displays on detail page
- [ ] Claimer can open item for split contributions
- [ ] Viewers can contribute to open splits
- [ ] Claimer can close split (cover remaining)
- [ ] Celebrant sees "Taken" badge without claimer identity
- [ ] All privacy rules enforced (celebrant can't see claimer info)

## Tasks

### Task 1: Add Claim State and Context Detection

Extend `app/(app)/wishlist/[id].tsx` with claim state:

```typescript
import {
  getClaimsForItems,
  getItemClaimStatus,
  claimItem,
  unclaimItem,
  type ClaimWithUser,
  type ItemClaimStatus,
} from '@/lib/claims';
import {
  getSplitStatus,
  getContributors,
  getSuggestedShare,
  openSplit,
  pledgeContribution,
  closeSplit,
  type SplitStatus,
  type SplitContributor,
} from '@/lib/contributions';

// Add state
const [claim, setClaim] = useState<ClaimWithUser | null>(null);
const [isTaken, setIsTaken] = useState(false);
const [isCelebrant, setIsCelebrant] = useState(false);
const [claimLoading, setClaimLoading] = useState(false);

// Split state
const [splitStatus, setSplitStatus] = useState<SplitStatus | null>(null);
const [contributors, setContributors] = useState<SplitContributor[]>([]);
const [suggestedShare, setSuggestedShare] = useState<number>(0);
const [userPledgeAmount, setUserPledgeAmount] = useState<number>(0);

// Derived state
const isYourClaim = claim?.claimed_by === currentUserId;
const isClaimed = !!claim || isTaken;
const canClaim = !isOwner && !isCelebrant && !isClaimed;
```

### Task 2: Load Claim Context

Add claim data loading based on context:

```typescript
// Add to loadItem function
const loadClaimContext = useCallback(async () => {
  if (!id || !currentUserId || isOwner) return;

  try {
    // If accessing via celebration, determine if user is celebrant
    if (celebrationId) {
      const { data: celebration } = await supabase
        .from('celebrations')
        .select('celebrant_id')
        .eq('id', celebrationId)
        .single();

      if (celebration?.celebrant_id === currentUserId) {
        setIsCelebrant(true);
        // Celebrant view: only get boolean status
        const statuses = await getItemClaimStatus([id]);
        const status = statuses.find(s => s.wishlist_item_id === id);
        setIsTaken(status?.is_claimed ?? false);
        return;
      }
    }

    // Non-celebrant view: get full claim data
    const claims = await getClaimsForItems([id]);
    const itemClaim = claims.find(c => c.wishlist_item_id === id);
    setClaim(itemClaim || null);

    // Load split data if claim exists
    if (itemClaim?.claim_type === 'split') {
      const [status, contribs, suggested] = await Promise.all([
        getSplitStatus(id),
        getContributors(id),
        getSuggestedShare(id),
      ]);
      setSplitStatus(status);
      setContributors(contribs);
      if (suggested) {
        setSuggestedShare(suggested.suggested_amount);
      }
      // Check user's pledge
      const userContrib = contribs.find(c => c.id === currentUserId);
      setUserPledgeAmount(userContrib?.amount ?? 0);
    }
  } catch (err) {
    console.error('Failed to load claim context:', err);
  }
}, [id, currentUserId, isOwner, celebrationId]);

useEffect(() => {
  if (item && currentUserId) {
    loadClaimContext();
  }
}, [item, currentUserId, loadClaimContext]);
```

### Task 3: Implement Claim Actions

Add claim/unclaim handlers:

```typescript
// Claim item
const handleClaim = useCallback(async () => {
  if (!id || !item) return;

  Alert.alert(
    t('wishlist.claim.confirmTitle'),
    t('wishlist.claim.confirmMessage', { title: item.title }),
    [
      { text: t('common.cancel'), style: 'cancel' },
      {
        text: t('wishlist.claim.claim'),
        onPress: async () => {
          setClaimLoading(true);
          try {
            const result = await claimItem(id, 'full');
            if (result.success) {
              await loadClaimContext();
            } else {
              Alert.alert(
                t('alerts.titles.unableToClaim'),
                result.error || t('common.errors.generic')
              );
            }
          } catch (err) {
            Alert.alert(t('alerts.titles.error'), t('wishlist.claim.failedToClaim'));
          } finally {
            setClaimLoading(false);
          }
        },
      },
    ]
  );
}, [id, item, t, loadClaimContext]);

// Unclaim item
const handleUnclaim = useCallback(async () => {
  if (!claim) return;

  Alert.alert(
    t('wishlist.claim.unclaimTitle'),
    t('wishlist.claim.unclaimMessage', { title: item?.title }),
    [
      { text: t('wishlist.claim.keepClaim'), style: 'cancel' },
      {
        text: t('wishlist.claim.unclaim'),
        style: 'destructive',
        onPress: async () => {
          setClaimLoading(true);
          try {
            const result = await unclaimItem(claim.id);
            if (result.success) {
              setClaim(null);
              setSplitStatus(null);
              setContributors([]);
            } else {
              Alert.alert(
                t('alerts.titles.unableToUnclaim'),
                result.error || t('common.errors.generic')
              );
            }
          } catch (err) {
            Alert.alert(t('alerts.titles.error'), t('wishlist.claim.failedToUnclaim'));
          } finally {
            setClaimLoading(false);
          }
        },
      },
    ]
  );
}, [claim, item, t]);
```

### Task 4: Implement Split Actions

Add split contribution handlers:

```typescript
// Open for split
const handleOpenSplit = useCallback(async (additionalCosts?: number) => {
  if (!id) return;

  setClaimLoading(true);
  try {
    const result = await openSplit(id, additionalCosts);
    if (result.success) {
      await loadClaimContext();
    } else {
      Alert.alert(t('alerts.titles.error'), result.error || t('wishlist.split.failedToOpenSplit'));
    }
  } catch (err) {
    Alert.alert(t('alerts.titles.error'), t('wishlist.split.failedToOpenSplit'));
  } finally {
    setClaimLoading(false);
  }
}, [id, t, loadClaimContext]);

// Pledge contribution
const handlePledge = useCallback(async (amount: number) => {
  if (!id) return;

  setClaimLoading(true);
  try {
    const result = await pledgeContribution(id, amount);
    if (result.success) {
      await loadClaimContext();
    } else {
      Alert.alert(t('alerts.titles.error'), result.error || t('wishlist.split.failedToPledge'));
    }
  } catch (err) {
    Alert.alert(t('alerts.titles.error'), t('wishlist.split.failedToPledge'));
  } finally {
    setClaimLoading(false);
  }
}, [id, t, loadClaimContext]);

// Close split (cover remaining)
const handleCloseSplit = useCallback(async () => {
  if (!id) return;

  setClaimLoading(true);
  try {
    const result = await closeSplit(id);
    if (result.success) {
      await loadClaimContext();
    } else {
      Alert.alert(t('alerts.titles.error'), result.error || t('wishlist.split.failedToCloseSplit'));
    }
  } catch (err) {
    Alert.alert(t('alerts.titles.error'), t('wishlist.split.failedToCloseSplit'));
  } finally {
    setClaimLoading(false);
  }
}, [id, t, loadClaimContext]);
```

### Task 5: Add Modal State and Components

Import existing components and add modal state:

```typescript
import { SplitContributionProgress } from '@/components/wishlist/SplitContributionProgress';
import { ContributorsDisplay } from '@/components/wishlist/ContributorsDisplay';
import { SplitModal } from '@/components/wishlist/SplitModal';
import { OpenSplitModal } from '@/components/wishlist/OpenSplitModal';
import { TakenBadge } from '@/components/wishlist/TakenBadge';
import { ClaimerAvatar } from '@/components/wishlist/ClaimerAvatar';
import { ClaimButton } from '@/components/wishlist/ClaimButton';

// Modal state
const [splitModalVisible, setSplitModalVisible] = useState(false);
const [openSplitModalVisible, setOpenSplitModalVisible] = useState(false);
```

### Task 6: Render Claim Section

Replace the placeholder claim section:

```typescript
const renderClaimSection = () => {
  // Owner view - no claim UI
  if (isOwner) return null;

  // Celebrant view - show taken status only
  if (isCelebrant) {
    if (!isTaken) return null;
    return (
      <View style={styles.claimSection}>
        <TakenBadge />
      </View>
    );
  }

  // Not claimable item types
  if (item?.item_type === 'surprise_me' || item?.item_type === 'mystery_box') {
    return (
      <View style={styles.claimSection}>
        <View style={styles.notClaimableNote}>
          <MaterialCommunityIcons name="information-outline" size={20} color={colors.cream[600]} />
          <Text style={styles.notClaimableText}>
            {t('wishlist.claim.notClaimable')}
          </Text>
        </View>
      </View>
    );
  }

  // Your claim view
  if (isYourClaim) {
    return (
      <View style={styles.claimSection}>
        <View style={styles.yourClaimHeader}>
          <MaterialCommunityIcons name="check-circle" size={24} color={colors.success} />
          <Text style={styles.yourClaimTitle}>{t('wishlist.claim.yourClaim')}</Text>
        </View>

        {/* Split progress if opened */}
        {splitStatus?.isOpen && (
          <>
            <SplitContributionProgress
              itemPrice={item?.price || 0}
              additionalCosts={splitStatus.additionalCosts}
              totalPledged={splitStatus.totalPledged}
              isFullyFunded={splitStatus.isFullyFunded}
            />
            <ContributorsDisplay contributors={contributors} />
          </>
        )}

        {/* Actions */}
        <View style={styles.claimActions}>
          {/* Open split button (if not already split) */}
          {!splitStatus?.isOpen && (
            <ClaimButton
              variant="openSplit"
              onClaim={() => {}}
              onUnclaim={() => {}}
              isClaimed={true}
              isYourClaim={true}
              loading={claimLoading}
              onOpenSplit={() => setOpenSplitModalVisible(true)}
            />
          )}

          {/* Close split button (if split open and not fully funded) */}
          {splitStatus?.isOpen && !splitStatus.isFullyFunded && (
            <ClaimButton
              variant="closeSplit"
              onClaim={() => {}}
              onUnclaim={() => {}}
              isClaimed={true}
              isYourClaim={true}
              loading={claimLoading}
              onCloseSplit={handleCloseSplit}
            />
          )}

          {/* Unclaim button (if not split) */}
          {!splitStatus?.isOpen && (
            <Pressable
              style={styles.unclaimButton}
              onPress={handleUnclaim}
              disabled={claimLoading}
            >
              <Text style={styles.unclaimButtonText}>{t('wishlist.claim.unclaim')}</Text>
            </Pressable>
          )}
        </View>
      </View>
    );
  }

  // Claimed by someone else view
  if (claim) {
    return (
      <View style={styles.claimSection}>
        {/* Claimer info */}
        <View style={styles.claimerSection}>
          <ClaimerAvatar
            avatarUrl={claim.claimer?.avatar_url}
            displayName={claim.claimer?.display_name || t('common.unknown')}
          />
          <View style={styles.claimerInfo}>
            <Text style={styles.claimedByLabel}>{t('wishlist.claim.claimedBy')}</Text>
            <Text style={styles.claimerName}>{claim.claimer?.display_name || t('common.unknown')}</Text>
          </View>
        </View>

        {/* Split progress if open */}
        {splitStatus?.isOpen && (
          <>
            <SplitContributionProgress
              itemPrice={item?.price || 0}
              additionalCosts={splitStatus.additionalCosts}
              totalPledged={splitStatus.totalPledged}
              isFullyFunded={splitStatus.isFullyFunded}
            />
            <ContributorsDisplay contributors={contributors} />

            {/* User's contribution badge */}
            {userPledgeAmount > 0 && (
              <View style={styles.userPledgeBadge}>
                <MaterialCommunityIcons name="hand-heart" size={18} color={colors.success} />
                <Text style={styles.userPledgeText}>
                  {t('wishlist.split.yourContribution')}: ${userPledgeAmount.toFixed(2)}
                </Text>
              </View>
            )}

            {/* Contribute button (if split open and not fully funded and user hasn't pledged) */}
            {!splitStatus.isFullyFunded && userPledgeAmount === 0 && (
              <ClaimButton
                variant="contribute"
                onClaim={() => {}}
                onUnclaim={() => {}}
                isClaimed={true}
                isYourClaim={false}
                loading={claimLoading}
                onContribute={() => setSplitModalVisible(true)}
              />
            )}
          </>
        )}
      </View>
    );
  }

  // Unclaimed - show claim button
  return (
    <View style={styles.claimSection}>
      <ClaimButton
        onClaim={handleClaim}
        onUnclaim={handleUnclaim}
        isClaimed={false}
        isYourClaim={false}
        loading={claimLoading}
      />
    </View>
  );
};
```

### Task 7: Add Modals

Add modals at the end of the component:

```typescript
return (
  <View style={styles.container}>
    {/* ... existing JSX ... */}

    {/* Split Modal - for pledging contribution */}
    <SplitModal
      visible={splitModalVisible}
      onClose={() => setSplitModalVisible(false)}
      onConfirm={handlePledge}
      itemTitle={item?.title || ''}
      itemPrice={item?.price || 0}
      additionalCosts={splitStatus?.additionalCosts}
      totalPledged={splitStatus?.totalPledged || 0}
      suggestedAmount={suggestedShare}
      loading={claimLoading}
    />

    {/* Open Split Modal - for opening item to split */}
    <OpenSplitModal
      visible={openSplitModalVisible}
      onClose={() => setOpenSplitModalVisible(false)}
      onConfirm={handleOpenSplit}
      itemTitle={item?.title || ''}
    />
  </View>
);
```

### Task 8: Add Claim Section Styles

Add to StyleSheet:

```typescript
claimSection: {
  padding: spacing.lg,
  borderTopWidth: 1,
  borderTopColor: colors.cream[200],
  gap: spacing.md,
},
yourClaimHeader: {
  flexDirection: 'row',
  alignItems: 'center',
  gap: spacing.sm,
},
yourClaimTitle: {
  fontSize: 18,
  fontWeight: '600',
  color: colors.success,
},
claimActions: {
  gap: spacing.sm,
  marginTop: spacing.md,
},
unclaimButton: {
  paddingVertical: spacing.sm,
  paddingHorizontal: spacing.md,
  borderRadius: borderRadius.md,
  borderWidth: 2,
  borderColor: colors.burgundy[300],
  backgroundColor: colors.cream[100],
  alignItems: 'center',
},
unclaimButtonText: {
  fontSize: 14,
  fontWeight: '600',
  color: colors.burgundy[600],
},
claimerSection: {
  flexDirection: 'row',
  alignItems: 'center',
  gap: spacing.md,
},
claimerInfo: {
  flex: 1,
},
claimedByLabel: {
  fontSize: 12,
  color: colors.cream[600],
},
claimerName: {
  fontSize: 16,
  fontWeight: '600',
  color: colors.burgundy[800],
},
userPledgeBadge: {
  flexDirection: 'row',
  alignItems: 'center',
  gap: spacing.xs,
  backgroundColor: '#dcfce7',
  paddingHorizontal: spacing.sm,
  paddingVertical: spacing.xs,
  borderRadius: borderRadius.sm,
  alignSelf: 'flex-start',
},
userPledgeText: {
  fontSize: 14,
  fontWeight: '600',
  color: '#15803d',
},
notClaimableNote: {
  flexDirection: 'row',
  alignItems: 'center',
  gap: spacing.sm,
  backgroundColor: colors.cream[100],
  padding: spacing.md,
  borderRadius: borderRadius.md,
},
notClaimableText: {
  fontSize: 14,
  color: colors.cream[600],
  flex: 1,
},
```

### Task 9: Add Translation Keys

Add to `locales/en/translation.json`:

```json
{
  "wishlist": {
    "claim": {
      "yourClaim": "Your Claim",
      "claimedBy": "Claimed by",
      "notClaimable": "This item type cannot be claimed"
    },
    "split": {
      "yourContribution": "Your contribution"
    }
  }
}
```

Add to `locales/es/translation.json`:

```json
{
  "wishlist": {
    "claim": {
      "yourClaim": "Tu reclamo",
      "claimedBy": "Reclamado por",
      "notClaimable": "Este tipo de artículo no se puede reclamar"
    },
    "split": {
      "yourContribution": "Tu contribución"
    }
  }
}
```

## Verification Checklist

After implementation:

- [ ] Unclaimed item shows "Claim" button
- [ ] Tapping claim shows confirmation dialog
- [ ] After claiming, shows "Your Claim" header
- [ ] Claimer can open split
- [ ] Open split shows progress bar
- [ ] Other users see "Contribute" button on open splits
- [ ] Contribution modal opens and works
- [ ] Claimer can close split (cover remaining)
- [ ] Claimer can unclaim (if not split)
- [ ] Celebrant only sees "Taken" badge
- [ ] Celebrant cannot see claimer name
- [ ] Celebrant cannot see split progress details
- [ ] surprise_me items show "not claimable" note
- [ ] mystery_box items show "not claimable" note
- [ ] All loading states work correctly
- [ ] All error states handled

## Dependencies

- All existing components from components/wishlist/
- lib/claims.ts
- lib/contributions.ts
- Plan 35-01 (ItemDetailScreen foundation)

## Risks

- **Modal component compatibility**: Ensure SplitModal and OpenSplitModal work correctly when imported into the detail screen
- **State synchronization**: Multiple state variables may get out of sync - loadClaimContext refreshes all at once

## Notes

- Realtime sync added in 35-03
- Options sheet moved to Phase 36
