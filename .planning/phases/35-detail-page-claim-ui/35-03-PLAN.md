# Plan 35-03: Navigation & Realtime Sync

## Goal

Wire up navigation from grid cards to detail page and add Supabase realtime subscription for claim state synchronization.

## Success Criteria

- [ ] Tapping grid card in My Wishlist navigates to detail page
- [ ] Tapping grid card in Celebration navigates to detail page with context
- [ ] Claim state syncs in real-time via Supabase
- [ ] Multiple users see claim updates without refresh
- [ ] Detail page loads in <200ms from grid tap
- [ ] All 4 view contexts work correctly (owner, celebrant, claimer, viewer)

## Tasks

### Task 1: Wire Up My Wishlist Navigation

**File**: `app/(app)/(tabs)/index.tsx`

Update the handleWishlistItemPress callback:

```typescript
import { useRouter } from 'expo-router';

// Inside component
const router = useRouter();

const handleWishlistItemPress = useCallback((item: WishlistItem) => {
  // Navigate to item detail page (owner view - no celebrationId)
  router.push(`/wishlist/${item.id}`);
}, [router]);
```

Remove the TODO comment and console.log.

### Task 2: Wire Up Celebration Page Navigation

**File**: `app/(app)/celebration/[id].tsx`

Update the handleWishlistItemPress callback:

```typescript
const handleWishlistItemPress = useCallback((item: WishlistItem) => {
  // Navigate to item detail page with celebration context
  // celebrationId enables claim UI and context detection
  router.push(`/wishlist/${item.id}?celebrationId=${id}`);
}, [router, id]);
```

Update handleLinkedItemPress for chat linked items:

```typescript
const handleLinkedItemPress = (itemId: string) => {
  // Navigate to wishlist item detail with celebration context
  router.push(`/wishlist/${itemId}?celebrationId=${id}`);
};
```

### Task 3: Add Realtime Subscription

**File**: `app/(app)/wishlist/[id].tsx`

Add realtime subscription for claim changes:

```typescript
// Add effect for realtime subscription
useEffect(() => {
  // Only subscribe if we're in a claim-relevant context
  if (!id || isOwner) return;

  const channel = supabase
    .channel(`item-claim-${id}`)
    .on(
      'postgres_changes',
      {
        event: '*', // INSERT, UPDATE, DELETE
        schema: 'public',
        table: 'gift_claims',
        filter: `wishlist_item_id=eq.${id}`,
      },
      (payload) => {
        console.log('[Realtime] Claim change detected:', payload.eventType);
        // Refresh claim data when any change occurs
        loadClaimContext();
      }
    )
    .subscribe((status) => {
      console.log('[Realtime] Subscription status:', status);
    });

  return () => {
    console.log('[Realtime] Unsubscribing from channel');
    supabase.removeChannel(channel);
  };
}, [id, isOwner, loadClaimContext]);
```

### Task 4: Add Split Contributions Realtime

Add subscription for split contribution changes:

```typescript
// Add another effect for split contributions
useEffect(() => {
  if (!id || isOwner || isCelebrant) return;
  if (!splitStatus?.isOpen) return;

  const channel = supabase
    .channel(`split-contrib-${id}`)
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'split_contributions',
        filter: `wishlist_item_id=eq.${id}`,
      },
      (payload) => {
        console.log('[Realtime] Split contribution change:', payload.eventType);
        // Refresh split data
        loadClaimContext();
      }
    )
    .subscribe();

  return () => {
    supabase.removeChannel(channel);
  };
}, [id, isOwner, isCelebrant, splitStatus?.isOpen, loadClaimContext]);
```

### Task 5: Optimize Load Performance

Ensure <200ms load time with parallel fetching:

```typescript
const loadItem = useCallback(async () => {
  if (!id) return;

  try {
    setLoading(true);
    setError(null);

    // Get current user first (required for context)
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      setError(t('common.errors.notAuthenticated'));
      return;
    }
    setCurrentUserId(user.id);

    // Parallel fetch: item + celebration (if context provided)
    const promises: Promise<any>[] = [getWishlistItem(id)];

    if (celebrationId) {
      promises.push(
        supabase
          .from('celebrations')
          .select('celebrant_id')
          .eq('id', celebrationId)
          .single()
      );
    }

    const [itemData, celebrationData] = await Promise.all(promises);

    if (!itemData) {
      setError(t('wishlist.errors.itemNotFound'));
      return;
    }

    setItem(itemData);
    const isItemOwner = itemData.user_id === user.id;
    setIsOwner(isItemOwner);

    // Set celebrant status
    if (celebrationData?.data) {
      setIsCelebrant(celebrationData.data.celebrant_id === user.id);
    }

  } catch (err) {
    console.error('Failed to load item:', err);
    setError(err instanceof Error ? err.message : t('common.errors.generic'));
  } finally {
    setLoading(false);
  }
}, [id, celebrationId, t]);
```

### Task 6: Add Navigation Performance Logging

Add performance timing for load monitoring:

```typescript
// At start of loadItem
const startTime = performance.now();

// At end of loadItem (in finally block)
const loadTime = performance.now() - startTime;
console.log(`[Performance] Item detail loaded in ${loadTime.toFixed(0)}ms`);

if (loadTime > 200) {
  console.warn(`[Performance] Load time exceeded 200ms target: ${loadTime.toFixed(0)}ms`);
}
```

### Task 7: Update WishlistGridCard Action Handler

**File**: `app/(app)/(tabs)/index.tsx`

Update handleWishlistItemAction for owner view:

```typescript
const handleWishlistItemAction = useCallback((item: WishlistItem) => {
  // Owner view: action button opens detail page (options sheet in Phase 36)
  router.push(`/wishlist/${item.id}`);
}, [router]);
```

**File**: `app/(app)/celebration/[id].tsx`

Update for celebration view:

```typescript
const handleWishlistItemAction = useCallback((item: WishlistItem) => {
  // Navigate to detail page with celebration context
  // Detail page shows claim UI
  router.push(`/wishlist/${item.id}?celebrationId=${id}`);
}, [router, id]);
```

### Task 8: Test All View Contexts

Create manual test checklist:

**Owner View (My Wishlist → Detail)**:
1. Navigate to My Wishlist tab
2. Tap any grid card
3. Verify: No claim UI shown
4. Verify: Item info displays correctly
5. Verify: Back button works

**Celebrant View (Celebration → Own Items)**:
1. View your own celebration page
2. Tap grid card of your item
3. Verify: "Taken" badge shows (if claimed)
4. Verify: No claimer identity visible
5. Verify: No split progress details

**Claimer View (Celebration → Claimed Item)**:
1. View someone else's celebration
2. Claim an item via detail page
3. Verify: "Your Claim" header shows
4. Verify: Can open split
5. Verify: Can unclaim (if not split)

**Viewer View (Celebration → Unclaimed Item)**:
1. View someone else's celebration
2. Tap unclaimed item
3. Verify: "Claim" button shows
4. Verify: After someone claims, button changes
5. Verify: For splits, "Contribute" button shows

### Task 9: Add Error Boundary for Navigation

Handle edge cases:

```typescript
// In ItemDetailScreen
if (!id) {
  return (
    <View style={styles.centered}>
      <Stack.Screen options={{ title: t('common.error') }} />
      <MaterialCommunityIcons name="alert-circle-outline" size={48} color={colors.error} />
      <Text style={styles.errorText}>{t('wishlist.errors.invalidItemId')}</Text>
      <Pressable onPress={() => router.back()} style={styles.backButton}>
        <Text style={styles.backButtonText}>{t('common.back')}</Text>
      </Pressable>
    </View>
  );
}
```

Add translation:
```json
{
  "wishlist": {
    "errors": {
      "invalidItemId": "Invalid item ID"
    }
  }
}
```

## Verification Checklist

After implementation:

- [ ] My Wishlist → tap card → navigates to detail
- [ ] Celebration → tap card → navigates to detail with context
- [ ] Owner view shows no claim UI
- [ ] Celebrant view shows only "Taken" badge
- [ ] Claimer view shows "Your Claim" + controls
- [ ] Viewer view shows "Claim" button
- [ ] Claiming updates UI in real-time for other users
- [ ] Split contributions update in real-time
- [ ] Load time logged in console
- [ ] Load time typically <200ms
- [ ] Back button works from all entry points
- [ ] Chat linked items navigate correctly
- [ ] Invalid item ID shows error state

## Dependencies

- Plan 35-01 (ItemDetailScreen foundation)
- Plan 35-02 (Claim UI integration)
- Supabase realtime enabled on gift_claims table
- Supabase realtime enabled on split_contributions table

## Risks

- **Realtime subscription limits**: Supabase has connection limits - ensure cleanup
- **Race conditions**: Multiple rapid claims could cause UI flicker - loadClaimContext handles this by refreshing all data

## Notes

- Performance logging helps identify slow queries
- Realtime subscriptions are scoped to single item for efficiency
- Channel names must be unique - include item ID
