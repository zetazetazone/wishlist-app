---
phase: 24-friend-core-services-tab
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/friends.ts
  - components/friends/FriendCard.tsx
  - app/(app)/(tabs)/friends.tsx
  - app/(app)/(tabs)/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "User can view their friends list in the Friends tab"
    - "Friends tab appears in main navigation between Groups and Celebrations"
    - "Friend list displays profile photo, name, and friends-since date"
    - "User can tap a friend to view their profile"
    - "User can remove an existing friend via three-dot menu with confirmation"
  artifacts:
    - path: "lib/friends.ts"
      provides: "Friend CRUD operations"
      exports: ["getFriends", "removeFriend", "FriendWithProfile"]
    - path: "components/friends/FriendCard.tsx"
      provides: "Friend list item component"
      exports: ["FriendCard"]
    - path: "app/(app)/(tabs)/friends.tsx"
      provides: "Friends tab screen"
      contains: "FriendsScreen"
    - path: "app/(app)/(tabs)/_layout.tsx"
      provides: "Tab navigation with Friends tab"
      contains: "name=\"friends\""
  key_links:
    - from: "app/(app)/(tabs)/friends.tsx"
      to: "lib/friends.ts"
      via: "import getFriends, removeFriend"
      pattern: "import.*from.*lib/friends"
    - from: "app/(app)/(tabs)/friends.tsx"
      to: "components/friends/FriendCard.tsx"
      via: "FriendCard component rendering"
      pattern: "<FriendCard"
    - from: "components/friends/FriendCard.tsx"
      to: "/member/[id]"
      via: "router.push on press"
      pattern: "router\\.push.*member"
    - from: "lib/friends.ts"
      to: "supabase.friends"
      via: "database query"
      pattern: "\\.from\\(['\"]friends['\"]\\)"
---

<objective>
Friend Core Services & Tab - Complete vertical slice

Implement friend list viewing, friend removal, and the Friends tab navigation. This plan delivers a complete vertical slice: service layer, UI component, tab screen, and navigation integration.

Purpose: Enable users to see their friends in a dedicated tab and manage friendships
Output: Working Friends tab with friend list display and remove functionality
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-database-foundation/23-01-SUMMARY.md

# Pattern references (read these for code style)
@lib/memberNotes.ts
@app/(app)/(tabs)/groups.tsx
@components/groups/MemberCard.tsx
@app/(app)/(tabs)/_layout.tsx
@lib/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create friends service library</name>
  <files>lib/friends.ts</files>
  <action>
Create `lib/friends.ts` following the pattern from `lib/memberNotes.ts`:

1. **Interface definition:**
```typescript
export interface FriendWithProfile {
  id: string;                    // friendship row ID (for deletion)
  friend_user_id: string;        // the friend's user ID
  created_at: string;            // when friendship was created
  friend?: {
    id: string;
    display_name: string | null;
    avatar_url: string | null;   // Already converted via getAvatarUrl
    birthday: string | null;
  };
}
```

2. **getFriends() function:**
- Get current user via `supabase.auth.getUser()`
- Query friends table with bidirectional OR: `.or(\`user_a_id.eq.${user.id},user_b_id.eq.${user.id}\`)`
- Extract friend IDs using ternary: `f.user_a_id === user.id ? f.user_b_id : f.user_a_id`
- Batch-fetch friend profiles from user_profiles
- Convert avatar_url via `getAvatarUrl()` from lib/storage.ts
- Return array of FriendWithProfile

3. **removeFriend(friendshipId: string) function:**
- Delete from friends table by id
- RLS policy "Users can unfriend" handles authorization
- Throw error if delete fails

Include TSDoc comments explaining:
- Bidirectional query pattern (user can be user_a or user_b)
- Friend ID extraction logic
- RLS policy handling

DO NOT query `are_friends()` RPC - that's for checking friendship existence, not listing. Use direct table query.
  </action>
  <verify>
```bash
# File exists with expected exports
grep -q "export async function getFriends" lib/friends.ts && echo "PASS: getFriends exported"
grep -q "export async function removeFriend" lib/friends.ts && echo "PASS: removeFriend exported"
grep -q "export interface FriendWithProfile" lib/friends.ts && echo "PASS: FriendWithProfile exported"

# Verify bidirectional query pattern
grep -q "user_a_id.*user_b_id" lib/friends.ts && echo "PASS: bidirectional query pattern"

# Verify getAvatarUrl usage
grep -q "getAvatarUrl" lib/friends.ts && echo "PASS: avatar URL conversion"

# TypeScript compiles
npx tsc --noEmit lib/friends.ts 2>&1 | head -20
```
  </verify>
  <done>
- lib/friends.ts exists with getFriends() and removeFriend() functions
- FriendWithProfile interface exported
- Bidirectional query handles both user_a_id and user_b_id positions
- Avatar URLs converted for display
- TSDoc comments explain RLS and query patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FriendCard component and Friends tab screen</name>
  <files>
    components/friends/FriendCard.tsx
    app/(app)/(tabs)/friends.tsx
  </files>
  <action>
**Part A: Create `components/friends/FriendCard.tsx`**

Follow the pattern from `components/groups/MemberCard.tsx`:

Props interface:
```typescript
interface FriendCardProps {
  friend: FriendWithProfile;
  onPress: () => void;
  onRemove: () => void;
  index?: number;  // For staggered animation
}
```

Layout:
- MotiView wrapper with staggered slide-in animation (from={opacity:0, translateX:-20})
- TouchableOpacity card with gold border (matches group style)
- Row: Avatar (56x56) | Name column | Three-dot menu button
- Avatar: Image if avatar_url, else initials fallback
- Name: display_name in burgundy[800], 16px, bold
- Secondary text: "Friends since [formatted date]" in cream[500], 13px
- Three-dot menu (MaterialCommunityIcons "dots-vertical"): Opens action sheet or triggers onRemove

Use formatDistanceToNow from date-fns for "Friends since" text, OR format as "Friends since Jan 2026" using toLocaleDateString.

**Part B: Create `app/(app)/(tabs)/friends.tsx`**

Follow the pattern from `app/(app)/(tabs)/groups.tsx`:

1. **State:**
- friends: FriendWithProfile[]
- loading: boolean
- refreshing: boolean

2. **Functions:**
- loadFriends(): Call getFriends(), update state
- handleRefresh(): Set refreshing, call loadFriends
- handleFriendPress(friendUserId): router.push(`/member/${friendUserId}`)
- handleRemoveFriend(friendshipId, friendName): Show Alert.alert confirmation, call removeFriend, reload list

3. **Render:**
- StatusBar barStyle="light-content"
- LinearGradient header (burgundy gradient, matching groups.tsx exactly)
- Header title: "Friends" (36px, white, bold)
- Subtitle: count "{N} friends" (16px, gold[200])
- ScrollView with RefreshControl
- Empty state if friends.length === 0 (icon, "No Friends Yet", "Add friends to see them here")
- Map friends to FriendCard components with index for stagger

DO NOT add action buttons (Add Friend, Find Friends) - those are Phase 25-26 features.
  </action>
  <verify>
```bash
# Files exist
[ -f "components/friends/FriendCard.tsx" ] && echo "PASS: FriendCard exists"
[ -f "app/(app)/(tabs)/friends.tsx" ] && echo "PASS: friends.tsx exists"

# FriendCard exports
grep -q "export.*FriendCard" components/friends/FriendCard.tsx && echo "PASS: FriendCard exported"

# friends.tsx imports
grep -q "import.*getFriends.*from" app/\(app\)/\(tabs\)/friends.tsx && echo "PASS: getFriends imported"
grep -q "import.*FriendCard" app/\(app\)/\(tabs\)/friends.tsx && echo "PASS: FriendCard imported"

# Navigation to member profile
grep -q "router.*member" app/\(app\)/\(tabs\)/friends.tsx && echo "PASS: member navigation"

# Remove friend with confirmation
grep -q "Alert.alert" app/\(app\)/\(tabs\)/friends.tsx && echo "PASS: remove confirmation"

# TypeScript compiles
npx tsc --noEmit app/\(app\)/\(tabs\)/friends.tsx components/friends/FriendCard.tsx 2>&1 | head -20
```
  </verify>
  <done>
- FriendCard.tsx renders friend avatar, name, and "Friends since" date
- FriendCard has three-dot menu triggering onRemove callback
- friends.tsx displays gradient header with friend count
- friends.tsx renders friend list with staggered animations
- friends.tsx has pull-to-refresh functionality
- friends.tsx shows empty state when no friends
- Tapping friend navigates to /member/[friendUserId]
- Remove friend shows confirmation dialog and reloads list on success
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Friends tab to navigation</name>
  <files>app/(app)/(tabs)/_layout.tsx</files>
  <action>
Modify `app/(app)/(tabs)/_layout.tsx` to add the Friends tab:

1. **Position:** Insert Friends tab AFTER groups tab, BEFORE celebrations tab (index 2)
   - Current order: Wishlist(0), Groups(1), Celebrations(2), Calendar(3)
   - New order: Wishlist(0), Groups(1), Friends(2), Celebrations(3), Calendar(4)

2. **Tab configuration:**
```typescript
<Tabs.Screen
  name="friends"
  options={{
    title: 'Friends',
    headerShown: false, // Friends has its own gradient header
    tabBarIcon: ({ color, size }) => (
      <MaterialCommunityIcons name="account-heart" size={size} color={color} />
    ),
  }}
/>
```

3. **Verify expo-router file-based routing:**
   - Tab order in _layout.tsx determines display order
   - The friends.tsx file in (tabs)/ directory is auto-discovered

DO NOT change any other tab configurations.
DO NOT add tabBarBadge or other enhancements (Phase 25 handles request badges).
  </action>
  <verify>
```bash
# Friends tab configured
grep -q 'name="friends"' app/\(app\)/\(tabs\)/_layout.tsx && echo "PASS: friends tab configured"

# Icon is account-heart
grep -q 'account-heart' app/\(app\)/\(tabs\)/_layout.tsx && echo "PASS: account-heart icon"

# headerShown false
grep -A5 'name="friends"' app/\(app\)/\(tabs\)/_layout.tsx | grep -q 'headerShown.*false' && echo "PASS: headerShown false"

# Tab order check (friends after groups)
grep -n 'name=' app/\(app\)/\(tabs\)/_layout.tsx | head -10

# TypeScript compiles
npx tsc --noEmit app/\(app\)/\(tabs\)/_layout.tsx 2>&1 | head -10
```
  </verify>
  <done>
- Friends tab appears in navigation between Groups and Celebrations
- Tab icon is "account-heart" MaterialCommunityIcons
- headerShown: false (custom gradient header in friends.tsx)
- Tab is discoverable and navigable
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
# 1. All files exist
echo "=== File Check ==="
for f in lib/friends.ts components/friends/FriendCard.tsx "app/(app)/(tabs)/friends.tsx"; do
  [ -f "$f" ] && echo "FOUND: $f" || echo "MISSING: $f"
done

# 2. TypeScript compiles without errors
echo "=== TypeScript Check ==="
npx tsc --noEmit 2>&1 | grep -E "(error|Error)" | head -10 || echo "No TS errors"

# 3. Key patterns present
echo "=== Pattern Check ==="
grep -l "user_a_id.*user_b_id" lib/friends.ts && echo "PASS: bidirectional query"
grep -l "LinearGradient" app/\(app\)/\(tabs\)/friends.tsx && echo "PASS: gradient header"
grep -l "account-heart" app/\(app\)/\(tabs\)/_layout.tsx && echo "PASS: tab icon"

# 4. App builds
echo "=== Build Check ==="
npx expo export --platform ios --output-dir /tmp/expo-test 2>&1 | tail -5
```

Manual verification (after starting dev server):
1. Navigate to Friends tab - should appear between Groups and Celebrations
2. Friends list loads (may be empty if no friends in test data)
3. Empty state displays correctly if no friends
4. Pull-to-refresh works
5. (If test data exists) Tap friend card navigates to member profile
6. (If test data exists) Three-dot menu shows remove option with confirmation
</verification>

<success_criteria>
- [ ] lib/friends.ts exports getFriends, removeFriend, FriendWithProfile
- [ ] getFriends uses bidirectional OR query for friends table
- [ ] FriendCard displays avatar, name, and "Friends since" date
- [ ] FriendCard has three-dot menu with remove action
- [ ] Friends tab screen matches Groups screen style (gradient header, animations)
- [ ] Friends tab appears in navigation at correct position
- [ ] Tapping friend navigates to /member/[id]
- [ ] Remove friend shows confirmation and reloads list
- [ ] TypeScript compiles without errors
- [ ] App builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/24-friend-core-services-tab/24-01-SUMMARY.md`
</output>
