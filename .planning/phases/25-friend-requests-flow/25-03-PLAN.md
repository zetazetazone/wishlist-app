---
phase: 25-friend-requests-flow
plan: 03
type: execute
wave: 2
depends_on: ["25-01", "25-02"]
files_modified:
  - app/(app)/(tabs)/friends.tsx
  - app/(app)/member/[id].tsx
autonomous: true

must_haves:
  truths:
    - "Friends tab has link to pending requests with badge count"
    - "User can send a friend request from a member's profile"
    - "Profile shows appropriate button based on relationship (Add Friend / Pending / Accept+Decline / Friends)"
  artifacts:
    - path: "app/(app)/(tabs)/friends.tsx"
      provides: "Header link to requests screen with pending count badge"
      contains: "router.push"
    - path: "app/(app)/member/[id].tsx"
      provides: "Friend request button with relationship status awareness"
      contains: "getRelationshipStatus"
  key_links:
    - from: "app/(app)/(tabs)/friends.tsx"
      to: "app/(app)/requests.tsx"
      via: "router.push('/requests')"
      pattern: "router.push.*requests"
    - from: "app/(app)/member/[id].tsx"
      to: "lib/friends.ts"
      via: "service function calls"
      pattern: "sendFriendRequest|getRelationshipStatus|acceptFriendRequest"
---

<objective>
Integration: Friends tab header link and member profile Add Friend button

Purpose: Connect the requests screen to the Friends tab with a header link showing pending count, and add the "Add Friend" button to member profiles with relationship-aware state (none/pending/friends).

Output: Friends tab header updated, member profile updated with friend request actions
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-friend-requests-flow/25-RESEARCH.md
@.planning/phases/25-friend-requests-flow/25-01-PLAN.md
@.planning/phases/25-friend-requests-flow/25-02-PLAN.md
@app/(app)/(tabs)/friends.tsx
@app/(app)/member/[id].tsx
@lib/friends.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pending requests link to Friends tab header</name>
  <files>app/(app)/(tabs)/friends.tsx</files>
  <action>
Modify friends.tsx to add a header button linking to requests screen:

**New state:**
```typescript
const [pendingCount, setPendingCount] = useState(0);
```

**Fetch pending count:**
- In the existing useFocusEffect (or create one), call getPendingRequests()
- Set pendingCount to incoming.length (incoming requests are what user needs to act on)

**Header modification:**
Add to the gradient header area (top right), a pressable element:
```typescript
<TouchableOpacity
  style={styles.requestsLink}
  onPress={() => router.push('/requests')}
>
  <MaterialCommunityIcons name="account-clock" size={24} color={colors.white} />
  {pendingCount > 0 && (
    <View style={styles.badge}>
      <Text style={styles.badgeText}>{pendingCount}</Text>
    </View>
  )}
</TouchableOpacity>
```

**Badge styling:**
- Small red circle (colors.red[500] or burgundy)
- Position: absolute, top-right of the icon
- White text, fontSize 10-12, fontWeight bold
- minWidth: 16-18, borderRadius: 9 (circular)

**Import additions:**
- import { getPendingRequests } from '../../../lib/friends';
- import { useRouter } from 'expo-router';

Ensure router.push uses '/requests' path (matching app/(app)/requests.tsx location).
  </action>
  <verify>
Verify header link:
- grep "router.push.*requests" app/\(app\)/\(tabs\)/friends.tsx
- grep "pendingCount" app/\(app\)/\(tabs\)/friends.tsx
- grep "getPendingRequests" app/\(app\)/\(tabs\)/friends.tsx
- grep "account-clock" app/\(app\)/\(tabs\)/friends.tsx
  </verify>
  <done>
Friends tab header shows a button with account-clock icon that navigates to /requests. When there are incoming pending requests, a red badge shows the count. Badge updates when tab focuses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add relationship-aware friend button to member profile</name>
  <files>app/(app)/member/[id].tsx</files>
  <action>
Modify member/[id].tsx to add friend request functionality:

**New state:**
```typescript
const [relationshipStatus, setRelationshipStatus] = useState<
  'none' | 'friends' | 'pending_incoming' | 'pending_outgoing' | 'blocked' | 'loading'
>('loading');
const [actionLoading, setActionLoading] = useState(false);
```

**Load relationship status:**
- In the existing useEffect that loads member data, also call:
  ```typescript
  const status = await getRelationshipStatus(id);
  setRelationshipStatus(status);
  ```
- Catch errors and default to 'none'

**Add button section in JSX:**
Place this in an appropriate location (after the profile header, before personal details):

```typescript
{/* Friend Action Button */}
{relationshipStatus === 'none' && (
  <TouchableOpacity
    style={[styles.friendButton, styles.addFriendButton]}
    onPress={handleSendRequest}
    disabled={actionLoading}
  >
    <MaterialCommunityIcons name="account-plus" size={20} color={colors.white} />
    <Text style={styles.friendButtonText}>Add Friend</Text>
  </TouchableOpacity>
)}
{relationshipStatus === 'pending_outgoing' && (
  <View style={[styles.friendButton, styles.pendingButton]}>
    <MaterialCommunityIcons name="clock-outline" size={20} color={colors.gray[600]} />
    <Text style={styles.pendingText}>Request Pending</Text>
  </View>
)}
{relationshipStatus === 'pending_incoming' && (
  <View style={styles.incomingActions}>
    <TouchableOpacity
      style={[styles.friendButton, styles.acceptButton]}
      onPress={handleAccept}
      disabled={actionLoading}
    >
      <Text style={styles.acceptText}>Accept Request</Text>
    </TouchableOpacity>
    <TouchableOpacity
      style={[styles.friendButton, styles.declineButton]}
      onPress={handleDecline}
      disabled={actionLoading}
    >
      <Text style={styles.declineText}>Decline</Text>
    </TouchableOpacity>
  </View>
)}
{relationshipStatus === 'friends' && (
  <View style={[styles.friendButton, styles.friendsIndicator]}>
    <MaterialCommunityIcons name="account-check" size={20} color={colors.green[600]} />
    <Text style={styles.friendsText}>Friends</Text>
  </View>
)}
{relationshipStatus === 'blocked' && null /* Show nothing for blocked users */}
```

**Handler functions:**
```typescript
const handleSendRequest = async () => {
  try {
    setActionLoading(true);
    await sendFriendRequest(id);
    setRelationshipStatus('pending_outgoing');
    Alert.alert('Success', 'Friend request sent!');
  } catch (error: any) {
    Alert.alert('Error', error.message || 'Failed to send request');
  } finally {
    setActionLoading(false);
  }
};

const handleAccept = async () => {
  try {
    setActionLoading(true);
    // Need to find the request ID first
    const { incoming } = await getPendingRequests();
    const request = incoming.find(r => r.from_user_id === id);
    if (!request) throw new Error('Request not found');
    await acceptFriendRequest(request.id);
    setRelationshipStatus('friends');
    Alert.alert('Success', 'You are now friends!');
  } catch (error: any) {
    Alert.alert('Error', error.message || 'Failed to accept request');
  } finally {
    setActionLoading(false);
  }
};

const handleDecline = async () => {
  Alert.alert(
    'Decline Request',
    'Are you sure you want to decline this friend request?',
    [
      { text: 'Cancel', style: 'cancel' },
      {
        text: 'Decline',
        style: 'destructive',
        onPress: async () => {
          try {
            setActionLoading(true);
            const { incoming } = await getPendingRequests();
            const request = incoming.find(r => r.from_user_id === id);
            if (!request) throw new Error('Request not found');
            await declineFriendRequest(request.id);
            setRelationshipStatus('none');
          } catch (error: any) {
            Alert.alert('Error', error.message);
          } finally {
            setActionLoading(false);
          }
        },
      },
    ]
  );
};
```

**Imports to add:**
```typescript
import {
  getRelationshipStatus,
  sendFriendRequest,
  acceptFriendRequest,
  declineFriendRequest,
  getPendingRequests,
} from '../../../lib/friends';
```

**Styling:**
- Add Friend button: burgundy background, white text, pill shape
- Pending indicator: gray outline, gray text
- Accept button: green background, white text
- Decline button: gray/red outline
- Friends indicator: light green background, green text with check icon
  </action>
  <verify>
Verify member profile integration:
- grep "getRelationshipStatus" app/\(app\)/member/\[id\].tsx
- grep "sendFriendRequest" app/\(app\)/member/\[id\].tsx
- grep "relationshipStatus" app/\(app\)/member/\[id\].tsx
- grep "Add Friend" app/\(app\)/member/\[id\].tsx
  </verify>
  <done>
Member profile shows relationship-aware button: "Add Friend" for strangers, "Request Pending" when outgoing request exists, Accept/Decline buttons when incoming request exists, "Friends" indicator when already friends. Actions update status immediately with optimistic UI.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Friends tab verified:**
   - Header shows requests icon with badge count
   - Tapping navigates to /requests screen
   - Badge count reflects incoming pending requests
   - Count updates when tab focuses

2. **Member profile verified:**
   - Shows appropriate button based on relationship status
   - Add Friend sends request and updates UI
   - Accept/Decline work for incoming requests
   - Status refreshes when profile loads

3. **End-to-end flow ready:**
   - User A can visit User B's profile and tap "Add Friend"
   - User B sees request in Requests screen (from plan 02)
   - User B can accept, which creates friendship
   - User A receives notification (from plan 01)
   - Both users now see "Friends" indicator on each other's profiles
</verification>

<success_criteria>
- Friends tab header has requests link with pending badge
- Member profile shows relationship-aware action button
- Send/accept/decline flows work from member profile
- UI updates optimistically after actions
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/25-friend-requests-flow/25-03-SUMMARY.md`
</output>
