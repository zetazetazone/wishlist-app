---
phase: 25-friend-requests-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260211000001_friend_request_notifications.sql
  - lib/friends.ts
autonomous: true

must_haves:
  truths:
    - "User receives push notification when receiving a friend request"
    - "User receives push notification when their friend request is accepted"
    - "Service functions exist for all friend request lifecycle operations"
  artifacts:
    - path: "supabase/migrations/20260211000001_friend_request_notifications.sql"
      provides: "Push notification triggers for friend request events"
      contains: "notify_friend_request_sent"
    - path: "lib/friends.ts"
      provides: "Friend request service functions"
      exports: ["getPendingRequests", "sendFriendRequest", "acceptFriendRequest", "declineFriendRequest", "cancelFriendRequest", "getRelationshipStatus", "blockUser"]
  key_links:
    - from: "notify_friend_request_sent trigger"
      to: "user_notifications table"
      via: "INSERT on friend_requests"
      pattern: "INSERT INTO public.user_notifications"
    - from: "notify_friend_request_accepted trigger"
      to: "user_notifications table"
      via: "UPDATE on friend_requests status"
      pattern: "INSERT INTO public.user_notifications"
---

<objective>
Database notification triggers and friend request service layer

Purpose: Establish the backend infrastructure for friend request lifecycle - notification triggers that fire push notifications on request sent/accepted events, and TypeScript service functions for all request operations.

Output: Migration with 2 triggers, extended lib/friends.ts with 7 new functions
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-friend-requests-flow/25-RESEARCH.md
@.planning/phases/23-database-foundation/23-01-SUMMARY.md
@.planning/phases/24-friend-core-services-tab/24-01-SUMMARY.md
@lib/friends.ts
@supabase/migrations/20260202000008_gift_leader_notifications.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification triggers migration</name>
  <files>supabase/migrations/20260211000001_friend_request_notifications.sql</files>
  <action>
Create migration file with two SECURITY DEFINER trigger functions:

**PART 1: notify_friend_request_sent()**
- Trigger: AFTER INSERT on friend_requests when status='pending'
- Queries users table JOIN user_profiles for sender name and avatar
- Inserts into user_notifications with:
  - user_id: NEW.to_user_id (receiver)
  - title: "{sender_name} sent you a friend request"
  - body: "Tap to view and respond"
  - data: jsonb with type='friend_request_received', screen='requests', request_id, from_user_id, avatar_url
- Pattern follows notify_gift_leader_assigned() from migration 20260202000008

**PART 2: notify_friend_request_accepted()**
- Trigger: AFTER UPDATE on friend_requests when OLD.status='pending' AND NEW.status='accepted'
- Queries users table JOIN user_profiles for accepter name and avatar
- Inserts into user_notifications with:
  - user_id: NEW.from_user_id (original sender)
  - title: "{accepter_name} accepted your friend request!"
  - body: "You are now friends. Tap to view their profile."
  - data: jsonb with type='friend_request_accepted', screen='member', friend_user_id, avatar_url

Both functions must use:
- SET search_path = '' for security
- COALESCE chain for name: u.full_name, up.display_name, u.email
- DROP TRIGGER IF EXISTS before CREATE TRIGGER
  </action>
  <verify>
Verify migration file structure:
- grep "notify_friend_request_sent" confirms function exists
- grep "notify_friend_request_accepted" confirms function exists
- grep "on_friend_request_sent" confirms INSERT trigger exists
- grep "on_friend_request_accepted" confirms UPDATE trigger exists
- grep "user_notifications" confirms notifications are inserted
  </verify>
  <done>
Migration file creates both notification triggers following the proven notify_gift_leader_assigned pattern. Triggers fire on INSERT (pending) and UPDATE (pending->accepted) to friend_requests table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend friends service with request functions</name>
  <files>lib/friends.ts</files>
  <action>
Add these functions to lib/friends.ts (extend existing file, do not replace):

**1. FriendRequestWithProfile interface:**
```typescript
export interface FriendRequestWithProfile {
  id: string;
  from_user_id: string;
  to_user_id: string;
  status: 'pending' | 'accepted' | 'rejected' | 'blocked';
  created_at: string;
  profile?: {
    id: string;
    display_name: string | null;
    avatar_url: string | null;
  };
}
```

**2. getPendingRequests():**
- Query friend_requests where status='pending'
- Use .or() for bidirectional (from_user_id or to_user_id equals current user)
- Separate into incoming (to_user_id = me) and outgoing (from_user_id = me)
- Batch-fetch profiles for senders (incoming) and receivers (outgoing)
- Return { incoming: FriendRequestWithProfile[], outgoing: FriendRequestWithProfile[] }

**3. sendFriendRequest(toUserId: string):**
- Check rate limit: count requests from me in last hour, fail if >= 20
- INSERT into friend_requests with from_user_id=me, to_user_id=target, status='pending'
- Handle unique_violation (23505): throw "Friend request already pending"
- Handle blocked error: throw "Cannot send request to this user"

**4. acceptFriendRequest(requestId: string):**
- Call RPC 'accept_friend_request' with p_request_id parameter
- Return the friend_id from response on success
- Throw error with message on failure

**5. declineFriendRequest(requestId: string):**
- UPDATE friend_requests set status='rejected' where id=requestId
- RLS policy allows receiver to update status

**6. cancelFriendRequest(requestId: string):**
- DELETE from friend_requests where id=requestId
- RLS policy allows sender to delete pending requests only

**7. getRelationshipStatus(otherUserId: string):**
- Returns 'friends' | 'pending_incoming' | 'pending_outgoing' | 'blocked' | 'none'
- Call RPC 'are_friends' to check friendship
- Query friend_requests for pending/blocked between users
- Used by member profile to show appropriate button

**8. blockUser(userId: string):**
- Insert or update friend_requests with status='blocked'
- If pending request exists (either direction), update to blocked
- If no request exists, create blocked request from current user
  </action>
  <verify>
Verify exports exist:
- grep "export async function getPendingRequests" lib/friends.ts
- grep "export async function sendFriendRequest" lib/friends.ts
- grep "export async function acceptFriendRequest" lib/friends.ts
- grep "export async function declineFriendRequest" lib/friends.ts
- grep "export async function cancelFriendRequest" lib/friends.ts
- grep "export async function getRelationshipStatus" lib/friends.ts
- grep "export async function blockUser" lib/friends.ts
- grep "FriendRequestWithProfile" lib/friends.ts

Run TypeScript check: npx tsc --noEmit lib/friends.ts (or full project check)
  </verify>
  <done>
lib/friends.ts exports 7 new functions for friend request lifecycle: getPendingRequests, sendFriendRequest, acceptFriendRequest, declineFriendRequest, cancelFriendRequest, getRelationshipStatus, blockUser. All follow existing patterns (bidirectional queries, profile batch-fetch, avatar URL conversion).
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Migration structure verified:**
   - File exists at supabase/migrations/20260211000001_friend_request_notifications.sql
   - Contains notify_friend_request_sent function and trigger
   - Contains notify_friend_request_accepted function and trigger
   - Both insert into user_notifications with correct data structure

2. **Service layer verified:**
   - lib/friends.ts exports all 7 new functions
   - TypeScript compiles without errors
   - Functions follow existing patterns (error handling, avatar conversion)

3. **Integration points ready:**
   - Triggers will fire when UI calls sendFriendRequest (INSERT)
   - Triggers will fire when UI calls acceptFriendRequest (RPC updates status)
   - Push notification infrastructure from v1.0 handles user_notifications -> Edge Function -> Expo Push
</verification>

<success_criteria>
- Migration file created with 2 trigger functions and 2 triggers
- lib/friends.ts extended with 7 new service functions
- TypeScript compiles cleanly
- Notification triggers follow proven notify_gift_leader_assigned pattern
- Service functions follow existing lib/friends.ts patterns
</success_criteria>

<output>
After completion, create `.planning/phases/25-friend-requests-flow/25-01-SUMMARY.md`
</output>
