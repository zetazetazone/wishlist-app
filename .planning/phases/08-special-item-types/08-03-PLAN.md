---
phase: 08-special-item-types
plan: 03
type: execute
wave: 3
depends_on: [08-01, 08-02]
files_modified:
  - supabase/migrations/20260203000001_fix_special_items.sql
  - components/wishlist/AddItemModal.tsx
  - types/database.types.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Surprise Me form does not show budget field"
    - "Mystery Box only shows €50 and €100 tier options"
    - "Adding Surprise Me item completes successfully without hanging"
  artifacts:
    - path: "supabase/migrations/20260203000001_fix_special_items.sql"
      provides: "amazon_url nullable, smart constraint, tier constraint fix"
      min_lines: 25
    - path: "components/wishlist/AddItemModal.tsx"
      provides: "Budget field removed, tier array updated, null handling"
      exports: ["AddItemModal"]
    - path: "types/database.types.ts"
      provides: "amazon_url nullable type, tier type without 25"
  key_links:
    - from: "components/wishlist/AddItemModal.tsx"
      to: "database constraint"
      via: "null amazon_url for special items"
      pattern: "amazon_url: null"
    - from: "AddItemModal"
      to: "MysteryBoxTier type"
      via: "tier selector array"
      pattern: "\\[50, 100\\]"
---

<objective>
Fix 3 critical gaps from Phase 08 UAT:
1. Remove budget field from Surprise Me form (group-specific, not per-item)
2. Remove €25 tier from Mystery Box (only €50 and €100 remain)
3. Fix amazon_url NOT NULL constraint blocking Surprise Me inserts

Purpose: Enable special item types to work correctly without form confusion or database errors
Output: Working Surprise Me and Mystery Box item creation with correct form fields and database constraints
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-special-item-types/08-01-SUMMARY.md
@.planning/phases/08-special-item-types/08-02-SUMMARY.md
@.planning/phases/08-special-item-types/08-UAT.md
@components/wishlist/AddItemModal.tsx
@supabase/migrations/20260201000001_initial_schema.sql
@supabase/migrations/20260202000011_schema_foundation.sql
@types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration to fix amazon_url and tier constraints</name>
  <files>supabase/migrations/20260203000001_fix_special_items.sql</files>
  <action>
Create new migration file with timestamp-based naming convention.

Fix amazon_url NOT NULL constraint (blocker):
- ALTER TABLE wishlist_items ALTER COLUMN amazon_url DROP NOT NULL
- Add smart CHECK constraint: (item_type='standard' AND amazon_url IS NOT NULL) OR (item_type!='standard')
- This ensures standard items MUST have URL, special items MUST NOT have URL

Fix mystery_box_tier constraint:
- DROP existing CHECK constraint for mystery_box_tier (allows 25, 50, 100)
- ADD new CHECK constraint: mystery_box_tier IN (50, 100)
- Keep existing cross-column constraint (tier requires item_type='mystery_box')

Include descriptive comments explaining why these constraints matter.
Add RAISE NOTICE at end to confirm successful migration.
  </action>
  <verify>
```bash
# Check migration file syntax
cat supabase/migrations/20260203000001_fix_special_items.sql

# Apply migration to database
npx supabase db push

# Verify constraints in remote database
npx supabase db remote execute "SELECT conname, pg_get_constraintdef(oid) FROM pg_constraint WHERE conrelid = 'public.wishlist_items'::regclass AND conname LIKE '%amazon%' OR conname LIKE '%tier%';"
```
  </verify>
  <done>Migration file exists, applies successfully, amazon_url is nullable with smart constraint, mystery_box_tier constraint only allows 50 and 100</done>
</task>

<task type="auto">
  <name>Task 2: Remove budget field from Surprise Me form and fix tier array</name>
  <files>components/wishlist/AddItemModal.tsx</files>
  <action>
Remove budget field from Surprise Me form:
- Line 44: Remove `const [budget, setBudget] = useState('');` declaration
- Lines 571-620: Delete entire budget input section (View with "Budget (Optional)" label)
- Line 117: Remove `surprise_me_budget: budget ? parseFloat(budget) : null` from payload
- Line 149: Remove `setBudget('');` from resetForm

Why: Budget is group-specific (groups.budget_limit_per_gift in database), not per-item. User correctly identified this as incorrect implementation.

Fix Mystery Box tier array:
- Line 18: Change type definition to `type MysteryBoxTier = 50 | 100;` (remove 25)
- Line 646: Change array to `[50, 100] as MysteryBoxTier[]` (remove 25)

Update null handling for amazon_url:
- Line 113: Change `amazon_url: ''` to `amazon_url: null` for surprise_me
- Line 122: Change `amazon_url: ''` to `amazon_url: null` for mystery_box

Update interface to reflect nullable amazon_url:
- Line 24: Change `amazon_url: string;` to `amazon_url: string | null;`
  </action>
  <verify>
```bash
# Check for budget references (should find NONE in AddItemModal)
grep -n "budget\|Budget" components/wishlist/AddItemModal.tsx

# Check tier array (should only show 50, 100)
grep -n "25\|50\|100" components/wishlist/AddItemModal.tsx

# Check amazon_url null handling
grep -n "amazon_url:" components/wishlist/AddItemModal.tsx

# TypeScript compilation
npx expo-cli type-check || echo "Type check complete"
```
  </verify>
  <done>Budget state and input removed, surprise_me_budget removed from payload, tier array is [50, 100], amazon_url uses null for special items, interface updated</done>
</task>

<task type="auto">
  <name>Task 3: Update TypeScript types to reflect schema changes</name>
  <files>types/database.types.ts</files>
  <action>
Update wishlist_items type definitions to match new schema:

Row type (line 106-107):
- Change `amazon_url: string` to `amazon_url: string | null`
- Change `mystery_box_tier: 25 | 50 | 100 | null` to `mystery_box_tier: 50 | 100 | null`

Insert type (line 116):
- Change `amazon_url: string` to `amazon_url: string | null`

Update type (if exists, check around line 125-135):
- Change `amazon_url?: string` to `amazon_url?: string | null`
- Change `mystery_box_tier?: 25 | 50 | 100 | null` to `mystery_box_tier?: 50 | 100 | null`

Why: TypeScript types must match database schema constraints for type safety.
  </action>
  <verify>
```bash
# Check updated types
grep -A 20 "interface Row" types/database.types.ts | grep -E "amazon_url|mystery_box_tier"

# TypeScript compilation
npx expo-cli type-check || echo "Type check complete"
```
  </verify>
  <done>amazon_url is nullable in all type definitions, mystery_box_tier only includes 50 and 100, TypeScript compiles without new errors</done>
</task>

</tasks>

<verification>
End-to-end verification of all three fixes:

1. **Budget field removal:**
```bash
# Visual check: Budget section should be gone
grep -n "Budget" components/wishlist/AddItemModal.tsx
# Expected: No matches in Surprise Me section
```

2. **Tier array fix:**
```bash
# Check tier options
grep -n "\[.*50.*100\]" components/wishlist/AddItemModal.tsx
# Expected: Line showing [50, 100] only
```

3. **Database constraint fix:**
```bash
# Verify migration applied
npx supabase db remote execute "SELECT conname FROM pg_constraint WHERE conrelid = 'public.wishlist_items'::regclass AND conname LIKE '%amazon%';"
# Expected: Smart constraint allowing null for special items

# Test insert with null amazon_url
npx supabase db remote execute "INSERT INTO wishlist_items (user_id, group_id, amazon_url, title, item_type) VALUES ('test-uuid', 'test-uuid', NULL, 'Test Surprise', 'surprise_me');"
# Expected: Success (or UUID not found error, not constraint violation)
```

4. **Type safety:**
```bash
npx expo-cli type-check
# Expected: No new TypeScript errors related to amazon_url or tier types
```
</verification>

<success_criteria>
- [ ] Database migration applied successfully without errors
- [ ] amazon_url column is nullable with smart constraint (standard requires URL, special items forbid URL)
- [ ] mystery_box_tier CHECK constraint only allows 50 and 100
- [ ] Surprise Me form does not render budget input field
- [ ] Mystery Box form shows only €50 and €100 tier buttons
- [ ] AddItemModal sends `null` for amazon_url on special items
- [ ] TypeScript types updated: amazon_url is `string | null`, tier is `50 | 100 | null`
- [ ] TypeScript compilation succeeds with no new errors
- [ ] User can add Surprise Me item without hanging (button no longer stuck in "Adding..." state)
</success_criteria>

<output>
After completion, create `.planning/phases/08-special-item-types/08-03-SUMMARY.md`
</output>
