---
phase: 08-special-item-types
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/wishlist/AddItemModal.tsx
  - app/(app)/(tabs)/wishlist.tsx
autonomous: true

must_haves:
  truths:
    - "User can select between Gift, Surprise Me, and Mystery Box when adding an item"
    - "Surprise Me items save with item_type='surprise_me' and optional budget"
    - "Mystery Box items save with item_type='mystery_box' and selected tier"
    - "Standard gift items continue to work (backward compatible)"
  artifacts:
    - path: "components/wishlist/AddItemModal.tsx"
      provides: "Type selector, conditional form fields"
      contains: "itemType === 'surprise_me'"
    - path: "app/(app)/(tabs)/wishlist.tsx"
      provides: "Updated insert handler for item_type"
      contains: "item_type:"
  key_links:
    - from: "components/wishlist/AddItemModal.tsx"
      to: "app/(app)/(tabs)/wishlist.tsx"
      via: "onAdd callback with item_type field"
      pattern: "onAdd.*item_type"
---

<objective>
Extend AddItemModal to support all three item types: standard gifts, Surprise Me, and Mystery Box.

Purpose: Enable users to add special wishlist items that signal openness (Surprise Me) or request curated mystery gifts (Mystery Box) - requirements SPEC-01 through SPEC-04.

Output: Updated AddItemModal with type selector and conditional form fields, updated insert handler in wishlist screen.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-special-item-types/08-RESEARCH.md
@types/database.types.ts
@components/wishlist/AddItemModal.tsx
@app/(app)/(tabs)/wishlist.tsx
@constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add type selector and conditional forms to AddItemModal</name>
  <files>components/wishlist/AddItemModal.tsx</files>
  <action>
Extend AddItemModal.tsx with:

1. Add itemType state: `const [itemType, setItemType] = useState<'standard' | 'surprise_me' | 'mystery_box'>('standard');`

2. Add tier state for Mystery Box: `const [selectedTier, setSelectedTier] = useState<25 | 50 | 100 | null>(null);`

3. Add budget state for Surprise Me: `const [budget, setBudget] = useState('');`

4. Add type selector UI after header, before form fields:
   - Horizontal row of 3 TouchableOpacity buttons
   - Icons: gift-outline (Gift), help-circle-outline (Surprise), gift (Mystery)
   - Active state uses burgundy[700] background, white text/icon
   - Inactive state uses cream[100] background, burgundy[600] text/icon
   - Style to match existing form field aesthetic (rounded corners, spacing)

5. Make form fields conditional:
   - Standard (itemType === 'standard'): Show URL, Title, Price, Priority (existing fields)
   - Surprise Me (itemType === 'surprise_me'): Show helper text "Let your group know you're open to any gift!", budget input (optional), NO priority selector
   - Mystery Box (itemType === 'mystery_box'): Show helper text "Select a Mystery Box tier", tier selector (25/50/100 buttons), NO priority or budget

6. Update handleSubmit validation:
   - Standard: require URL and title (existing logic)
   - Surprise Me: no required fields (budget is optional)
   - Mystery Box: require selectedTier

7. Update onAdd interface to include new fields:
   ```typescript
   onAdd: (item: {
     amazon_url: string;
     title: string;
     price?: number;
     priority: number;
     item_type: 'standard' | 'surprise_me' | 'mystery_box';
     mystery_box_tier?: 25 | 50 | 100 | null;
     surprise_me_budget?: number | null;
   }) => Promise<void>;
   ```

8. Build payload based on type:
   - Standard: existing fields + item_type: 'standard'
   - Surprise Me: amazon_url: '', title: 'Surprise Me!', item_type: 'surprise_me', surprise_me_budget, priority: 3
   - Mystery Box: amazon_url: '', title: `${selectedTier} Mystery Box`, item_type: 'mystery_box', mystery_box_tier: selectedTier, price: selectedTier, priority: 3

9. Update resetForm (handleCancel and post-submit) to also reset itemType, selectedTier, budget

10. Reset type-specific fields when itemType changes (useEffect):
    - When switching away from mystery_box: setSelectedTier(null)
    - When switching away from surprise_me: setBudget('')

Styling notes:
- Type selector: flexDirection: 'row', gap: spacing.sm, marginBottom: spacing.lg
- Each type button: flex: 1, paddingVertical: spacing.sm, borderRadius: borderRadius.md, alignItems: 'center'
- Tier selector: similar horizontal row with 3 buttons showing "25", "50", "100"
- Helper text: fontSize: 14, color: colors.burgundy[600], marginBottom: spacing.md, textAlign: 'center'
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
Modal opens and shows type selector with 3 buttons.
  </verify>
  <done>
AddItemModal displays type selector, shows conditional fields based on selection, builds correct payload for each type.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update wishlist insert handler for new item fields</name>
  <files>app/(app)/(tabs)/wishlist.tsx</files>
  <action>
Update the handleAddItem function in wishlist.tsx to handle the new item_type fields:

1. Update the function parameter type to match the new onAdd interface from AddItemModal

2. Update the Supabase insert to include new columns:
   ```typescript
   const { data, error } = await supabase
     .from('wishlist_items')
     .insert([
       {
         user_id: userId,
         amazon_url: itemData.amazon_url,
         title: itemData.title,
         price: itemData.price,
         priority: itemData.priority,
         status: 'active',
         item_type: itemData.item_type,
         mystery_box_tier: itemData.mystery_box_tier,
         surprise_me_budget: itemData.surprise_me_budget,
       },
     ])
     .select()
     .single();
   ```

3. Update success message based on item type:
   - Standard: 'Gift added to your wishlist!' (existing)
   - Surprise Me: 'Added Surprise Me to your wishlist!'
   - Mystery Box: 'Added Mystery Box to your wishlist!'

4. Ensure the items state refresh includes the new columns in the select query (if filtered).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Test in app: Add standard gift - works as before.
Test in app: Add Surprise Me - saves with item_type='surprise_me'.
Test in app: Add Mystery Box (50) - saves with item_type='mystery_box', mystery_box_tier=50.
  </verify>
  <done>
All three item types can be added to wishlist and persist to database with correct item_type and type-specific fields.
  </done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - no TypeScript errors
2. Open app, navigate to My Wishlist
3. Tap "+" to open AddItemModal
4. Verify type selector shows 3 options: Gift, Surprise, Mystery
5. Test standard gift flow - URL and title required, saves normally
6. Test Surprise Me - shows helper text and budget input, saves with item_type='surprise_me'
7. Test Mystery Box - shows tier selector, requires tier selection, saves with correct tier
8. Verify existing items still display (backward compatibility)
</verification>

<success_criteria>
- Type selector visible with 3 distinct options
- Conditional form fields render correctly per type
- Standard items save with item_type='standard' (explicit or default)
- Surprise Me items save with item_type='surprise_me' and optional budget
- Mystery Box items save with selected tier (25, 50, or 100)
- No regression in existing standard gift add flow
</success_criteria>

<output>
After completion, create `.planning/phases/08-special-item-types/08-01-SUMMARY.md`
</output>
