---
phase: 03-calendar
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - utils/deviceCalendar.ts
  - components/calendar/CalendarSyncButton.tsx
  - supabase/migrations/20260202000006_auto_celebrations.sql
  - app.json
autonomous: true

must_haves:
  truths:
    - "User can sync birthday events to Google Calendar or Apple Calendar"
    - "Celebrations are automatically created when birthdays approach (within 30 days)"
    - "User grants calendar permission only when tapping sync button"
    - "Synced events recur yearly"
  artifacts:
    - path: "utils/deviceCalendar.ts"
      provides: "Device calendar sync functionality"
      exports: ["syncBirthdayEvent", "syncAllBirthdays", "checkCalendarPermission"]
      min_lines: 80
    - path: "components/calendar/CalendarSyncButton.tsx"
      provides: "Button to trigger device calendar sync"
      min_lines: 40
    - path: "supabase/migrations/20260202000006_auto_celebrations.sql"
      provides: "pg_cron job for auto-celebration creation"
      contains: "create_upcoming_celebrations"
  key_links:
    - from: "components/calendar/CalendarSyncButton.tsx"
      to: "utils/deviceCalendar.ts"
      via: "sync function call"
      pattern: "syncBirthdayEvent|syncAllBirthdays"
    - from: "supabase/migrations/20260202000006_auto_celebrations.sql"
      to: "public.celebrations"
      via: "INSERT statement"
      pattern: "INSERT INTO.*celebrations"
---

<objective>
Enable device calendar sync and automatic celebration creation from birthdays.

Purpose: Users want birthday reminders in their native calendar app (Google Calendar or Apple Calendar) where they already manage their schedule. Additionally, celebrations should automatically be created when a birthday is within the planning window (30 days), so Gift Leaders can start coordinating without manual celebration creation.

Output: Device calendar sync functionality with permission handling, CalendarSyncButton component for UI integration, and a Supabase pg_cron job that runs daily to create celebrations for upcoming birthdays.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-calendar/03-RESEARCH.md

# Database schema for celebrations
@supabase/migrations/20260202000005_celebrations.sql
@lib/celebrations.ts

# Existing patterns
@components/celebrations/CelebrationCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install expo-calendar and create device calendar sync utility</name>
  <files>
    package.json
    app.json
    utils/deviceCalendar.ts
  </files>
  <action>
1. Install expo-calendar:
   ```bash
   npx expo install expo-calendar
   ```

2. Update `app.json` to add calendar permission descriptions (required for iOS):
   - Add to expo.ios.infoPlist:
     ```json
     "NSCalendarsUsageDescription": "We need calendar access to sync birthday reminders to your calendar",
     "NSCalendarsFullAccessUsageDescription": "We need full calendar access to create and manage birthday events"
     ```
   - Note: Android permissions are handled automatically by expo-calendar

3. Create `utils/deviceCalendar.ts` with full calendar sync functionality:

   **Exports:**
   - `checkCalendarPermission(): Promise<boolean>` - Check if calendar access granted
   - `requestCalendarPermission(): Promise<boolean>` - Request permission, return result
   - `getOrCreateWishlistCalendar(): Promise<string>` - Get or create "Wishlist Birthdays" calendar
   - `syncBirthdayEvent(userName: string, birthday: Date, groupName: string): Promise<SyncResult>` - Sync single birthday
   - `syncAllBirthdays(birthdays: GroupBirthday[]): Promise<SyncResult[]>` - Sync all birthdays

   **Implementation details:**
   - Calendar named "Wishlist Birthdays" with color #FF6B6B
   - On iOS: Try iCloud source first, fall back to local
   - On Android: Use local source
   - Events: All-day, recurring yearly
   - Alarms: 1 week before (-10080 min) and 1 day before (-1440 min)
   - Event title format: "{userName}'s Birthday"
   - Event notes: "Birthday celebration for {groupName} group - Wishlist App"
   - Handle iOS 17 permission quirks (verify status after grant)

   **Error handling:**
   - Return `{ success: boolean, eventId?: string, error?: string }`
   - Catch all errors gracefully, never crash
   - Log errors for debugging

4. Use Platform from react-native for iOS/Android branching
  </action>
  <verify>
    - `npm ls expo-calendar` shows installed
    - `npx tsc --noEmit` passes
    - app.json has calendar permission descriptions
    - Functions compile without TypeScript errors
  </verify>
  <done>
    - expo-calendar installed
    - app.json has iOS permission descriptions
    - deviceCalendar.ts exports all required functions
    - Platform-specific calendar source handling implemented
    - Events configured as yearly recurring with alarms
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CalendarSyncButton component and integrate into calendar screen</name>
  <files>
    components/calendar/CalendarSyncButton.tsx
    app/(app)/(tabs)/calendar.tsx
  </files>
  <action>
1. Create `components/calendar/CalendarSyncButton.tsx`:
   - Props: `birthdays: GroupBirthday[]`, `onSyncComplete?: (results: SyncResult[]) => void`
   - States: `syncing`, `permissionGranted`, `syncComplete`
   - UI:
     - Button with calendar-sync icon
     - Text: "Sync to Calendar" (before sync) / "Synced!" (after)
     - Loading spinner when syncing
     - Disabled state while syncing
   - Behavior:
     - On press: Check permission, request if needed
     - If granted: Call syncAllBirthdays
     - Show success/error toast via react-native Alert
     - Track sync completion in local state
   - Use Gluestack UI Button component for consistency
   - Match app color scheme (burgundy primary)

2. Update `app/(app)/(tabs)/calendar.tsx` to include sync button:
   - Add CalendarSyncButton in header or as floating action button
   - Pass birthdays data to the button
   - Position: Top right of header or bottom right corner
   - Only show if birthdays exist

3. Handle edge cases:
   - No birthdays to sync: Show informative message
   - Permission denied: Show helpful message about enabling in Settings
   - Partial sync failure: Report which succeeded/failed
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - CalendarSyncButton renders without errors
    - Button appears on calendar screen
    - Tapping button triggers permission flow
  </verify>
  <done>
    - CalendarSyncButton prompts for calendar permission on first tap
    - After permission grant, syncs all birthdays to device calendar
    - Events appear in device calendar app (Wishlist Birthdays calendar)
    - Button shows syncing/synced state
    - Error cases handled gracefully with user feedback
  </done>
</task>

<task type="auto">
  <name>Task 3: Create pg_cron migration for automatic celebration creation</name>
  <files>
    supabase/migrations/20260202000006_auto_celebrations.sql
  </files>
  <action>
1. Create `supabase/migrations/20260202000006_auto_celebrations.sql`:

   **Enable extensions (if not already enabled):**
   ```sql
   CREATE EXTENSION IF NOT EXISTS pg_cron;
   ```

   **Create function `create_upcoming_celebrations()`:**
   - Planning window: 30 days in advance (configurable via function parameter)
   - Find all users with birthdays in the planning window
   - For each user+group combination where no celebration exists for this year:
     - INSERT into celebrations table
     - Calculate Gift Leader using birthday rotation (same algorithm as lib/celebrations.ts)
     - Create corresponding chat_room for the celebration
   - Handle edge cases:
     - Feb 29 birthdays in non-leap years
     - Users in multiple groups (create celebration per group)
     - Null birthdays (skip)
   - Log activity with RAISE NOTICE

   **Birthday rotation in SQL:**
   - Sort group members by (EXTRACT(MONTH FROM birthday), EXTRACT(DAY FROM birthday), user_id)
   - Gift Leader = next person in rotation after celebrant
   - Handle wrap-around (last person -> first person)
   - Handle 2-person groups (Gift Leader = the other person)

   **Schedule the job:**
   ```sql
   SELECT cron.schedule(
     'create-upcoming-celebrations',
     '0 0 * * *',  -- Daily at midnight UTC
     $$SELECT public.create_upcoming_celebrations();$$
   );
   ```

   **Also create chat_rooms for new celebrations:**
   - After inserting celebrations, insert chat_rooms for any celebration without one
   - This ensures chat is immediately available

2. Include RLS bypass for the function (SECURITY DEFINER) since it runs as system

3. Add comment documentation explaining the cron job
  </action>
  <verify>
    - Migration file has valid SQL syntax
    - Function handles all edge cases mentioned
    - Cron schedule syntax is correct
    - Gift Leader calculation matches lib/celebrations.ts algorithm
  </verify>
  <done>
    - Migration creates pg_cron extension and function
    - Function creates celebrations for birthdays within 30 days
    - Gift Leader assigned using birthday rotation algorithm
    - Chat rooms auto-created with celebrations
    - Cron job scheduled to run daily at midnight UTC
    - Feb 29 and edge cases handled
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. expo-calendar installed and app.json has permission descriptions
2. Sync button appears on calendar screen
3. Tapping sync button requests calendar permission (first time)
4. After granting, birthdays sync to device calendar
5. "Wishlist Birthdays" calendar created in device calendar app
6. Events show as all-day, yearly recurring with 1-week and 1-day alarms
7. Migration file ready to apply to Supabase
8. pg_cron function correctly calculates Gift Leader
9. TypeScript compiles without errors
</verification>

<success_criteria>
- CALR-02 COMPLETE: Celebrations automatically created when birthdays approach (via pg_cron)
- CALR-03 COMPLETE: User can sync birthday events to Google Calendar or Apple Calendar
- No TypeScript errors
- Migration ready for deployment
- Device calendar sync works on iOS and Android
</success_criteria>

<output>
After completion, create `.planning/phases/03-calendar/03-02-SUMMARY.md` following the template at @/home/zetaz/.claude/get-shit-done/templates/summary.md

**Post-execution note:** The pg_cron migration needs to be applied to Supabase. User should:
1. Apply migration via Supabase Dashboard SQL editor or CLI
2. Verify cron.schedule_jobs shows the new job
3. Test by manually running: `SELECT public.create_upcoming_celebrations();`
</output>
