---
phase: 03-calendar
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - app/(app)/(tabs)/calendar.tsx
  - app/(app)/(tabs)/_layout.tsx
  - components/calendar/BirthdayCalendar.tsx
  - components/calendar/CountdownCard.tsx
  - utils/countdown.ts
  - lib/birthdays.ts
autonomous: true

must_haves:
  truths:
    - "User can view an in-app calendar showing all group birthdays"
    - "User can tap a date to see whose birthday falls on that day"
    - "User can see countdown to each upcoming birthday in the calendar screen"
    - "Calendar marks multiple groups with different colored dots"
  artifacts:
    - path: "app/(app)/(tabs)/calendar.tsx"
      provides: "Calendar tab screen with birthday display"
      min_lines: 100
    - path: "components/calendar/BirthdayCalendar.tsx"
      provides: "Calendar component with multi-dot marking"
      min_lines: 50
    - path: "components/calendar/CountdownCard.tsx"
      provides: "Countdown display for upcoming birthdays"
      min_lines: 40
    - path: "utils/countdown.ts"
      provides: "Birthday countdown calculation logic"
      exports: ["getDaysUntilBirthday", "getPlanningStatus"]
    - path: "lib/birthdays.ts"
      provides: "Query birthdays from all user groups"
      exports: ["getGroupBirthdays"]
  key_links:
    - from: "app/(app)/(tabs)/calendar.tsx"
      to: "components/calendar/BirthdayCalendar.tsx"
      via: "import and render"
      pattern: "import.*BirthdayCalendar"
    - from: "components/calendar/BirthdayCalendar.tsx"
      to: "lib/birthdays.ts"
      via: "fetch birthday data"
      pattern: "getGroupBirthdays"
    - from: "components/calendar/CountdownCard.tsx"
      to: "utils/countdown.ts"
      via: "calculate days until"
      pattern: "getDaysUntilBirthday"
---

<objective>
Build the in-app calendar view with birthday marking and countdown display.

Purpose: Users need a visual way to see when group members' birthdays occur and plan ahead. The calendar provides at-a-glance birthday visibility across all groups, while countdown cards highlight upcoming celebrations that need attention.

Output: Calendar tab screen with react-native-calendars showing marked birthdays (multi-dot for multiple groups), date selection to show birthday details, and countdown cards for upcoming birthdays within the planning window.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-calendar/03-RESEARCH.md

# Existing patterns to follow
@app/(app)/(tabs)/celebrations.tsx
@app/(app)/(tabs)/_layout.tsx
@lib/celebrations.ts
@types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-native-calendars and create birthday data layer</name>
  <files>
    package.json
    lib/birthdays.ts
    utils/countdown.ts
  </files>
  <action>
1. Install react-native-calendars (pure JS, no native linking needed):
   ```bash
   npm install react-native-calendars
   ```

2. Create `lib/birthdays.ts` with function to query birthdays across all user groups:
   - `getGroupBirthdays(userId: string)` - Queries user_profiles joined with group_members to get all birthdays from groups the user belongs to
   - Return format: `{ userId, userName, birthday, groupId, groupName, groupColor }[]`
   - Use Supabase client with proper typing
   - Group colors: Use a predefined palette (8 distinct colors) assigned by group order

3. Create `utils/countdown.ts` with birthday countdown calculations:
   - `getDaysUntilBirthday(birthday: Date | string): number` - Calculate days until next birthday occurrence
   - Handle Feb 29 birthdays correctly (show on Feb 28 in non-leap years)
   - `getPlanningStatus(daysUntil: number): 'urgent' | 'soon' | 'planning' | 'future'`
     - urgent: <= 7 days
     - soon: 8-14 days
     - planning: 15-30 days
     - future: > 30 days

Use date-fns (already in project v4.1.0) for date calculations: differenceInDays, setYear, getYear, isBefore, isValid.
  </action>
  <verify>
    - `npm ls react-native-calendars` shows installed
    - `npx tsc --noEmit` passes for new files
    - Functions exported correctly from both files
  </verify>
  <done>
    - react-native-calendars installed
    - getGroupBirthdays function queries and returns typed birthday data
    - getDaysUntilBirthday correctly calculates days including Feb 29 handling
    - getPlanningStatus categorizes countdown correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BirthdayCalendar and CountdownCard components</name>
  <files>
    components/calendar/BirthdayCalendar.tsx
    components/calendar/CountdownCard.tsx
  </files>
  <action>
1. Create `components/calendar/BirthdayCalendar.tsx`:
   - Import Calendar from react-native-calendars
   - Props: `birthdays: GroupBirthday[]`, `onDateSelect: (date: string) => void`, `selectedDate: string | null`
   - Use `useMemo` to transform birthdays to markedDates format (critical for performance - react-native-calendars compares by reference)
   - Use `markingType="multi-dot"` for multiple birthdays on same date
   - Each group gets a different colored dot from palette
   - Enable swipe between months
   - Start week on Monday (firstDay={1})
   - Theme to match app burgundy color scheme (#8B1538 for today highlight)
   - onDayPress calls onDateSelect with dateString

2. Create `components/calendar/CountdownCard.tsx`:
   - Props: `birthday: GroupBirthday`, `daysUntil: number`
   - Display: User name, group name, days remaining (or "TODAY!")
   - Color-coded background based on getPlanningStatus:
     - urgent (#FF6B6B red)
     - soon (#FF9F43 orange)
     - planning (#48DBFB blue)
     - future (#95A5A6 gray)
   - Pressable to navigate to celebration (if exists)
   - Use Gluestack UI components for styling consistency
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Components export default correctly
    - BirthdayCalendar renders without errors when imported
  </verify>
  <done>
    - BirthdayCalendar shows monthly view with dot markers for birthdays
    - Dots are colored per group
    - Tapping date triggers onDateSelect callback
    - CountdownCard displays countdown with color-coded urgency
    - Components match existing app styling patterns
  </done>
</task>

<task type="auto">
  <name>Task 3: Create calendar tab screen and wire everything together</name>
  <files>
    app/(app)/(tabs)/calendar.tsx
    app/(app)/(tabs)/_layout.tsx
  </files>
  <action>
1. Create `app/(app)/(tabs)/calendar.tsx`:
   - Fetch birthdays using getGroupBirthdays on mount (useEffect + useState)
   - State: `birthdays`, `selectedDate`, `loading`, `error`
   - Layout:
     - Top section: BirthdayCalendar component
     - Bottom section: Scrollable list of CountdownCards for upcoming birthdays (next 30 days)
     - If date selected, show birthdays for that date below calendar
   - Filter and sort upcoming birthdays by getDaysUntilBirthday
   - Use FlashList for countdown cards (consistent with app patterns)
   - Handle loading and error states
   - Pull to refresh support

2. Update `app/(app)/(tabs)/_layout.tsx`:
   - Add calendar tab entry after celebrations:
     ```tsx
     <Tabs.Screen
       name="calendar"
       options={{
         title: 'Calendar',
         headerShown: false,
         tabBarIcon: ({ color, size }) => (
           <MaterialCommunityIcons name="calendar" size={size} color={color} />
         ),
       }}
     />
     ```
   - Place between celebrations and notifications tabs

3. Ensure calendar screen matches app styling:
   - Use SafeAreaView with proper padding
   - Header with title "Birthday Calendar"
   - Consistent with celebrations.tsx and other tab screens
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - App builds without errors: `npx expo start` runs
    - Calendar tab appears in bottom navigation
    - Tapping calendar tab shows calendar with any existing birthdays marked
  </verify>
  <done>
    - Calendar tab visible in app navigation
    - Calendar displays birthdays from all user's groups
    - Tapping a date shows birthdays for that day
    - Upcoming birthdays section shows countdown cards
    - Color-coded dots identify different groups
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Calendar tab appears in bottom navigation between Celebrations and Notifications
2. Calendar shows dots on dates where group members have birthdays
3. Multiple birthdays on same date show multiple colored dots
4. Tapping a date reveals whose birthday it is
5. Countdown cards show upcoming birthdays with days remaining
6. Cards are color-coded by urgency (red/orange/blue/gray)
7. Feb 29 birthdays handled correctly in non-leap years
8. TypeScript compiles without errors
</verification>

<success_criteria>
- CALR-01 COMPLETE: User can view an in-app calendar showing all group birthdays
- CALR-04 COMPLETE: User can see countdown to each upcoming birthday in planning window
- No TypeScript errors
- App runs on both iOS and Android simulators
</success_criteria>

<output>
After completion, create `.planning/phases/03-calendar/03-01-SUMMARY.md` following the template at @/home/zetaz/.claude/get-shit-done/templates/summary.md
</output>
