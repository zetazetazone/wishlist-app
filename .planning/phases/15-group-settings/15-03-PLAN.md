---
phase: 15-group-settings
plan: 03
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - app/group/[id]/settings.tsx
  - utils/groups.ts
  - components/groups/MemberListItem.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see list of all members in settings with their roles"
    - "Admin can remove a non-admin member from the group"
    - "Removing a member who is Gift Leader triggers reassignment before deletion"
    - "Admin can transfer admin role to another member"
    - "Admin transfer is confirmed with a dialog before executing"
    - "Non-admin member can leave the group from settings"
    - "Admin cannot leave without first transferring admin role"
  artifacts:
    - path: "components/groups/MemberListItem.tsx"
      provides: "Member row component with admin actions (remove, make admin)"
      min_lines: 60
    - path: "utils/groups.ts"
      provides: "removeMember(), transferAdmin() functions"
      exports: ["removeMember", "transferAdmin"]
    - path: "app/group/[id]/settings.tsx"
      provides: "Members section and Danger Zone section (replacing Plan 01 placeholders)"
      min_lines: 200
  key_links:
    - from: "utils/groups.ts removeMember()"
      to: "lib/celebrations.ts getNextGiftLeader()"
      via: "Gift Leader reassignment before deletion"
      pattern: "getNextGiftLeader"
    - from: "utils/groups.ts transferAdmin()"
      to: "supabase.rpc('transfer_admin_role')"
      via: "Database function call for atomic transfer"
      pattern: "transfer_admin_role"
    - from: "app/group/[id]/settings.tsx"
      to: "utils/groups.ts"
      via: "removeMember(), transferAdmin(), leaveGroup() calls"
      pattern: "removeMember|transferAdmin|leaveGroup"
---

<objective>
Implement member management: admin can remove members (with Gift Leader reassignment), transfer admin role, and non-admin members can leave the group.

Purpose: This plan delivers the final 3 requirements (GSET-04, GSET-05, GSET-07). This is the most complex feature in Phase 15 due to Gift Leader reassignment logic on member removal and the atomic admin transfer. It gets its own plan to ensure quality execution within context budget.

Output: Working member management in settings screen, MemberListItem component, removeMember/transferAdmin utility functions.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-group-settings/15-RESEARCH.md
@.planning/phases/15-group-settings/15-01-SUMMARY.md
@.planning/phases/15-group-settings/15-02-SUMMARY.md
@utils/groups.ts
@lib/celebrations.ts
@components/groups/MemberCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add removeMember and transferAdmin to utils/groups.ts</name>
  <files>utils/groups.ts</files>
  <action>
Add two new exported functions to `utils/groups.ts`:

1. **removeMember()** - Handles Gift Leader reassignment, then removes the member:
   ```typescript
   export async function removeMember(groupId: string, removedUserId: string) {
     try {
       const { data: { user } } = await supabase.auth.getUser();
       if (!user) throw new Error('Not authenticated');

       // Step 1: Check if removed user is Gift Leader for any active/upcoming celebrations
       const { data: celebrations } = await supabase
         .from('celebrations')
         .select('id, celebrant_id')
         .eq('group_id', groupId)
         .eq('gift_leader_id', removedUserId)
         .in('status', ['upcoming', 'active']);

       // Step 2: Reassign Gift Leader for each affected celebration
       if (celebrations && celebrations.length > 0) {
         // Import getNextGiftLeader from lib/celebrations
         const { getNextGiftLeader } = await import('../lib/celebrations');

         for (const celebration of celebrations) {
           try {
             const newLeaderId = await getNextGiftLeader(groupId, celebration.celebrant_id);

             // Update celebration with new leader
             await supabase
               .from('celebrations')
               .update({ gift_leader_id: newLeaderId })
               .eq('id', celebration.id);

             // Record in gift_leader_history with 'member_left' reason
             await supabase
               .from('gift_leader_history')
               .insert({
                 celebration_id: celebration.id,
                 assigned_to: newLeaderId,
                 assigned_by: null, // System reassignment
                 reason: 'member_left',
               });
           } catch (reassignError) {
             console.error('Failed to reassign gift leader for celebration:', celebration.id, reassignError);
             // If reassignment fails (e.g., only 2 members and removing one leaves <2),
             // set gift_leader_id to NULL as fallback
             await supabase
               .from('celebrations')
               .update({ gift_leader_id: null })
               .eq('id', celebration.id);
           }
         }
       }

       // Step 3: Delete the group_members row
       // RLS policy (updated in Plan 01 migration) allows admin to delete other members
       const { error } = await supabase
         .from('group_members')
         .delete()
         .eq('group_id', groupId)
         .eq('user_id', removedUserId);

       if (error) throw error;
       return { error: null };
     } catch (error) {
       return { error };
     }
   }
   ```

   IMPORTANT: Use dynamic import for getNextGiftLeader to avoid circular dependency issues (utils/groups.ts should not have a top-level import from lib/celebrations.ts if celebrations.ts imports from groups.ts). Check existing imports first -- if there's no circular risk, use a static import instead.

2. **transferAdmin()** - Calls the database function for atomic transfer:
   ```typescript
   export async function transferAdmin(groupId: string, newAdminId: string) {
     try {
       const { error } = await supabase
         .rpc('transfer_admin_role', {
           p_group_id: groupId,
           p_new_admin_id: newAdminId,
         });

       if (error) throw error;
       return { error: null };
     } catch (error) {
       return { error };
     }
   }
   ```

Also verify the existing `leaveGroup()` function is sufficient for GSET-07. It currently just deletes the group_members row for auth.uid(). This works for non-admin members. No changes needed to leaveGroup() itself, but the UI should prevent admins from using it (they must transfer first).
  </action>
  <verify>
Read utils/groups.ts and verify:
- `removeMember()` exported, handles Gift Leader reassignment before deletion
- `removeMember()` queries celebrations table for affected celebrations
- `removeMember()` logs to gift_leader_history with 'member_left' reason
- `transferAdmin()` exported, calls supabase.rpc('transfer_admin_role')
- No circular import issues
- Existing functions remain unchanged
  </verify>
  <done>removeMember (with Gift Leader reassignment) and transferAdmin (atomic via DB function) utility functions ready. leaveGroup() confirmed sufficient for non-admin leave.</done>
</task>

<task type="auto">
  <name>Task 2: Create MemberListItem component and implement member management in settings</name>
  <files>components/groups/MemberListItem.tsx, app/group/[id]/settings.tsx</files>
  <action>
**Part A: Create MemberListItem component**

Create `components/groups/MemberListItem.tsx`:

Props:
```typescript
interface MemberListItemProps {
  member: {
    user_id: string;
    role: 'admin' | 'member';
    full_name: string;
    avatar_url: string | null;
  };
  isCurrentUser: boolean;
  isViewerAdmin: boolean;
  onRemove?: () => void;       // Only for non-self, non-admin members when viewer is admin
  onMakeAdmin?: () => void;    // Only for non-admin members when viewer is admin
}
```

Layout:
- Horizontal row with:
  - User avatar (use gluestack Avatar or a simple circular Image with fallback initials)
  - Name + role badge ("Admin" badge if role === 'admin', styled with burgundy background; "(You)" suffix if isCurrentUser)
  - Right side: action buttons (only if isViewerAdmin and not isCurrentUser):
    - If member is not admin: "Remove" icon button (trash-can-outline, red) and "Make Admin" icon button (shield-account, gold)
    - If member is admin: no actions (can't remove another admin -- there's only one admin per group)
- White background, subtle bottom border, padding matching app style

**Part B: Implement Members section in settings screen**

Replace the "Members" placeholder section in `app/group/[id]/settings.tsx`:

1. **Fetch members on mount** (extend the existing data fetch in the screen):
   ```typescript
   const { data: members } = await supabase
     .from('group_members')
     .select(`
       user_id,
       role,
       users (
         id,
         full_name,
         avatar_url
       )
     `)
     .eq('group_id', id);
   ```
   Store members in state.

2. **Render MemberListItem for each member:**
   - Get current user ID from supabase.auth.getUser() (already fetched for isAdmin check)
   - Map over members, render MemberListItem for each
   - For admin viewer: pass onRemove and onMakeAdmin handlers

3. **onRemove handler:**
   ```typescript
   const handleRemoveMember = (member) => {
     Alert.alert(
       'Remove Member',
       `Are you sure you want to remove ${member.full_name} from the group? This cannot be undone.`,
       [
         { text: 'Cancel', style: 'cancel' },
         {
           text: 'Remove',
           style: 'destructive',
           onPress: async () => {
             const { error } = await removeMember(id, member.user_id);
             if (error) {
               Alert.alert('Error', 'Failed to remove member');
             } else {
               // Remove from local state
               setMembers(prev => prev.filter(m => m.user_id !== member.user_id));
             }
           },
         },
       ]
     );
   };
   ```

4. **onMakeAdmin handler (admin transfer):**
   ```typescript
   const handleMakeAdmin = (member) => {
     Alert.alert(
       'Transfer Admin Role',
       `Are you sure you want to make ${member.full_name} the group admin? You will become a regular member and lose admin privileges.`,
       [
         { text: 'Cancel', style: 'cancel' },
         {
           text: 'Transfer',
           style: 'destructive',
           onPress: async () => {
             const { error } = await transferAdmin(id, member.user_id);
             if (error) {
               Alert.alert('Error', 'Failed to transfer admin role');
             } else {
               // Update local state: demote self, promote target
               setMembers(prev => prev.map(m => ({
                 ...m,
                 role: m.user_id === member.user_id ? 'admin' : m.user_id === currentUserId ? 'member' : m.role,
               })));
               setIsAdmin(false);
               Alert.alert('Done', `${member.full_name} is now the group admin.`);
             }
           },
         },
       ]
     );
   };
   ```

**Part C: Implement Danger Zone section**

Replace the "Danger Zone" placeholder:

For **non-admin** members: Show a "Leave Group" button:
```typescript
<TouchableOpacity
  onPress={() => {
    Alert.alert(
      'Leave Group',
      'Are you sure you want to leave this group? You will need an invite code to rejoin.',
      [
        { text: 'Cancel', style: 'cancel' },
        {
          text: 'Leave',
          style: 'destructive',
          onPress: async () => {
            const { error } = await leaveGroup(id);
            if (error) {
              Alert.alert('Error', 'Failed to leave group');
            } else {
              router.replace('/(app)/(tabs)/groups');
            }
          },
        },
      ]
    );
  }}
  style={{ /* red/destructive button styling */ }}
>
  <Text>Leave Group</Text>
</TouchableOpacity>
```

For **admin** members: Show informational text: "To leave this group, first transfer the admin role to another member." The Leave button should either be hidden or shown as disabled with this explanation. This prevents the admin-leaves-group-with-no-admin pitfall.

**Imports to add to settings.tsx:**
- `import { MemberListItem } from '../../../components/groups/MemberListItem'`
- `import { removeMember, transferAdmin, leaveGroup } from '../../../utils/groups'`
  </action>
  <verify>
- MemberListItem.tsx renders member row with avatar, name, role badge, and conditional action buttons
- Settings screen shows all members with their roles
- Admin sees Remove and Make Admin buttons for non-admin, non-self members
- Remove member shows confirmation dialog, removes on confirm, updates local state
- Make Admin shows confirmation dialog explaining loss of privileges, transfers on confirm, updates local state and isAdmin flag
- Non-admin sees Leave Group button in Danger Zone
- Admin sees "transfer admin first" message instead of Leave button
- Confirmation dialogs use destructive style for irreversible actions
- Run `npx tsc --noEmit 2>&1 | grep -E "settings|MemberListItem|groups" | head -20` to check for TypeScript errors
  </verify>
  <done>Full member management working: admin can remove members (with Gift Leader reassignment), admin can transfer role, non-admin can leave group. GSET-04, GSET-05, GSET-07 complete.</done>
</task>

</tasks>

<verification>
1. Admin can see all members listed in settings with their roles
2. Admin can remove a regular member (confirmation dialog, then member disappears from list)
3. If removed member was Gift Leader, celebrations show new Gift Leader (check gift_leader_history for 'member_left' entry)
4. Admin can tap "Make Admin" on a member, confirm transfer, see their own role change to "member"
5. After admin transfer, former admin no longer sees admin-only sections
6. Non-admin member sees "Leave Group" button, can leave and gets redirected to groups list
7. Admin sees disabled/explanation instead of Leave button
8. All destructive actions have confirmation dialogs
</verification>

<success_criteria>
- GSET-04 satisfied: Admin removes members with Gift Leader reassignment
- GSET-05 satisfied: Admin transfers admin role atomically
- GSET-07 satisfied: Non-admin can leave group
- Gift Leader orphaning prevented (reassignment before removal)
- Admin orphaning prevented (must transfer before leaving)
- All 7 GSET requirements now satisfied across Plans 01-03
</success_criteria>

<output>
After completion, create `.planning/phases/15-group-settings/15-03-SUMMARY.md`
</output>
