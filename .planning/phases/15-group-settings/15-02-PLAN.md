---
phase: 15-group-settings
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - app/group/[id]/settings.tsx
  - utils/groups.ts
  - components/groups/InviteCodeSection.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can edit group name from settings and see it persist"
    - "Admin can edit group description from settings and see it persist"
    - "Admin can change group photo from settings and see it update"
    - "Any member can view the invite code in settings"
    - "Any member can copy invite code to clipboard"
    - "Any member can share invite code via native share sheet"
    - "Any member can regenerate invite code with confirmation"
  artifacts:
    - path: "app/group/[id]/settings.tsx"
      provides: "Group info editing section and invite code section (replacing placeholders from Plan 01)"
      min_lines: 150
    - path: "utils/groups.ts"
      provides: "updateGroupInfo(), regenerateInviteCode() functions"
      exports: ["updateGroupInfo", "regenerateInviteCode"]
    - path: "components/groups/InviteCodeSection.tsx"
      provides: "Invite code display, copy, share, regenerate component"
      min_lines: 60
  key_links:
    - from: "app/group/[id]/settings.tsx"
      to: "utils/groups.ts"
      via: "updateGroupInfo() call on save"
      pattern: "updateGroupInfo"
    - from: "app/group/[id]/settings.tsx"
      to: "lib/storage.ts"
      via: "uploadGroupPhotoFromUri() for photo change"
      pattern: "uploadGroupPhotoFromUri"
    - from: "components/groups/InviteCodeSection.tsx"
      to: "expo-clipboard"
      via: "Clipboard.setStringAsync() for copy"
      pattern: "setStringAsync"
    - from: "components/groups/InviteCodeSection.tsx"
      to: "utils/groups.ts"
      via: "regenerateInviteCode() RPC call"
      pattern: "regenerateInviteCode"
---

<objective>
Implement group info editing (name, description, photo) and invite code management.

Purpose: This plan delivers 4 of 7 requirements (GSET-01, GSET-02, GSET-03, GSET-06). Admin can edit all group properties from settings. All members can view, copy, share, and regenerate the group invite code. These are the simpler, lower-risk features that build on the skeleton from Plan 01.

Output: Working group info editing in settings, InviteCodeSection component, updated utils/groups.ts with new functions.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-group-settings/15-RESEARCH.md
@.planning/phases/15-group-settings/15-01-SUMMARY.md
@utils/groups.ts
@lib/storage.ts
@app/(app)/settings/profile.tsx
@constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add updateGroupInfo and regenerateInviteCode to utils/groups.ts</name>
  <files>utils/groups.ts</files>
  <action>
Add two new exported functions to `utils/groups.ts`:

1. **updateGroupInfo()** - Extends the existing `updateGroup()` to accept v1.2 fields:
   ```typescript
   export interface UpdateGroupInfoOptions {
     name?: string;
     description?: string | null;
     photo_url?: string | null;
   }

   export async function updateGroupInfo(groupId: string, updates: UpdateGroupInfoOptions) {
     try {
       const { data, error } = await supabase
         .from('groups')
         .update(updates)
         .eq('id', groupId)
         .select()
         .single();

       if (error) throw error;
       return { data, error: null };
     } catch (error) {
       return { data: null, error };
     }
   }
   ```
   Note: This is separate from the existing `updateGroup()` which has a narrow type signature. We create a new function rather than breaking the existing one.

2. **regenerateInviteCode()** - Calls the database function created in Plan 01:
   ```typescript
   export async function regenerateInviteCode(groupId: string) {
     try {
       const { data, error } = await supabase
         .rpc('regenerate_invite_code', { p_group_id: groupId });

       if (error) throw error;
       return { data: data as string, error: null };
     } catch (error) {
       return { data: null, error };
     }
   }
   ```

3. **Update joinGroup()** to support invite codes:
   Modify the existing `joinGroup()` function. Currently it receives a `groupId` (UUID) directly. Update it to first check if the input looks like a UUID; if not, treat it as an invite code and look up the group:
   ```typescript
   export async function joinGroup(codeOrId: string) {
     try {
       const { data: { user } } = await supabase.auth.getUser();
       if (!user) throw new Error('Not authenticated');

       let groupId = codeOrId;

       // If it doesn't look like a UUID, treat as invite code
       const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
       if (!uuidRegex.test(codeOrId)) {
         const { data: group, error: lookupError } = await supabase
           .from('groups')
           .select('id')
           .eq('invite_code', codeOrId.toUpperCase())
           .single();

         if (lookupError || !group) throw new Error('Invalid invite code');
         groupId = group.id;
       }

       // ... rest of existing joinGroup logic using groupId ...
     }
   }
   ```
   Keep all the existing logic (check if group exists, check if already member, insert group_members row, set default favorite) but use the resolved `groupId`.
  </action>
  <verify>
Read utils/groups.ts and verify:
- `updateGroupInfo()` exported with correct type signature
- `regenerateInviteCode()` exported, calls supabase.rpc
- `joinGroup()` updated to handle both UUIDs and invite codes
- Existing functions (`createGroup`, `fetchUserGroups`, `fetchGroupDetails`, `leaveGroup`, `updateGroup`) are unchanged
  </verify>
  <done>Three utility functions ready: updateGroupInfo for admin edits, regenerateInviteCode for code rotation, joinGroup updated for invite code lookup.</done>
</task>

<task type="auto">
  <name>Task 2: Create InviteCodeSection component</name>
  <files>components/groups/InviteCodeSection.tsx</files>
  <action>
Create `components/groups/InviteCodeSection.tsx`:

A self-contained component that displays the invite code with copy, share, and regenerate actions.

Props:
```typescript
interface InviteCodeSectionProps {
  inviteCode: string;
  groupId: string;
  groupName: string;
  onCodeRegenerated: (newCode: string) => void;
}
```

Implementation:
- Import `* as Clipboard from 'expo-clipboard'`
- Import `{ Share, Alert, TouchableOpacity, View, Text } from 'react-native'`
- Import `{ MaterialCommunityIcons } from '@expo/vector-icons'`
- Import `{ regenerateInviteCode } from '../../utils/groups'`
- Import `{ colors, spacing, borderRadius, shadows } from '../../constants/theme'`

Layout (matching app's burgundy/gold card style):
1. **Code display:** Large, bold, monospace-style text showing the 6-character invite code, centered in a slightly highlighted background area (burgundy[50] or cream[100]).

2. **Action buttons row** (3 buttons, evenly spaced):
   - **Copy** button: clipboard icon + "Copy" label. On press: `Clipboard.setStringAsync(inviteCode)` then show a brief Alert or feedback.
   - **Share** button: share icon + "Share" label. On press: `Share.share({ message: 'Join "${groupName}" on Wishlist App!\n\nInvite Code: ${inviteCode}', title: 'Join ${groupName}' })`
   - **Regenerate** button: refresh icon + "New Code" label. On press: show Alert.alert confirmation dialog ("Regenerate Code?", "The current code will stop working immediately. Anyone with the old code won't be able to join.", [Cancel, Regenerate(destructive)]). If confirmed, call `regenerateInviteCode(groupId)`, then call `onCodeRegenerated(newCode)`.

3. Style the buttons as compact pill-shaped buttons with icons, following the app's existing button patterns (burgundy[700] background or outlined).

4. Show a small info text below: "Share this code with friends to invite them to the group"
  </action>
  <verify>
Read the component file and verify:
- Imports expo-clipboard correctly
- Has copy, share, regenerate actions
- Regenerate shows confirmation dialog before executing
- Calls onCodeRegenerated callback after successful regeneration
- Follows app's visual theme (burgundy/gold colors)
  </verify>
  <done>InviteCodeSection component renders invite code with copy (clipboard), share (native), and regenerate (with confirmation) actions.</done>
</task>

<task type="auto">
  <name>Task 3: Implement group info editing and invite code section in settings screen</name>
  <files>app/group/[id]/settings.tsx</files>
  <action>
Update the settings screen skeleton (created in Plan 01) to replace the "Group Info" and "Invite Code" placeholder sections with real implementations.

**Group Info Section (admin only):**
Replace the placeholder with an editable form inside the white card:

1. **Group photo** at the top of the section:
   - Show current group photo using GroupAvatar component (imported from components/groups/GroupAvatar)
   - Below it, a "Change Photo" button
   - On press: launch image picker via expo-image-picker (use same 16:9 aspect, allowsEditing: true pattern), then call `uploadGroupPhotoFromUri(uri, groupId)` from lib/storage.ts, then call `updateGroupInfo(groupId, { photo_url: storagePath })`, then update local state.
   - Show loading indicator while uploading.

2. **Group name** input:
   - TextInput with current group name as default value
   - Style: white background, border, borderRadius.md, matching the profile settings screen pattern
   - Save button below (or auto-save on blur -- prefer explicit Save button for consistency with profile.tsx pattern)

3. **Group description** input:
   - TextInput with multiline={true}, numberOfLines={3}
   - Current description as default value (or empty string if null)
   - Shares the Save button with name

4. **Save button:**
   - "Save Changes" button, burgundy[700] background, disabled when saving or when no changes made
   - On press: call `updateGroupInfo(groupId, { name: newName.trim(), description: newDescription.trim() || null })`
   - Show success Alert on save, update local group state
   - If error, show error Alert

Track `hasChanges` by comparing current form values to original loaded values. Only enable Save when changes exist.

**Invite Code Section (all members):**
Replace the placeholder with the InviteCodeSection component:
```tsx
<InviteCodeSection
  inviteCode={group.invite_code}
  groupId={id}
  groupName={group.name}
  onCodeRegenerated={(newCode) => setGroup(prev => prev ? { ...prev, invite_code: newCode } : prev)}
/>
```

**Important implementation details:**
- Keep the "Members" and "Danger Zone" placeholders as-is (Plan 03 will replace them)
- The group state should include invite_code (already fetched in Plan 01's skeleton)
- Import GroupAvatar, uploadGroupPhotoFromUri, getGroupPhotoUrl, updateGroupInfo, InviteCodeSection
- Import ImagePicker from expo-image-picker for the photo change flow
- Use optimistic update pattern for name/description: update local state immediately, revert on error
  </action>
  <verify>
- Settings screen shows editable name, description, and photo change button for admins
- Name/description changes persist when saved (verify by re-loading the screen)
- Photo change launches image picker, uploads, and updates display
- InviteCodeSection renders for all members with copy/share/regenerate
- Non-admin users see invite code section but NOT group info editing section
- Run `npx tsc --noEmit 2>&1 | grep "settings" | head -20` to check for TypeScript errors
  </verify>
  <done>Group info editing works (name, description, photo) for admins. Invite code management works for all members (view, copy, share, regenerate). GSET-01, GSET-02, GSET-03, GSET-06 complete.</done>
</task>

</tasks>

<verification>
1. Admin can change group name, save, and see it reflected on reload
2. Admin can change group description, save, and see it reflected on reload
3. Admin can change group photo via image picker
4. Any member can see invite code on settings screen
5. Copy button copies invite code to clipboard (verify via paste)
6. Share button opens native share sheet with invite message
7. Regenerate shows confirmation, generates new code, old code no longer works
8. joinGroup() works with both UUID and invite code inputs
</verification>

<success_criteria>
- GSET-01 satisfied: Admin edits group name from settings
- GSET-02 satisfied: Admin edits group description from settings
- GSET-03 satisfied: Admin changes group photo from settings
- GSET-06 satisfied: Any member views and regenerates invite code
- All changes persist to database via Supabase
- No regression in existing group detail screen functionality
</success_criteria>

<output>
After completion, create `.planning/phases/15-group-settings/15-02-SUMMARY.md`
</output>
