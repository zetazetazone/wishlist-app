---
phase: 40-multi-wishlist-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/wishlists.ts
  - hooks/useWishlists.ts
  - types/database.types.ts
autonomous: true

must_haves:
  truths:
    - "Supabase types include wishlists table with id, name, emoji, sort_order, is_default"
    - "React Query hooks exist for fetching user's wishlists"
    - "CRUD functions exist for create, update, delete, reorder wishlists"
  artifacts:
    - path: "lib/wishlists.ts"
      provides: "Supabase CRUD functions for wishlists"
      exports: ["getWishlists", "createWishlist", "updateWishlist", "deleteWishlist", "reorderWishlists"]
    - path: "hooks/useWishlists.ts"
      provides: "React Query hooks for wishlists"
      exports: ["useWishlists", "useCreateWishlist", "useUpdateWishlist", "useDeleteWishlist", "useReorderWishlists"]
    - path: "types/database.types.ts"
      provides: "Wishlists table type definitions"
      contains: "wishlists"
  key_links:
    - from: "hooks/useWishlists.ts"
      to: "lib/wishlists.ts"
      via: "import"
      pattern: "import.*from.*wishlists"
    - from: "lib/wishlists.ts"
      to: "supabase"
      via: "supabase client"
      pattern: "supabase\\.from\\('wishlists'\\)"
---

<objective>
Create the data layer foundation for multi-wishlist management: Supabase CRUD functions, React Query hooks, and regenerated TypeScript types.

Purpose: All UI components in subsequent plans need a stable data layer. This plan establishes the service and hook patterns used throughout Phase 40.
Output: lib/wishlists.ts, hooks/useWishlists.ts, regenerated types/database.types.ts
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-database-foundation/37-01-SUMMARY.md

# Existing patterns to follow
@lib/wishlistItems.ts
@lib/shareIntent.ts
@hooks/useLanguage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Regenerate Supabase types and create wishlists lib</name>
  <files>types/database.types.ts, lib/wishlists.ts</files>
  <action>
1. Regenerate Supabase types to include wishlists table:
   ```bash
   npx supabase gen types typescript --local > types/database.types.ts
   ```

2. Create `lib/wishlists.ts` with CRUD functions:
   - `getWishlists()` - Fetch all wishlists for current user, ordered by sort_order
   - `createWishlist(data: { name: string; emoji?: string })` - Create new wishlist with next sort_order
   - `updateWishlist(id: string, data: { name?: string; emoji?: string })` - Update name/emoji (NOT is_default)
   - `deleteWishlist(id: string)` - Delete wishlist (must not be default - RLS enforces this)
   - `reorderWishlists(updates: Array<{ id: string; sort_order: number }>)` - Batch update sort_order

   Follow existing patterns from lib/wishlistItems.ts:
   - Import supabase from './supabase'
   - Export Wishlist type from Database['public']['Tables']['wishlists']['Row']
   - Each function logs errors to console.error
   - Each function throws Error with message on failure

   For createWishlist: Query max(sort_order) first, then insert with sort_order = max + 1.
   For reorderWishlists: Use Promise.all with individual updates (Supabase doesn't support bulk upsert easily).
  </action>
  <verify>
   - File types/database.types.ts contains "wishlists" table definition
   - File lib/wishlists.ts exports all 5 functions
   - No TypeScript errors: `npx tsc --noEmit lib/wishlists.ts`
  </verify>
  <done>
   Supabase types regenerated with wishlists table. lib/wishlists.ts exports getWishlists, createWishlist, updateWishlist, deleteWishlist, reorderWishlists functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create React Query hooks for wishlists</name>
  <files>hooks/useWishlists.ts</files>
  <action>
Create `hooks/useWishlists.ts` with React Query hooks:

1. `useWishlists()` - Query hook returning wishlists array
   - queryKey: ['wishlists']
   - queryFn: getWishlists()
   - staleTime: 30000 (30 seconds)

2. `useCreateWishlist()` - Mutation hook
   - mutationFn: createWishlist
   - onSuccess: invalidate ['wishlists']

3. `useUpdateWishlist()` - Mutation hook
   - mutationFn: ({ id, data }) => updateWishlist(id, data)
   - onSuccess: invalidate ['wishlists']

4. `useDeleteWishlist()` - Mutation hook
   - mutationFn: deleteWishlist
   - onSuccess: invalidate ['wishlists']

5. `useReorderWishlists()` - Mutation hook with optimistic updates
   - mutationFn: reorderWishlists
   - onMutate: optimistically update cache with new order
   - onError: rollback to previous order
   - onSuccess: invalidate ['wishlists']

Imports:
```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { getWishlists, createWishlist, updateWishlist, deleteWishlist, reorderWishlists, Wishlist } from '../lib/wishlists';
```

Note: Project uses @tanstack/react-query (v5 syntax), not react-query.
  </action>
  <verify>
   - File exports all 5 hooks
   - No TypeScript errors: `npx tsc --noEmit hooks/useWishlists.ts`
   - Import test compiles: `echo "import { useWishlists } from './hooks/useWishlists'" | npx tsc --noEmit --allowJs --checkJs --esModuleInterop --moduleResolution node --jsx react-jsx`
  </verify>
  <done>
   hooks/useWishlists.ts exports useWishlists, useCreateWishlist, useUpdateWishlist, useDeleteWishlist, useReorderWishlists hooks with proper React Query v5 patterns.
  </done>
</task>

</tasks>

<verification>
1. Types include wishlists: `grep -c "wishlists" types/database.types.ts` returns > 0
2. Lib exports all functions: `grep -E "^export (async )?function" lib/wishlists.ts`
3. Hooks export all hooks: `grep -E "^export (const|function)" hooks/useWishlists.ts`
4. No TypeScript errors in new files
</verification>

<success_criteria>
- types/database.types.ts includes wishlists table definition
- lib/wishlists.ts exports 5 CRUD functions
- hooks/useWishlists.ts exports 5 React Query hooks
- All files pass TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/40-multi-wishlist-ui/40-01-SUMMARY.md`
</output>
