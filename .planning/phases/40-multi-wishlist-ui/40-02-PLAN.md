---
phase: 40-multi-wishlist-ui
plan: 02
type: execute
wave: 1
depends_on: ["40-01"]
files_modified:
  - components/wishlist/WishlistManager.tsx
  - components/wishlist/WishlistCard.tsx
  - app/(app)/wishlist-manager.tsx
  - app/(app)/(tabs)/index.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can view list of all their wishlists"
    - "User can drag wishlists to reorder them (WISH-05)"
    - "User can see aggregate view of all items (WISH-07)"
    - "Default wishlist is visually distinguished"
    - "Aggregate toggle shows all items across all wishlists when enabled"
  artifacts:
    - path: "components/wishlist/WishlistManager.tsx"
      provides: "Main wishlist management screen component"
      min_lines: 100
    - path: "components/wishlist/WishlistCard.tsx"
      provides: "Draggable wishlist row item"
      min_lines: 50
    - path: "app/(app)/wishlist-manager.tsx"
      provides: "Route screen for wishlist management"
      min_lines: 20
  key_links:
    - from: "components/wishlist/WishlistManager.tsx"
      to: "hooks/useWishlists.ts"
      via: "import"
      pattern: "useWishlists|useReorderWishlists"
    - from: "components/wishlist/WishlistManager.tsx"
      to: "react-native-draggable-flatlist"
      via: "import"
      pattern: "DraggableFlatList"
    - from: "app/(app)/(tabs)/index.tsx"
      to: "aggregate view state"
      via: "navigation or context"
      pattern: "showAggregateView|aggregateMode"
---

<objective>
Create the wishlist management screen with drag-to-reorder functionality and aggregate item view toggle.

Purpose: Enable users to see all wishlists, reorder them by drag (WISH-05), and toggle aggregate view (WISH-07).
Output: WishlistManager component, WishlistCard component, wishlist-manager route, react-native-draggable-flatlist installed, aggregate view functionality
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-multi-wishlist-ui/40-01-PLAN.md

# Existing patterns
@components/groups/GroupPickerSheet.tsx
@app/(app)/(tabs)/index.tsx
@constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-native-draggable-flatlist and create WishlistCard</name>
  <files>package.json, components/wishlist/WishlistCard.tsx</files>
  <action>
1. Install dependency:
   ```bash
   npm install react-native-draggable-flatlist --legacy-peer-deps
   ```

2. Create `components/wishlist/WishlistCard.tsx`:
   - Props: `{ wishlist: Wishlist; onLongPress: () => void; isActive: boolean; onPress: () => void; onEdit: () => void; onDelete: () => void }`
   - Display: emoji (or default clipboard emoji), name, item count badge, default badge if is_default
   - Styling: Follow existing card patterns (colors.burgundy, borderRadius.md, shadows)
   - When isActive: Scale up slightly, add shadow, change background to highlight drag state
   - Action buttons: Edit icon (pencil), Delete icon (trash) - hide delete for default wishlist
   - Use MaterialCommunityIcons for icons (already in project)

   Follow GroupPickerSheet styling patterns:
   - colors.burgundy[600] for selected/active states
   - colors.cream[50] for backgrounds
   - spacing.md for padding
  </action>
  <verify>
   - Package installed: `grep "react-native-draggable-flatlist" package.json`
   - Component exports default: `grep "export default" components/wishlist/WishlistCard.tsx`
   - No TypeScript errors: `npx tsc --noEmit components/wishlist/WishlistCard.tsx`
  </verify>
  <done>
   react-native-draggable-flatlist installed. WishlistCard component created with drag state support and action buttons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WishlistManager component with DraggableFlatList</name>
  <files>components/wishlist/WishlistManager.tsx</files>
  <action>
Create `components/wishlist/WishlistManager.tsx`:

1. Imports:
   - DraggableFlatList, ScaleDecorator, RenderItemParams from react-native-draggable-flatlist
   - useWishlists, useReorderWishlists from hooks/useWishlists
   - WishlistCard from ./WishlistCard
   - GestureHandlerRootView from react-native-gesture-handler (required wrapper)

2. Component structure:
   ```typescript
   const WishlistManager = () => {
     const { data: wishlists, isLoading, refetch } = useWishlists();
     const reorderMutation = useReorderWishlists();
     const [showAggregateView, setShowAggregateView] = useState(false);
     // ... state for modals (edit, delete, create - wired in Plan 03)

     const handleDragEnd = ({ data }: { data: Wishlist[] }) => {
       const updates = data.map((w, index) => ({ id: w.id, sort_order: index }));
       reorderMutation.mutate(updates);
     };

     const renderItem = ({ item, drag, isActive }: RenderItemParams<Wishlist>) => (
       <ScaleDecorator>
         <WishlistCard
           wishlist={item}
           onLongPress={drag}
           isActive={isActive}
           onPress={() => handleWishlistPress(item)}
           onEdit={() => setEditingWishlist(item)}
           onDelete={() => setDeletingWishlist(item)}
         />
       </ScaleDecorator>
     );

     return (
       <GestureHandlerRootView style={{ flex: 1 }}>
         {/* Header with title and "Add Wishlist" button */}
         {/* Toggle for aggregate view (WISH-07) */}
         {/* DraggableFlatList */}
       </GestureHandlerRootView>
     );
   };
   ```

3. Header section:
   - Title: "My Wishlists" (use t('wishlists.myWishlists'))
   - Add button: "+" icon or "New Wishlist" button (onPress to be wired in Plan 03)
   - Aggregate toggle: Switch or button to toggle showAggregateView

4. List section:
   - DraggableFlatList with wishlists
   - RefreshControl for pull-to-refresh
   - Empty state when no wishlists (shouldn't happen due to default wishlist)

5. Loading state: ActivityIndicator centered

6. Note: Edit/Delete/Create modals will be connected in Plan 03. For now, just set state variables that will be used.
  </action>
  <verify>
   - Component renders without crash: manual test or storybook
   - DraggableFlatList imported correctly
   - No TypeScript errors: `npx tsc --noEmit components/wishlist/WishlistManager.tsx`
  </verify>
  <done>
   WishlistManager component created with DraggableFlatList for drag-to-reorder (WISH-05), header with add button, and aggregate view toggle state (WISH-07).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create wishlist-manager route</name>
  <files>app/(app)/wishlist-manager.tsx</files>
  <action>
Create `app/(app)/wishlist-manager.tsx` as a new route:

1. Import WishlistManager from components
2. Configure Stack.Screen options with header title
3. Export the component

```typescript
import { Stack } from 'expo-router';
import { useTranslation } from 'react-i18next';
import { WishlistManager } from '../../components/wishlist/WishlistManager';

export default function WishlistManagerScreen() {
  const { t } = useTranslation();

  return (
    <>
      <Stack.Screen
        options={{
          title: t('wishlists.manageWishlists'),
          headerBackTitle: t('common.back'),
        }}
      />
      <WishlistManager />
    </>
  );
}
```

Add navigation from main wishlist tab (index.tsx):
- Add a settings/manage button in the header or as a FAB
- On press: `router.push('/wishlist-manager')`

Note: Translations will be added as part of implementation (create keys in en.json, es.json, etc. under 'wishlists' namespace).
  </action>
  <verify>
   - Route file exists: `ls app/(app)/wishlist-manager.tsx`
   - Route exports default function
   - Manual navigation test: app opens wishlist-manager screen
  </verify>
  <done>
   wishlist-manager route created. Users can navigate to manage their wishlists.
  </done>
</task>

<task type="auto">
  <name>Task 4: Implement aggregate view functionality (WISH-07)</name>
  <files>app/(app)/(tabs)/index.tsx, components/wishlist/WishlistManager.tsx</files>
  <action>
Implement the actual aggregate view functionality when the toggle is enabled:

1. Update WishlistManager.tsx to persist aggregate view preference:
   ```typescript
   import AsyncStorage from '@react-native-async-storage/async-storage';

   const AGGREGATE_VIEW_KEY = 'wishlist_aggregate_view';

   // Load preference on mount
   useEffect(() => {
     AsyncStorage.getItem(AGGREGATE_VIEW_KEY).then(value => {
       if (value === 'true') setShowAggregateView(true);
     });
   }, []);

   // Save preference on toggle
   const handleToggleAggregate = async (value: boolean) => {
     setShowAggregateView(value);
     await AsyncStorage.setItem(AGGREGATE_VIEW_KEY, value.toString());
   };
   ```

2. Add navigation to index.tsx with aggregate mode:
   When navigating from wishlist-manager to main wishlist view, pass aggregate mode:
   ```typescript
   // In WishlistManager, when user taps on aggregate toggle:
   if (showAggregateView) {
     router.push({ pathname: '/', params: { aggregate: 'true' } });
   }
   ```

3. Update app/(app)/(tabs)/index.tsx to respect aggregate mode:

   Add useLocalSearchParams to read aggregate param:
   ```typescript
   import { useLocalSearchParams } from 'expo-router';

   const { aggregate } = useLocalSearchParams<{ aggregate?: string }>();
   const isAggregateMode = aggregate === 'true';
   ```

   Modify fetchWishlistItems to query all wishlists when in aggregate mode:
   ```typescript
   const fetchWishlistItems = async () => {
     try {
       setLoading(true);

       let query = supabase
         .from('wishlist_items')
         .select('*, wishlists!inner(name, emoji)')
         .eq('user_id', userId)
         .order('created_at', { ascending: false });

       // If NOT in aggregate mode and a specific wishlist is selected, filter by it
       // In aggregate mode, fetch ALL items across ALL wishlists
       if (!isAggregateMode && selectedWishlistId) {
         query = query.eq('wishlist_id', selectedWishlistId);
       }

       const { data, error } = await query;

       if (error) throw error;
       setItems(data || []);
     } catch (error) {
       console.error('Error fetching wishlist items:', error);
       Alert.alert(t('alerts.titles.error'), t('wishlist.failedToLoad'));
     } finally {
       setLoading(false);
     }
   };
   ```

4. Update header to show aggregate mode indicator:
   ```typescript
   // In header, show "All Wishlists" instead of specific wishlist name when aggregate
   <Text style={styles.headerTitle}>
     {isAggregateMode ? t('wishlists.allWishlists') : t('wishlist.title')}
   </Text>

   // Show item count from all wishlists
   <Text style={styles.headerSubtitle}>
     {items.length} {t('wishlist.itemType.gift', { count: items.length })}
     {isAggregateMode && ` - ${t('wishlists.fromAllWishlists')}`}
   </Text>
   ```

5. Optionally show wishlist badge on each item card when in aggregate mode:
   - This helps user identify which wishlist each item belongs to
   - Can show small emoji badge or subtle text with wishlist name

6. Add translations:
   ```json
   "allWishlists": "All Wishlists",
   "fromAllWishlists": "from all wishlists",
   "showAllItems": "Show All Items",
   "aggregateView": "View all items"
   ```
  </action>
  <verify>
   - Toggle aggregate view in WishlistManager
   - Navigate to main view with aggregate=true param
   - Items from ALL wishlists appear in the list
   - Header shows "All Wishlists" or similar indicator
   - Turning off aggregate returns to single-wishlist view
  </verify>
  <done>
   Aggregate view fully implemented (WISH-07). When enabled, users see all items across all their wishlists in a single view.
  </done>
</task>

</tasks>

<verification>
1. react-native-draggable-flatlist in package.json
2. WishlistCard component exists with drag state handling
3. WishlistManager component uses DraggableFlatList
4. wishlist-manager route accessible via router.push
5. Aggregate view toggle persists preference and shows all items when enabled (WISH-07)
6. No TypeScript errors in new components
</verification>

<success_criteria>
- User can see list of all wishlists on wishlist-manager screen
- User can long-press and drag to reorder wishlists (WISH-05)
- Reordering persists to database via reorderWishlists mutation
- Default wishlist is visually distinguished (badge or icon)
- Aggregate view toggle shows ALL items from ALL wishlists when enabled (WISH-07)
- Aggregate view preference persists across sessions
</success_criteria>

<output>
After completion, create `.planning/phases/40-multi-wishlist-ui/40-02-SUMMARY.md`
</output>
