---
phase: 40-multi-wishlist-ui
plan: 04
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - components/wishlist/WishlistPickerSheet.tsx
  - components/wishlist/MoveItemSheet.tsx
  - components/wishlist/OptionsSheet.tsx
  - app/(app)/add-from-url.tsx
  - app/(app)/shared-url.tsx
  - lib/wishlistItems.ts
autonomous: false

must_haves:
  truths:
    - "User can move items between wishlists (WISH-06)"
    - "User can choose which wishlist to add new item to (SCRAPE-10)"
    - "Add-from-url screen shows wishlist picker"
    - "Share intent flow uses wishlist picker"
    - "User can access move action from item options menu"
  artifacts:
    - path: "components/wishlist/WishlistPickerSheet.tsx"
      provides: "Bottom sheet for selecting target wishlist"
      min_lines: 80
    - path: "components/wishlist/MoveItemSheet.tsx"
      provides: "Bottom sheet for moving item to different wishlist"
      min_lines: 60
  key_links:
    - from: "components/wishlist/WishlistPickerSheet.tsx"
      to: "hooks/useWishlists.ts"
      via: "import"
      pattern: "useWishlists"
    - from: "app/(app)/add-from-url.tsx"
      to: "components/wishlist/WishlistPickerSheet.tsx"
      via: "import"
      pattern: "WishlistPickerSheet"
    - from: "components/wishlist/OptionsSheet.tsx"
      to: "components/wishlist/MoveItemSheet.tsx"
      via: "import and render"
      pattern: "MoveItemSheet"
---

<objective>
Enable item movement between wishlists and wishlist selection when adding items.

Purpose: Complete the multi-wishlist user experience by allowing item relocation (WISH-06) and wishlist selection during item creation (SCRAPE-10).
Output: WishlistPickerSheet, MoveItemSheet, updated add-from-url and shared-url screens, OptionsSheet with move action
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-multi-wishlist-ui/40-01-PLAN.md

# Existing patterns
@components/wishlist/GroupPickerSheet.tsx
@app/(app)/add-from-url.tsx
@app/(app)/shared-url.tsx
@components/wishlist/OptionsSheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WishlistPickerSheet component</name>
  <files>components/wishlist/WishlistPickerSheet.tsx</files>
  <action>
Create `components/wishlist/WishlistPickerSheet.tsx` following GroupPickerSheet pattern:

1. Props interface:
   ```typescript
   interface WishlistPickerSheetProps {
     visible: boolean;
     onClose: () => void;
     onSelect: (wishlistId: string) => void;
     selectedWishlistId?: string;
     title?: string; // Default: "Select Wishlist"
   }
   ```

2. Component structure:
   - Modal with fade animation, transparent background
   - Bottom sheet container (borderTopLeftRadius, borderTopRightRadius)
   - Handle bar at top
   - Title: title prop or t('wishlists.selectWishlist')
   - ScrollView with wishlist rows
   - Each row: emoji, name, default badge if applicable, radio/check for selection

3. Styling (follow GroupPickerSheet exactly):
   - colors.white for sheet background
   - borderRadius.xl for corners
   - spacing.lg for padding
   - colors.burgundy[600] for selected state border
   - colors.cream[50] for row backgrounds

4. Selection behavior:
   - Single select (radio button style)
   - On select: call onSelect(wishlistId), then onClose()
   - Show check mark for currently selected wishlist
  </action>
  <verify>
   - Component exports named function WishlistPickerSheet
   - Uses useWishlists hook to fetch wishlists
   - No TypeScript errors: `npx tsc --noEmit components/wishlist/WishlistPickerSheet.tsx`
  </verify>
  <done>
   WishlistPickerSheet created with single-select behavior for choosing target wishlist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MoveItemSheet and add move function</name>
  <files>components/wishlist/MoveItemSheet.tsx, lib/wishlistItems.ts</files>
  <action>
1. Add moveItemToWishlist function to lib/wishlistItems.ts:
   ```typescript
   /**
    * Move a wishlist item to a different wishlist
    */
   export async function moveItemToWishlist(
     itemId: string,
     targetWishlistId: string
   ): Promise<void> {
     const { error } = await supabase
       .from('wishlist_items')
       .update({ wishlist_id: targetWishlistId })
       .eq('id', itemId);

     if (error) {
       console.error('Failed to move item:', error);
       throw new Error(`Failed to move item: ${error.message}`);
     }
   }
   ```

2. Create `components/wishlist/MoveItemSheet.tsx`:

   Props interface:
   ```typescript
   interface MoveItemSheetProps {
     visible: boolean;
     onClose: () => void;
     item: WishlistItem;
     currentWishlistId: string;
     onMoved: () => void;
   }
   ```

   Component structure:
   - Uses WishlistPickerSheet internally
   - Title: "Move to Wishlist" or t('wishlists.moveToWishlist')
   - Pre-selects current wishlist
   - On select different wishlist: call moveItemToWishlist, then onMoved(), then onClose()
   - Show loading state during move

   Note: This sheet is essentially a wrapper around WishlistPickerSheet that handles the move operation.
  </action>
  <verify>
   - moveItemToWishlist function exported from lib/wishlistItems.ts
   - MoveItemSheet component exists and uses WishlistPickerSheet
   - No TypeScript errors
  </verify>
  <done>
   moveItemToWishlist function added. MoveItemSheet created for moving items between wishlists (WISH-06).
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate wishlist picker into add-from-url and shared-url</name>
  <files>app/(app)/add-from-url.tsx, app/(app)/shared-url.tsx</files>
  <action>
1. Update app/(app)/add-from-url.tsx:

   Add state for wishlist selection:
   ```typescript
   const [selectedWishlistId, setSelectedWishlistId] = useState<string | null>(null);
   const [showWishlistPicker, setShowWishlistPicker] = useState(false);
   const { data: wishlists } = useWishlists();
   ```

   On component mount, default to user's default wishlist:
   ```typescript
   useEffect(() => {
     if (wishlists && !selectedWishlistId) {
       const defaultWishlist = wishlists.find(w => w.is_default);
       if (defaultWishlist) setSelectedWishlistId(defaultWishlist.id);
     }
   }, [wishlists]);
   ```

   Add wishlist selector UI above the save button:
   - Display: selected wishlist emoji + name
   - TouchableOpacity: opens WishlistPickerSheet
   - Label: "Add to:" or t('wishlists.addTo')

   Update save logic to use selectedWishlistId instead of hardcoded default:
   ```typescript
   // In handleSave function, update the insert to use selectedWishlistId
   wishlist_id: selectedWishlistId,
   ```

2. Update app/(app)/shared-url.tsx:

   Similar changes:
   - Add selectedWishlistId state
   - Default to default wishlist
   - Add wishlist selector UI (can be simpler - just show emoji + tap to change)
   - Update quickAddToDefaultWishlist call or inline the insert to use selectedWishlistId

   Note: For quick-add flow, keep the "one-tap" experience by defaulting to default wishlist but showing small "Change" link.

3. Add translations for wishlist picker:
   ```json
   "addTo": "Add to",
   "selectWishlist": "Select Wishlist",
   "moveToWishlist": "Move to Wishlist",
   "itemMoved": "Item moved to {{name}}"
   ```
  </action>
  <verify>
   - add-from-url shows wishlist picker
   - shared-url allows changing target wishlist
   - Items save with correct wishlist_id
   - Manual test: add item to non-default wishlist, verify it appears there
  </verify>
  <done>
   add-from-url and shared-url screens integrated with WishlistPickerSheet. Users can choose which wishlist to add items to (SCRAPE-10).
  </done>
</task>

<task type="auto">
  <name>Task 4: Wire MoveItemSheet into OptionsSheet</name>
  <files>components/wishlist/OptionsSheet.tsx</files>
  <action>
Update OptionsSheet.tsx to add "Move to Wishlist" action:

1. Add imports at top:
   ```typescript
   import { MoveItemSheet } from './MoveItemSheet';
   ```

2. Add state for MoveItemSheet visibility:
   ```typescript
   const [showMoveSheet, setShowMoveSheet] = useState(false);
   ```

3. Update OptionsSheetProps interface to include onMoved callback:
   ```typescript
   interface OptionsSheetProps {
     onFavoriteToggle: (item: WishlistItem) => void;
     onPriorityChange: (itemId: string, priority: number) => void;
     onDelete: (itemId: string) => Promise<void>;
     isFavorite: (itemId: string) => boolean;
     onMoved?: () => void; // Called after item is moved to refresh list
   }
   ```

4. Add handleMove function:
   ```typescript
   const handleMove = useCallback(() => {
     setShowMoveSheet(true);
   }, []);

   const handleMoved = useCallback(() => {
     setShowMoveSheet(false);
     handleClose();
     onMoved?.();
   }, [handleClose, onMoved]);
   ```

5. Add "Move to Wishlist" button in actionsSection, between Share and Edit:
   ```tsx
   <Pressable
     style={({ pressed }) => [
       styles.actionButton,
       pressed && styles.actionButtonPressed,
     ]}
     onPress={handleMove}
   >
     <MaterialCommunityIcons
       name="folder-move"
       size={24}
       color={colors.burgundy[400]}
     />
     <Text style={styles.actionText}>{t('wishlists.moveToWishlist')}</Text>
   </Pressable>
   ```

6. Render MoveItemSheet at bottom of component (after the Modal, sibling to it):
   ```tsx
   {item && (
     <MoveItemSheet
       visible={showMoveSheet}
       onClose={() => setShowMoveSheet(false)}
       item={item}
       currentWishlistId={item.wishlist_id}
       onMoved={handleMoved}
     />
   )}
   ```

7. Update callers (index.tsx) to pass onMoved prop:
   ```tsx
   <OptionsSheet
     ref={optionsSheetRef}
     onFavoriteToggle={handleFavoriteToggle}
     onPriorityChange={handlePriorityChange}
     onDelete={handleOptionsDelete}
     isFavorite={isFavorite}
     onMoved={handleRefresh} // Refresh list after move
   />
   ```
  </action>
  <verify>
   - OptionsSheet shows "Move to Wishlist" option
   - Tapping it opens MoveItemSheet
   - Selecting a different wishlist moves the item
   - List refreshes after move
   - No TypeScript errors: `npx tsc --noEmit components/wishlist/OptionsSheet.tsx`
  </verify>
  <done>
   MoveItemSheet wired into OptionsSheet. Users can access "Move to Wishlist" from item options menu (WISH-06 complete).
  </done>
</task>

</tasks>

<verification>
1. WishlistPickerSheet renders list of user's wishlists
2. MoveItemSheet moves item to selected wishlist (WISH-06)
3. OptionsSheet shows "Move to Wishlist" action that opens MoveItemSheet
4. add-from-url screen shows wishlist selector (SCRAPE-10)
5. shared-url screen shows wishlist selector
6. Items saved with correct wishlist_id
7. No TypeScript errors in modified files
</verification>

<success_criteria>
- User can move items between wishlists via MoveItemSheet from item options menu (WISH-06)
- User can choose target wishlist when adding from URL (SCRAPE-10)
- User can choose target wishlist when sharing URL
- Default wishlist pre-selected for new items
- Wishlist picker shows emoji + name + default badge
</success_criteria>

<output>
After completion, create `.planning/phases/40-multi-wishlist-ui/40-04-SUMMARY.md`
</output>
