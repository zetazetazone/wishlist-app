---
phase: 29-foundation-tooling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/i18n/index.ts
  - src/i18n/resources.ts
  - src/i18n/types/i18next.d.ts
  - src/i18n/locales/en.json
  - src/i18n/locales/es.json
  - tsconfig.json
autonomous: true

must_haves:
  truths:
    - "expo-localization, i18next, and react-i18next are installed and importable"
    - "i18next initializes with device language detection using expo-localization"
    - "i18next falls back to English when device language is not supported"
    - "Translation keys have TypeScript autocomplete in IDE"
    - "Invalid translation keys cause TypeScript compile errors"
  artifacts:
    - path: "src/i18n/index.ts"
      provides: "i18next initialization with device detection"
      exports: ["i18n", "initI18n", "LANGUAGE_KEY", "SUPPORTED_LANGUAGES", "SupportedLanguage"]
    - path: "src/i18n/resources.ts"
      provides: "Translation resources with type inference"
      exports: ["resources", "defaultNS"]
    - path: "src/i18n/types/i18next.d.ts"
      provides: "TypeScript module augmentation for type-safe keys"
      contains: "CustomTypeOptions"
    - path: "src/i18n/locales/en.json"
      provides: "English translation file"
      min_lines: 15
    - path: "src/i18n/locales/es.json"
      provides: "Spanish translation file"
      min_lines: 15
  key_links:
    - from: "src/i18n/index.ts"
      to: "expo-localization"
      via: "getLocales() import"
      pattern: "getLocales.*expo-localization"
    - from: "src/i18n/index.ts"
      to: "src/i18n/resources.ts"
      via: "resources import"
      pattern: "import.*resources.*from.*resources"
    - from: "src/i18n/types/i18next.d.ts"
      to: "src/i18n/resources.ts"
      via: "type reference"
      pattern: "typeof resources"
---

<objective>
Install i18n dependencies and create core configuration with TypeScript type safety.

Purpose: Establish the i18n foundation that Phase 30-32 build upon. Device language detection, fallback logic, and type-safe translation keys enable all subsequent localization work.

Output: Working i18next configuration with TypeScript autocomplete for translation keys.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-foundation-tooling/29-RESEARCH.md

# Existing patterns to follow
@lib/supabase.ts
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install i18n dependencies</name>
  <files>package.json, package-lock.json</files>
  <action>
Install required dependencies using npx expo install for SDK version resolution:

```bash
npx expo install expo-localization
npm install i18next@^25.8.5 react-i18next@^16.5.4
```

Verify installation by checking package.json contains:
- expo-localization: ~17.0.x (SDK 54 compatible version)
- i18next: ^25.8.5
- react-i18next: ^16.5.4

Note: AsyncStorage is already installed (used by Supabase auth in lib/supabase.ts).
  </action>
  <verify>
```bash
grep -E "expo-localization|i18next|react-i18next" package.json
# Should show all 3 packages with correct versions
```
  </verify>
  <done>All three i18n packages appear in package.json dependencies with correct version ranges</done>
</task>

<task type="auto">
  <name>Task 2: Create i18n configuration with device detection</name>
  <files>src/i18n/index.ts, src/i18n/resources.ts, src/i18n/locales/en.json, src/i18n/locales/es.json</files>
  <action>
Create directory structure: `src/i18n/`, `src/i18n/locales/`

**src/i18n/locales/en.json** - Minimal English translations for Phase 29 verification:
```json
{
  "common": {
    "loading": "Loading...",
    "error": "Error",
    "cancel": "Cancel",
    "save": "Save",
    "ok": "OK"
  },
  "settings": {
    "language": "Language",
    "languageDescription": "Choose your preferred language"
  },
  "languages": {
    "en": "English",
    "es": "Spanish"
  }
}
```

**src/i18n/locales/es.json** - Matching Spanish translations:
```json
{
  "common": {
    "loading": "Cargando...",
    "error": "Error",
    "cancel": "Cancelar",
    "save": "Guardar",
    "ok": "OK"
  },
  "settings": {
    "language": "Idioma",
    "languageDescription": "Elige tu idioma preferido"
  },
  "languages": {
    "en": "Ingles",
    "es": "Espanol"
  }
}
```

**src/i18n/resources.ts** - Resources with `as const` for type inference:
```typescript
import en from './locales/en.json';
import es from './locales/es.json';

export const resources = {
  en: { translation: en },
  es: { translation: es },
} as const;

export const defaultNS = 'translation';
```

**src/i18n/index.ts** - i18next initialization with device detection:
```typescript
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import { getLocales } from 'expo-localization';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { resources, defaultNS } from './resources';

export const LANGUAGE_KEY = '@app_language';
export const SUPPORTED_LANGUAGES = ['en', 'es'] as const;
export type SupportedLanguage = typeof SUPPORTED_LANGUAGES[number];

// Detect device language with fallback to English
const getDeviceLanguage = (): SupportedLanguage => {
  const locales = getLocales();
  const deviceLang = locales[0]?.languageCode;

  if (deviceLang && SUPPORTED_LANGUAGES.includes(deviceLang as SupportedLanguage)) {
    return deviceLang as SupportedLanguage;
  }
  return 'en';
};

// Initialize with async language detection
export const initI18n = async (): Promise<typeof i18n> => {
  // Try local storage first, then device language
  const savedLanguage = await AsyncStorage.getItem(LANGUAGE_KEY);
  const initialLanguage = (savedLanguage as SupportedLanguage) || getDeviceLanguage();

  await i18n.use(initReactI18next).init({
    resources,
    lng: initialLanguage,
    fallbackLng: 'en',
    defaultNS,
    interpolation: {
      escapeValue: false // React already escapes
    },
    react: {
      useSuspense: false, // Disable for React Native
      bindI18n: 'languageChanged loaded', // Re-render on language change
    },
    // Development: log missing keys
    saveMissing: __DEV__,
    missingKeyHandler: (_lngs, _ns, key) => {
      if (__DEV__) {
        console.warn(`[i18n] Missing translation key: ${key}`);
      }
    },
  });

  return i18n;
};

export { i18n };
export default i18n;
```

Key implementation details:
- SUPPORTED_LANGUAGES as const enables type inference
- getDeviceLanguage() uses expo-localization's getLocales()[0].languageCode
- Falls back to 'en' when device language not in SUPPORTED_LANGUAGES
- AsyncStorage priority over device detection (Phase 29 only persists locally)
- bindI18n: 'languageChanged loaded' ensures UI re-renders on language change
- __DEV__ logging for missing keys aids development
  </action>
  <verify>
```bash
# Verify file structure
ls -la src/i18n/
ls -la src/i18n/locales/

# Verify TypeScript compiles
npx tsc --noEmit src/i18n/index.ts src/i18n/resources.ts
```
  </verify>
  <done>
- src/i18n/index.ts exports initI18n, i18n, LANGUAGE_KEY, SUPPORTED_LANGUAGES, SupportedLanguage
- src/i18n/resources.ts exports resources object with as const
- Both locale JSON files exist with matching key structure
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create TypeScript type declarations for type-safe keys</name>
  <files>src/i18n/types/i18next.d.ts, tsconfig.json</files>
  <action>
Create directory: `src/i18n/types/`

**src/i18n/types/i18next.d.ts** - Module augmentation for type-safe keys:
```typescript
// TypeScript module augmentation for i18next
// Enables autocomplete and compile-time validation for translation keys
// Source: https://www.i18next.com/overview/typescript

import 'i18next';
import type { resources } from '../resources';

declare module 'i18next' {
  interface CustomTypeOptions {
    defaultNS: 'translation';
    resources: typeof resources['en'];
  }
}
```

**tsconfig.json** - Ensure src/ is included in TypeScript compilation:
Check tsconfig.json and verify:
1. "include" array contains "src/**/*" (or src is not explicitly excluded)
2. If "include" is not set, TypeScript includes all .ts/.tsx by default

If tsconfig.json needs updating, add:
```json
{
  "include": ["**/*.ts", "**/*.tsx", ".expo/types/**/*.ts", "expo-env.d.ts", "src/**/*"]
}
```

Verify type safety by creating a temporary test file:
```typescript
// test-i18n-types.ts (delete after verification)
import { useTranslation } from 'react-i18next';

function TestComponent() {
  const { t } = useTranslation();

  // These should have autocomplete:
  t('common.loading');
  t('settings.language');

  // This should show error in IDE (invalid key):
  // t('invalid.nonexistent.key');
}
```
  </action>
  <verify>
```bash
# Verify declaration file exists
cat src/i18n/types/i18next.d.ts

# Verify TypeScript recognizes the module augmentation
npx tsc --noEmit

# Test that invalid keys would fail (optional verification)
# Create temporary file with invalid key and verify tsc catches it
```
  </verify>
  <done>
- src/i18n/types/i18next.d.ts exists with CustomTypeOptions interface
- tsconfig.json includes src/ directory
- npx tsc --noEmit completes successfully
- Using t('invalid.key') in code would produce TypeScript error
  </done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - should pass with no errors
2. Verify expo-localization, i18next, react-i18next in package.json
3. Verify file structure:
   - src/i18n/index.ts
   - src/i18n/resources.ts
   - src/i18n/types/i18next.d.ts
   - src/i18n/locales/en.json
   - src/i18n/locales/es.json
4. Verify getLocales import from expo-localization in index.ts
5. Verify SUPPORTED_LANGUAGES includes 'en' and 'es'
6. Verify fallbackLng is 'en' in i18next config
</verification>

<success_criteria>
- All three i18n packages installed with correct versions
- i18next configured with expo-localization device detection
- Fallback to English when device language not supported
- TypeScript module augmentation enables autocomplete for translation keys
- Minimal en/es translation files created with matching structure
- npx tsc --noEmit passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/29-foundation-tooling/29-01-SUMMARY.md`
</output>
