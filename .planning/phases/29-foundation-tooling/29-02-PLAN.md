---
phase: 29-foundation-tooling
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - lib/language.ts
  - hooks/useLanguage.ts
autonomous: true

must_haves:
  truths:
    - "User's language preference persists across app restarts via AsyncStorage"
    - "getLanguagePreference() returns saved language or 'en' default"
    - "setLanguagePreference() updates i18next and AsyncStorage atomically"
    - "useLanguage hook exposes currentLanguage, changeLanguage, and isLoading"
  artifacts:
    - path: "lib/language.ts"
      provides: "Language preference service layer"
      exports: ["getLanguagePreference", "setLanguagePreference", "LANGUAGE_KEY", "SUPPORTED_LANGUAGES", "SupportedLanguage"]
    - path: "hooks/useLanguage.ts"
      provides: "React hook for language state and change function"
      exports: ["useLanguage"]
  key_links:
    - from: "lib/language.ts"
      to: "src/i18n/index.ts"
      via: "i18n import for changeLanguage"
      pattern: "i18n.*changeLanguage"
    - from: "lib/language.ts"
      to: "@react-native-async-storage/async-storage"
      via: "AsyncStorage import"
      pattern: "AsyncStorage.*setItem|getItem"
    - from: "hooks/useLanguage.ts"
      to: "lib/language.ts"
      via: "service imports"
      pattern: "import.*from.*lib/language"
    - from: "hooks/useLanguage.ts"
      to: "react-i18next"
      via: "useTranslation hook"
      pattern: "useTranslation.*react-i18next"
---

<objective>
Create language service layer and useLanguage hook for preference persistence.

Purpose: Complete the local persistence story (PERS-01). The language service provides get/set operations with AsyncStorage, and the hook exposes language state to React components. Phase 30 will extend this with server sync.

Output: Working language persistence that survives app restarts.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-foundation-tooling/29-RESEARCH.md
@.planning/phases/29-foundation-tooling/29-01-SUMMARY.md

# Existing patterns to follow
@lib/supabase.ts
@hooks/usePushNotifications.ts

# Dependencies from Plan 01
@src/i18n/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create language service layer</name>
  <files>lib/language.ts</files>
  <action>
Create lib/language.ts following existing service patterns in lib/:

```typescript
/**
 * Language preference service
 *
 * Handles language preference get/set with local persistence via AsyncStorage.
 * Phase 30 will extend this with server sync to Supabase.
 */

import AsyncStorage from '@react-native-async-storage/async-storage';
import i18n from '../src/i18n';

// Re-export from i18n for convenience
export { LANGUAGE_KEY, SUPPORTED_LANGUAGES } from '../src/i18n';
export type { SupportedLanguage } from '../src/i18n';

import { LANGUAGE_KEY, SUPPORTED_LANGUAGES, SupportedLanguage } from '../src/i18n';

/**
 * Get current language preference from AsyncStorage
 * @returns Saved language or 'en' as default
 */
export async function getLanguagePreference(): Promise<SupportedLanguage> {
  try {
    const saved = await AsyncStorage.getItem(LANGUAGE_KEY);
    if (saved && SUPPORTED_LANGUAGES.includes(saved as SupportedLanguage)) {
      return saved as SupportedLanguage;
    }
  } catch (error) {
    console.warn('[language] Failed to read language preference:', error);
  }
  return 'en';
}

/**
 * Set language preference - updates i18next and persists to AsyncStorage
 * @param language - The language code to set ('en' or 'es')
 *
 * Note: Phase 30 will add optional userId parameter for server sync
 */
export async function setLanguagePreference(language: SupportedLanguage): Promise<void> {
  // Validate language code
  if (!SUPPORTED_LANGUAGES.includes(language)) {
    console.warn(`[language] Invalid language code: ${language}, falling back to 'en'`);
    language = 'en';
  }

  try {
    // 1. Update i18next (triggers UI re-render via bindI18n config)
    await i18n.changeLanguage(language);

    // 2. Persist to AsyncStorage
    await AsyncStorage.setItem(LANGUAGE_KEY, language);
  } catch (error) {
    console.error('[language] Failed to set language preference:', error);
    throw error;
  }
}

/**
 * Check if a language code is supported
 */
export function isSupported(lang: string): lang is SupportedLanguage {
  return SUPPORTED_LANGUAGES.includes(lang as SupportedLanguage);
}
```

Key implementation details:
- Follow existing lib/ patterns (see lib/supabase.ts for style)
- Re-exports constants from src/i18n for convenience
- getLanguagePreference returns 'en' on any error (fail-safe)
- setLanguagePreference validates input and updates both i18next and AsyncStorage
- isSupported helper for type guards
- JSDoc comments note Phase 30 extension point for server sync
  </action>
  <verify>
```bash
# Verify file exists and exports correctly
cat lib/language.ts

# Verify TypeScript compiles
npx tsc --noEmit lib/language.ts
```
  </verify>
  <done>
- lib/language.ts exists with getLanguagePreference, setLanguagePreference, isSupported functions
- Re-exports LANGUAGE_KEY, SUPPORTED_LANGUAGES, SupportedLanguage from src/i18n
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useLanguage hook</name>
  <files>hooks/useLanguage.ts</files>
  <action>
Create hooks/useLanguage.ts following existing hook patterns:

```typescript
/**
 * useLanguage hook
 *
 * Exposes current language state and change function for React components.
 * Integrates with react-i18next for reactive updates.
 *
 * Usage:
 * ```tsx
 * const { currentLanguage, changeLanguage, isLoading, supportedLanguages } = useLanguage();
 *
 * // In settings screen:
 * <Button onPress={() => changeLanguage('es')}>Switch to Spanish</Button>
 * ```
 */

import { useState, useCallback } from 'react';
import { useTranslation } from 'react-i18next';
import {
  setLanguagePreference,
  SUPPORTED_LANGUAGES,
  SupportedLanguage
} from '../lib/language';

export interface UseLanguageReturn {
  /** Current active language code */
  currentLanguage: SupportedLanguage;
  /** Change language with loading state management */
  changeLanguage: (language: SupportedLanguage) => Promise<void>;
  /** Loading state during language change */
  isLoading: boolean;
  /** List of supported language codes */
  supportedLanguages: readonly SupportedLanguage[];
}

export function useLanguage(): UseLanguageReturn {
  const { i18n } = useTranslation();
  const [isLoading, setIsLoading] = useState(false);

  const currentLanguage = i18n.language as SupportedLanguage;

  const changeLanguage = useCallback(async (language: SupportedLanguage) => {
    if (language === currentLanguage) {
      return; // No-op if same language
    }

    setIsLoading(true);
    try {
      await setLanguagePreference(language);
      // Note: i18n.language updates automatically via setLanguagePreference
      // UI re-renders due to react-i18next bindI18n config
    } catch (error) {
      console.error('[useLanguage] Failed to change language:', error);
      throw error;
    } finally {
      setIsLoading(false);
    }
  }, [currentLanguage]);

  return {
    currentLanguage,
    changeLanguage,
    isLoading,
    supportedLanguages: SUPPORTED_LANGUAGES,
  };
}
```

Key implementation details:
- Uses useTranslation from react-i18next to get current i18n instance
- currentLanguage is reactive (updates when i18n.language changes)
- changeLanguage is memoized with useCallback
- isLoading state for UI feedback during language change
- Early return if setting same language (no-op)
- Exposes supportedLanguages for language picker UI
- TypeScript interface documents return type
  </action>
  <verify>
```bash
# Verify file exists
cat hooks/useLanguage.ts

# Verify TypeScript compiles
npx tsc --noEmit hooks/useLanguage.ts
```
  </verify>
  <done>
- hooks/useLanguage.ts exports useLanguage hook
- Hook returns currentLanguage, changeLanguage, isLoading, supportedLanguages
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify complete i18n infrastructure</name>
  <files>N/A</files>
  <action>
Run comprehensive verification of the complete Phase 29 i18n infrastructure:

1. **TypeScript compilation check:**
```bash
npx tsc --noEmit
```

2. **Verify all required exports:**
```bash
# Check src/i18n/index.ts exports
grep -E "export (const|type|function|async)" src/i18n/index.ts

# Check lib/language.ts exports
grep -E "export (const|type|function|async)" lib/language.ts

# Check hooks/useLanguage.ts exports
grep -E "export" hooks/useLanguage.ts
```

3. **Verify file structure:**
```bash
ls -la src/i18n/
ls -la src/i18n/locales/
ls -la src/i18n/types/
```

4. **Verify key patterns:**
```bash
# Device language detection
grep "getLocales" src/i18n/index.ts

# AsyncStorage usage
grep "AsyncStorage" src/i18n/index.ts lib/language.ts

# Fallback to English
grep "fallbackLng.*en" src/i18n/index.ts
```

5. **Verify package.json dependencies:**
```bash
grep -E "expo-localization|i18next|react-i18next" package.json
```

Document any issues found for SUMMARY.md.
  </action>
  <verify>
All verification commands pass:
- npx tsc --noEmit exits with code 0
- All expected exports are present
- File structure matches plan
- Key patterns (getLocales, AsyncStorage, fallbackLng) are present
  </verify>
  <done>
Phase 29 i18n infrastructure is complete and verified:
- Dependencies installed
- i18next configured with device detection and English fallback
- TypeScript type safety enabled
- Language service provides AsyncStorage persistence
- useLanguage hook ready for UI integration
  </done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - passes with no errors
2. lib/language.ts exports getLanguagePreference, setLanguagePreference
3. hooks/useLanguage.ts exports useLanguage
4. useLanguage returns currentLanguage, changeLanguage, isLoading, supportedLanguages
5. AsyncStorage used for persistence (grep confirms pattern)
6. Complete file structure exists

Phase 29 Success Criteria checklist:
- [x] INFRA-01: expo-localization.getLocales() called in src/i18n/index.ts
- [x] INFRA-02: SUPPORTED_LANGUAGES array with 'en' fallback implemented
- [x] INFRA-03: i18next.d.ts file created with CustomTypeOptions
- [x] PERS-01: AsyncStorage integration with LANGUAGE_KEY constant
</verification>

<success_criteria>
- lib/language.ts provides get/set functions with AsyncStorage persistence
- hooks/useLanguage.ts exposes reactive language state to components
- Changing language updates both i18next and AsyncStorage atomically
- useLanguage isLoading state enables UI feedback
- All TypeScript compiles without errors
- Phase 29 requirements INFRA-01, INFRA-02, INFRA-03, PERS-01 complete
</success_criteria>

<output>
After completion, create `.planning/phases/29-foundation-tooling/29-02-SUMMARY.md`
</output>
