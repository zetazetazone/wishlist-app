---
phase: 02-celebrations-coordination
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - lib/chat.ts
  - lib/contributions.ts
  - components/chat/ChatBubble.tsx
  - components/chat/ChatInput.tsx
  - components/chat/ChatList.tsx
  - components/celebrations/ContributionProgress.tsx
  - components/celebrations/ContributionModal.tsx
  - app/(app)/celebration/[id].tsx
autonomous: false

must_haves:
  truths:
    - "Users can send text messages in celebration chat rooms"
    - "Messages appear in real-time without refresh"
    - "Users can link chat messages to specific wishlist items"
    - "Celebrant CANNOT see chat messages (enforced by RLS)"
    - "Contribution tracking shows who spent what per celebration"
    - "Progress bar shows total contributed vs optional target"
    - "Contributions can be added/updated anytime during planning"
  artifacts:
    - path: "lib/chat.ts"
      provides: "Chat message CRUD and realtime subscriptions"
      exports: ["sendMessage", "getMessages", "useChatSubscription"]
    - path: "lib/contributions.ts"
      provides: "Contribution tracking per celebration"
      exports: ["addContribution", "updateContribution", "getContributions", "getCelebrationTotal"]
    - path: "components/chat/ChatList.tsx"
      provides: "FlashList-based chat message list with realtime updates"
      min_lines: 80
    - path: "components/celebrations/ContributionProgress.tsx"
      provides: "Progress bar showing total vs target"
      min_lines: 40
    - path: "app/(app)/celebration/[id].tsx"
      provides: "Updated celebration detail with chat and contribution UI"
      min_lines: 250
  key_links:
    - from: "lib/chat.ts"
      to: "supabase realtime"
      via: "channel subscription"
      pattern: "supabase\\.channel\\("
    - from: "components/chat/ChatList.tsx"
      to: "lib/chat.ts"
      via: "useChatSubscription hook"
      pattern: "useChatSubscription"
    - from: "lib/contributions.ts"
      to: "celebration_contributions table"
      via: "supabase queries"
      pattern: "from\\('celebration_contributions'\\)"
---

<objective>
Add real-time secret chat and contribution tracking to celebrations.

Purpose: Enables group members (except celebrant) to coordinate gift purchases through chat and track who's contributing what to the gift fund. This completes the core coordination functionality.

Output:
- Real-time chat utilities with proper subscription cleanup
- Chat UI components with FlashList
- Contribution tracking with progress visualization
- Updated celebration detail screen with integrated chat and contributions
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-celebrations-coordination/02-RESEARCH.md
@.planning/phases/02-celebrations-coordination/02-CONTEXT.md
@.planning/phases/02-celebrations-coordination/02-01-SUMMARY.md
@lib/celebrations.ts
@types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chat utilities with realtime subscriptions</name>
  <files>
    lib/chat.ts
  </files>
  <action>
Create chat utilities following patterns from 02-RESEARCH.md.

**Export these functions:**

1. `getMessages(chatRoomId: string): Promise<ChatMessage[]>`
   - Fetch messages ordered by created_at ASC
   - Include sender info (display_name, avatar_url) via join
   - RLS automatically excludes celebrant
   - Handle linked_item_id with wishlist_items join

2. `sendMessage(chatRoomId: string, content: string, linkedItemId?: string): Promise<ChatMessage>`
   - Insert message with sender_id = current user
   - Optional linked_item_id for CHAT-03 (linking to wishlist items)
   - RLS INSERT policy validates celebrant exclusion
   - Return created message

3. `useChatSubscription(chatRoomId: string, onNewMessage: (msg: ChatMessage) => void): void`
   - React hook for realtime subscription
   - Subscribe to postgres_changes INSERT on chat_messages table
   - Filter by chat_room_id
   - CRITICAL: Return cleanup function in useEffect
   - Pattern from RESEARCH.md:
     ```typescript
     const channel = supabase
       .channel(`chat:${chatRoomId}`)
       .on('postgres_changes', {
         event: 'INSERT',
         schema: 'public',
         table: 'chat_messages',
         filter: `chat_room_id=eq.${chatRoomId}`
       }, callback)
       .subscribe();

     return () => supabase.removeChannel(channel);
     ```

4. `getChatRoomForCelebration(celebrationId: string): Promise<ChatRoom | null>`
   - Get chat_room by celebration_id
   - Returns null if celebrant tries to access (RLS blocks)

**Types:**
```typescript
interface ChatMessage {
  id: string;
  chat_room_id: string;
  sender_id: string;
  content: string;
  linked_item_id: string | null;
  created_at: string;
  sender?: {
    display_name: string;
    avatar_url: string | null;
  };
  linked_item?: {
    title: string;
    price: number | null;
  };
}

interface ChatRoom {
  id: string;
  celebration_id: string;
  created_at: string;
}
```

**Race Condition Prevention:**
Note in code comment that caller should:
1. Fetch initial messages
2. Set up subscription
3. Handle potential duplicates by message ID
  </action>
  <verify>
1. `grep -c "export" lib/chat.ts` returns at least 4
2. `grep "supabase.channel" lib/chat.ts` finds realtime subscription
3. `grep "removeChannel" lib/chat.ts` finds cleanup pattern
4. `npx tsc --noEmit` passes
  </verify>
  <done>
lib/chat.ts exports message CRUD and realtime subscription hook with proper cleanup to prevent memory leaks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create chat UI components and contribution utilities</name>
  <files>
    components/chat/ChatBubble.tsx
    components/chat/ChatInput.tsx
    components/chat/ChatList.tsx
    lib/contributions.ts
    components/celebrations/ContributionProgress.tsx
    components/celebrations/ContributionModal.tsx
  </files>
  <action>
**Create ChatBubble.tsx:**
- Props: message, isOwnMessage, onLinkedItemPress
- Different styling for own messages (right-aligned, different background)
- Show sender name + avatar for other users' messages
- Show linked wishlist item as tappable card if linked_item_id exists
- Timestamp in small text (use date-fns formatDistanceToNow)

**Create ChatInput.tsx:**
- Props: onSend, disabled, placeholder
- TextInput for message content
- Send button (disabled when empty or while sending)
- Optional: Item link button (opens wishlist picker - can be placeholder for now)
- Handle keyboard properly (KeyboardAvoidingView consideration)

**Create ChatList.tsx:**
- Props: chatRoomId
- Fetch initial messages on mount
- Subscribe to realtime updates using useChatSubscription
- Use FlashList with maintainVisibleContentPosition for chat UX:
  ```typescript
  <FlashList
    data={messages}
    renderItem={renderMessage}
    estimatedItemSize={80}
    maintainVisibleContentPosition={{
      autoscrollToBottomThreshold: 0.2,
      startRenderingFromBottom: true,
    }}
  />
  ```
- Handle empty state: "No messages yet. Start the conversation!"
- Clean up subscription on unmount (critical for memory)

**Create lib/contributions.ts:**
- Following CONTEXT.md: per-celebration contributions, not per-item

Functions:
1. `getContributions(celebrationId: string): Promise<Contribution[]>`
   - Fetch all contributions for celebration
   - Include contributor info (display_name, avatar_url)
   - RLS excludes celebrant

2. `addContribution(celebrationId: string, amount: number): Promise<Contribution>`
   - Insert or update (UPSERT on celebration_id, user_id)
   - amount must be > 0

3. `updateContribution(contributionId: string, amount: number): Promise<Contribution>`
   - Update existing contribution
   - Only owner can update (RLS enforced)

4. `getCelebrationTotal(celebrationId: string): Promise<number>`
   - Sum all contributions for celebration
   - Return 0 if none

**Create ContributionProgress.tsx:**
- Props: totalContributed, targetAmount (optional)
- If targetAmount set: show progress bar (total / target)
- Always show total contributed as currency
- Use Gluestack Progress component or styled View

**Create ContributionModal.tsx:**
- Props: isOpen, onClose, celebrationId, existingContribution
- Input for amount (numeric keyboard)
- Show list of who else contributed and how much
- Save button calls addContribution or updateContribution
- Use @gorhom/bottom-sheet (already in project) or Modal
  </action>
  <verify>
1. `ls components/chat/` shows ChatBubble.tsx, ChatInput.tsx, ChatList.tsx
2. `ls lib/contributions.ts` exists
3. `grep "useChatSubscription" components/chat/ChatList.tsx` finds hook usage
4. `grep "FlashList" components/chat/ChatList.tsx` finds list component
5. `npx tsc --noEmit` passes
  </verify>
  <done>
Chat components render messages with realtime updates. Contribution utilities support CRUD with progress visualization.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate chat and contributions into celebration detail</name>
  <files>
    app/(app)/celebration/[id].tsx
  </files>
  <action>
Update the celebration detail screen created in 02-01 to include chat and contribution sections.

**Screen Layout (top to bottom):**

1. **Header Section** (from 02-01)
   - Celebrant info
   - Event date
   - Gift Leader badge

2. **Contribution Section** (new)
   - ContributionProgress component showing total vs target
   - "Your Contribution" card showing user's contribution or "Add Contribution" button
   - Tap to open ContributionModal
   - List of contributors with amounts (names visible per CONTEXT.md decision)

3. **Chat Section** (new)
   - Takes remaining screen space (flex: 1)
   - ChatList component with chatRoomId
   - ChatInput component at bottom
   - KeyboardAvoidingView to handle keyboard

**Data Fetching:**
- Fetch celebration details (from 02-01)
- Fetch chat_room for this celebration
- Fetch contributions for display
- Subscription handled internally by ChatList

**State Management:**
- celebrationLoading, contributionLoading states
- refreshContributions after modal save

**Navigation:**
- Linked item press in chat: navigate to wishlist item detail (if exists)

**Edge Cases:**
- If chat_room query returns null/error (user is celebrant):
  - This shouldn't happen with proper navigation
  - Show error state: "You cannot view this celebration's chat"
- If celebration not found: show error

**Styling:**
- Use existing Gluestack components (Box, VStack, HStack, Text, Pressable)
- Chat area should be scrollable independently
- Contribution section fixed height or collapsible
  </action>
  <verify>
1. `wc -l app/(app)/celebration/[id].tsx` shows at least 250 lines
2. `grep "ChatList" app/(app)/celebration/[id].tsx` finds component
3. `grep "ContributionProgress" app/(app)/celebration/[id].tsx` finds component
4. `grep "ContributionModal" app/(app)/celebration/[id].tsx` finds component
5. `npx tsc --noEmit` passes
  </verify>
  <done>
Celebration detail screen includes real-time chat with input, contribution progress bar, and contribution management modal.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete celebrations coordination system with:
- Celebrations list and detail screens
- Gift Leader assignment and reassignment
- Real-time secret chat (excludes celebrant)
- Contribution tracking with progress bar
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Run migration: `npx supabase db push` or apply migration in Supabase Dashboard
2. Start app: `npx expo start`

**Test 1: Celebration Creation (requires 2+ group members)**
1. Create a test celebration manually in database or via Supabase Dashboard:
   - Insert into celebrations table with your group_id, a celebrant_id (NOT you), event_date, year
   - Note the generated ID
2. Insert a chat_room for that celebration_id
3. Refresh app and navigate to Celebrations tab
4. Should see the celebration in list

**Test 2: Gift Leader Display**
1. Set yourself as gift_leader_id for the test celebration
2. Celebration card should show "You are Gift Leader" badge
3. Tap celebration to see detail
4. Gift Leader section should highlight your role

**Test 3: Gift Leader Reassignment (if you're group admin)**
1. On celebration detail, find "Reassign" button
2. Select another group member
3. Gift Leader should update
4. Check gift_leader_history table has new entry

**Test 4: Chat Functionality**
1. On celebration detail, scroll to chat section
2. Type a message and send
3. Message should appear in list
4. Open app on second device (or second account) in same group
5. Messages should sync in real-time

**Test 5: Celebrant Exclusion (SECURITY CRITICAL)**
1. Log in as the celebrant user
2. Navigate to Celebrations tab
3. The celebration for YOUR birthday should NOT show chat/contribution details
4. If you can see the chat, this is a SECURITY FAILURE

**Test 6: Contribution Tracking**
1. On celebration detail, tap "Add Contribution"
2. Enter an amount (e.g., $25)
3. Save
4. Progress bar should update
5. Your name should appear in contributors list

**Test 7: Linked Wishlist Items (optional)**
1. In chat, tap the link item button (if implemented)
2. Select a wishlist item from celebrant's list
3. Message with linked item should display item card
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, especially the celebrant exclusion test (Test 5).

If issues found, describe:
- Which test failed
- Expected vs actual behavior
- Any error messages
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Chat utilities:**
   - Run: `grep "export" lib/chat.ts`
   - Should show sendMessage, getMessages, useChatSubscription

2. **Contribution utilities:**
   - Run: `grep "export" lib/contributions.ts`
   - Should show addContribution, getContributions, getCelebrationTotal

3. **Components:**
   - Run: `ls components/chat/ components/celebrations/`
   - Should show all component files

4. **TypeScript:**
   - Run: `npx tsc --noEmit`
   - Should pass

5. **Integration:**
   - Celebration detail should be >250 lines with all components integrated
</verification>

<success_criteria>
- [ ] Chat messages send and receive in real-time
- [ ] Chat subscription properly cleans up on unmount
- [ ] Linked wishlist items display in chat messages
- [ ] Contribution amounts visible to all except celebrant
- [ ] Progress bar shows total vs target (when target set)
- [ ] Contributions can be added/updated freely
- [ ] Celebrant CANNOT see chat or contributions (RLS enforced)
- [ ] TypeScript compiles without errors
- [ ] Human verification passes all tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-celebrations-coordination/02-02-SUMMARY.md`
</output>
