---
phase: 04-smart-reminders
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260202000008_gift_leader_notifications.sql
  - supabase/functions/push/index.ts
autonomous: true

must_haves:
  truths:
    - "Gift Leader receives notification immediately when assigned to a celebration"
    - "Gift Leader receives notification immediately when celebration is created (30 days out)"
    - "Old Gift Leader receives notification when reassigned away"
    - "New Gift Leader receives notification when reassigned to"
    - "Push notifications can display celebrant avatar image"
  artifacts:
    - path: "supabase/migrations/20260202000008_gift_leader_notifications.sql"
      provides: "Gift Leader notification trigger"
      contains: "notify_gift_leader_assigned"
    - path: "supabase/functions/push/index.ts"
      provides: "Rich content push support"
      contains: "richContent"
  key_links:
    - from: "celebrations INSERT/UPDATE trigger"
      to: "notify_gift_leader_assigned function"
      via: "AFTER INSERT OR UPDATE OF gift_leader_id"
      pattern: "AFTER INSERT OR UPDATE OF gift_leader_id"
    - from: "notify_gift_leader_assigned"
      to: "user_notifications"
      via: "INSERT statement"
      pattern: "INSERT INTO public.user_notifications"
    - from: "push Edge Function"
      to: "Expo Push API"
      via: "richContent.image field"
      pattern: "richContent.*image"
---

<objective>
Create Gift Leader notification system with immediate assignment alerts and rich push content.

Purpose: Ensure Gift Leaders know immediately when they're responsible for coordinating a celebration, giving them maximum time to prepare.

Output: Database trigger for Gift Leader notifications, enhanced Edge Function supporting avatar images in push notifications.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-smart-reminders/04-CONTEXT.md
@.planning/phases/04-smart-reminders/04-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md (notification infrastructure)
@.planning/phases/02-celebrations-coordination/02-01-SUMMARY.md (celebrations schema)

# Existing patterns to follow:
@supabase/functions/push/index.ts (current Edge Function)
@supabase/migrations/20260202000005_celebrations.sql (celebrations table)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Gift Leader notification trigger</name>
  <files>supabase/migrations/20260202000008_gift_leader_notifications.sql</files>
  <action>
Create a SQL migration with a trigger function for Gift Leader notifications:

1. **Create notify_gift_leader_assigned() trigger function:**
   - Fires on INSERT and UPDATE OF gift_leader_id on celebrations table
   - Only processes when gift_leader_id is NOT NULL and has changed

2. **On INSERT (new celebration):**
   - Notify the assigned Gift Leader with full context
   - Title: "You're the Gift Leader for {celebrant_name}!"
   - Body: "{group_name} - Birthday on {date} ({days} days). Tap to view wishlist."
   - Data payload:
     ```json
     {
       "type": "gift_leader_assigned",
       "screen": "celebration",
       "celebration_id": "uuid",
       "group_id": "uuid",
       "celebrant_id": "uuid",
       "avatar_url": "celebrant avatar"
     }
     ```

3. **On UPDATE (reassignment):**
   - Notify the NEW Gift Leader (same as above)
   - Notify the OLD Gift Leader they've been relieved:
     - Title: "Gift Leader role reassigned"
     - Body: "You're no longer Gift Leader for {celebrant_name}'s birthday."
     - Data payload:
       ```json
       {
         "type": "gift_leader_relieved",
         "screen": "celebration",
         "celebration_id": "uuid"
       }
       ```
   - Only notify old leader if OLD.gift_leader_id was NOT NULL

4. **Query pattern:**
   - Join users table to get celebrant.full_name (or display_name from user_profiles view)
   - Join groups table to get group.name
   - Calculate days until: (NEW.event_date - CURRENT_DATE)

5. **Create the trigger:**
   ```sql
   CREATE TRIGGER on_gift_leader_changed
     AFTER INSERT OR UPDATE OF gift_leader_id ON celebrations
     FOR EACH ROW EXECUTE FUNCTION notify_gift_leader_assigned();
   ```

**Important:** Use SECURITY DEFINER since the trigger needs to:
- Read from users table (celebrant info)
- Read from groups table (group name)
- Write to user_notifications (which has open INSERT policy)

**Note on Gift Leader 1-week nudge:** This is handled by the reminder function in Plan 01. The reminder function includes 'gift_leader_1w' as a reminder_type specifically for Gift Leaders.
  </action>
  <verify>
1. Migration file exists
2. Run `npx supabase db push` or apply manually
3. Verify function: SELECT proname FROM pg_proc WHERE proname = 'notify_gift_leader_assigned';
4. Verify trigger: SELECT tgname FROM pg_trigger WHERE tgname = 'on_gift_leader_changed';
5. Test: Insert a new celebration manually and check user_notifications
6. Test: Update gift_leader_id and check both old and new leader get notifications
  </verify>
  <done>
- notify_gift_leader_assigned function exists
- Trigger fires on celebrations INSERT
- Trigger fires on celebrations UPDATE of gift_leader_id
- New Gift Leader receives assignment notification
- Old Gift Leader receives relieved notification on reassignment
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance Edge Function for rich push content</name>
  <files>supabase/functions/push/index.ts</files>
  <action>
Modify the existing push Edge Function to support avatar images in notifications:

1. **Update ExpoPushMessage interface:**
   ```typescript
   interface ExpoPushMessage {
     to: string;
     sound?: 'default';
     title: string;
     body: string;
     data?: Record<string, any>;
     channelId?: string;
     // Rich content support
     richContent?: {
       image?: string;
     };
   }
   ```

2. **Update message building logic:**
   - Check if data.avatar_url exists
   - If present, add richContent.image field:
   ```typescript
   const messages: ExpoPushMessage[] = tokens.map((token: DeviceToken) => ({
     to: token.expo_push_token,
     sound: 'default',
     title,
     body,
     data: data || {},
     channelId: 'default',
     // Conditionally add rich content for avatar image
     ...(data?.avatar_url && {
       richContent: {
         image: data.avatar_url
       }
     })
   }));
   ```

3. **Ensure avatar_url is HTTPS:**
   - Expo Push API requires HTTPS URLs for images
   - Log warning if avatar_url is HTTP (but don't block)

4. **Keep backward compatibility:**
   - Notifications without avatar_url should work exactly as before
   - No breaking changes to existing payload structure

**Key insight from RESEARCH.md:** The `richContent.image` field enables avatar display in push notifications. This works automatically on Android. iOS may require Notification Service Extension (test on physical device).

**Testing note:** Avatar images will only display if:
- URL is valid HTTPS
- Image is accessible (public URL)
- Device supports rich notifications (most modern devices do)
  </action>
  <verify>
1. Edge Function file updated
2. Deploy: npx supabase functions deploy push
3. Test by inserting notification with avatar_url in data:
   ```sql
   INSERT INTO user_notifications (user_id, title, body, data)
   VALUES ('your-id', 'Test', 'Body', '{"avatar_url": "https://example.com/avatar.jpg"}');
   ```
4. Check push notification on device shows image (Android immediately, iOS may vary)
5. Test without avatar_url still works normally
  </verify>
  <done>
- Edge Function includes richContent support
- Notifications with avatar_url include image in push
- Notifications without avatar_url work unchanged
- Function deployed and operational
  </done>
</task>

</tasks>

<verification>
## Plan Verification

1. **Gift Leader assignment notification (new celebration):**
   - Create new celebration with gift_leader_id set
   - Check user_notifications for Gift Leader
   - Title should include celebrant name
   - Body should include group name and date

2. **Gift Leader reassignment notification:**
   - Update existing celebration's gift_leader_id
   - Old Gift Leader should see "reassigned" notification
   - New Gift Leader should see "assigned" notification

3. **Rich push content:**
   - Send notification with avatar_url in data
   - Verify image appears in push notification (physical device)

4. **Integration with auto-celebration:**
   - When pg_cron creates celebrations via create_upcoming_celebrations()
   - Gift Leader should automatically receive notification
   - (This works because trigger fires on INSERT)
</verification>

<success_criteria>
- [ ] Migration file exists at supabase/migrations/20260202000008_gift_leader_notifications.sql
- [ ] notify_gift_leader_assigned trigger function created
- [ ] Trigger attached to celebrations table
- [ ] New Gift Leader notified on INSERT
- [ ] Both leaders notified on reassignment UPDATE
- [ ] Edge Function updated with richContent support
- [ ] Avatar images supported in push payload
- [ ] Backward compatibility maintained
- [ ] TypeScript compiles without new errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-smart-reminders/04-02-SUMMARY.md`
</output>
