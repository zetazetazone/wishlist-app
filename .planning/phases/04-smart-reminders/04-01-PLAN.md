---
phase: 04-smart-reminders
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260202000007_reminder_scheduling.sql
  - hooks/usePushNotifications.ts
autonomous: true

must_haves:
  truths:
    - "User receives birthday reminder at 9:00 AM their local time"
    - "Reminder sequence fires at 4w, 2w, 1w, and day-of"
    - "Celebrant does NOT receive countdown reminders (only day-of Happy Birthday)"
    - "Same-day birthdays are grouped into single notification"
    - "User can mute reminders per group"
    - "Duplicate reminders are prevented even on job retry"
  artifacts:
    - path: "supabase/migrations/20260202000007_reminder_scheduling.sql"
      provides: "Reminder tables, function, pg_cron job"
      contains: "process_birthday_reminders"
    - path: "hooks/usePushNotifications.ts"
      provides: "Automatic timezone detection"
      contains: "Intl.DateTimeFormat"
  key_links:
    - from: "pg_cron job"
      to: "process_birthday_reminders function"
      via: "cron.schedule every 15 minutes"
      pattern: "SELECT public.process_birthday_reminders"
    - from: "process_birthday_reminders"
      to: "user_notifications"
      via: "INSERT statement"
      pattern: "INSERT INTO public.user_notifications"
    - from: "usePushNotifications"
      to: "users.timezone"
      via: "Supabase update"
      pattern: "update.*timezone"
---

<objective>
Create the birthday reminder scheduling system with timezone-aware pg_cron job.

Purpose: Enable users to receive timely birthday reminders at their local 9:00 AM, supporting the core value of automated celebration coordination.

Output: Database migration with reminder tracking, timezone support, muting preferences, and a pg_cron job that processes reminders every 15 minutes.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-smart-reminders/04-CONTEXT.md
@.planning/phases/04-smart-reminders/04-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md (notification infrastructure)
@.planning/phases/02-celebrations-coordination/02-01-SUMMARY.md (celebrations schema)

# Existing patterns to follow:
@supabase/migrations/20260202000006_auto_celebrations.sql (pg_cron pattern)
@supabase/migrations/20260202000001_notifications.sql (notification tables)
@hooks/usePushNotifications.ts (timezone detection location)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reminder scheduling migration</name>
  <files>supabase/migrations/20260202000007_reminder_scheduling.sql</files>
  <action>
Create a comprehensive SQL migration with:

1. **Add timezone column to users table:**
   ```sql
   ALTER TABLE public.users ADD COLUMN IF NOT EXISTS timezone TEXT DEFAULT 'UTC';
   ```

2. **Create reminder_sent tracking table:**
   - celebration_id (UUID, FK to celebrations)
   - user_id (UUID, FK to users)
   - reminder_type (TEXT, CHECK IN: '4w', '2w', '1w', 'day_of', 'happy_birthday', 'gift_leader_initial', 'gift_leader_1w')
   - sent_at (TIMESTAMPTZ, DEFAULT NOW())
   - UNIQUE constraint on (celebration_id, user_id, reminder_type)
   - RLS policy: users can view their own sent reminders

3. **Create user_group_preferences table for muting:**
   - user_id (UUID, FK to users)
   - group_id (UUID, FK to groups)
   - mute_reminders (BOOLEAN, DEFAULT FALSE)
   - PRIMARY KEY (user_id, group_id)
   - RLS policy: users can manage their own preferences

4. **Create process_birthday_reminders() function:**
   - Runs every 15 minutes
   - Finds users where local time is 9:00 AM (within 15-min window using AT TIME ZONE)
   - For each celebration in 28-day window:
     - Calculate days_until from event_date
     - Determine reminder_type: 28 days = '4w', 14 = '2w', 7 = '1w', 0 = 'day_of'
     - Skip if reminder already in reminder_sent
     - Skip if user has muted the group
     - **Celebrant exclusion:** Skip countdown reminders (4w/2w/1w) for celebrant
     - Celebrant DOES get 'happy_birthday' on day-of
   - Group same-day birthdays per user:
     - If multiple celebrations on same event_date for same recipient, batch into single notification
     - Title: "3 birthdays in 2 weeks!" Body lists names
   - Insert into user_notifications with data for deep linking:
     ```json
     {
       "type": "birthday_reminder",
       "screen": "celebration",
       "celebration_id": "uuid",
       "group_id": "uuid",
       "avatar_url": "url"
     }
     ```
   - Include contribution progress in body: "$45 of $60 goal"
   - Record in reminder_sent with ON CONFLICT DO NOTHING
   - Use SECURITY DEFINER for cross-table access

5. **Schedule pg_cron job:**
   - Remove existing job if exists (idempotent)
   - Schedule: '*/15 * * * *' (every 15 minutes)
   - Call: SELECT public.process_birthday_reminders();

**Notification content patterns:**
- 4w: "{name}'s birthday in 4 weeks!"
- 2w: "{name}'s birthday in 2 weeks! ${contributed} of ${goal} collected."
- 1w: "1 week until {name}'s birthday! ${contributed} of ${goal} collected."
- day_of (non-celebrant): "It's {name}'s birthday today! Tap to celebrate."
- happy_birthday (celebrant): "Happy Birthday! Your group is celebrating you today."

**Batched notification:**
- Title: "{count} birthdays in {time}!"
- Body: "{names} all have birthdays on {date}. Tap to coordinate."

**Key implementation details:**
- Use PostgreSQL AT TIME ZONE for DST-safe timezone conversion
- 15-min window: EXTRACT(HOUR) = 9 AND EXTRACT(MINUTE) < 15
- Join user_group_preferences to filter muted groups
- Join celebrations with status IN ('upcoming', 'active')
- Join celebration_contributions for progress totals
  </action>
  <verify>
1. Migration file exists
2. Run `npx supabase db push` or apply manually
3. Verify tables: SELECT * FROM information_schema.tables WHERE table_name IN ('reminder_sent', 'user_group_preferences');
4. Verify function: SELECT proname FROM pg_proc WHERE proname = 'process_birthday_reminders';
5. Verify cron job: SELECT * FROM cron.job WHERE jobname = 'process-birthday-reminders';
6. Test function manually: SELECT public.process_birthday_reminders();
  </verify>
  <done>
- reminder_sent table exists with UNIQUE constraint
- user_group_preferences table exists
- users.timezone column exists
- process_birthday_reminders function exists and executes without error
- pg_cron job scheduled every 15 minutes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add automatic timezone detection to push notifications hook</name>
  <files>hooks/usePushNotifications.ts</files>
  <action>
Modify the existing usePushNotifications hook to automatically detect and save the user's timezone:

1. After successful push token registration, detect user's timezone:
   ```typescript
   const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
   ```

2. Save timezone to users table (alongside token save or separately):
   ```typescript
   await supabase
     .from('users')
     .update({ timezone })
     .eq('id', session.user.id);
   ```

3. Update timezone on every app open (not just first registration) to catch:
   - Users who travel
   - DST changes affecting timezone name

4. Add error handling - timezone save failure should NOT block push registration

**Integration point:** This runs when the hook initializes and the user is authenticated.

**Rationale:** Automatic detection respects user privacy (no manual input required) while ensuring accurate local time delivery for notifications.
  </action>
  <verify>
1. Open app in Expo dev build
2. Check Supabase: SELECT timezone FROM users WHERE id = 'your-user-id';
3. Timezone should match device setting (e.g., 'America/New_York')
4. Push notifications still work after change
  </verify>
  <done>
- usePushNotifications hook detects timezone using Intl.DateTimeFormat
- Timezone is saved to users.timezone on app open
- No regression in push token registration
  </done>
</task>

</tasks>

<verification>
## Plan Verification

1. **Reminder scheduling works:**
   - Create test celebration 7 days from now
   - Set user timezone to current timezone
   - Manually run: `SELECT public.process_birthday_reminders();`
   - Check user_notifications for reminder
   - Check reminder_sent for tracking record

2. **Celebrant exclusion works:**
   - As celebrant, should NOT see 4w/2w/1w reminders in user_notifications
   - AS celebrant, SHOULD see 'happy_birthday' on day-of

3. **Muting works:**
   - Insert into user_group_preferences with mute_reminders = true
   - Run reminder function
   - No notification created for that group

4. **Batching works:**
   - Create 2 celebrations on same day
   - Run reminder function
   - Should see single batched notification

5. **Timezone detection works:**
   - Open app
   - Check users.timezone is populated
</verification>

<success_criteria>
- [ ] Migration file exists at supabase/migrations/20260202000007_reminder_scheduling.sql
- [ ] reminder_sent table created with UNIQUE constraint
- [ ] user_group_preferences table created with mute_reminders column
- [ ] users.timezone column exists
- [ ] process_birthday_reminders function handles all reminder types
- [ ] pg_cron job scheduled at */15 * * * *
- [ ] Celebrant excluded from countdown reminders
- [ ] Same-day birthdays batched into single notification
- [ ] Timezone auto-detected in usePushNotifications hook
- [ ] TypeScript compiles without new errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-smart-reminders/04-01-SUMMARY.md`
</output>
