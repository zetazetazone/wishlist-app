---
phase: 04-smart-reminders
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - supabase/migrations/20260202000009_reminder_gaps.sql
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Same-day birthdays within a group produce single batched notification"
    - "Batched notification shows multiple names (e.g., '3 birthdays in Family in 2 weeks!')"
    - "New group members receive catch-up reminders for missed reminder types"
    - "Catch-up reminders are differentiated from normal reminders"
  artifacts:
    - path: "supabase/migrations/20260202000009_reminder_gaps.sql"
      provides: "Updated process_birthday_reminders function with batching and catch-up"
      contains: "array_agg"
  key_links:
    - from: "process_birthday_reminders"
      to: "user_notifications"
      via: "batched INSERT with array_agg grouping"
      pattern: "array_agg.*celebration_id"
---

<objective>
Close verification gaps in birthday reminder system: implement same-day batching and explicit catch-up logic for new members.

Purpose: VERIFICATION.md identified two gaps in the reminder system - (1) same-day birthdays send individual notifications instead of batched, (2) new members only get current reminder, not catch-up for missed types. Both are modifications to the same function.

Output: New migration that replaces process_birthday_reminders() with enhanced version supporting true batching and explicit catch-up reminders.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-smart-reminders/04-VERIFICATION.md
@supabase/migrations/20260202000007_reminder_scheduling.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement same-day batching with array aggregation</name>
  <files>supabase/migrations/20260202000009_reminder_gaps.sql</files>
  <action>
Create a new migration that replaces process_birthday_reminders() with an enhanced version.

**Same-day batching implementation:**

1. Change the query strategy from nested loops to a two-phase approach:
   - Phase 1: Collect all (user_id, group_id, event_date, reminder_type) combinations
   - Phase 2: Group same (user_id, group_id, event_date, reminder_type) into batches

2. Use array_agg to collect celebration IDs and celebrant names for same-day birthdays:
```sql
SELECT
  user_id,
  group_id,
  event_date,
  reminder_type,
  array_agg(celebration_id) AS celebration_ids,
  array_agg(celebrant_name) AS celebrant_names
FROM reminder_candidates
GROUP BY user_id, group_id, event_date, reminder_type
```

3. Format batched notification based on count:
   - 1 person: Use current format (e.g., "Alice's birthday in 2 weeks!")
   - 2 people: "Alice and Bob's birthdays in 2 weeks!"
   - 3+ people: "3 birthdays in Family in 2 weeks!"

4. For batched notifications:
   - Use first celebrant's avatar_url in payload
   - Include array of celebration_ids in data for deep linking
   - Insert one reminder_sent record per celebration in the batch

5. Keep all existing logic (celebrant exclusion, muting, Gift Leader nudge) intact.
  </action>
  <verify>
Run: `grep -c "array_agg" supabase/migrations/20260202000009_reminder_gaps.sql`
Expected: At least 2 occurrences (for celebration_ids and celebrant_names)

Check function signature still returns (notification_count, batch_count):
`grep "RETURNS TABLE" supabase/migrations/20260202000009_reminder_gaps.sql`
  </verify>
  <done>Function uses array_agg to group same-day celebrations per group and produces batched notifications with multiple names.</done>
</task>

<task type="auto">
  <name>Task 2: Implement explicit catch-up reminders for new members</name>
  <files>supabase/migrations/20260202000009_reminder_gaps.sql</files>
  <action>
Enhance the function created in Task 1 to add explicit catch-up logic:

**Catch-up reminder implementation:**

1. For each user-celebration pair, determine which reminder types were "due" but user wasn't a member yet:
```sql
-- Calculate which reminders user should have received
-- 28 days before = 4w due, 14 days before = 2w due, 7 days before = 1w due
v_days_member_missed := (v_celebration.event_date - v_celebration.member_joined_at::DATE)::INT;

-- Determine missed reminder types
v_missed_types := ARRAY[]::TEXT[];
IF v_days_member_missed < 28 AND v_days_member_missed >= 14 THEN
  v_missed_types := array_append(v_missed_types, '4w');
END IF;
IF v_days_member_missed < 14 AND v_days_member_missed >= 7 THEN
  v_missed_types := array_append(v_missed_types, '4w');
  v_missed_types := array_append(v_missed_types, '2w');
END IF;
-- etc.
```

2. For new members who missed reminders, send a SINGLE consolidated catch-up notification:
   - Type: 'catch_up'
   - Title: "Heads up: {Name}'s birthday in {X} days!"
   - Body: "You missed earlier reminders. {Name}'s birthday is {event_date}."

3. Only send catch-up if:
   - User joined after the earliest reminder window (28 days before)
   - User hasn't received the catch-up notification yet
   - Current time is within the first 15-minute window after join (or at their local 9 AM)

4. Add 'catch_up' to the valid reminder_type CHECK constraint:
```sql
ALTER TABLE public.reminder_sent
DROP CONSTRAINT IF EXISTS reminder_sent_reminder_type_check;

ALTER TABLE public.reminder_sent
ADD CONSTRAINT reminder_sent_reminder_type_check
CHECK (reminder_type IN ('4w', '2w', '1w', 'day_of', 'happy_birthday', 'gift_leader_initial', 'gift_leader_1w', 'catch_up'));
```

5. Track catch-up in reminder_sent to prevent duplicates.
  </action>
  <verify>
Run: `grep -c "catch_up" supabase/migrations/20260202000009_reminder_gaps.sql`
Expected: At least 3 occurrences (in CHECK constraint, in logic, in INSERT)

Check for missed types detection:
`grep "member_joined_at" supabase/migrations/20260202000009_reminder_gaps.sql`
  </verify>
  <done>New members receive a consolidated catch-up notification listing what they missed, recorded in reminder_sent to prevent duplicates.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Batching verification:**
```sql
-- Simulate two same-day birthdays in one group
-- Should produce ONE notification with both names
SELECT * FROM public.process_birthday_reminders();
-- Check user_notifications: should see batched title like "2 birthdays in..."
```

2. **Catch-up verification:**
```sql
-- Check reminder_type constraint includes catch_up
SELECT conname, pg_get_constraintdef(oid)
FROM pg_constraint
WHERE conname = 'reminder_sent_reminder_type_check';
```

3. **No regressions:**
- Celebrant exclusion still works
- Gift Leader 1w nudge still works
- Group muting still works
- Duplicate prevention still works
</verification>

<success_criteria>
1. Same-day birthdays within a group produce single batched notification (not multiple individual ones)
2. Batched notification format: "2 birthdays..." or "Alice and Bob's birthdays..."
3. New members joining mid-window receive catch_up notification
4. catch_up type added to reminder_type CHECK constraint
5. All existing functionality preserved (celebrant exclusion, muting, Gift Leader nudge)
</success_criteria>

<output>
After completion, create `.planning/phases/04-smart-reminders/04-03-SUMMARY.md`
</output>
