---
phase: 43-enforcement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260220000001_v1.7_wishlist_id_enforcement.sql
autonomous: true

must_haves:
  truths:
    - "wishlist_id column is NOT NULL (no orphaned items possible)"
    - "Partial index replaced with full index for performance"
    - "ON DELETE behavior changed to CASCADE (cleaner data model)"
    - "Migration validates zero data corruption before and after schema changes"
    - "gift_claims RLS policies remain unchanged (celebrant exclusion preserved)"
  artifacts:
    - path: "supabase/migrations/20260220000001_v1.7_wishlist_id_enforcement.sql"
      provides: "NOT NULL enforcement migration"
      contains: "ALTER TABLE public.wishlist_items ALTER COLUMN wishlist_id SET NOT NULL"
  key_links:
    - from: "wishlist_items.wishlist_id"
      to: "wishlists.id"
      via: "FOREIGN KEY with ON DELETE CASCADE"
      pattern: "ON DELETE CASCADE"
---

<objective>
Enforce NOT NULL constraint on wishlist_id and optimize indexes for the completed multi-wishlist migration.

Purpose: Phase 37 introduced wishlist_id as nullable during the v1.7 transition period. Now that all items have been backfilled and the visibility system is complete (Phase 42), we can enforce NOT NULL to prevent orphaned items and upgrade the partial index to a full index for better query performance.

Output: Single migration file that:
1. Validates no NULL wishlist_id values exist (pre-check)
2. Changes FK behavior from ON DELETE SET NULL to ON DELETE CASCADE
3. Makes wishlist_id NOT NULL
4. Replaces partial index with full index
5. Validates migration integrity (post-check)
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior migration for reference
@supabase/migrations/20260216000001_v1.7_multi_wishlist_foundation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NOT NULL enforcement migration</name>
  <files>supabase/migrations/20260220000001_v1.7_wishlist_id_enforcement.sql</files>
  <action>
Create migration file with the following structure:

**PART 1: Pre-migration validation**
- Count rows where wishlist_id IS NULL
- RAISE EXCEPTION if count > 0 (migration cannot proceed safely)
- This validation MUST come first to prevent partial migration failures

**PART 2: Change FK behavior from SET NULL to CASCADE**
PostgreSQL cannot ALTER a FK constraint directly. Must:
1. DROP the existing FK constraint (find its name from information_schema)
2. ADD new FK constraint with ON DELETE CASCADE
Use naming convention: `wishlist_items_wishlist_id_fkey`

**PART 3: Set NOT NULL constraint**
```sql
ALTER TABLE public.wishlist_items
  ALTER COLUMN wishlist_id SET NOT NULL;
```

**PART 4: Replace partial index with full index**
The existing partial index `idx_wishlist_items_wishlist` has `WHERE wishlist_id IS NOT NULL`.
Now that column is NOT NULL, this condition is redundant and prevents full optimization.
1. DROP INDEX idx_wishlist_items_wishlist
2. CREATE INDEX idx_wishlist_items_wishlist ON public.wishlist_items(wishlist_id)
   (full index, no WHERE clause)

**PART 5: Update column comment**
Update the COMMENT ON COLUMN for wishlist_id to reflect it is now NOT NULL and uses CASCADE.

**PART 6: Post-migration validation block**
DO $$ block that verifies:
- Column is NOT NULL (check information_schema.columns.is_nullable = 'NO')
- FK constraint exists with ON DELETE CASCADE action
- Full index exists (not partial)
- RAISE NOTICE with migration summary

**CRITICAL: Do NOT modify gift_claims RLS policies**
The gift_claims SELECT and INSERT policies use wi.group_id for celebrant exclusion.
This is intentional and MUST NOT be changed. The dual-access pattern in wishlist_items
RLS is separate and does not affect gift_claims.

**Migration filename reasoning:**
- 20260220000001 follows chronologically after 20260219000001 (visibility RLS)
- v1.7 prefix indicates this is part of the Global Wishlist milestone
  </action>
  <verify>
Run `npx supabase db reset` and verify:
1. Migration completes without error
2. `\d wishlist_items` shows wishlist_id as NOT NULL
3. `\d+ wishlist_items` shows FK constraint with CASCADE delete rule
4. Index `idx_wishlist_items_wishlist` exists without WHERE clause
  </verify>
  <done>
- wishlist_id column is NOT NULL
- FK uses ON DELETE CASCADE instead of SET NULL
- Full index replaces partial index
- Validation block confirms all changes
  </done>
</task>

<task type="auto">
  <name>Task 2: Regenerate TypeScript types</name>
  <files>types/supabase.ts</files>
  <action>
Run `npx supabase gen types typescript --local > types/supabase.ts` to regenerate
TypeScript types after the schema change.

The wishlist_id field in wishlist_items should change from `string | null` to `string`
in the generated types, reflecting the NOT NULL constraint.

Verify the types file has this change in both Row and Insert types for wishlist_items.
  </action>
  <verify>
`grep -A5 'wishlist_id' types/supabase.ts` shows `string` not `string | null`
  </verify>
  <done>
TypeScript types reflect NOT NULL constraint (wishlist_id: string, not string | null)
  </done>
</task>

</tasks>

<verification>
1. Run `npx supabase db reset` - should complete without errors
2. Query test: `SELECT COUNT(*) FROM wishlist_items WHERE wishlist_id IS NULL` returns 0
3. Constraint test: Attempt to INSERT a wishlist_item with wishlist_id = NULL fails
4. Cascade test: DELETE a wishlist and verify its items are deleted (not orphaned)
5. TypeScript: `npx tsc --noEmit` passes
6. Gift claims: Verify celebrant can still be excluded from viewing claims
</verification>

<success_criteria>
- [ ] Migration file exists at supabase/migrations/20260220000001_v1.7_wishlist_id_enforcement.sql
- [ ] Pre-migration validation prevents partial failures
- [ ] wishlist_id is NOT NULL in schema
- [ ] FK constraint uses ON DELETE CASCADE
- [ ] Full index (not partial) exists for wishlist_id
- [ ] TypeScript types updated to reflect NOT NULL
- [ ] gift_claims RLS policies unchanged
- [ ] npx supabase db reset succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/43-enforcement/43-01-SUMMARY.md`
</output>
