---
phase: 37-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260216000001_v1.7_multi_wishlist_foundation.sql
autonomous: true

must_haves:
  truths:
    - "User has exactly one default wishlist created automatically"
    - "All existing wishlist items belong to user's default wishlist"
    - "Existing gift claims continue to work without data loss"
    - "Celebrant exclusion still prevents claim visibility to birthday person"
    - "Database supports nullable wishlist_id during transition period"
  artifacts:
    - path: "supabase/migrations/20260216000001_v1.7_multi_wishlist_foundation.sql"
      provides: "Multi-wishlist schema: wishlists table, wishlist_id column, backfill, RLS, trigger"
      contains: "CREATE TABLE public.wishlists"
    - path: "supabase/migrations/20260216000001_v1.7_multi_wishlist_foundation.sql"
      provides: "Default wishlist partial unique index"
      contains: "idx_wishlists_user_default"
    - path: "supabase/migrations/20260216000001_v1.7_multi_wishlist_foundation.sql"
      provides: "Trigger for new user default wishlist"
      contains: "create_default_wishlist"
  key_links:
    - from: "wishlist_items.wishlist_id"
      to: "wishlists.id"
      via: "Foreign key reference"
      pattern: "REFERENCES public.wishlists"
    - from: "wishlists.user_id"
      to: "users.id"
      via: "Owner relationship"
      pattern: "REFERENCES public.users"
    - from: "gift_claims RLS"
      to: "wishlist_items.group_id"
      via: "Celebrant exclusion join"
      pattern: "wi.group_id"
---

<objective>
Create multi-wishlist database foundation with safe migration of existing group-scoped items.

Purpose: Enable v1.7 Global Wishlist features by transitioning from group-centric to user-owned wishlist architecture. All existing items migrate to user's default wishlist while preserving gift claims and celebrant exclusion.

Output: Single migration file establishing wishlists table, extending wishlist_items, migrating data, and updating RLS policies with dual-access pattern.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-database-foundation/37-RESEARCH.md
@supabase/migrations/20260210000001_v1.4_friends_system_foundation.sql (pattern template)
@supabase/migrations/20260206000001_v1.3_claims_details_notes.sql (celebrant exclusion pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-wishlist migration file</name>
  <files>supabase/migrations/20260216000001_v1.7_multi_wishlist_foundation.sql</files>
  <action>
Create a comprehensive migration file following the established pattern from v1.4 friends_system_foundation.sql. The migration has 12 parts:

**PART 1: wishlists table**
```sql
CREATE TABLE public.wishlists (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  emoji TEXT,
  visibility TEXT DEFAULT 'public' CHECK (visibility IN ('public', 'private', 'friends')),
  is_default BOOLEAN DEFAULT FALSE NOT NULL,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**PART 2: Partial unique index for one default per user**
```sql
CREATE UNIQUE INDEX idx_wishlists_user_default
  ON public.wishlists(user_id)
  WHERE is_default = TRUE;
```

**PART 3: Add wishlist_id column to wishlist_items (nullable)**
```sql
ALTER TABLE public.wishlist_items
  ADD COLUMN IF NOT EXISTS wishlist_id UUID REFERENCES public.wishlists(id) ON DELETE SET NULL;
```
Note: ON DELETE SET NULL (not CASCADE) during transition - items orphan rather than delete if wishlist removed.

**PART 4: Create default wishlists for all existing users**
Use INSERT with NOT EXISTS to prevent duplicates:
- First for users with items
- Then for users without items
Name: 'My Wishlist', emoji: NULL, visibility: 'public', is_default: TRUE

**PART 5: Backfill existing items to default wishlists**
```sql
UPDATE public.wishlist_items wi
SET wishlist_id = (
  SELECT w.id FROM public.wishlists w
  WHERE w.user_id = wi.user_id AND w.is_default = TRUE
  LIMIT 1
)
WHERE wi.wishlist_id IS NULL AND wi.user_id IS NOT NULL;
```

**PART 6: RLS policies for wishlists table**
- SELECT: Owner can view own wishlists
- INSERT: Owner only
- UPDATE: Owner only (cannot change user_id)
- DELETE: Owner only, cannot delete default (is_default = FALSE check)

**PART 7: Updated RLS policy for wishlist_items SELECT**
Drop existing "Users can view wishlist items" policy and recreate with dual-access pattern:
- Own items (user_id = auth.uid())
- Group-based access (group_id path via is_group_member)
- Wishlist-based access (wishlist_id path for owner's wishlists)

**PART 8: Trigger for new users**
Create `create_default_wishlist()` function (SECURITY DEFINER) and trigger on public.users INSERT.

**PART 9: Indexes**
- idx_wishlists_user ON wishlists(user_id)
- idx_wishlist_items_wishlist ON wishlist_items(wishlist_id) WHERE wishlist_id IS NOT NULL

**PART 10: Triggers**
- set_wishlists_updated_at using existing handle_updated_at()

**PART 11: Comments**
Document tables, columns, and RLS patterns.

**PART 12: Grants**
GRANT EXECUTE on create_default_wishlist to authenticated.

**CRITICAL:** Do NOT modify gift_claims RLS policies. The existing celebrant exclusion policy uses wi.group_id which is preserved. Adding wishlist_id doesn't affect it.

**CRITICAL:** Do NOT make wishlist_id NOT NULL - that's Phase 43.
  </action>
  <verify>
1. Run `npx supabase db reset` to apply all migrations
2. Check migration applied: `npx supabase db dump --schema public | grep -c "wishlists"` returns non-zero
3. Verify no SQL syntax errors in migration output
  </verify>
  <done>
- wishlists table exists with all columns
- Partial unique index on is_default=TRUE enforces one default per user
- wishlist_id column added to wishlist_items (nullable)
- Default wishlists created for all existing users
- All items linked to owner's default wishlist
- RLS policies allow owner CRUD, block default deletion
- Dual-access RLS on wishlist_items supports both group_id and wishlist_id
- Trigger creates default wishlist for new users
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate migration integrity and celebrant exclusion</name>
  <files>supabase/migrations/20260216000001_v1.7_multi_wishlist_foundation.sql</files>
  <action>
After migration runs, execute validation queries directly in the migration file (at the end, after all schema changes).

Add a DO $$ block that raises NOTICE for each validation and RAISEs EXCEPTION if any fails:

**Validation 1: All users have default wishlist**
```sql
SELECT COUNT(*) FROM public.users u
WHERE NOT EXISTS (
  SELECT 1 FROM public.wishlists w
  WHERE w.user_id = u.id AND w.is_default = TRUE
);
-- Expected: 0
```

**Validation 2: No user has multiple default wishlists**
```sql
SELECT user_id, COUNT(*)
FROM public.wishlists
WHERE is_default = TRUE
GROUP BY user_id
HAVING COUNT(*) > 1;
-- Expected: 0 rows
```

**Validation 3: All items with user_id have wishlist_id**
```sql
SELECT COUNT(*)
FROM public.wishlist_items
WHERE wishlist_id IS NULL AND user_id IS NOT NULL;
-- Expected: 0
```

**Validation 4: Gift claims count unchanged**
Compare COUNT(*) from gift_claims before and after - should be same (no data loss).

**Validation 5: Celebrant exclusion preserved**
Document in comments that gift_claims SELECT policy still uses wi.group_id which is preserved. No code change needed - just verify the policy logic remains valid.

Add completion notice (DO $$ block) with summary:
- Tables created: wishlists
- Columns added: wishlist_items.wishlist_id
- Default wishlists created: {count}
- Items backfilled: {count}
- RLS policies: wishlists (4), wishlist_items updated (1)
- Trigger: on_user_created_create_wishlist
  </action>
  <verify>
1. Run `npx supabase db reset` - no errors
2. Check validation queries in migration output - all pass
3. Verify celebrant exclusion: The gift_claims SELECT policy joins through wishlist_items.group_id (not wishlist_id) so existing claims visibility is unchanged
  </verify>
  <done>
- All validation queries pass (0 orphans, 0 duplicate defaults, all items linked)
- Celebrant exclusion confirmed preserved (gift_claims RLS unchanged)
- Migration completes without rollback
- Summary notice shows correct counts
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Database state verification:**
   - Run `npx supabase db reset`
   - Connect to database and verify:
     - `SELECT COUNT(*) FROM wishlists;` > 0
     - `SELECT COUNT(*) FROM wishlist_items WHERE wishlist_id IS NULL AND user_id IS NOT NULL;` = 0
     - `SELECT COUNT(*) FROM users u WHERE NOT EXISTS (SELECT 1 FROM wishlists w WHERE w.user_id = u.id AND w.is_default = TRUE);` = 0

2. **RLS verification:**
   - Verify dual-access pattern in wishlist_items SELECT policy
   - Verify cannot delete default wishlist via RLS
   - Verify gift_claims RLS unchanged (celebrant exclusion intact)

3. **Trigger verification:**
   - Create new user, verify default wishlist auto-created
</verification>

<success_criteria>
- [ ] Migration file exists at supabase/migrations/20260216000001_v1.7_multi_wishlist_foundation.sql
- [ ] `npx supabase db reset` completes without errors
- [ ] wishlists table has: id, user_id, name, emoji, visibility, is_default, sort_order, created_at, updated_at
- [ ] Partial unique index idx_wishlists_user_default exists
- [ ] wishlist_items.wishlist_id column exists (nullable)
- [ ] All existing users have exactly one default wishlist
- [ ] All existing items with user_id have wishlist_id populated
- [ ] Gift claims count unchanged after migration
- [ ] RLS allows owner to manage wishlists, blocks deleting default
- [ ] Dual-access RLS on wishlist_items supports both access patterns
- [ ] Trigger creates default wishlist for new users
</success_criteria>

<output>
After completion, create `.planning/phases/37-database-foundation/37-01-SUMMARY.md`
</output>
