---
phase: 41-column-rename
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260216000001_rename_amazon_url_to_source_url.sql
  - types/database.types.ts
autonomous: true

must_haves:
  truths:
    - "Database column is named source_url (not amazon_url)"
    - "TypeScript types reference source_url"
    - "Existing data preserved after column rename"
  artifacts:
    - path: "supabase/migrations/20260216000001_rename_amazon_url_to_source_url.sql"
      provides: "Column rename migration"
      contains: "RENAME COLUMN amazon_url TO source_url"
    - path: "types/database.types.ts"
      provides: "Updated TypeScript types"
      contains: "source_url"
  key_links:
    - from: "types/database.types.ts"
      to: "supabase schema"
      via: "npx supabase gen types"
      pattern: "source_url.*string"
---

<objective>
Create database migration to rename amazon_url column to source_url and regenerate TypeScript types.

Purpose: The column name "amazon_url" is a legacy artifact from when the app only supported Amazon links. Now that we support any URL via the scraping system, the column should reflect its actual purpose.

Output: Migration file and updated TypeScript types with source_url
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference for column structure
@supabase/migrations/20260201000001_initial_schema.sql
@types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create column rename migration</name>
  <files>supabase/migrations/20260216000001_rename_amazon_url_to_source_url.sql</files>
  <action>
Create a new migration file that:

1. Renames the column in wishlist_items table:
   ```sql
   ALTER TABLE public.wishlist_items
   RENAME COLUMN amazon_url TO source_url;
   ```

2. Add a comment explaining the rename:
   ```sql
   COMMENT ON COLUMN public.wishlist_items.source_url IS
     'URL to product page (renamed from amazon_url to reflect support for any retailer)';
   ```

This is a simple metadata-only operation - no data transformation needed. PostgreSQL handles column renames atomically.

Do NOT modify any RLS policies, indexes, or constraints - they reference the column by position/table, not by name.
  </action>
  <verify>
Run `npx supabase db diff` to verify the migration is valid syntax.
Check migration file exists and contains RENAME COLUMN statement.
  </verify>
  <done>Migration file exists at supabase/migrations/20260216000001_rename_amazon_url_to_source_url.sql with correct ALTER TABLE RENAME COLUMN statement</done>
</task>

<task type="auto">
  <name>Task 2: Regenerate TypeScript types</name>
  <files>types/database.types.ts</files>
  <action>
Run the Supabase type generation command to update TypeScript types:

```bash
npx supabase gen types typescript --local > types/database.types.ts
```

After generation, verify that:
1. The wishlist_items Row type has `source_url: string` (not `amazon_url`)
2. The wishlist_items Insert type has `source_url: string`
3. The wishlist_items Update type has `source_url?: string`
4. No references to `amazon_url` remain in the file

If supabase is not running locally, start it first:
```bash
npx supabase start
npx supabase db push  # Apply the new migration
npx supabase gen types typescript --local > types/database.types.ts
```
  </action>
  <verify>
Run: `grep -c "source_url" types/database.types.ts` (should show 3+ occurrences)
Run: `grep -c "amazon_url" types/database.types.ts` (should show 0)
  </verify>
  <done>types/database.types.ts contains source_url in wishlist_items Row/Insert/Update types, zero amazon_url references</done>
</task>

</tasks>

<verification>
1. Migration file exists with correct syntax
2. Types file regenerated with source_url
3. No amazon_url in types/database.types.ts
4. `npx tsc --noEmit` will fail (expected - source files still reference amazon_url, fixed in Plan 02)
</verification>

<success_criteria>
- [ ] supabase/migrations/20260216000001_rename_amazon_url_to_source_url.sql exists
- [ ] Migration contains ALTER TABLE RENAME COLUMN statement
- [ ] types/database.types.ts has source_url in wishlist_items types
- [ ] types/database.types.ts has zero amazon_url references
</success_criteria>

<output>
After completion, create `.planning/phases/41-column-rename/41-01-SUMMARY.md`
</output>
