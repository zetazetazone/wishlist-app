---
phase: 39-share-intent
plan: 03
type: execute
wave: 3
depends_on: ["39-01", "39-02"]
files_modified:
  - app/(app)/_layout.tsx
  - app/(app)/shared-url.tsx
autonomous: false

must_haves:
  truths:
    - "App detects incoming share intent in (app) layout"
    - "Share intent routes to shared-url screen with URL param"
    - "User sees scraped preview after sharing URL"
    - "User can quick-add to default wishlist with one tap"
    - "Share intent is reset after handling to prevent re-triggering"
  artifacts:
    - path: "app/(app)/shared-url.tsx"
      provides: "Share handler screen with preview and quick-add"
      min_lines: 100
    - path: "app/(app)/_layout.tsx"
      provides: "Share intent detection and routing"
      contains: "useShareIntentContext"
  key_links:
    - from: "app/(app)/_layout.tsx"
      to: "app/(app)/shared-url.tsx"
      via: "router.push with URL param"
      pattern: "router\\.push.*shared-url"
    - from: "app/(app)/shared-url.tsx"
      to: "lib/urlScraper.ts"
      via: "scrapeUrl function call"
      pattern: "scrapeUrl"
    - from: "app/(app)/shared-url.tsx"
      to: "lib/shareIntent.ts"
      via: "quickAddToDefaultWishlist call"
      pattern: "quickAddToDefaultWishlist"
---

<objective>
Create share handler screen with intent detection, scraping, and quick-add flow

Purpose: Complete the share intent user flow - detect shared URL, scrape metadata, enable quick-add
Output: shared-url.tsx screen, updated app layout with intent detection
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-share-intent/39-RESEARCH.md
@.planning/phases/39-share-intent/39-01-SUMMARY.md
@.planning/phases/39-share-intent/39-02-SUMMARY.md
@app/(app)/_layout.tsx
@app/(app)/add-from-url.tsx
@lib/urlScraper.ts
@lib/shareIntent.ts
@constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add share intent detection to app layout</name>
  <files>app/(app)/_layout.tsx</files>
  <action>
Modify `app/(app)/_layout.tsx` to detect incoming share intents and route to handler:

1. Add imports:
   ```typescript
   import { useShareIntentContext } from "expo-share-intent";
   import { useRouter } from "expo-router";
   import { useEffect } from "react";
   import { extractUrlFromText } from "../../lib/shareIntent";
   ```

2. Add share intent detection hook inside AppLayout:
   ```typescript
   const router = useRouter();
   const { hasShareIntent, shareIntent, resetShareIntent } = useShareIntentContext();

   useEffect(() => {
     if (hasShareIntent && shareIntent) {
       // Extract URL: prefer webUrl, fall back to extracting from text
       const url = shareIntent.webUrl || extractUrlFromText(shareIntent.text);

       if (url) {
         // Navigate to share handler with URL as param
         router.push({
           pathname: '/(app)/shared-url',
           params: { url }
         });
       }

       // Reset after handling to prevent re-triggering on navigation
       resetShareIntent();
     }
   }, [hasShareIntent, shareIntent]);
   ```

3. Add Stack.Screen for shared-url in the Stack:
   ```typescript
   <Stack.Screen
     name="shared-url"
     options={{
       headerShown: true,
       headerStyle: {
         backgroundColor: '#ffffff',
       },
       headerTintColor: '#8B1538',
       headerTitleStyle: {
         fontWeight: '600',
       },
       headerBackTitle: 'Back',
       title: 'Add Shared Item',
     }}
   />
   ```

This handles both SHARE-04 (cold start) and SHARE-05 (warm start) since ShareIntentProvider is at root level and this effect runs when app layout mounts.
  </action>
  <verify>
- `grep -n "useShareIntentContext" app/(app)/_layout.tsx` shows hook usage
- `grep -n "shared-url" app/(app)/_layout.tsx` shows Stack.Screen registered
  </verify>
  <done>App layout detects share intent and routes to shared-url screen</done>
</task>

<task type="auto">
  <name>Task 2: Create shared-url screen with preview and quick-add</name>
  <files>app/(app)/shared-url.tsx</files>
  <action>
Create `app/(app)/shared-url.tsx` as the share handler screen:

The screen should:
1. Receive URL from route params
2. Auto-scrape on mount using scrapeUrl from lib/urlScraper.ts
3. Show loading state while scraping
4. Display scraped preview (image, title, price, description)
5. Show quick-add button for one-tap save (SHARE-06)
6. Show edit button to go to full add-from-url form
7. Handle scrape failures gracefully with manual entry option

Use similar styling patterns from add-from-url.tsx for consistency.

Key implementation details:
```typescript
import { useState, useEffect } from 'react';
import { View, Text, TouchableOpacity, ActivityIndicator, Image, ScrollView } from 'react-native';
import { useRouter, useLocalSearchParams } from 'expo-router';
import { useTranslation } from 'react-i18next';
import { LinearGradient } from 'expo-linear-gradient';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import { scrapeUrl } from '../../lib/urlScraper';
import { quickAddToDefaultWishlist } from '../../lib/shareIntent';
import { supabase } from '../../lib/supabase';
import { colors, spacing, borderRadius, shadows } from '../../constants/theme';
import type { ScrapedMetadata } from '../../types/scraping.types';

export default function SharedUrlScreen() {
  const router = useRouter();
  const { url } = useLocalSearchParams<{ url: string }>();
  const { t } = useTranslation();

  const [isLoading, setIsLoading] = useState(true);
  const [metadata, setMetadata] = useState<ScrapedMetadata | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [isSaving, setIsSaving] = useState(false);

  // Auto-scrape on mount
  useEffect(() => {
    if (url) {
      handleScrape(url);
    }
  }, [url]);

  async function handleScrape(targetUrl: string) {
    setIsLoading(true);
    setError(null);

    const result = await scrapeUrl(targetUrl);

    if (result.success && result.data) {
      setMetadata(result.data);
    } else {
      setError(result.error || 'Failed to extract product info');
      // Set partial metadata for display
      setMetadata({
        title: null,
        description: null,
        imageUrl: null,
        price: null,
        currency: null,
        siteName: null,
        sourceUrl: targetUrl,
      });
    }

    setIsLoading(false);
  }

  async function handleQuickAdd() {
    if (!metadata) return;

    setIsSaving(true);
    const result = await quickAddToDefaultWishlist(metadata, supabase);
    setIsSaving(false);

    if (result.success) {
      // Show success and navigate to main app
      router.replace('/(app)/(tabs)');
    } else {
      setError(result.error || 'Failed to save');
    }
  }

  function handleEdit() {
    // Navigate to full add-from-url with prefilled URL
    router.push({
      pathname: '/(app)/add-from-url',
      params: { prefillUrl: url }
    });
  }

  // ... render loading, preview, buttons similar to add-from-url.tsx
}
```

Include:
- Loading indicator with "Loading product info..." text
- Image preview (200px height, or placeholder if no image)
- Title, price display
- Source URL display
- Gold "Add to Wishlist" button (quick-add)
- Secondary "Edit Details" button linking to full form
- Error state with option to edit manually
- Cancel button to dismiss
  </action>
  <verify>
- `cat app/(app)/shared-url.tsx` shows complete screen implementation
- File imports scrapeUrl from lib/urlScraper
- File imports quickAddToDefaultWishlist from lib/shareIntent
- `npx tsc --noEmit` passes
  </verify>
  <done>shared-url.tsx created with scraping, preview, and quick-add flow</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete share intent flow:
- iOS Share Extension activation rules configured
- Android Intent Filters configured
- ShareIntentProvider wrapping app at root
- Share intent detection in app layout
- URL extraction from text blocks
- shared-url.tsx screen with scraping and quick-add
  </what-built>
  <how-to-verify>
NOTE: This requires a development build, not Expo Go. Run `npx expo run:ios` or `npx expo run:android`.

1. Build and run development client:
   ```bash
   npx expo run:ios
   # or
   npx expo run:android
   ```

2. Test iOS share sheet (if on iOS):
   - Open Safari
   - Navigate to https://www.amazon.com/dp/B09V3KXJPB (any product URL)
   - Tap share icon
   - Verify "wishlist-app" appears in share sheet
   - Tap it
   - Verify app opens to shared-url screen
   - Verify scraped preview shows (or error state if scraping fails)
   - Tap "Add to Wishlist" for quick-add
   - Verify item appears in wishlist

3. Test Android share (if on Android):
   - Open Chrome
   - Navigate to any product URL
   - Tap share icon
   - Verify app appears in share options
   - Tap it
   - Verify same flow as iOS

4. Test cold start (SHARE-04):
   - Force quit the app
   - Share a URL from browser
   - Verify app launches and shows shared-url screen

5. Test warm start (SHARE-05):
   - Leave app in background
   - Share a URL from browser
   - Verify app foregrounds to shared-url screen

6. Test text with URL (SHARE-07):
   - Share text containing a URL (e.g., from Notes app: "Check this out: https://amazon.com/dp/B123")
   - Verify URL is extracted and scraped

Expected: App appears in share sheets, handles shared URLs, shows preview, quick-add works.
  </how-to-verify>
  <resume-signal>Type "approved" if share intent flow works end-to-end, or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
- [ ] app/(app)/_layout.tsx imports and uses useShareIntentContext
- [ ] app/(app)/_layout.tsx has Stack.Screen for shared-url
- [ ] app/(app)/shared-url.tsx exists with complete implementation
- [ ] Quick-add saves to default wishlist
- [ ] Edit button navigates to add-from-url
- [ ] Human verified: Share sheet shows app
- [ ] Human verified: Cold start works
- [ ] Human verified: Warm start works
- [ ] Human verified: Text with URL extraction works
</verification>

<success_criteria>
Complete share intent flow working - users can share URLs from Safari/Chrome/any app, see scraped preview, and quick-add to their default wishlist. Satisfies SHARE-01 through SHARE-08.
</success_criteria>

<output>
After completion, create `.planning/phases/39-share-intent/39-03-SUMMARY.md`
</output>
