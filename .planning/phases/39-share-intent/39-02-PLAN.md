---
phase: 39-share-intent
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - app/_layout.tsx
  - lib/shareIntent.ts
autonomous: true

must_haves:
  truths:
    - "ShareIntentProvider wraps entire app at root level"
    - "URL extraction handles both direct URLs and text with embedded URLs"
    - "Quick-add utility can save to default wishlist"
  artifacts:
    - path: "app/_layout.tsx"
      provides: "ShareIntentProvider wrapper"
      contains: "ShareIntentProvider"
    - path: "lib/shareIntent.ts"
      provides: "URL extraction and quick-add utilities"
      exports: ["extractUrlFromText", "quickAddToDefaultWishlist"]
  key_links:
    - from: "app/_layout.tsx"
      to: "expo-share-intent"
      via: "ShareIntentProvider import"
      pattern: "from.*expo-share-intent"
    - from: "lib/shareIntent.ts"
      to: "lib/supabase"
      via: "Supabase client for database operations"
      pattern: "from.*supabase"
---

<objective>
Integrate ShareIntentProvider at root level and create URL extraction utilities

Purpose: Enable share intent detection across the app and provide URL extraction from text blocks
Output: Provider integration, lib/shareIntent.ts with extraction and quick-add functions
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-share-intent/39-RESEARCH.md
@.planning/phases/39-share-intent/39-01-SUMMARY.md
@app/_layout.tsx
@lib/urlScraper.ts
@types/scraping.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shareIntent utility library</name>
  <files>lib/shareIntent.ts</files>
  <action>
Create `lib/shareIntent.ts` with:

1. URL extraction function for SHARE-07 (extracting URLs from text blocks):
   ```typescript
   /**
    * Extract first URL from text content
    * Handles both direct URLs and URLs embedded in text
    */
   export function extractUrlFromText(text: string | null | undefined): string | null {
     if (!text) return null;

     // Pattern for HTTP/HTTPS URLs
     const URL_REGEX = /https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*)/gi;

     const matches = text.match(URL_REGEX);
     return matches?.[0] || null;
   }
   ```

2. Quick-add to default wishlist function for SHARE-06:
   ```typescript
   import { SupabaseClient } from '@supabase/supabase-js';
   import type { ScrapedMetadata } from '../types/scraping.types';

   export interface QuickAddResult {
     success: boolean;
     error?: string;
   }

   /**
    * Quick-add scraped item to user's default wishlist
    */
   export async function quickAddToDefaultWishlist(
     metadata: ScrapedMetadata,
     supabase: SupabaseClient
   ): Promise<QuickAddResult> {
     try {
       const { data: { user } } = await supabase.auth.getUser();
       if (!user) {
         return { success: false, error: 'Not authenticated' };
       }

       // Get default wishlist
       const { data: defaultWishlist, error: wishlistError } = await supabase
         .from('wishlists')
         .select('id')
         .eq('user_id', user.id)
         .eq('is_default', true)
         .single();

       if (wishlistError || !defaultWishlist) {
         return { success: false, error: 'No default wishlist found' };
       }

       // Insert item
       const { error: insertError } = await supabase
         .from('wishlist_items')
         .insert({
           user_id: user.id,
           wishlist_id: defaultWishlist.id,
           group_id: null,
           name: metadata.title || 'Untitled Item',
           description: metadata.description || null,
           price: metadata.price,
           image_url: metadata.imageUrl,
           amazon_url: metadata.sourceUrl, // Legacy column name
           priority: 0,
           status: 'active',
           item_type: 'standard',
         });

       if (insertError) {
         return { success: false, error: insertError.message };
       }

       return { success: true };
     } catch (error) {
       return {
         success: false,
         error: error instanceof Error ? error.message : 'Unknown error'
       };
     }
   }
   ```

3. Type exports for the module.

Pattern follows existing add-from-url.tsx save logic for consistency.
  </action>
  <verify>
- `cat lib/shareIntent.ts` shows extractUrlFromText and quickAddToDefaultWishlist functions
- No TypeScript errors: `npx tsc --noEmit lib/shareIntent.ts` (or check via IDE)
  </verify>
  <done>lib/shareIntent.ts created with URL extraction and quick-add utilities</done>
</task>

<task type="auto">
  <name>Task 2: Wrap root layout with ShareIntentProvider</name>
  <files>app/_layout.tsx</files>
  <action>
Modify `app/_layout.tsx` to wrap the entire component tree with ShareIntentProvider:

1. Add import at top:
   ```typescript
   import { ShareIntentProvider } from "expo-share-intent";
   ```

2. Wrap the return JSX with ShareIntentProvider as the outermost provider:
   ```typescript
   return (
     <ShareIntentProvider>
       <GluestackUIProvider config={config}>
         {/* ... existing providers ... */}
       </GluestackUIProvider>
     </ShareIntentProvider>
   );
   ```

IMPORTANT: ShareIntentProvider MUST be at the outermost level, before auth checks, so it can capture share intents on cold start before auth state is determined.

The provider placement is critical for SHARE-04 (cold start) - if placed inside auth-dependent code, share intents may be lost.
  </action>
  <verify>
- `grep -n "ShareIntentProvider" app/_layout.tsx` shows import and usage
- `npx tsc --noEmit` passes (or IDE shows no errors)
- ShareIntentProvider wraps the entire return statement
  </verify>
  <done>Root layout wrapped with ShareIntentProvider at outermost level</done>
</task>

</tasks>

<verification>
- [ ] lib/shareIntent.ts exists with extractUrlFromText function
- [ ] lib/shareIntent.ts has quickAddToDefaultWishlist function
- [ ] app/_layout.tsx imports ShareIntentProvider from expo-share-intent
- [ ] ShareIntentProvider wraps entire component tree (outermost provider)
- [ ] No TypeScript errors in modified files
</verification>

<success_criteria>
ShareIntentProvider active at app root, utilities ready for share handler screen. URL extraction handles SHARE-07 (text with URLs). Quick-add ready for SHARE-06.
</success_criteria>

<output>
After completion, create `.planning/phases/39-share-intent/39-02-SUMMARY.md`
</output>
