---
phase: 05-integration-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260202000010_fix_read_at_schema.sql
  - docs/WEBHOOK-SETUP.md
  - types/database.types.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Notification inbox mark-as-read works without SQL errors"
    - "Webhook configuration is documented with step-by-step instructions"
    - "Database schema matches TypeScript type definitions"
  artifacts:
    - path: "supabase/migrations/20260202000010_fix_read_at_schema.sql"
      provides: "Schema fix replacing is_read with read_at"
      contains: "read_at TIMESTAMPTZ"
    - path: "docs/WEBHOOK-SETUP.md"
      provides: "Complete webhook configuration guide"
      min_lines: 50
    - path: "types/database.types.ts"
      provides: "Updated type definitions"
      contains: "read_at"
  key_links:
    - from: "app/(app)/(tabs)/notifications.tsx"
      to: "user_notifications.read_at"
      via: "Supabase update query"
      pattern: "update.*read_at"
    - from: "supabase/functions/push/index.ts"
      to: "Expo Push Service"
      via: "Webhook trigger"
      pattern: "exp.host.*push"
---

<objective>
Fix schema mismatch and document webhook configuration to enable full E2E notification flows.

Purpose: Close gaps identified in v1 milestone audit that prevent push notification delivery and mark-as-read functionality.
Output: Working mark-as-read functionality, comprehensive webhook setup documentation.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1-MILESTONE-AUDIT.md
@.planning/phases/05-integration-fixes/05-RESEARCH.md
@supabase/migrations/20260202000001_notifications.sql
@app/(app)/(tabs)/notifications.tsx
@types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schema migration to fix is_read vs read_at mismatch</name>
  <files>
    supabase/migrations/20260202000010_fix_read_at_schema.sql
    types/database.types.ts
  </files>
  <action>
Create a new migration file `supabase/migrations/20260202000010_fix_read_at_schema.sql` that fixes the schema mismatch:

1. Drop the existing index on is_read (MUST be done before column drop):
   ```sql
   DROP INDEX IF EXISTS idx_user_notifications_is_read;
   ```

2. Drop the old is_read column:
   ```sql
   ALTER TABLE public.user_notifications DROP COLUMN IF EXISTS is_read;
   ```

3. Add the new read_at column (nullable TIMESTAMPTZ - NULL means unread):
   ```sql
   ALTER TABLE public.user_notifications ADD COLUMN IF NOT EXISTS read_at TIMESTAMPTZ;
   ```

4. Create new index for efficient unread queries:
   ```sql
   CREATE INDEX IF NOT EXISTS idx_user_notifications_read_at ON public.user_notifications(read_at);
   ```

5. Add documentation comment:
   ```sql
   COMMENT ON COLUMN public.user_notifications.read_at IS 'Timestamp when notification was read. NULL means unread.';
   ```

Then update `types/database.types.ts`:
- Find the UserNotification interface
- Replace `is_read: boolean` with `read_at: string | null`
- The existing code in notifications.tsx already expects read_at, so no changes needed there

Use IF EXISTS/IF NOT EXISTS for idempotency.
  </action>
  <verify>
Run `cat supabase/migrations/20260202000010_fix_read_at_schema.sql` and verify:
- DROP INDEX for idx_user_notifications_is_read
- DROP COLUMN for is_read
- ADD COLUMN for read_at TIMESTAMPTZ
- CREATE INDEX for read_at
- Proper IF EXISTS/IF NOT EXISTS clauses

Run `grep -n "read_at" types/database.types.ts` to verify type definition updated.
  </verify>
  <done>
Migration file exists with correct DDL statements. TypeScript types updated. Schema will match code after migration is applied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive webhook setup documentation</name>
  <files>
    docs/WEBHOOK-SETUP.md
  </files>
  <action>
Create `docs/WEBHOOK-SETUP.md` with comprehensive webhook configuration guide.

The documentation MUST include:

**1. Overview Section**
- Explain that Supabase webhooks cannot be created via SQL migrations
- Explain why this is needed (triggers Edge Function for push delivery)
- Link to where the Edge Function is defined

**2. Prerequisites Section**
- Edge Function deployed (`npx supabase functions deploy push`)
- Project reference ID (from Supabase Dashboard URL)
- Anon key (from Supabase Dashboard -> Settings -> API)

**3. Dashboard Configuration Steps (Primary Method)**
Step-by-step with exact paths:
1. Open Supabase Dashboard
2. Navigate to Database -> Webhooks
3. Click "Create webhook"
4. Configure:
   - Name: `push-notifications`
   - Table: `user_notifications`
   - Events: `INSERT`
   - Type: `HTTP Request`
   - Method: `POST`
   - URL: `https://<project-ref>.supabase.co/functions/v1/push`
   - Headers:
     - `Authorization: Bearer <anon-key>`
     - `Content-Type: application/json`

**4. Verification Section**
How to test the webhook:
```sql
-- Insert test notification (run in SQL Editor)
INSERT INTO public.user_notifications (user_id, title, body, data)
VALUES (
  (SELECT id FROM auth.users LIMIT 1),
  'Test Notification',
  'Testing webhook configuration',
  '{}'::jsonb
);
```
Then check:
- Supabase Dashboard -> Edge Functions -> push -> Logs
- Physical device for push notification receipt

**5. Troubleshooting Section**
Common issues:
- "Function not found" - Edge Function not deployed
- "Unauthorized" - Wrong anon key or missing Authorization header
- "Connection refused" - Function crashed, check logs
- Push not received - Device token not registered, or Expo token invalid

**6. Local Development Note**
For local Supabase development, webhooks use:
- URL: `http://host.docker.internal:54321/functions/v1/push`
- Note: `localhost` doesn't work from Docker container

Use proper markdown formatting with code blocks, headers, and bullet points.
  </action>
  <verify>
Run `cat docs/WEBHOOK-SETUP.md` and verify:
- Has all 6 sections (Overview, Prerequisites, Configuration, Verification, Troubleshooting, Local Development)
- Includes exact Dashboard navigation path
- Includes test SQL query
- At least 50 lines
  </verify>
  <done>
Comprehensive webhook documentation exists at docs/WEBHOOK-SETUP.md with step-by-step instructions for configuration and verification.
  </done>
</task>

</tasks>

<verification>
1. Migration file exists with correct DDL:
   ```bash
   cat supabase/migrations/20260202000010_fix_read_at_schema.sql | head -20
   ```

2. TypeScript types updated:
   ```bash
   grep -A 5 "UserNotification" types/database.types.ts | grep read_at
   ```

3. Documentation complete:
   ```bash
   wc -l docs/WEBHOOK-SETUP.md  # Should be >= 50 lines
   grep -c "## " docs/WEBHOOK-SETUP.md  # Should show multiple sections
   ```

4. No TypeScript errors introduced:
   ```bash
   npx tsc --noEmit 2>&1 | head -20
   ```
</verification>

<success_criteria>
- [ ] Migration file 20260202000010_fix_read_at_schema.sql exists
- [ ] Migration drops is_read index and column
- [ ] Migration adds read_at TIMESTAMPTZ column
- [ ] TypeScript types updated (read_at instead of is_read)
- [ ] docs/WEBHOOK-SETUP.md exists with >= 50 lines
- [ ] Documentation includes Dashboard configuration steps
- [ ] Documentation includes verification SQL query
- [ ] Documentation includes troubleshooting section
- [ ] No new TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-integration-fixes/05-01-SUMMARY.md`
</output>
