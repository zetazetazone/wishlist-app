---
phase: 14-group-view-redesign
plan: 03
type: execute
wave: 2
depends_on: ["14-01", "14-02"]
files_modified:
  - utils/groups.ts
  - app/group/[id].tsx
autonomous: true

must_haves:
  truths:
    - "Member cards sorted by closest upcoming birthday"
    - "Member cards show favorite item preview (thumbnail and title) if available"
    - "Tapping member card navigates to their celebration page"
  artifacts:
    - path: "utils/groups.ts"
      provides: "Enhanced fetchGroupDetails with favorites data"
      exports: ["fetchGroupDetails"]
    - path: "app/group/[id].tsx"
      provides: "Redesigned group detail screen with new components"
      min_lines: 150
  key_links:
    - from: "app/group/[id].tsx"
      to: "components/groups/GroupViewHeader.tsx"
      via: "import and render"
      pattern: "import.*GroupViewHeader"
    - from: "app/group/[id].tsx"
      to: "components/groups/MemberCard.tsx"
      via: "import and render in map"
      pattern: "import.*MemberCard"
    - from: "app/group/[id].tsx"
      to: "utils/countdown.ts"
      via: "import getDaysUntilBirthday and sortByUpcoming"
      pattern: "import.*sortByUpcoming.*from.*countdown"
    - from: "utils/groups.ts"
      to: "group_favorites"
      via: "Supabase query join"
      pattern: "group_favorites"
---

<objective>
Integrate new components into the group detail screen with birthday sorting and favorites data.

Purpose: Complete the group view redesign by wiring header and member card components, implementing birthday sorting, fetching favorites data, and enabling member navigation (GVIEW-04, GVIEW-06, GVIEW-07).
Output: Fully redesigned group detail screen with all GVIEW requirements implemented.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-group-view-redesign/14-RESEARCH.md

# Prior plan outputs (from this phase)
@.planning/phases/14-group-view-redesign/14-01-SUMMARY.md
@.planning/phases/14-group-view-redesign/14-02-SUMMARY.md

# Files to modify
@utils/groups.ts
@app/group/[id].tsx
@utils/countdown.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance fetchGroupDetails to include favorites</name>
  <files>utils/groups.ts</files>
  <action>
Modify fetchGroupDetails to also fetch group_favorites with wishlist_items data for each member.

After fetching members, add a second query to get favorites:
```typescript
// Fetch favorites for all members in this group
const memberIds = members.map(m => m.users.id);
const { data: favorites, error: favoritesError } = await supabase
  .from('group_favorites')
  .select(`
    user_id,
    item_id,
    wishlist_items (
      id,
      title,
      image_url,
      item_type
    )
  `)
  .eq('group_id', groupId)
  .in('user_id', memberIds);

if (favoritesError) {
  console.error('Failed to fetch favorites:', favoritesError);
  // Non-blocking - continue without favorites
}

// Build a map of user_id -> favorite item
const favoritesByUser: Record<string, { title: string; image_url: string | null; item_type: string } | null> = {};
(favorites || []).forEach(f => {
  if (f.wishlist_items) {
    const item = f.wishlist_items as unknown as { title: string; image_url: string | null; item_type: string };
    favoritesByUser[f.user_id] = item;
  }
});
```

Return the favoritesByUser in the result:
```typescript
return { data: { ...group, members, favoritesByUser }, error: null };
```

This avoids N+1 queries by fetching all favorites in a single batch query.
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit`
fetchGroupDetails returns favoritesByUser in response
  </verify>
  <done>
fetchGroupDetails fetches member favorites in single batch query, returns favoritesByUser map
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor GroupDetailScreen with new components</name>
  <files>app/group/[id].tsx</files>
  <action>
Completely refactor the group detail screen to use new components and implement birthday sorting.

Imports to add:
```typescript
import { GroupViewHeader } from '../../components/groups/GroupViewHeader';
import { MemberCard } from '../../components/groups/MemberCard';
import { getDaysUntilBirthday, sortByUpcoming } from '../../utils/countdown';
```

Update GroupWithMembers interface to include favoritesByUser:
```typescript
interface GroupWithMembers extends Group {
  members: Array<{
    role: string;
    users: User;
  }>;
  favoritesByUser?: Record<string, { title: string; image_url: string | null; item_type: string } | null>;
}
```

Add state for sorted members:
```typescript
const [sortedMembers, setSortedMembers] = useState<Array<{
  role: string;
  users: User;
  daysUntil: number;
}>>([]);
```

Add useEffect to compute sorted members when group data loads:
```typescript
useEffect(() => {
  if (!group?.members) return;

  const membersWithCountdown = group.members.map(member => ({
    ...member,
    daysUntil: getDaysUntilBirthday(member.users.birthday || ''),
  }));

  // Sort by daysUntil (ascending - closest birthday first)
  const sorted = [...membersWithCountdown].sort((a, b) => {
    // Handle invalid dates (-1) by putting them at the end
    if (a.daysUntil === -1) return 1;
    if (b.daysUntil === -1) return -1;
    return a.daysUntil - b.daysUntil;
  });

  setSortedMembers(sorted);
}, [group?.members]);
```

Replace the entire header (LinearGradient block) with:
```typescript
<GroupViewHeader
  group={{
    name: group.name,
    description: group.description,
    photo_url: group.photo_url,
    mode: group.mode || 'gifts',
  }}
  memberCount={group.members?.length || 0}
  onBack={() => router.push('/(app)/(tabs)/groups')}
/>
```

Replace the members section with:
```typescript
<View style={{ marginBottom: spacing.lg }}>
  <Text style={{
    fontSize: 20,
    fontWeight: '700',
    color: colors.burgundy[800],
    marginBottom: spacing.md,
  }}>
    Members
  </Text>

  <View style={{ gap: spacing.sm }}>
    {sortedMembers.map((member, index) => (
      <MemberCard
        key={member.users.id}
        member={member}
        daysUntilBirthday={member.daysUntil}
        favoriteItem={group.favoritesByUser?.[member.users.id] || null}
        onPress={() => router.push(`/celebration/${member.users.id}`)}
        index={index}
      />
    ))}
  </View>
</View>
```

Keep the action buttons section (Share Invite Code, View Invite Code) as-is.

IMPORTANT:
- Remove all email-related rendering (MaterialCommunityIcons email, email text)
- Member navigation goes to `/celebration/{userId}` for their celebration page
- The mode field may be undefined for old groups - default to 'gifts'
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit`
Email is not rendered anywhere in the file
GroupViewHeader and MemberCard are imported and used
sortByUpcoming or manual sorting is implemented
Navigation to celebration page is wired
  </verify>
  <done>
Group detail screen uses new header and member card components, members sorted by birthday, favorites displayed, email hidden, navigation to celebration page works
  </done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] fetchGroupDetails returns favoritesByUser data
- [ ] GroupDetailScreen imports and uses GroupViewHeader
- [ ] GroupDetailScreen imports and uses MemberCard
- [ ] Members are sorted by birthday (closest first)
- [ ] No email is displayed on member cards
- [ ] Tapping member card navigates to /celebration/{userId}
- [ ] App runs without crashes: `npm run start` and test navigation
</verification>

<success_criteria>
1. Group header displays photo/avatar, name, description, mode badge (GVIEW-01, GVIEW-02)
2. Member cards show profile photo and name only - no email (GVIEW-03)
3. Members sorted by closest upcoming birthday (GVIEW-04)
4. Member cards show birthday countdown text (GVIEW-05)
5. Member cards show favorite item preview when available (GVIEW-06)
6. Tapping member card navigates to their celebration page (GVIEW-07)
7. All 7 GVIEW requirements are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/14-group-view-redesign/14-03-SUMMARY.md`
</output>
