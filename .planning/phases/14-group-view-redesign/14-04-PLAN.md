---
phase: 14-group-view-redesign
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/celebrations.ts
  - app/group/[id].tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Tapping a member card navigates to that member's celebration page when a celebration exists"
    - "Tapping a member card shows a graceful message when no celebration exists for that member"
    - "Navigation uses a celebration record ID, not a user ID"
  artifacts:
    - path: "lib/celebrations.ts"
      provides: "Function to find celebration by user_id + group_id"
      exports: ["findCelebrationForMember"]
    - path: "app/group/[id].tsx"
      provides: "Fixed onPress handler that resolves celebration ID before navigating"
      contains: "findCelebrationForMember"
  key_links:
    - from: "app/group/[id].tsx"
      to: "lib/celebrations.ts"
      via: "findCelebrationForMember(userId, groupId)"
      pattern: "findCelebrationForMember"
    - from: "app/group/[id].tsx"
      to: "/(app)/celebration/[id]"
      via: "router.push with celebration.id"
      pattern: "celebration\\.id"
---

<objective>
Fix member card navigation bug: tapping a member card passes a user ID to the celebration screen, but the celebration screen expects a celebration record ID. The fix adds a lookup function to find a celebration by user_id + group_id, then navigates with the correct celebration ID. When no celebration exists for that member (birthday not yet scheduled), show an informative alert instead of navigating to an error page.

Purpose: Close the sole UAT gap from 14-03 (test 6: celebration navigation)
Output: Working member card navigation that correctly reaches celebration pages
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-group-view-redesign/14-03-SUMMARY.md

Key source files:
@lib/celebrations.ts
@app/group/[id].tsx
@app/(app)/celebration/[id].tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add findCelebrationForMember function and fix navigation</name>
  <files>lib/celebrations.ts, app/group/[id].tsx</files>
  <action>
**In `lib/celebrations.ts`**, add a new exported async function `findCelebrationForMember`:

```typescript
export async function findCelebrationForMember(
  userId: string,
  groupId: string
): Promise<{ id: string; status: string } | null>
```

Implementation:
- Query the `celebrations` table filtering by `celebrant_id = userId` AND `group_id = groupId`
- Order by `event_date` descending (most recent/upcoming first)
- Limit to 1 result
- Return `{ id, status }` if found, `null` if no rows
- No need for user auth check here -- RLS handles access control
- No need for elaborate joins -- we only need the celebration ID and status

**In `app/group/[id].tsx`**, fix the MemberCard `onPress` handler:

1. Import `findCelebrationForMember` from `../../lib/celebrations`
2. Import `Alert` (already imported)
3. Replace the inline `onPress` arrow function on line 248:

   FROM: `onPress={() => router.push(\`/(app)/celebration/${member.users.id}\`)}`

   TO: A named async function `handleMemberPress(userId: string)` that:
   - Calls `findCelebrationForMember(userId, id)` where `id` is the group ID from useLocalSearchParams
   - If a celebration is found: `router.push(\`/(app)/celebration/${celebration.id}\`)`
   - If no celebration exists: Show `Alert.alert('No Celebration Yet', 'There is no upcoming celebration for this member yet. Celebrations are created automatically as birthdays approach.')`

4. Update the MemberCard onPress prop: `onPress={() => handleMemberPress(member.users.id)}`

Do NOT add loading states or spinners for the lookup -- it should be fast enough that a brief delay is acceptable. Keep it simple.
  </action>
  <verify>
1. `npx tsc --noEmit` passes (or has no NEW errors beyond pre-existing ones)
2. Grep for `member.users.id` in the router.push call in `app/group/[id].tsx` -- should NOT appear (the old bug pattern)
3. Grep for `findCelebrationForMember` in both `lib/celebrations.ts` (definition) and `app/group/[id].tsx` (usage) -- should appear in both
4. Grep for `celebration.id` in the router.push call -- should appear (the correct pattern)
  </verify>
  <done>
- `findCelebrationForMember` exported from `lib/celebrations.ts`, queries by celebrant_id + group_id
- `app/group/[id].tsx` MemberCard onPress calls `findCelebrationForMember` then navigates with celebration record ID
- When no celebration exists, user sees an alert instead of an error page
- No regression in existing celebration screen behavior (it still receives a celebration UUID)
  </done>
</task>

</tasks>

<verification>
1. The navigation path from member card to celebration screen uses a celebration record UUID, not a user UUID
2. `findCelebrationForMember` queries `celebrations` table by `celebrant_id` + `group_id`
3. Graceful handling when no celebration record exists (alert, not error page)
4. TypeScript compiles without new errors
</verification>

<success_criteria>
- UAT test 6 ("Tapping on a member card navigates to that member's celebration page") passes
- No "Celebration not found or access denied" error when tapping member cards
- Members without an active celebration see a friendly alert message
</success_criteria>

<output>
After completion, create `.planning/phases/14-group-view-redesign/14-04-SUMMARY.md`
</output>
