---
phase: 20-personal-details
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - components/profile/SizesSection.tsx
  - components/profile/PreferencesSection.tsx
  - components/profile/ExternalLinksSection.tsx
  - components/profile/ExternalLinkRow.tsx
  - app/(app)/settings/personal-details.tsx
autonomous: true

must_haves:
  truths:
    - "User can select clothing sizes from dropdowns"
    - "User can add/remove color, brand, interest, and dislike tags"
    - "User can add external links with URL validation"
    - "User can save all personal details with single button"
    - "Form loads existing data on mount"
  artifacts:
    - path: "components/profile/SizesSection.tsx"
      provides: "Clothing size selectors"
      exports: ["SizesSection"]
    - path: "components/profile/PreferencesSection.tsx"
      provides: "Tag inputs for preferences"
      exports: ["PreferencesSection"]
    - path: "components/profile/ExternalLinksSection.tsx"
      provides: "External link list with add modal"
      exports: ["ExternalLinksSection"]
    - path: "app/(app)/settings/personal-details.tsx"
      provides: "Personal details edit screen"
  key_links:
    - from: "app/(app)/settings/personal-details.tsx"
      to: "lib/personalDetails.ts"
      via: "getPersonalDetails and upsertPersonalDetails"
      pattern: "import.*getPersonalDetails|upsertPersonalDetails"
    - from: "components/profile/PreferencesSection.tsx"
      to: "components/profile/TagInput.tsx"
      via: "uses TagInput component"
      pattern: "import.*TagInput"
---

<objective>
Build form sections and the personal details edit screen for users to fill in their sizes, preferences, and external links

Purpose: This is the core user-facing feature for PROF-01 through PROF-05, enabling users to share personal details for better gift selection.

Output: Form section components and a complete edit screen at /settings/personal-details
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-personal-details/20-RESEARCH.md
@.planning/phases/20-personal-details/20-01-SUMMARY.md (TagChip, TagInput, CompletenessIndicator)
@lib/personalDetails.ts (getPersonalDetails, upsertPersonalDetails)
@types/database.types.ts (PersonalSizes, PersonalPreferences, ExternalLink)
@app/(app)/settings/profile.tsx (form pattern reference)
@constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create form section components</name>
  <files>
    components/profile/SizesSection.tsx
    components/profile/PreferencesSection.tsx
    components/profile/ExternalLinksSection.tsx
    components/profile/ExternalLinkRow.tsx
  </files>
  <action>
**SizesSection.tsx:**
- Props: `{ sizes: PersonalSizes; onChange: (sizes: PersonalSizes) => void }`
- Display: VStack with Heading "Clothing Sizes" and helper text
- Four size fields using gluestack-ui Select component:
  - Shirt: options ['XS', 'S', 'M', 'L', 'XL', 'XXL', '3XL']
  - Pants: free text Input (varied formats like "32x30", "M", "size 8")
  - Shoe: free text Input (e.g., "10 US", "42 EU")
  - Ring: free text Input (e.g., "7", "size 6")
- onChange spreads existing sizes and updates single key: `onChange({ ...sizes, [key]: value || undefined })`
- Clear value if empty string (don't store empty strings)

**PreferencesSection.tsx:**
- Props: `{ preferences: PersonalPreferences; onChange: (prefs: PersonalPreferences) => void }`
- Display: VStack with Heading "Preferences"
- Four TagInput instances:
  1. Favorite Colors: predefinedOptions=['Red', 'Blue', 'Green', 'Black', 'White', 'Pink', 'Purple', 'Orange', 'Yellow', 'Gray', 'Brown', 'Navy', 'Teal']
  2. Favorite Brands: no predefinedOptions, placeholder="Add brands you love"
  3. Interests: no predefinedOptions, placeholder="Add hobbies or interests"
  4. Dislikes: no predefinedOptions, placeholder="Things to avoid", use warning color hint text
- Each TagInput maps to preferences.colors, preferences.brands, preferences.interests, preferences.dislikes

**ExternalLinkRow.tsx:**
- Props: `{ link: ExternalLink; onRemove: () => void; onOpen: () => void }`
- detectPlatform helper: returns 'amazon' | 'pinterest' | 'etsy' | 'other' based on hostname
- Platform icons map: amazon (orange), pinterest (red), etsy (orange), other (burgundy)
- Display: HStack with platform icon, label (or URL if no label), open button, remove button
- Use MaterialCommunityIcons: 'amazon', 'pinterest', 'link-variant' (for other)
- Note: Pinterest and Etsy don't have direct icons, use 'link-variant' with platform color

**ExternalLinksSection.tsx:**
- Props: `{ links: ExternalLink[]; onChange: (links: ExternalLink[]) => void }`
- Display: VStack with Heading "External Wishlists" and helper text
- List of ExternalLinkRow for each link
- "Add Link" Button at bottom
- Add link modal (useState visible):
  - URL Input with validation using `new URL()` constructor
  - Optional Label Input
  - Add button (disabled if URL invalid)
  - URL validation: must be http/https, show error if invalid
- onOpen: use Linking.openURL(link.url)
- onRemove: filter out link by index
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- All 4 files exist in components/profile/
- Import paths resolve correctly
  </verify>
  <done>
- SizesSection renders Select for shirt, Input for pants/shoe/ring
- PreferencesSection renders 4 TagInput components for colors/brands/interests/dislikes
- ExternalLinksSection renders links with add/remove/open functionality
- URL validation prevents invalid URLs
  </done>
</task>

<task type="auto">
  <name>Task 2: Create personal details edit screen</name>
  <files>
    app/(app)/settings/personal-details.tsx
  </files>
  <action>
Create the personal details form screen following profile.tsx pattern:

**State:**
- isLoading, isSaving booleans
- sizes: PersonalSizes (initialize {})
- preferences: PersonalPreferences (initialize {})
- externalLinks: ExternalLink[] (initialize [])

**Load on mount:**
```typescript
useEffect(() => {
  loadDetails();
}, []);

const loadDetails = async () => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) { router.back(); return; }

  const details = await getPersonalDetails(user.id);
  if (details) {
    setSizes(details.sizes);
    setPreferences(details.preferences);
    setExternalLinks(details.external_links);
  }
  setIsLoading(false);
};
```

**Save handler:**
```typescript
const handleSave = async () => {
  setIsSaving(true);
  try {
    await upsertPersonalDetails({
      sizes,
      preferences,
      external_links: externalLinks,
    });
    Alert.alert('Success', 'Personal details saved', [
      { text: 'OK', onPress: () => router.back() }
    ]);
  } catch (error) {
    Alert.alert('Error', 'Failed to save personal details');
  } finally {
    setIsSaving(false);
  }
};
```

**Layout:**
- ScrollView with padding
- Heading "Personal Details"
- CompletenessIndicator (import from components/profile)
- SizesSection
- PreferencesSection
- ExternalLinksSection
- Save Button (disabled while saving)
- Loading spinner when isLoading

**Update settings layout:**
Read `app/(app)/settings/_layout.tsx` and add screen if needed. The layout should already support dynamic screens.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Screen exists at app/(app)/settings/personal-details.tsx
- Screen imports all section components
- `grep -E 'import.*getPersonalDetails|upsertPersonalDetails' app/(app)/settings/personal-details.tsx` confirms service functions are imported
- `grep 'upsertPersonalDetails' app/(app)/settings/personal-details.tsx` confirms save function is called
  </verify>
  <done>
- Form loads existing personal details
- User can edit sizes, preferences, and links
- Save button persists all changes
- Completeness indicator updates as form is filled
- Navigation works from /settings/profile
  </done>
</task>

</tasks>

<verification>
- All 5 files created and compile without errors
- Form state manages all three JSONB sections
- Save button calls upsertPersonalDetails with all fields
- PROF-01 (sizes), PROF-02 (colors), PROF-03 (brands/interests), PROF-04 (dislikes), PROF-05 (external links) implemented
</verification>

<success_criteria>
- User can fill in all personal details sections
- Form saves all data atomically (no partial saves)
- Completeness indicator reflects actual form state
- URL validation prevents invalid external links
</success_criteria>

<output>
After completion, create `.planning/phases/20-personal-details/20-02-SUMMARY.md`
</output>
