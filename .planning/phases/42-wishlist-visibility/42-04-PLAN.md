---
phase: 42-wishlist-visibility
plan: 04
type: execute
wave: 3
depends_on: ["42-02", "42-03"]
files_modified:
  - app/(app)/celebration/[id].tsx
  - locales/en/translation.json
autonomous: false

must_haves:
  truths:
    - "Celebration page shows celebrant's public wishlists"
    - "Each wishlist appears as collapsible section with name and emoji"
    - "Private wishlists do NOT appear on celebration page"
    - "User can browse items from multiple public wishlists"
  artifacts:
    - path: "app/(app)/celebration/[id].tsx"
      provides: "Public wishlists display using useCelebrantPublicWishlists"
      contains: "useCelebrantPublicWishlists"
    - path: "locales/en/translation.json"
      provides: "Translation keys for visibility features"
      contains: "wishlists.selectGroup"
  key_links:
    - from: "celebration/[id].tsx"
      to: "useCelebrantPublicWishlists"
      via: "hook invocation"
      pattern: "useCelebrantPublicWishlists.*celebrant_id"
    - from: "celebration/[id].tsx"
      to: "WishlistGrid"
      via: "render items from public wishlists"
      pattern: "WishlistGrid.*items"
---

<objective>
Integrate public wishlists display on celebration pages and add translation keys.

Purpose: Show celebrant's public wishlists on their celebration page so group members can see and claim items (VIS-07). Add missing translation keys for visibility features.

Output: Updated celebration page with multi-wishlist support, complete translation keys.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-wishlist-visibility/42-RESEARCH.md
@.planning/phases/42-wishlist-visibility/42-02-SUMMARY.md

# Existing celebration page
@app/(app)/celebration/[id].tsx
@locales/en/translation.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add translation keys for visibility features</name>
  <files>locales/en/translation.json</files>
  <action>
Add these translation keys under the "wishlists" section in locales/en/translation.json:

```json
{
  "wishlists": {
    // ... existing keys ...
    "selectGroup": "Select Group",
    "noGroupLink": "No group link",
    "linkToGroup": "Link to Group",
    "selectGroupOptional": "Select a group (optional)",
    "groupLinked": "Group linked",
    "groupLinkHelp": "Group members can view and add items to this wishlist",
    "visibilityHelp": {
      "public": "Visible to all your groups",
      "private": "Only you can see this",
      "friends": "Visible to your friends"
    },
    "celebrantWishlists": "{{name}}'s Wishlists",
    "itemsInWishlist": "{{count}} items",
    "noPublicWishlists": "No public wishlists to show"
  }
}
```

Also ensure these keys exist (may already be present):
- "wishlists.visibility"
- "wishlists.public"
- "wishlists.private"
- "wishlists.friendsOnly"
- "wishlists.ownerType"
- "wishlists.forMyself"
- "wishlists.forOther"
- "wishlists.forFriend"

If the file uses a different structure, follow the existing pattern.
  </action>
  <verify>
Grep locales/en/translation.json for "selectGroup" and "groupLinkHelp".
Verify JSON is valid using `cat locales/en/translation.json | python3 -m json.tool > /dev/null`.
  </verify>
  <done>
Translation keys for visibility features added to English translation file.
JSON is valid.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update celebration page to show public wishlists</name>
  <files>app/(app)/celebration/[id].tsx</files>
  <action>
Update the celebration page to fetch and display celebrant's public wishlists instead of flat items list.

**1. Add import:**
```typescript
import { useCelebrantPublicWishlists } from '../../../hooks/useWishlists';
```

**2. Replace the existing celebrant wishlist loading with the new hook:**
Find the section that loads celebrant items (loadCelebrantWishlist callback) and modify:

```typescript
// Add at top of component after other hooks
const {
  data: celebrantWishlists,
  isLoading: wishlistsLoading
} = useCelebrantPublicWishlists(celebration?.celebrant_id);
```

**3. Remove old state and callback:**
Remove:
- `const [celebrantItems, setCelebrantItems] = useState<WishlistItem[]>([]);`
- `const loadCelebrantWishlist = useCallback(...)`
- The useEffect that calls loadCelebrantWishlist

Keep wishlistLoading state but wire to query loading.

**4. Update the Wishlist Section render (in gifts mode):**
Replace the existing celebrant wishlist section with collapsible wishlist sections:

```tsx
{/* Celebrant's Public Wishlists Section */}
<View style={styles.section}>
  <View style={styles.sectionHeader}>
    <MaterialCommunityIcons name="gift" size={22} color="#8B1538" />
    <Text style={styles.sectionTitle}>
      {t('wishlists.celebrantWishlists', { name: celebrantName })}
    </Text>
  </View>

  {wishlistsLoading ? (
    <View style={styles.loadingCard}>
      <ActivityIndicator size="small" color="#8B1538" />
    </View>
  ) : !celebrantWishlists || celebrantWishlists.length === 0 ? (
    <View style={styles.emptyCard}>
      <Text style={styles.emptyText}>{t('wishlists.noPublicWishlists')}</Text>
    </View>
  ) : (
    celebrantWishlists.map((wishlist) => (
      <WishlistSection
        key={wishlist.id}
        wishlist={wishlist}
        onItemPress={handleWishlistItemPress}
        onItemAction={handleWishlistItemAction}
        currentUserId={currentUserId}
        isCelebrant={currentUserId === celebration?.celebrant_id}
        claims={claims}
        claimStatuses={claimStatusesMap}
        favoriteItemId={celebrantFavoriteId}
      />
    ))
  )}
</View>
```

**5. Create WishlistSection inline component (or separate):**
Add this component inside the file or as a separate component:

```tsx
interface WishlistSectionProps {
  wishlist: {
    id: string;
    name: string;
    emoji: string | null;
    items: WishlistItem[];
  };
  onItemPress: (item: WishlistItem) => void;
  onItemAction: (item: WishlistItem) => void;
  currentUserId: string | null;
  isCelebrant: boolean;
  claims: ClaimWithUser[];
  claimStatuses: Map<string, boolean>;
  favoriteItemId: string | null;
}

function WishlistSection({
  wishlist,
  onItemPress,
  onItemAction,
  currentUserId,
  isCelebrant,
  claims,
  claimStatuses,
  favoriteItemId,
}: WishlistSectionProps) {
  const { t } = useTranslation();
  const [expanded, setExpanded] = useState(true);

  const claimsMap = useMemo(() => {
    const map = new Map<string, ClaimWithUser>();
    claims.forEach(claim => {
      if (claim.wishlist_item_id) {
        map.set(claim.wishlist_item_id, claim);
      }
    });
    return map;
  }, [claims]);

  if (!wishlist.items || wishlist.items.length === 0) {
    return null;
  }

  return (
    <View style={styles.wishlistSection}>
      <Pressable
        style={styles.wishlistHeader}
        onPress={() => setExpanded(!expanded)}
      >
        <Text style={styles.wishlistEmoji}>{wishlist.emoji || 'ðŸ“‹'}</Text>
        <View style={styles.wishlistHeaderText}>
          <Text style={styles.wishlistName}>{wishlist.name}</Text>
          <Text style={styles.wishlistItemCount}>
            {t('wishlists.itemsInWishlist', { count: wishlist.items.length })}
          </Text>
        </View>
        <MaterialCommunityIcons
          name={expanded ? 'chevron-up' : 'chevron-down'}
          size={24}
          color="#6b7280"
        />
      </Pressable>

      {expanded && (
        <View style={styles.wishlistItems}>
          {wishlist.items.map((item) => (
            <WishlistGridCard
              key={item.id}
              item={item}
              onPress={() => onItemPress(item)}
              onAction={() => onItemAction(item)}
              isOwner={false}
              isCelebrant={isCelebrant}
              isClaimed={claimStatuses.get(item.id)}
              claim={claimsMap.get(item.id)}
              currentUserId={currentUserId || undefined}
              isFavorite={item.id === favoriteItemId}
            />
          ))}
        </View>
      )}
    </View>
  );
}
```

**6. Add styles for wishlist sections:**
```typescript
wishlistSection: {
  marginBottom: spacing.md,
  backgroundColor: '#ffffff',
  borderRadius: borderRadius.lg,
  overflow: 'hidden',
},
wishlistHeader: {
  flexDirection: 'row',
  alignItems: 'center',
  padding: spacing.md,
  borderBottomWidth: 1,
  borderBottomColor: '#f3f4f6',
},
wishlistEmoji: {
  fontSize: 24,
  marginRight: spacing.sm,
},
wishlistHeaderText: {
  flex: 1,
},
wishlistName: {
  fontSize: 16,
  fontWeight: '600',
  color: '#1f2937',
},
wishlistItemCount: {
  fontSize: 13,
  color: '#6b7280',
  marginTop: 2,
},
wishlistItems: {
  flexDirection: 'row',
  flexWrap: 'wrap',
  padding: spacing.sm,
},
```

**7. Update claims loading to work with multiple wishlists:**
The loadClaims callback needs to get items from all wishlists:

```typescript
const loadClaims = useCallback(async () => {
  if (!celebrantWishlists || celebrantWishlists.length === 0) return;

  setClaimsLoading(true);
  try {
    // Flatten items from all wishlists
    const allItems = celebrantWishlists.flatMap(w => w.items || []);
    const itemIds = allItems.map(item => item.id);

    const claimsData = await getClaimsForItems(itemIds);
    setClaims(claimsData);

    // ... rest of existing logic for split data and claim summary
  } catch (err) {
    console.error('Failed to load claims:', err);
  } finally {
    setClaimsLoading(false);
  }
}, [celebrantWishlists, celebration?.celebrant_id, celebration?.group_id, currentUserId]);
```

Update the useEffect that depends on celebrantItems to depend on celebrantWishlists instead.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors.
Start the app and navigate to a celebration page to verify wishlists render.
  </verify>
  <done>
Celebration page fetches and displays celebrant's public wishlists.
Each wishlist shows as collapsible section with emoji, name, and item count.
Claims are loaded for items across all wishlists.
Private wishlists do not appear (RLS enforced + explicit query filter).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete visibility system:
1. RLS policies enforce visibility rules (public/private/friends/linked_group)
2. Service layer functions for visibility queries
3. Group picker for linking for-others wishlists
4. Celebration page shows public wishlists with collapsible sections
  </what-built>
  <how-to-verify>
1. Open CreateWishlistModal and select "For Other"
   - Group picker should appear
   - Select a group and save

2. Create a wishlist with "Private" visibility
   - It should NOT appear on celebration pages

3. Go to a celebration page
   - Should see celebrant's PUBLIC wishlists as collapsible sections
   - Each section shows emoji, name, item count
   - Clicking expands/collapses to show items

4. Test that claims still work on items within the wishlist sections
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Translation keys exist in locales/en/translation.json
2. Celebration page uses useCelebrantPublicWishlists hook
3. Public wishlists render as collapsible sections
4. Claims work correctly across wishlist sections
5. Private wishlists do NOT appear
</verification>

<success_criteria>
- Translation keys for all visibility features
- Celebration page shows public wishlists grouped by wishlist
- Collapsible UI for multiple wishlists
- Claims and item interactions work within sections
- Visual verification that private wishlists are excluded
</success_criteria>

<output>
After completion, create `.planning/phases/42-wishlist-visibility/42-04-SUMMARY.md`
</output>
