---
phase: 42-wishlist-visibility
plan: 03
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - components/wishlist/CreateWishlistModal.tsx
  - components/groups/GroupPickerSheet.tsx
  - lib/groups.ts
autonomous: true

must_haves:
  truths:
    - "User can select a group when creating for-others wishlist"
    - "Group selection is disabled for self-owned wishlists"
    - "User sees list of groups they belong to for linking"
    - "linked_group_id is saved when creating/editing wishlist"
  artifacts:
    - path: "components/groups/GroupPickerSheet.tsx"
      provides: "Bottom sheet for selecting group from user's groups"
      min_lines: 80
    - path: "components/wishlist/CreateWishlistModal.tsx"
      provides: "Integration of group picker for for-others wishlists"
      contains: "GroupPickerSheet"
    - path: "lib/groups.ts"
      provides: "getUserGroups function if not exists"
      exports: ["getUserGroups"]
  key_links:
    - from: "CreateWishlistModal.tsx"
      to: "GroupPickerSheet.tsx"
      via: "conditional render when ownerType !== 'self'"
      pattern: "ownerType.*GroupPickerSheet"
    - from: "CreateWishlistModal.tsx"
      to: "createWishlist/updateWishlist"
      via: "linked_group_id in mutation payload"
      pattern: "linked_group_id"
---

<objective>
Add group picker UI for linking for-others wishlists to groups in CreateWishlistModal.

Purpose: Enable users to select which group can collaboratively access their for-others wishlists (VIS-04, VIS-05, VIS-06).

Output: GroupPickerSheet component, updated CreateWishlistModal with group selection for for-others wishlists.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-wishlist-visibility/42-RESEARCH.md

# Existing components for patterns
@components/wishlist/CreateWishlistModal.tsx
@components/wishlist/WishlistPickerSheet.tsx
@lib/groups.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GroupPickerSheet component</name>
  <files>components/groups/GroupPickerSheet.tsx</files>
  <action>
Create a reusable GroupPickerSheet component following WishlistPickerSheet patterns.

```typescript
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  Modal,
  TouchableOpacity,
  StyleSheet,
  ScrollView,
  ActivityIndicator,
  Image,
  Pressable,
} from 'react-native';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import { useTranslation } from 'react-i18next';
import { colors, spacing, borderRadius, shadows } from '../../constants/theme';
import { useAuth } from '../../providers/AuthProvider';
import { getUserGroups } from '../../lib/groups';

interface Group {
  id: string;
  name: string;
  photo_url: string | null;
}

interface GroupPickerSheetProps {
  visible: boolean;
  onClose: () => void;
  onSelect: (groupId: string | null) => void;
  selectedGroupId: string | null;
  allowNone?: boolean;
}

export function GroupPickerSheet({
  visible,
  onClose,
  onSelect,
  selectedGroupId,
  allowNone = true,
}: GroupPickerSheetProps) {
  const { t } = useTranslation();
  const { user } = useAuth();
  const [groups, setGroups] = useState<Group[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (visible && user) {
      setLoading(true);
      getUserGroups(user.id)
        .then(setGroups)
        .catch((err) => console.error('Failed to load groups:', err))
        .finally(() => setLoading(false));
    }
  }, [visible, user]);

  const handleSelect = (groupId: string | null) => {
    onSelect(groupId);
    onClose();
  };

  return (
    <Modal
      visible={visible}
      transparent
      animationType="slide"
      onRequestClose={onClose}
    >
      <View style={styles.overlay}>
        <Pressable style={styles.backdrop} onPress={onClose} />
        <View style={styles.sheet}>
          <View style={styles.handle} />

          <View style={styles.header}>
            <Text style={styles.title}>{t('wishlists.selectGroup')}</Text>
            <TouchableOpacity onPress={onClose} style={styles.closeButton}>
              <MaterialCommunityIcons name="close" size={24} color={colors.burgundy[600]} />
            </TouchableOpacity>
          </View>

          {loading ? (
            <View style={styles.loadingContainer}>
              <ActivityIndicator size="large" color={colors.burgundy[600]} />
            </View>
          ) : (
            <ScrollView style={styles.list} showsVerticalScrollIndicator={false}>
              {allowNone && (
                <TouchableOpacity
                  style={[
                    styles.groupItem,
                    selectedGroupId === null && styles.groupItemSelected,
                  ]}
                  onPress={() => handleSelect(null)}
                >
                  <View style={styles.groupIconPlaceholder}>
                    <MaterialCommunityIcons
                      name="cancel"
                      size={24}
                      color={colors.cream[500]}
                    />
                  </View>
                  <Text style={styles.groupName}>{t('wishlists.noGroupLink')}</Text>
                  {selectedGroupId === null && (
                    <MaterialCommunityIcons
                      name="check-circle"
                      size={24}
                      color={colors.burgundy[600]}
                    />
                  )}
                </TouchableOpacity>
              )}

              {groups.map((group) => {
                const isSelected = selectedGroupId === group.id;
                return (
                  <TouchableOpacity
                    key={group.id}
                    style={[
                      styles.groupItem,
                      isSelected && styles.groupItemSelected,
                    ]}
                    onPress={() => handleSelect(group.id)}
                  >
                    {group.photo_url ? (
                      <Image
                        source={{ uri: group.photo_url }}
                        style={styles.groupImage}
                      />
                    ) : (
                      <View style={styles.groupIconPlaceholder}>
                        <MaterialCommunityIcons
                          name="account-group"
                          size={24}
                          color={colors.cream[500]}
                        />
                      </View>
                    )}
                    <Text style={styles.groupName} numberOfLines={1}>
                      {group.name}
                    </Text>
                    {isSelected && (
                      <MaterialCommunityIcons
                        name="check-circle"
                        size={24}
                        color={colors.burgundy[600]}
                      />
                    )}
                  </TouchableOpacity>
                );
              })}

              {groups.length === 0 && (
                <View style={styles.emptyContainer}>
                  <MaterialCommunityIcons
                    name="account-group-outline"
                    size={48}
                    color={colors.cream[400]}
                  />
                  <Text style={styles.emptyText}>{t('groups.noGroupsYet')}</Text>
                </View>
              )}
            </ScrollView>
          )}
        </View>
      </View>
    </Modal>
  );
}

const styles = StyleSheet.create({
  overlay: {
    flex: 1,
    justifyContent: 'flex-end',
  },
  backdrop: {
    ...StyleSheet.absoluteFillObject,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
  },
  sheet: {
    backgroundColor: colors.white,
    borderTopLeftRadius: borderRadius.xl,
    borderTopRightRadius: borderRadius.xl,
    maxHeight: '70%',
    ...shadows.lg,
  },
  handle: {
    width: 40,
    height: 4,
    backgroundColor: colors.cream[300],
    borderRadius: 2,
    alignSelf: 'center',
    marginTop: spacing.sm,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.md,
    borderBottomWidth: 1,
    borderBottomColor: colors.cream[200],
  },
  title: {
    fontSize: 18,
    fontWeight: '600',
    color: colors.burgundy[900],
  },
  closeButton: {
    padding: spacing.xs,
  },
  loadingContainer: {
    padding: spacing.xl,
    alignItems: 'center',
  },
  list: {
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.md,
  },
  groupItem: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: spacing.md,
    borderRadius: borderRadius.md,
    marginBottom: spacing.sm,
    backgroundColor: colors.cream[50],
  },
  groupItemSelected: {
    backgroundColor: colors.burgundy[50],
    borderWidth: 1,
    borderColor: colors.burgundy[300],
  },
  groupImage: {
    width: 44,
    height: 44,
    borderRadius: 22,
    marginRight: spacing.md,
  },
  groupIconPlaceholder: {
    width: 44,
    height: 44,
    borderRadius: 22,
    backgroundColor: colors.cream[200],
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: spacing.md,
  },
  groupName: {
    flex: 1,
    fontSize: 16,
    fontWeight: '500',
    color: colors.burgundy[800],
  },
  emptyContainer: {
    alignItems: 'center',
    paddingVertical: spacing.xl,
  },
  emptyText: {
    marginTop: spacing.md,
    fontSize: 14,
    color: colors.cream[500],
    textAlign: 'center',
  },
});
```

Also ensure getUserGroups exists in lib/groups.ts. If not, add:
```typescript
/**
 * Get all groups the user belongs to
 */
export async function getUserGroups(userId: string) {
  const { data, error } = await supabase
    .from('group_members')
    .select(`
      group:groups(
        id,
        name,
        photo_url
      )
    `)
    .eq('user_id', userId);

  if (error) throw error;
  return data?.map(d => d.group).filter(Boolean) || [];
}
```
  </action>
  <verify>
Check components/groups/GroupPickerSheet.tsx exists.
Check lib/groups.ts exports getUserGroups.
Run `npx tsc --noEmit` to verify no type errors.
  </verify>
  <done>
GroupPickerSheet component created with group list, selection state, and empty state.
getUserGroups function available in lib/groups.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate group picker in CreateWishlistModal</name>
  <files>components/wishlist/CreateWishlistModal.tsx</files>
  <action>
Update CreateWishlistModal to include group picker for for-others wishlists.

**1. Add import at top:**
```typescript
import { GroupPickerSheet } from '../groups/GroupPickerSheet';
```

**2. Add state for linkedGroupId and sheet visibility:**
The state already exists from quick-007:
- linkedGroupId state (should already be present or add: `const [linkedGroupId, setLinkedGroupId] = useState<string | null>(null);`)
- showGroupPicker state: `const [showGroupPicker, setShowGroupPicker] = useState(false);`

**3. Initialize linkedGroupId in useEffect when modal opens:**
```typescript
// In the existing useEffect that initializes form
setLinkedGroupId(editingWishlist?.linked_group_id || null);
```

**4. Add group picker UI after owner type section (after the for-name input):**
Find the section after `{ownerType === 'other_manual' && ...}` and add:

```tsx
{/* Group linking for collaborative access */}
{ownerType !== 'self' && (
  <View style={styles.formGroup}>
    <Text style={styles.label}>{t('wishlists.linkToGroup')}</Text>
    <TouchableOpacity
      style={styles.groupPickerButton}
      onPress={() => setShowGroupPicker(true)}
      disabled={isSubmitting}
    >
      {linkedGroupId ? (
        <MaterialCommunityIcons name="account-group" size={20} color={colors.burgundy[600]} />
      ) : (
        <MaterialCommunityIcons name="link-variant" size={20} color={colors.cream[500]} />
      )}
      <Text style={[
        styles.groupPickerText,
        !linkedGroupId && styles.groupPickerPlaceholder
      ]}>
        {linkedGroupId ? t('wishlists.groupLinked') : t('wishlists.selectGroupOptional')}
      </Text>
      <MaterialCommunityIcons name="chevron-right" size={20} color={colors.cream[500]} />
    </TouchableOpacity>
    <Text style={styles.helperText}>{t('wishlists.groupLinkHelp')}</Text>
  </View>
)}
```

**5. Add GroupPickerSheet at bottom of component (before the EmojiPickerModal):**
```tsx
{/* Group Picker Sheet */}
<GroupPickerSheet
  visible={showGroupPicker}
  onClose={() => setShowGroupPicker(false)}
  onSelect={setLinkedGroupId}
  selectedGroupId={linkedGroupId}
  allowNone={true}
/>
```

**6. Update handleSubmit to include linked_group_id:**
In both create and update mutation calls, add:
```typescript
linked_group_id: ownerType !== 'self' ? linkedGroupId : null,
```

**7. Add styles:**
```typescript
groupPickerButton: {
  flexDirection: 'row',
  alignItems: 'center',
  padding: spacing.md,
  backgroundColor: colors.cream[50],
  borderRadius: borderRadius.md,
  borderWidth: 1,
  borderColor: colors.cream[300],
  gap: spacing.sm,
},
groupPickerText: {
  flex: 1,
  fontSize: 16,
  color: colors.burgundy[800],
},
groupPickerPlaceholder: {
  color: colors.cream[500],
},
helperText: {
  fontSize: 12,
  color: colors.cream[600],
  marginTop: spacing.xs,
},
```

**8. Reset linkedGroupId when ownerType changes to 'self':**
In the ownerType onChange handler (already exists in the SegmentedControl), ensure:
```typescript
if (value === 'self') {
  setForName('');
  setForUserId(null);
  setLinkedGroupId(null);  // Add this line if not present
}
```
  </action>
  <verify>
Check CreateWishlistModal imports GroupPickerSheet.
Check linked_group_id is in mutation payloads.
Run `npx tsc --noEmit` to verify no type errors.
  </verify>
  <done>
CreateWishlistModal shows group picker for for-others wishlists.
linked_group_id is saved when creating/editing for-others wishlists.
Group picker is hidden for self-owned wishlists.
  </done>
</task>

</tasks>

<verification>
1. GroupPickerSheet component renders and shows user's groups
2. CreateWishlistModal shows group picker only for for-others wishlists
3. linked_group_id is correctly included in create/update mutations
4. No TypeScript errors
5. Translation keys work (or show raw keys if not yet added)
</verification>

<success_criteria>
- GroupPickerSheet component exists and functions correctly
- CreateWishlistModal integrates group selection for for-others wishlists
- linked_group_id flows through to database on create/update
- UI is hidden for self-owned wishlists per constraint
</success_criteria>

<output>
After completion, create `.planning/phases/42-wishlist-visibility/42-03-SUMMARY.md`
</output>
