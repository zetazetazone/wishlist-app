---
phase: 42-wishlist-visibility
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - lib/wishlists.ts
  - hooks/useWishlists.ts
autonomous: true

must_haves:
  truths:
    - "Celebration page can fetch celebrant's public wishlists"
    - "Group context can fetch for-others wishlists linked to that group"
    - "User can update wishlist visibility via lib function"
    - "User can link/unlink wishlist to group via lib function"
  artifacts:
    - path: "lib/wishlists.ts"
      provides: "getCelebrantPublicWishlists, getGroupForOthersWishlists, updateWishlistVisibility, linkWishlistToGroup"
      exports: ["getCelebrantPublicWishlists", "getGroupForOthersWishlists", "updateWishlistVisibility", "linkWishlistToGroup"]
    - path: "hooks/useWishlists.ts"
      provides: "React Query hooks for visibility queries"
      exports: ["useCelebrantPublicWishlists", "useGroupForOthersWishlists", "useUpdateVisibility", "useLinkWishlistToGroup"]
  key_links:
    - from: "hooks/useWishlists.ts"
      to: "lib/wishlists.ts"
      via: "import and queryFn calls"
      pattern: "getCelebrantPublicWishlists|getGroupForOthersWishlists"
    - from: "celebration/[id].tsx"
      to: "useCelebrantPublicWishlists"
      via: "hook invocation"
      pattern: "useCelebrantPublicWishlists"
---

<objective>
Add service layer functions and React Query hooks for visibility-related wishlist queries.

Purpose: Provide typed API for fetching public wishlists on celebration pages and for-others wishlists in group context. Enable visibility and group linking updates.

Output: Extended lib/wishlists.ts with 4 new functions, extended hooks/useWishlists.ts with 4 new hooks.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-wishlist-visibility/42-RESEARCH.md

# Existing lib and hooks for patterns
@lib/wishlists.ts
@hooks/useWishlists.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visibility lib functions</name>
  <files>lib/wishlists.ts</files>
  <action>
Add these 4 functions to lib/wishlists.ts following existing patterns:

**1. getCelebrantPublicWishlists(celebrantId: string)**
```typescript
/**
 * Fetch public wishlists for a celebrant to display on celebration page
 * Only returns 'public' visibility, 'self' owner_type wishlists
 * RLS ensures requester shares a group with celebrant
 */
export async function getCelebrantPublicWishlists(celebrantId: string) {
  const { data, error } = await supabase
    .from('wishlists')
    .select(`
      id,
      name,
      emoji,
      visibility,
      items:wishlist_items(
        id,
        title,
        source_url,
        image_url,
        price,
        priority,
        is_favorite,
        is_most_wanted
      )
    `)
    .eq('user_id', celebrantId)
    .eq('visibility', 'public')
    .eq('owner_type', 'self')
    .order('sort_order', { ascending: true });

  if (error) throw error;
  return data;
}
```

**2. getGroupForOthersWishlists(groupId: string)**
```typescript
/**
 * Fetch for-others wishlists linked to a specific group
 * Returns wishlists where linked_group_id matches and owner_type is other_*
 * RLS ensures requester is group member
 */
export async function getGroupForOthersWishlists(groupId: string) {
  const { data, error } = await supabase
    .from('wishlists')
    .select(`
      id,
      name,
      emoji,
      for_name,
      for_user_id,
      owner_type,
      user_id,
      linked_group_id,
      items:wishlist_items(count)
    `)
    .eq('linked_group_id', groupId)
    .in('owner_type', ['other_manual', 'other_user'])
    .order('created_at', { ascending: false });

  if (error) throw error;
  return data;
}
```

**3. updateWishlistVisibility(wishlistId: string, visibility: WishlistVisibility)**
```typescript
/**
 * Update wishlist visibility setting
 */
export async function updateWishlistVisibility(
  wishlistId: string,
  visibility: WishlistVisibility
) {
  const { data, error } = await supabase
    .from('wishlists')
    .update({ visibility })
    .eq('id', wishlistId)
    .select()
    .single();

  if (error) throw error;
  return data;
}
```

**4. linkWishlistToGroup(wishlistId: string, groupId: string | null)**
```typescript
/**
 * Link or unlink a for-others wishlist to a group for collaborative access
 * Pass null to unlink
 */
export async function linkWishlistToGroup(wishlistId: string, groupId: string | null) {
  const { data, error } = await supabase
    .from('wishlists')
    .update({ linked_group_id: groupId })
    .eq('id', wishlistId)
    .select()
    .single();

  if (error) throw error;
  return data;
}
```

Ensure WishlistVisibility type is already exported (it is, from existing code).
  </action>
  <verify>
Check lib/wishlists.ts exports all 4 new functions using grep.
Run `npx tsc --noEmit` to verify no type errors.
  </verify>
  <done>
lib/wishlists.ts exports getCelebrantPublicWishlists, getGroupForOthersWishlists, updateWishlistVisibility, linkWishlistToGroup.
All functions follow existing patterns and use correct Supabase queries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add visibility React Query hooks</name>
  <files>hooks/useWishlists.ts</files>
  <action>
Add these 4 hooks to hooks/useWishlists.ts following existing patterns:

**1. useCelebrantPublicWishlists(celebrantId: string | undefined)**
```typescript
/**
 * Hook to fetch public wishlists for a celebrant (for celebration pages)
 */
export function useCelebrantPublicWishlists(celebrantId: string | undefined) {
  return useQuery({
    queryKey: ['wishlists', 'public', celebrantId],
    queryFn: () => getCelebrantPublicWishlists(celebrantId!),
    enabled: !!celebrantId,
  });
}
```

**2. useGroupForOthersWishlists(groupId: string | undefined)**
```typescript
/**
 * Hook to fetch for-others wishlists linked to a group
 */
export function useGroupForOthersWishlists(groupId: string | undefined) {
  return useQuery({
    queryKey: ['wishlists', 'for-others', groupId],
    queryFn: () => getGroupForOthersWishlists(groupId!),
    enabled: !!groupId,
  });
}
```

**3. useUpdateVisibility()**
```typescript
/**
 * Hook to update wishlist visibility
 */
export function useUpdateVisibility() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ wishlistId, visibility }: { wishlistId: string; visibility: WishlistVisibility }) =>
      updateWishlistVisibility(wishlistId, visibility),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['wishlists'] });
    },
  });
}
```

**4. useLinkWishlistToGroup()**
```typescript
/**
 * Hook to link/unlink wishlist to group
 */
export function useLinkWishlistToGroup() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ wishlistId, groupId }: { wishlistId: string; groupId: string | null }) =>
      linkWishlistToGroup(wishlistId, groupId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['wishlists'] });
    },
  });
}
```

Update imports at top to include new functions:
```typescript
import {
  getWishlists,
  getDefaultWishlist,
  createWishlist,
  updateWishlist,
  deleteWishlist,
  reorderWishlists,
  moveItemToWishlist,
  getCelebrantPublicWishlists,
  getGroupForOthersWishlists,
  updateWishlistVisibility,
  linkWishlistToGroup,
  type Wishlist,
  type WishlistInsert,
  type WishlistUpdate,
  type WishlistVisibility,
} from '../lib/wishlists';
```
  </action>
  <verify>
Check hooks/useWishlists.ts exports all 4 new hooks using grep.
Run `npx tsc --noEmit` to verify no type errors.
  </verify>
  <done>
hooks/useWishlists.ts exports useCelebrantPublicWishlists, useGroupForOthersWishlists, useUpdateVisibility, useLinkWishlistToGroup.
All hooks follow React Query patterns and invalidate correct query keys.
  </done>
</task>

</tasks>

<verification>
1. lib/wishlists.ts has all 4 new functions
2. hooks/useWishlists.ts has all 4 new hooks
3. No TypeScript errors
4. Imports are correct and complete
</verification>

<success_criteria>
- All 4 lib functions implemented with correct Supabase queries
- All 4 React Query hooks implemented following existing patterns
- Functions filter correctly: public + self for celebrant, linked_group_id for for-others
- Mutations invalidate wishlists query cache
- No type errors
</success_criteria>

<output>
After completion, create `.planning/phases/42-wishlist-visibility/42-02-SUMMARY.md`
</output>
