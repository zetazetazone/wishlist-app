---
phase: 21-split-contributions-claim-enhancements
plan: 06
type: execute
wave: 1
depends_on: [21-05]
files_modified:
  - components/wishlist/LuxuryWishlistCard.tsx
  - components/wishlist/OpenSplitModal.tsx
  - utils/groups.ts
  - app/group/[id]/index.tsx
  - app/(app)/celebration/[id].tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Open Split button prompts for additional costs on all platforms"
    - "Invite code is consistent between group screen and group settings"
    - "Celebrant sees claimed items marked as Taken"
    - "Clock icon appears on claimed items for tap-to-reveal timestamp"
  artifacts:
    - path: "components/wishlist/OpenSplitModal.tsx"
      provides: "Cross-platform modal for Open Split with TextInput"
    - path: "components/wishlist/LuxuryWishlistCard.tsx"
      provides: "ClaimTimestamp integration, OpenSplitModal usage"
    - path: "utils/groups.ts"
      provides: "fetchGroupDetails with invite_code column"
    - path: "app/group/[id]/index.tsx"
      provides: "Share message using group.invite_code"
    - path: "app/(app)/celebration/[id].tsx"
      provides: "isTaken prop passed to LuxuryWishlistCard"
  key_links:
    - from: "components/wishlist/LuxuryWishlistCard.tsx"
      to: "components/wishlist/OpenSplitModal.tsx"
      via: "modal state and callbacks"
    - from: "components/wishlist/LuxuryWishlistCard.tsx"
      to: "components/wishlist/ClaimTimestamp.tsx"
      via: "import and render when claim exists"
    - from: "app/group/[id]/index.tsx"
      to: "utils/groups.ts"
      via: "fetchGroupDetails returns invite_code"
---

<objective>
Fix 4 diagnosed UAT issues from Phase 21 verification.

Purpose: Close gaps identified in UAT testing to complete Phase 21 functionality.
Output: All 4 issues resolved: cross-platform Open Split modal, consistent invite codes, celebrant Taken status, claim timestamps.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-split-contributions-claim-enhancements/21-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OpenSplitModal and replace Alert.prompt</name>
  <files>
    components/wishlist/OpenSplitModal.tsx
    components/wishlist/LuxuryWishlistCard.tsx
  </files>
  <action>
    **Issue:** Alert.prompt() is iOS-only, causing Open Split to silently fail on Android.

    **Create OpenSplitModal.tsx:**
    - Follow SplitModal.tsx pattern (BottomSheetModal with TextInput)
    - Props: visible, onClose, onConfirm(additionalCosts?: number), itemTitle, loading
    - Title: "Open for Split"
    - Subtitle: "Add shipping or other costs? (optional)"
    - TextInput: keyboardType="decimal-pad", placeholder="0.00"
    - Buttons: Cancel (closes modal), Open Split (calls onConfirm with parsed amount or undefined if empty/zero)
    - Amount validation: if entered, must be positive number; empty is allowed (undefined)

    **Update LuxuryWishlistCard.tsx:**
    - Import OpenSplitModal
    - Add state: const [showOpenSplitModal, setShowOpenSplitModal] = useState(false);
    - Replace handleOpenSplit function body:
      - Remove Alert.prompt call entirely
      - Set: setShowOpenSplitModal(true);
    - Add handleOpenSplitConfirm callback:
      - Receives additionalCosts?: number
      - Calls onOpenSplit?.(item.id, additionalCosts);
      - Closes modal
    - Render OpenSplitModal after SplitModal:
      - visible={showOpenSplitModal}
      - onClose={() => setShowOpenSplitModal(false)}
      - onConfirm={handleOpenSplitConfirm}
      - itemTitle={item.title}

    **Why not Alert.prompt:** iOS-only API, no Android support, causes silent failure.
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - Manual test on Android: Open Split button opens modal with TextInput
    - Manual test: Can enter amount and confirm, or cancel
  </verify>
  <done>
    Open Split button works on both iOS and Android, prompting for additional costs via cross-platform modal.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix invite code inconsistency</name>
  <files>
    utils/groups.ts
    app/group/[id]/index.tsx
  </files>
  <action>
    **Issue:** fetchGroupDetails uses SELECT * but invite_code may not be selected (or group screen uses group.id instead of group.invite_code).

    **Update utils/groups.ts (line ~170):**
    - Confirm SELECT includes invite_code explicitly or uses * which includes it
    - If using SELECT *, this should already work - verify the column exists in return type
    - The actual issue is the consumer using group.id instead of group.invite_code

    **Update app/group/[id]/index.tsx:**
    - Line 122 (handleShare): Change `group.id` to `group.invite_code`
      ```typescript
      message: `Join "${group.name}" on Wishlist App!\n\nInvite Code: ${group.invite_code}\n\nUse this code to join our gift-giving group.`,
      ```
    - Line 135 (copyInviteCode): Change `group.id` to `group.invite_code`
      ```typescript
      group.invite_code,
      ```

    **Why group.id was wrong:** The invite_code is a separate, shorter, human-readable code; group.id is a UUID not meant for sharing.
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - Check group screen share message uses invite_code not UUID
  </verify>
  <done>
    Invite code shown in share message and copy dialog matches the code shown in group settings.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix celebrant Taken status and add ClaimTimestamp</name>
  <files>
    app/(app)/celebration/[id].tsx
    components/wishlist/LuxuryWishlistCard.tsx
  </files>
  <action>
    **Issue 1:** isTaken prop not passed to LuxuryWishlistCard in celebration page.
    **Issue 2:** ClaimTimestamp component exists but not integrated.

    **Update app/(app)/celebration/[id].tsx (around line 910):**
    - Add isTaken prop to LuxuryWishlistCard:
      ```typescript
      isTaken={isCelebrant && !!claim}
      ```
    - Add after isYourClaim prop (line ~909):
      ```typescript
      isYourClaim={isYourClaim}
      isTaken={isCelebrant && !!claim}
      isCelebrant={isCelebrant}
      ```

    **Update components/wishlist/LuxuryWishlistCard.tsx:**
    - Add import at top with other wishlist imports:
      ```typescript
      import { ClaimTimestamp } from './ClaimTimestamp';
      ```
    - In the Actions row (around line 360), add ClaimTimestamp after TakenBadge or ClaimerAvatar:
      ```typescript
      {/* Claim timestamp - shows clock icon when claim exists */}
      {claim?.claimed_at && !isCelebrant && (
        <ClaimTimestamp timestamp={claim.claimed_at} />
      )}
      ```
    - Position it in the actions row, after ClaimerAvatar and before FavoriteHeart

    **Why celebrant check:** Celebrant should not see detailed claim info, only "Taken" badge.
    **Why ClaimTimestamp integration:** Component was built in prior plan but never wired in.
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - As celebrant: claimed items show Taken badge with dimmed opacity
    - As non-celebrant: claimed items show clock icon, tappable to reveal timestamp
  </verify>
  <done>
    Celebrant sees "Taken" on claimed items. Non-celebrants see clock icon for tap-to-reveal claim timestamp.
  </done>
</task>

</tasks>

<verification>
All 4 diagnosed UAT issues resolved:
1. Open Split works on Android (cross-platform modal)
2. Invite code is consistent (uses invite_code column)
3. Celebrant sees Taken status (isTaken prop added)
4. Clock icon shows on claimed items (ClaimTimestamp integrated)
</verification>

<success_criteria>
- TypeScript compiles without errors
- Open Split button works on Android (modal appears, can enter amount)
- Invite code in share matches invite code in group settings
- Celebrant viewing own celebration sees "Taken" badge on claimed items
- Non-celebrant sees clock icon on claimed items, tappable for timestamp
- UAT tests 2, 9, 11 can now pass
</success_criteria>

<output>
After completion, create `.planning/phases/21-split-contributions-claim-enhancements/21-06-SUMMARY.md`
</output>
