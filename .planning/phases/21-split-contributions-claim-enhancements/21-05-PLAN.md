---
phase: 21-split-contributions-claim-enhancements
plan: 05
type: execute
wave: 3
depends_on: ["21-02"]
files_modified:
  - components/wishlist/ClaimTimestamp.tsx
  - components/wishlist/YourClaimIndicator.tsx
  - app/(app)/(tabs)/wishlist-luxury.tsx
autonomous: true

must_haves:
  truths:
    - "Claim timestamp shows relative time (e.g., '2 hours ago') on tap"
    - "YourClaimIndicator distinguishes full claim icon from split claim icon"
    - "My Wishlist header shows claim summary alongside item count"
    - "Claim count refreshes when navigating to wishlist tab"
  artifacts:
    - path: "components/wishlist/ClaimTimestamp.tsx"
      provides: "Timestamp display with tap-to-show behavior"
      min_lines: 30
    - path: "app/(app)/(tabs)/wishlist-luxury.tsx"
      provides: "My Wishlist with claim summary header"
      contains: "ClaimSummary"
  key_links:
    - from: "YourClaimIndicator"
      to: "claim_type"
      via: "icon selection"
      pattern: "claim_type.*split.*gift-open"
    - from: "wishlist-luxury.tsx"
      to: "getItemClaimStatus"
      via: "useEffect fetch"
      pattern: "getItemClaimStatus"
---

<objective>
Add claim timestamp display, differentiate full/split claim icons, and integrate claim summary into My Wishlist header for celebrant view.

Purpose: Complete the claim enhancement requirements (CLMX-03: timestamps, CLMX-02: summaries) and visual distinction for claim types.
Output: ClaimTimestamp component, updated YourClaimIndicator, enhanced My Wishlist header.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/21-split-contributions-claim-enhancements/21-CONTEXT.md
@.planning/phases/21-split-contributions-claim-enhancements/21-02-SUMMARY.md
@components/wishlist/YourClaimIndicator.tsx
@app/(app)/(tabs)/wishlist-luxury.tsx
@lib/claims.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClaimTimestamp and update YourClaimIndicator</name>
  <files>components/wishlist/ClaimTimestamp.tsx, components/wishlist/YourClaimIndicator.tsx</files>
  <action>
**1. Create ClaimTimestamp.tsx:**

```typescript
import React, { useState } from 'react';
import { TouchableOpacity, Text, StyleSheet } from 'react-native';
import { formatDistanceToNow, format, differenceInDays } from 'date-fns';
import { colors, spacing } from '../../constants/theme';

interface ClaimTimestampProps {
  timestamp: string;  // ISO date string
}

/**
 * ClaimTimestamp - Shows claim time on tap
 *
 * Display logic (per CONTEXT decision):
 * - Hidden by default (shows nothing or icon)
 * - On tap: shows timestamp
 * - < 7 days: relative format ("2 hours ago", "3 days ago")
 * - >= 7 days: exact format ("Feb 6, 2:30pm")
 */
export function ClaimTimestamp({ timestamp }: ClaimTimestampProps) {
  const [showTimestamp, setShowTimestamp] = useState(false);

  const date = new Date(timestamp);
  const daysDiff = differenceInDays(new Date(), date);

  const displayText = daysDiff < 7
    ? formatDistanceToNow(date, { addSuffix: true })
    : format(date, 'MMM d, h:mma');

  return (
    <TouchableOpacity
      onPress={() => setShowTimestamp(!showTimestamp)}
      style={styles.container}
      activeOpacity={0.7}
    >
      {showTimestamp ? (
        <Text style={styles.timestampText}>{displayText}</Text>
      ) : (
        <Text style={styles.tapHint}>Tap for time</Text>
      )}
    </TouchableOpacity>
  );
}

const styles = StyleSheet.create({
  container: {
    paddingVertical: spacing.xs,
    paddingHorizontal: spacing.sm,
  },
  timestampText: {
    fontSize: 12,
    color: colors.cream[600],
  },
  tapHint: {
    fontSize: 11,
    color: colors.cream[500],
    fontStyle: 'italic',
  },
});

export default ClaimTimestamp;
```

**2. Update YourClaimIndicator.tsx:**

Add claim_type prop to distinguish icons:

```typescript
interface YourClaimIndicatorProps {
  visible: boolean;
  claimType?: 'full' | 'split';  // NEW: determines icon
}
```

Change icon based on claimType:
- 'full': "gift" icon (existing)
- 'split': "gift-open" icon (open gift, represents shared)

Update the icon render:
```tsx
<MaterialCommunityIcons
  name={claimType === 'split' ? 'gift-open' : 'gift'}
  size={14}
  color={colors.burgundy[700]}
/>
```

If claimType is 'split', also adjust badge text or add small indicator:
- Full: "Your Claim"
- Split: "Your Split" or keep "Your Claim" with different icon
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Verify ClaimTimestamp toggles on tap.
Verify YourClaimIndicator shows different icons for full vs split.
  </verify>
  <done>
ClaimTimestamp shows relative/exact time on tap. YourClaimIndicator distinguishes full (gift icon) from split (gift-open icon) claims.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add claim summary to My Wishlist header</name>
  <files>app/(app)/(tabs)/wishlist-luxury.tsx</files>
  <action>
**1. Import ClaimSummary component and getItemClaimStatus:**

```typescript
import { ClaimSummary } from '../../../components/celebrations/ClaimSummary';
import { getItemClaimStatus } from '../../../lib/claims';
```

**2. Add state for taken count (for celebrant view):**

The My Wishlist screen is the celebrant's own view. They can see which items are "taken" but not by whom. Add a summary showing taken items count.

```typescript
// Add to existing state
const [takenCount, setTakenCount] = useState(0);
```

**3. Extend existing useEffect that fetches items:**

After fetching wishlist items, also fetch claim status:

```typescript
// In loadWishlistItems or similar
const items = await getWishlistItemsByUserId(userId);
setWishlistItems(items);

// Fetch claim status for own items
if (items.length > 0) {
  const itemIds = items
    .filter(item => item.item_type !== 'surprise_me' && item.item_type !== 'mystery_box')
    .map(item => item.id);
  const statuses = await getItemClaimStatus(itemIds);
  const taken = statuses.filter(s => s.is_claimed).length;
  setTakenCount(taken);
}
```

**4. Add summary to header section:**

In the header area (near the profile header or item count), add:

```tsx
{/* After item count display */}
{takenCount > 0 && (
  <View style={styles.claimSummaryRow}>
    <MaterialCommunityIcons name="gift" size={16} color={colors.cream[600]} />
    <Text style={styles.takenText}>
      {takenCount} of {wishlistItems.filter(i => i.item_type === 'standard').length} taken
    </Text>
  </View>
)}
```

Style the summary row to fit alongside existing header elements:
```typescript
claimSummaryRow: {
  flexDirection: 'row',
  alignItems: 'center',
  gap: spacing.xs,
  marginTop: spacing.xs,
},
takenText: {
  fontSize: 14,
  color: colors.cream[600],
},
```

**5. Refresh on focus:**

Use useFocusEffect to refresh claim status when tab is focused:

```typescript
import { useFocusEffect } from '@react-navigation/native';

useFocusEffect(
  useCallback(() => {
    // Refresh claim status when tab focused
    if (userId && wishlistItems.length > 0) {
      const itemIds = wishlistItems
        .filter(item => item.item_type !== 'surprise_me' && item.item_type !== 'mystery_box')
        .map(item => item.id);
      getItemClaimStatus(itemIds).then(statuses => {
        const taken = statuses.filter(s => s.is_claimed).length;
        setTakenCount(taken);
      });
    }
  }, [userId, wishlistItems])
);
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Test My Wishlist page loads and shows taken count.
Verify count refreshes on tab focus.
  </verify>
  <done>
My Wishlist header shows "X of Y taken" summary for celebrant. Count refreshes on tab focus.
  </done>
</task>

</tasks>

<verification>
- [ ] ClaimTimestamp component exists and toggles on tap
- [ ] YourClaimIndicator shows different icons for full vs split
- [ ] My Wishlist header displays taken count
- [ ] Taken count excludes special item types
- [ ] Count refreshes when navigating to tab
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
- Timestamps visible on tap with relative/exact format
- Visual distinction between full and split claim indicators
- Celebrant sees taken summary in their wishlist header
- All data refreshes appropriately on navigation
</success_criteria>

<output>
After completion, create `.planning/phases/21-split-contributions-claim-enhancements/21-05-SUMMARY.md`
</output>
