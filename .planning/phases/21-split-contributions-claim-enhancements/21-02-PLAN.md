---
phase: 21-split-contributions-claim-enhancements
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - lib/contributions.ts
  - types/database.types.ts
autonomous: true

must_haves:
  truths:
    - "openSplit() calls open_split RPC and returns typed result"
    - "pledgeContribution() calls pledge_contribution RPC and returns remaining amount"
    - "closeSplit() calls close_split RPC and returns final amount"
    - "getSplitStatus() returns typed split funding progress"
    - "getSuggestedShare() returns equal split calculation for UI"
    - "getClaimSummary() returns total/claimed/split counts for celebration"
  artifacts:
    - path: "lib/contributions.ts"
      provides: "Split contribution service functions"
      exports: ["openSplit", "pledgeContribution", "closeSplit", "getSplitStatus", "getSuggestedShare", "getContributors", "getClaimSummary"]
  key_links:
    - from: "lib/contributions.ts"
      to: "supabase.rpc"
      via: "RPC function calls"
      pattern: "supabase\\.rpc\\('open_split|pledge_contribution|close_split|get_split_status|get_suggested_share'"
---

<objective>
Create TypeScript service library for split contributions with typed interfaces and RPC wrappers, plus claim summary aggregation for celebration headers.

Purpose: Provide type-safe client-side API for split contribution operations that UI components will consume.
Output: lib/contributions.ts with 7 exported functions and supporting types.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/21-split-contributions-claim-enhancements/21-CONTEXT.md
@.planning/phases/21-split-contributions-claim-enhancements/21-01-SUMMARY.md
@lib/claims.ts
@lib/supabase.ts
@types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contributions service with types</name>
  <files>lib/contributions.ts</files>
  <action>
Create new lib/contributions.ts file with:

**Types/Interfaces:**
```typescript
/** Result from open_split RPC */
export interface OpenSplitResult {
  success: boolean;
  error?: string;
}

/** Result from pledge_contribution RPC */
export interface PledgeResult {
  success: boolean;
  claim_id?: string;
  remaining?: number;
  error?: string;
}

/** Result from close_split RPC */
export interface CloseSplitResult {
  success: boolean;
  final_amount?: number;
  error?: string;
}

/** Split status from get_split_status RPC */
export interface SplitStatus {
  item_price: number;
  additional_costs: number | null;
  total_pledged: number;
  is_fully_funded: boolean;
  is_open: boolean;
  contributor_count: number;
}

/** Suggested share from get_suggested_share RPC */
export interface SuggestedShare {
  suggested_amount: number;
  remaining_members: number;
}

/** Contributor info for split display */
export interface Contributor {
  id: string;
  display_name: string | null;
  avatar_url: string | null;
  amount: number;
  created_at: string;
}

/** Claim summary for celebration headers */
export interface ClaimSummary {
  total_items: number;
  claimed_items: number;  // Full claims
  split_items: number;    // Items with split contributions
  unclaimed_items: number;
}
```

**Functions:**
1. `openSplit(itemId: string, additionalCosts?: number): Promise<OpenSplitResult>`
   - Calls open_split RPC
   - Error handling: returns {success: false, error: message} on failure

2. `pledgeContribution(itemId: string, amount: number): Promise<PledgeResult>`
   - Calls pledge_contribution RPC
   - Returns remaining amount for UI feedback

3. `closeSplit(itemId: string): Promise<CloseSplitResult>`
   - Calls close_split RPC
   - Returns final amount claimer contributed

4. `getSplitStatus(itemId: string): Promise<SplitStatus | null>`
   - Calls get_split_status RPC
   - Returns null on error (graceful degradation pattern from lib/claims.ts)

5. `getSuggestedShare(itemId: string): Promise<SuggestedShare | null>`
   - Calls get_suggested_share RPC
   - Returns suggested equal-split amount for UI pre-fill
   - NOTE: This is just a suggestion - users can change the amount in the pledge UI
   - Returns null if split not open or no remaining members

6. `getContributors(itemId: string): Promise<Contributor[]>`
   - Direct query to gift_claims WHERE claim_type='split'
   - Joins user_profiles for display_name and avatar_url
   - Orders by created_at ascending
   - Uses getAvatarUrl() from lib/storage.ts for avatar URLs

7. `getClaimSummary(celebrantUserId: string, groupId: string): Promise<ClaimSummary>`
   - Direct aggregate query (no RPC needed for reads)
   - Count total items, full claims, split items, unclaimed
   - Exclude surprise_me and mystery_box items from counts

Follow patterns from lib/claims.ts:
- Same supabase import
- Console.error logging on failures
- Graceful degradation (read functions return defaults on error)
- Cast RPC results through `as` for proper typing
  </action>
  <verify>
Run `npx tsc --noEmit` to check TypeScript compilation.
Verify all 7 functions exported and properly typed.
  </verify>
  <done>
lib/contributions.ts exports openSplit, pledgeContribution, closeSplit, getSplitStatus, getSuggestedShare, getContributors, getClaimSummary with proper types and error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update database types</name>
  <files>types/database.types.ts</files>
  <action>
Run `npx supabase gen types typescript --local > types/database.types.ts` to regenerate types from the new migration.

Verify the regenerated types include:
- gift_claims.claim_type with 'full' | 'split' union
- gift_claims.amount as number | null
- wishlist_items.additional_costs as number | null (if added)
- New RPC function signatures (open_split, pledge_contribution, close_split, get_split_status, get_suggested_share)

If auto-generation fails or is unavailable, manually add type augmentation:

```typescript
// Add to Functions section
open_split: {
  Args: { p_item_id: string; p_additional_costs?: number | null };
  Returns: Json;
};
pledge_contribution: {
  Args: { p_item_id: string; p_amount: number };
  Returns: Json;
};
close_split: {
  Args: { p_item_id: string };
  Returns: Json;
};
get_split_status: {
  Args: { p_item_id: string };
  Returns: {
    item_price: number;
    additional_costs: number | null;
    total_pledged: number;
    is_fully_funded: boolean;
    is_open: boolean;
    contributor_count: number;
  } | null;
};
get_suggested_share: {
  Args: { p_item_id: string };
  Returns: {
    suggested_amount: number;
    remaining_members: number;
  } | null;
};
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors.
Check that lib/contributions.ts compiles without `@ts-ignore` comments.
  </verify>
  <done>
Database types regenerated with new RPC function signatures including get_suggested_share and updated gift_claims/wishlist_items column types.
  </done>
</task>

</tasks>

<verification>
- [ ] lib/contributions.ts exists with all 7 functions exported
- [ ] All interfaces have proper JSDoc comments
- [ ] TypeScript compiles without errors
- [ ] RPC calls use proper argument names matching SQL function parameters
- [ ] getSuggestedShare() wrapper included for equal-split UI
- [ ] Error handling follows graceful degradation pattern
</verification>

<success_criteria>
- All functions type-check correctly
- No `any` types in public interface
- Functions callable from React components
- Error states handled gracefully
- getSuggestedShare() available for UI to pre-fill pledge amount
</success_criteria>

<output>
After completion, create `.planning/phases/21-split-contributions-claim-enhancements/21-02-SUMMARY.md`
</output>
