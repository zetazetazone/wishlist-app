---
phase: 21-split-contributions-claim-enhancements
plan: 04
type: execute
wave: 3
depends_on: ["21-02", "21-03"]
files_modified:
  - components/wishlist/LuxuryWishlistCard.tsx
  - components/wishlist/ClaimButton.tsx
  - app/(app)/celebration/[id].tsx
autonomous: true

must_haves:
  truths:
    - "Claimer sees 'Open for Split' toggle on their claimed item"
    - "Non-claimers see split progress and 'Contribute' button on split items"
    - "Celebrant sees 'Taken' indicator with no split details"
    - "Celebration page displays claim summary in header"
    - "Split items show contributor avatars with amounts"
  artifacts:
    - path: "components/wishlist/LuxuryWishlistCard.tsx"
      provides: "Extended card with split contribution UI"
      contains: "SplitContributionProgress"
    - path: "app/(app)/celebration/[id].tsx"
      provides: "Celebration page with claim summary and split integration"
      contains: "ClaimSummary"
  key_links:
    - from: "LuxuryWishlistCard"
      to: "SplitContributionProgress"
      via: "conditional render when split is open"
      pattern: "claim\\.claim_type.*split"
    - from: "celebration/[id].tsx"
      to: "getClaimSummary"
      via: "useEffect fetch"
      pattern: "getClaimSummary"
---

<objective>
Integrate split contribution components into LuxuryWishlistCard and celebration page, enabling the full split contribution workflow with proper role-based visibility.

Purpose: Connect split UI components to the data layer and implement role-aware rendering (claimer, contributor, celebrant).
Output: Updated wishlist card with split UI, celebration page with claim summary header.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/21-split-contributions-claim-enhancements/21-CONTEXT.md
@.planning/phases/21-split-contributions-claim-enhancements/21-02-SUMMARY.md
@.planning/phases/21-split-contributions-claim-enhancements/21-03-SUMMARY.md
@components/wishlist/LuxuryWishlistCard.tsx
@components/wishlist/ClaimButton.tsx
@app/(app)/celebration/[id].tsx
@lib/contributions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend LuxuryWishlistCard with split contribution UI</name>
  <files>components/wishlist/LuxuryWishlistCard.tsx, components/wishlist/ClaimButton.tsx</files>
  <action>
**1. Add new props to LuxuryWishlistCard:**

```typescript
interface LuxuryWishlistCardProps {
  // ... existing props
  splitStatus?: {
    itemPrice: number;
    additionalCosts: number | null;
    totalPledged: number;
    isFullyFunded: boolean;
    isOpen: boolean;
  } | null;
  contributors?: Array<{
    id: string;
    display_name: string | null;
    avatar_url: string | null;
    amount: number;
  }>;
  onOpenSplit?: (itemId: string, additionalCosts?: number) => void;
  onPledge?: (itemId: string, amount: number) => void;
  onCloseSplit?: (itemId: string) => void;
}
```

**2. Add split UI sections to card body (below ClaimButton):**

**For claimer (isYourClaim && claim exists):**
- If NOT split yet: Show "Open for Split" button
  - On press: show input for additional costs (optional), then call onOpenSplit
- If split is open: Show SplitContributionProgress + ContributorsDisplay
  - Show "Close Split" button to cover remaining amount
  - Disable if already fully funded

**For non-claimer non-celebrant (claim exists with type='split'):**
- Show SplitContributionProgress
- Show ContributorsDisplay
- If not fully funded AND user hasn't pledged: Show "Contribute" button
  - On press: open SplitModal
- If user already pledged: show "Your contribution: $X" badge

**For celebrant (isCelebrant=true):**
- Show only TakenBadge (existing behavior)
- No split details visible

**3. Extend ClaimButton with split variant:**

Add optional props:
```typescript
interface ClaimButtonProps {
  // ... existing
  variant?: 'claim' | 'openSplit' | 'contribute' | 'closeSplit';
  onOpenSplit?: () => void;
  onContribute?: () => void;
  onCloseSplit?: () => void;
}
```

- 'openSplit': Secondary button style, "Open for Split" text
- 'contribute': Success style (green), "Contribute" text
- 'closeSplit': Secondary outline, "Cover Remaining" text

Import new components:
```typescript
import { SplitContributionProgress } from './SplitContributionProgress';
import { ContributorsDisplay } from './ContributorsDisplay';
import { SplitModal } from './SplitModal';
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Verify conditional rendering logic for all three user roles.
  </verify>
  <done>
LuxuryWishlistCard shows split UI based on user role. Claimer can open/close split. Non-claimers can contribute. Celebrant sees only "Taken".
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate claim summary and split data into celebration page</name>
  <files>app/(app)/celebration/[id].tsx</files>
  <action>
**1. Import new functions and components:**

```typescript
import {
  getClaimSummary,
  getSplitStatus,
  getContributors,
  openSplit,
  pledgeContribution,
  closeSplit,
  type ClaimSummary,
  type SplitStatus,
  type Contributor,
} from '../../../lib/contributions';
import { ClaimSummary as ClaimSummaryComponent } from '../../../components/celebrations/ClaimSummary';
```

**2. Add state for claim summary and split data:**

```typescript
const [claimSummary, setClaimSummary] = useState<ClaimSummary | null>(null);
const [splitStatusMap, setSplitStatusMap] = useState<Map<string, SplitStatus>>(new Map());
const [contributorsMap, setContributorsMap] = useState<Map<string, Contributor[]>>(new Map());
```

**3. Fetch claim summary on load:**

In existing useEffect that loads celebration data, add:
```typescript
// After loading celebration and items
if (celebration && wishlistItems.length > 0) {
  const summary = await getClaimSummary(celebration.celebrant_id, celebration.group_id);
  setClaimSummary(summary);

  // Fetch split status for items that have split claims
  const splitItemIds = wishlistItems
    .filter(item => claimsMap.get(item.id)?.some(c => c.claim_type === 'split'))
    .map(item => item.id);

  for (const itemId of splitItemIds) {
    const status = await getSplitStatus(itemId);
    if (status) setSplitStatusMap(prev => new Map(prev).set(itemId, status));
    const contribs = await getContributors(itemId);
    setContributorsMap(prev => new Map(prev).set(itemId, contribs));
  }
}
```

**4. Add ClaimSummary to celebration header:**

In the header section (after status badge), add:
```tsx
{claimSummary && !isCelebrant && (
  <ClaimSummaryComponent
    totalItems={claimSummary.total_items}
    claimedItems={claimSummary.claimed_items}
    splitItems={claimSummary.split_items}
  />
)}
```

**5. Pass split props to LuxuryWishlistCard:**

In the wishlist items FlatList renderItem:
```tsx
<LuxuryWishlistCard
  // ... existing props
  splitStatus={splitStatusMap.get(item.id) || null}
  contributors={contributorsMap.get(item.id) || []}
  onOpenSplit={handleOpenSplit}
  onPledge={handlePledge}
  onCloseSplit={handleCloseSplit}
/>
```

**6. Implement split handlers:**

```typescript
const handleOpenSplit = async (itemId: string, additionalCosts?: number) => {
  const result = await openSplit(itemId, additionalCosts);
  if (result.success) {
    // Refresh data
    await refreshWishlistData();
  } else {
    Alert.alert('Error', result.error || 'Failed to open split');
  }
};

const handlePledge = async (itemId: string, amount: number) => {
  const result = await pledgeContribution(itemId, amount);
  if (result.success) {
    await refreshWishlistData();
  } else {
    Alert.alert('Error', result.error || 'Failed to pledge');
  }
};

const handleCloseSplit = async (itemId: string) => {
  const result = await closeSplit(itemId);
  if (result.success) {
    await refreshWishlistData();
  } else {
    Alert.alert('Error', result.error || 'Failed to close split');
  }
};
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Test celebration page loads without errors.
Verify claim summary appears in header for non-celebrant.
  </verify>
  <done>
Celebration page shows claim summary in header. Split items show progress and contributor avatars. Split operations (open, pledge, close) work end-to-end.
  </done>
</task>

</tasks>

<verification>
- [ ] LuxuryWishlistCard receives and uses split props
- [ ] ClaimButton supports new variants
- [ ] Celebration page fetches and displays claim summary
- [ ] Split status and contributors load for split items
- [ ] Open split / pledge / close split handlers work
- [ ] Celebrant cannot see split details
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
- Claimer can open an item for split contributions
- Other members can see progress and contribute
- Celebrant sees only "Taken" status
- Claim summary appears in celebration header
- All operations show loading states and error handling
</success_criteria>

<output>
After completion, create `.planning/phases/21-split-contributions-claim-enhancements/21-04-SUMMARY.md`
</output>
