---
phase: 21-split-contributions-claim-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260206000002_split_contributions.sql
autonomous: true

must_haves:
  truths:
    - "pledge_contribution RPC validates amount does not exceed remaining"
    - "open_split RPC converts full claim to split-open state"
    - "close_split RPC allows claimer to cover remaining amount"
    - "Split invite notification fires only on first split claim for an item"
    - "Fully funded notification fires when total pledges >= item price"
  artifacts:
    - path: "supabase/migrations/20260206000002_split_contributions.sql"
      provides: "Split contribution RPC functions and notification triggers"
      contains: "pledge_contribution"
  key_links:
    - from: "pledge_contribution"
      to: "gift_claims"
      via: "INSERT with amount validation"
      pattern: "INSERT INTO.*gift_claims.*claim_type.*split"
---

<objective>
Create PostgreSQL RPC functions for split contribution operations (pledge, open split, close split) and database triggers for notifications (split invite, fully funded, split canceled).

Purpose: Enable atomic split contribution operations with race-condition safety and automated push notifications for split workflow events.
Output: Database migration with 4 RPC functions and 3 notification triggers.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-split-contributions-claim-enhancements/21-CONTEXT.md
@.planning/phases/21-split-contributions-claim-enhancements/21-RESEARCH.md
@supabase/migrations/20260206000001_v1.3_claims_details_notes.sql
@lib/claims.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create split contribution RPC functions</name>
  <files>supabase/migrations/20260206000002_split_contributions.sql</files>
  <action>
Create a new migration file with the following RPC functions:

1. **open_split(p_item_id UUID, p_additional_costs NUMERIC DEFAULT NULL)**
   - SECURITY DEFINER with SET search_path = ''
   - Validates caller owns the full claim on this item
   - Updates existing claim to claim_type='split' (claimer's pledge stays as their contribution)
   - Optionally stores additional_costs (shipping) in wishlist_items table (add column if needed)
   - Returns JSONB {success: true} or {success: false, error: string}
   - Use SELECT FOR UPDATE on wishlist_items to prevent race conditions

2. **pledge_contribution(p_item_id UUID, p_amount NUMERIC)**
   - SECURITY DEFINER with SET search_path = ''
   - Validates user is group member (not celebrant)
   - Validates split is open (EXISTS claim with claim_type='split')
   - Validates user hasn't already pledged to this item
   - Validates total pledges + p_amount <= item price + additional_costs
   - INSERT into gift_claims with claim_type='split', amount=p_amount
   - Returns JSONB {success: true, claim_id: uuid, remaining: numeric} or error

3. **close_split(p_item_id UUID)**
   - SECURITY DEFINER with SET search_path = ''
   - Validates caller is the original claimer (owns the first split claim)
   - Calculates remaining amount needed
   - Updates caller's existing claim amount to cover remaining
   - Returns JSONB {success: true, final_amount: numeric} or error

4. **get_split_status(p_item_id UUID)**
   - SECURITY DEFINER, STABLE (read-only)
   - Returns item_price, additional_costs, total_pledged, is_fully_funded, is_open
   - Caller must be group member (not celebrant) - RLS-style check

Also add column to wishlist_items if needed:
```sql
ALTER TABLE public.wishlist_items
ADD COLUMN IF NOT EXISTS additional_costs NUMERIC CHECK (additional_costs IS NULL OR additional_costs >= 0);
COMMENT ON COLUMN public.wishlist_items.additional_costs IS 'Shipping/delivery costs added by claimer when opening split';
```

Follow existing patterns from 20260206000001_v1.3_claims_details_notes.sql for:
- SECURITY DEFINER + SET search_path = ''
- JSONB return format with success/error pattern
- (SELECT auth.uid()) optimization
- SELECT FOR UPDATE SKIP LOCKED for race condition prevention
  </action>
  <verify>
Run `npx supabase db diff` to see migration preview.
Verify migration file contains all 4 RPC functions with proper SECURITY DEFINER and error handling.
  </verify>
  <done>
4 RPC functions (open_split, pledge_contribution, close_split, get_split_status) created with atomic operations and proper error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notification triggers for split events</name>
  <files>supabase/migrations/20260206000002_split_contributions.sql</files>
  <action>
Add to the same migration file, notification trigger functions:

1. **notify_split_invite() TRIGGER**
   - Fires AFTER INSERT ON gift_claims
   - WHEN condition: NEW.claim_type = 'split'
   - Only fires for the FIRST split claim (the original claimer opening the split)
   - Check: `(SELECT COUNT(*) FROM gift_claims WHERE wishlist_item_id = NEW.wishlist_item_id AND claim_type = 'split') = 1`
   - Get item title, celebrant name, claimer name from joined tables
   - INSERT into user_notifications for all group members EXCEPT celebrant and claimer
   - Notification format: title="Split Invite", body="[Claimer] invited you to split [Item] for [Celebrant]"
   - data JSONB: {type: 'split_invite', item_id, item_title, claimer_id, claimer_name}

2. **notify_split_fully_funded() TRIGGER**
   - Fires AFTER INSERT ON gift_claims
   - WHEN condition: NEW.claim_type = 'split'
   - Check if total pledges >= item price + additional_costs
   - If fully funded, INSERT into user_notifications for ALL contributors
   - Notification format: title="Split Fully Funded!", body="[Item] for [Celebrant] is fully funded!"
   - data JSONB: {type: 'split_fully_funded', item_id, item_title}

3. **notify_split_canceled() TRIGGER**
   - Fires AFTER DELETE ON gift_claims
   - WHEN condition: OLD.claim_type = 'split' - detect when split is being unclaimed
   - Check if this was the original claimer's claim (the first one)
   - If original claimer unclaims, INSERT into user_notifications for all other contributors
   - Notification format: title="Split Canceled", body="The split for [Item] was canceled"
   - data JSONB: {type: 'split_canceled', item_id, item_title}

IMPORTANT: Modify unclaim_item() RPC to BLOCK unclaiming if item has other contributors:
```sql
-- In unclaim_item(), before deletion, add check:
IF EXISTS (
  SELECT 1 FROM public.gift_claims
  WHERE wishlist_item_id = v_claim.wishlist_item_id
    AND claimed_by != v_user_id
    AND claim_type = 'split'
) THEN
  RETURN jsonb_build_object('success', false, 'error', 'Cannot unclaim: item has contributions from other members');
END IF;
```

Follow existing notification trigger pattern from supabase/migrations/20260202000007_reminder_scheduling.sql for:
- INSERT into user_notifications
- JSONB data payload structure
- SECURITY DEFINER on trigger functions
  </action>
  <verify>
Verify migration file contains all 3 trigger functions and trigger attachments.
Verify unclaim_item blocking logic added.
Run `npx supabase db reset` to test migration applies cleanly.
  </verify>
  <done>
3 notification triggers created: split invite (to group members), fully funded (to contributors), split canceled (to contributors). unclaim_item blocks when contributions exist.
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at expected path
- [ ] All 4 RPC functions have SECURITY DEFINER and proper return types
- [ ] All 3 trigger functions fire on correct events
- [ ] unclaim_item() modified to block unclaiming with existing contributions
- [ ] `npx supabase db reset` completes without errors
- [ ] GRANT EXECUTE statements included for authenticated users
</verification>

<success_criteria>
- Migration applies cleanly
- RPC functions callable via `supabase.rpc()` from client
- Notification triggers fire on correct events
- Split contributions cannot exceed item price + additional_costs
- Unclaim blocked when other contributors exist
</success_criteria>

<output>
After completion, create `.planning/phases/21-split-contributions-claim-enhancements/21-01-SUMMARY.md`
</output>
