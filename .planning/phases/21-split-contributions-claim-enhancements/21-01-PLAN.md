---
phase: 21-split-contributions-claim-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260206000002_split_contributions.sql
autonomous: true

must_haves:
  truths:
    - "pledge_contribution RPC validates amount does not exceed remaining"
    - "open_split RPC converts full claim to split-open state"
    - "close_split RPC allows claimer to cover remaining amount"
    - "Split invite notification fires only on first split claim for an item"
    - "Fully funded notification fires when total pledges >= item price"
    - "Full claim notification (CLMX-01) fires when item is claimed with claim_type='full'"
    - "Contributor pledges are immutable - cannot be deleted"
  artifacts:
    - path: "supabase/migrations/20260206000002_split_contributions.sql"
      provides: "Split contribution RPC functions and notification triggers"
      contains: "pledge_contribution"
  key_links:
    - from: "pledge_contribution"
      to: "gift_claims"
      via: "INSERT with amount validation"
      pattern: "INSERT INTO.*gift_claims.*claim_type.*split"
    - from: "notify_item_claimed"
      to: "user_notifications"
      via: "INSERT on full claim"
      pattern: "notify_item_claimed"
---

<objective>
Create PostgreSQL RPC functions for split contribution operations (pledge, open split, close split, get suggested share) and database triggers for notifications (split invite, fully funded, split canceled, item claimed) plus pledge immutability enforcement.

Purpose: Enable atomic split contribution operations with race-condition safety, automated push notifications for split workflow events, and immutable pledge enforcement per user decisions.
Output: Database migration with 5 RPC functions, 4 notification triggers, and 1 immutability trigger.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-split-contributions-claim-enhancements/21-CONTEXT.md
@.planning/phases/21-split-contributions-claim-enhancements/21-RESEARCH.md
@supabase/migrations/20260206000001_v1.3_claims_details_notes.sql
@lib/claims.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create split contribution RPC functions</name>
  <files>supabase/migrations/20260206000002_split_contributions.sql</files>
  <action>
Create a new migration file with the following RPC functions:

1. **open_split(p_item_id UUID, p_additional_costs NUMERIC)**
   - SECURITY DEFINER with SET search_path = ''
   - Validates caller owns the full claim on this item
   - Updates existing claim to claim_type='split' (claimer's pledge stays as their contribution)
   - Stores additional_costs (shipping/delivery) in wishlist_items table - add column if needed
   - IMPORTANT: additional_costs is provided at open_split time (UI enforces this before opening split)
   - Returns JSONB {success: true} or {success: false, error: string}
   - Use SELECT FOR UPDATE on wishlist_items to prevent race conditions

   Add column to wishlist_items:
   ```sql
   ALTER TABLE public.wishlist_items
   ADD COLUMN IF NOT EXISTS additional_costs NUMERIC CHECK (additional_costs IS NULL OR additional_costs >= 0);
   COMMENT ON COLUMN public.wishlist_items.additional_costs IS 'Shipping/delivery costs added by claimer when opening split - provided at split open time';
   ```

2. **pledge_contribution(p_item_id UUID, p_amount NUMERIC)**
   - SECURITY DEFINER with SET search_path = ''
   - Validates user is group member (not celebrant)
   - Validates split is open (EXISTS claim with claim_type='split')
   - Validates user hasn't already pledged to this item
   - Validates total pledges + p_amount <= item price + additional_costs
   - NOTE: p_amount can be ANY valid amount (user choice) - get_suggested_share() is just a helper for UI
   - INSERT into gift_claims with claim_type='split', amount=p_amount
   - Returns JSONB {success: true, claim_id: uuid, remaining: numeric} or error

3. **close_split(p_item_id UUID)**
   - SECURITY DEFINER with SET search_path = ''
   - Validates caller is the original claimer (owns the first split claim)
   - Calculates remaining amount needed
   - Updates caller's existing claim amount to cover remaining
   - Returns JSONB {success: true, final_amount: numeric} or error

4. **get_split_status(p_item_id UUID)**
   - SECURITY DEFINER, STABLE (read-only)
   - Returns item_price, additional_costs, total_pledged, is_fully_funded, is_open, contributor_count
   - Caller must be group member (not celebrant) - RLS-style check

5. **get_suggested_share(p_item_id UUID)**
   - SECURITY DEFINER, STABLE (read-only)
   - Helper function for "equal split" UI suggestion
   - Calculates: (item_price + COALESCE(additional_costs, 0) - total_pledged) / remaining_member_count
   - remaining_member_count = group members who haven't pledged yet and haven't claimed another item
   - NOTE: This is just a SUGGESTION - users can pledge any amount they want via pledge_contribution
   - Returns JSONB {suggested_amount: numeric, remaining_members: integer} or null if not applicable

Follow existing patterns from 20260206000001_v1.3_claims_details_notes.sql for:
- SECURITY DEFINER + SET search_path = ''
- JSONB return format with success/error pattern
- (SELECT auth.uid()) optimization
- SELECT FOR UPDATE SKIP LOCKED for race condition prevention
  </action>
  <verify>
Run `npx supabase db diff` to see migration preview.
Verify migration file contains all 5 RPC functions with proper SECURITY DEFINER and error handling.
  </verify>
  <done>
5 RPC functions (open_split, pledge_contribution, close_split, get_split_status, get_suggested_share) created with atomic operations and proper error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notification triggers and pledge immutability</name>
  <files>supabase/migrations/20260206000002_split_contributions.sql</files>
  <action>
Add to the same migration file, notification trigger functions:

1. **notify_item_claimed() TRIGGER** (CLMX-01 requirement)
   - Fires AFTER INSERT ON gift_claims
   - WHEN condition: NEW.claim_type = 'full' (regular claims, NOT split pledges)
   - Get item title, celebrant name, claimer name from joined tables
   - INSERT into user_notifications for all group members EXCEPT celebrant and claimer
   - Notification format: title="Item Claimed", body="[Claimer] claimed [Item] for [Celebrant]"
   - data JSONB: {type: 'item_claimed', item_id, item_title, claimer_id, claimer_name}

2. **notify_split_invite() TRIGGER**
   - Fires AFTER INSERT ON gift_claims
   - WHEN condition: NEW.claim_type = 'split'
   - Only fires for the FIRST split claim (the original claimer opening the split)
   - Check: `(SELECT COUNT(*) FROM gift_claims WHERE wishlist_item_id = NEW.wishlist_item_id AND claim_type = 'split') = 1`
   - Get item title, celebrant name, claimer name from joined tables
   - INSERT into user_notifications for all group members EXCEPT celebrant and claimer
   - Notification format: title="Split Invite", body="[Claimer] invited you to split [Item] for [Celebrant]"
   - data JSONB: {type: 'split_invite', item_id, item_title, claimer_id, claimer_name}

3. **notify_split_fully_funded() TRIGGER**
   - Fires AFTER INSERT ON gift_claims
   - WHEN condition: NEW.claim_type = 'split'
   - Check if total pledges >= item price + additional_costs
   - If fully funded, INSERT into user_notifications for ALL contributors
   - Notification format: title="Split Fully Funded!", body="[Item] for [Celebrant] is fully funded!"
   - data JSONB: {type: 'split_fully_funded', item_id, item_title}

4. **notify_split_canceled() TRIGGER**
   - Fires AFTER DELETE ON gift_claims
   - WHEN condition: OLD.claim_type = 'split'
   - Only fires when the ORIGINAL claimer's claim is deleted (before any other contributors pledged)
   - NOTE: Per CONTEXT.md decision "Cannot unclaim an item once any contributions exist (blocked)"
   - This trigger only fires when there are NO other contributors (original claimer unclaims before others pledge)
   - If original claimer unclaims, INSERT into user_notifications for all group members (info only)
   - Notification format: title="Split Canceled", body="The split for [Item] was canceled"
   - data JSONB: {type: 'split_canceled', item_id, item_title}

5. **enforce_pledge_immutability() TRIGGER**
   - Fires BEFORE DELETE ON gift_claims
   - WHEN condition: OLD.claim_type = 'split'
   - Per CONTEXT.md decision: "Pledges are locked once made - contributors cannot withdraw"
   - Check if the deleting user is NOT the original claimer for this item
   - Original claimer = the user whose split claim was created first (MIN(created_at))
   - If deleting user is a contributor (not original claimer), RAISE EXCEPTION 'Pledges cannot be withdrawn'
   - This allows the original claimer to unclaim (if no other contributions), but blocks contributors

CRITICAL: Modify unclaim_item() RPC to BLOCK unclaiming if item has other contributors:
```sql
-- In unclaim_item(), before deletion, add check:
-- Per CONTEXT.md: "Cannot unclaim an item once any contributions exist (blocked)"
IF EXISTS (
  SELECT 1 FROM public.gift_claims
  WHERE wishlist_item_id = v_claim.wishlist_item_id
    AND claimed_by != v_user_id
    AND claim_type = 'split'
) THEN
  RETURN jsonb_build_object('success', false, 'error', 'Cannot unclaim: item has contributions from other members');
END IF;
```
This is CORRECT per user decision - blocking is intentional. The UI will show a warning dialog explaining why unclaim is blocked.

Follow existing notification trigger pattern from supabase/migrations/20260202000007_reminder_scheduling.sql for:
- INSERT into user_notifications
- JSONB data payload structure
- SECURITY DEFINER on trigger functions
  </action>
  <verify>
Verify migration file contains all 5 trigger functions and trigger attachments:
- notify_item_claimed (CLMX-01)
- notify_split_invite
- notify_split_fully_funded
- notify_split_canceled
- enforce_pledge_immutability

Verify unclaim_item blocking logic added.
Run `npx supabase db reset` to test migration applies cleanly.
  </verify>
  <done>
5 triggers created: item claimed (CLMX-01), split invite (to group members), fully funded (to contributors), split canceled (to group members), pledge immutability enforcement. unclaim_item blocks when contributions exist per user decision.
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at expected path
- [ ] All 5 RPC functions have SECURITY DEFINER and proper return types
- [ ] get_suggested_share() provides equal split calculation helper
- [ ] All 5 trigger functions fire on correct events
- [ ] notify_item_claimed() fires for full claims (CLMX-01)
- [ ] enforce_pledge_immutability() prevents contributor DELETE
- [ ] unclaim_item() modified to block unclaiming with existing contributions
- [ ] `npx supabase db reset` completes without errors
- [ ] GRANT EXECUTE statements included for authenticated users
</verification>

<success_criteria>
- Migration applies cleanly
- RPC functions callable via `supabase.rpc()` from client
- Notification triggers fire on correct events
- Full claim notifications sent to group members (CLMX-01)
- Split contributions cannot exceed item price + additional_costs
- Contributor pledges are immutable (DELETE blocked)
- Unclaim blocked when other contributors exist
- get_suggested_share() returns equal split amount for UI
</success_criteria>

<output>
After completion, create `.planning/phases/21-split-contributions-claim-enhancements/21-01-SUMMARY.md`
</output>
