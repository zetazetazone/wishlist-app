---
phase: 36-options-sheet-polish
plan: 02
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - app/(app)/(tabs)/index.tsx
  - app/(app)/wishlist/[id].tsx
autonomous: true

must_haves:
  truths:
    - "Action button on grid card (owner view) opens OptionsSheet"
    - "Options button in detail page header (owner view) opens OptionsSheet"
    - "Priority changes in sheet update item immediately in grid"
    - "Favorite toggle opens GroupPickerSheet for selection"
    - "Delete from sheet removes item from list"
  artifacts:
    - path: "app/(app)/(tabs)/index.tsx"
      provides: "OptionsSheet integration with My Wishlist tab"
      contains: "OptionsSheet"
    - path: "app/(app)/wishlist/[id].tsx"
      provides: "OptionsSheet integration with detail page"
      contains: "OptionsSheet"
  key_links:
    - from: "app/(app)/(tabs)/index.tsx"
      to: "components/wishlist/OptionsSheet.tsx"
      via: "ref and callbacks"
      pattern: "optionsSheetRef.*open"
    - from: "app/(app)/wishlist/[id].tsx"
      to: "components/wishlist/OptionsSheet.tsx"
      via: "ref and callbacks"
      pattern: "optionsSheetRef.*open"
---

<objective>
Wire OptionsSheet to My Wishlist tab and item detail page.

Purpose: Enable owners to access item options from both the grid and detail views.
Output: Updated index.tsx and [id].tsx with OptionsSheet integration.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-options-sheet-polish/36-RESEARCH.md
@.planning/phases/36-options-sheet-polish/36-01-PLAN.md
@app/(app)/(tabs)/index.tsx
@app/(app)/wishlist/[id].tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate OptionsSheet into My Wishlist tab</name>
  <files>app/(app)/(tabs)/index.tsx</files>
  <action>
Update the My Wishlist tab (index.tsx) to use OptionsSheet:

1. **Add imports**:
   ```typescript
   import { OptionsSheet, OptionsSheetRef } from '../../../components/wishlist';
   ```

2. **Add ref**:
   ```typescript
   const optionsSheetRef = useRef<OptionsSheetRef>(null);
   ```

3. **Update handleItemAction**:
   Change from navigating to detail page to opening options sheet:
   ```typescript
   const handleItemAction = useCallback((item: WishlistItem) => {
     // Owner view: open options sheet
     optionsSheetRef.current?.open(item);
   }, []);
   ```

4. **Create isFavorite callback**:
   ```typescript
   const isFavorite = useCallback((itemId: string) => {
     return favorites.some(f => f.itemId === itemId);
   }, [favorites]);
   ```

5. **Create handleOptionsDelete callback** (wraps existing handleDeleteItem):
   ```typescript
   const handleOptionsDelete = useCallback(async (itemId: string) => {
     await handleDeleteItem(itemId);
   }, [handleDeleteItem]);
   ```

6. **Create handleFavoriteToggle callback**:
   This should find the item and call the existing handleHeartPress:
   ```typescript
   const handleFavoriteToggle = useCallback((item: WishlistItem) => {
     handleHeartPress(item);
   }, [handleHeartPress]);
   ```

7. **Add OptionsSheet component** after GroupPickerSheet at end of JSX:
   ```typescript
   <OptionsSheet
     ref={optionsSheetRef}
     onFavoriteToggle={handleFavoriteToggle}
     onPriorityChange={handlePriorityChange}
     onDelete={handleOptionsDelete}
     isFavorite={isFavorite}
   />
   ```

NOTE: The existing `handlePriorityChange` function already handles optimistic updates and Supabase calls - reuse it directly.
NOTE: `handleDeleteItem` already handles favorite promotion, Supabase delete, and state updates - wrap it for the callback.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit 2>&1 | grep -E "(index\.tsx|error)" | head -20`
OptionsSheet imported: `grep "OptionsSheet" app/\(app\)/\(tabs\)/index.tsx`
Ref created: `grep "optionsSheetRef" app/\(app\)/\(tabs\)/index.tsx`
  </verify>
  <done>
My Wishlist tab:
- Imports OptionsSheet and OptionsSheetRef
- Creates optionsSheetRef
- handleItemAction opens OptionsSheet instead of navigating
- OptionsSheet rendered with all required callbacks
- Favorite toggle connects to existing handleHeartPress (opens GroupPickerSheet)
- Priority change reuses existing handlePriorityChange
- Delete reuses existing handleDeleteItem
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate OptionsSheet into detail page</name>
  <files>app/(app)/wishlist/[id].tsx</files>
  <action>
Update the item detail page ([id].tsx) to use OptionsSheet for owner view:

1. **Add imports**:
   ```typescript
   import { OptionsSheet, OptionsSheetRef } from '@/components/wishlist';
   import { supabase } from '@/lib/supabase';
   ```
   Note: supabase is already imported, verify and keep existing import.

2. **Add ref**:
   ```typescript
   const optionsSheetRef = useRef<OptionsSheetRef>(null);
   ```

3. **Add favorite state** (for owner view only):
   ```typescript
   const [isFavorited, setIsFavorited] = useState(false);
   ```

4. **Load favorite status in loadItem** (after setting isOwner):
   Only for owner view, check if item is favorited:
   ```typescript
   if (isItemOwner) {
     // Check favorite status for any group
     const { data: favs } = await supabase
       .from('group_favorites')
       .select('item_id')
       .eq('user_id', user.id)
       .eq('item_id', id);
     setIsFavorited(!!favs && favs.length > 0);
   }
   ```

5. **Update header right button** (currently TODO comment):
   Replace the placeholder onPress with actual handler:
   ```typescript
   headerRight: () => (
     <Pressable
       onPress={() => {
         if (isOwner && item) {
           optionsSheetRef.current?.open(item);
         }
       }}
       style={[styles.headerButton, { marginRight: spacing.sm }]}
     >
       <MaterialCommunityIcons name="dots-vertical" size={24} color={colors.white} />
     </Pressable>
   ),
   ```

6. **Create callback functions** for OptionsSheet:
   ```typescript
   const handleFavoriteToggle = useCallback(async (toggleItem: WishlistItem) => {
     // Show alert that favorite must be changed from My Wishlist
     // (GroupPickerSheet needs full group context not available here)
     Alert.alert(
       t('wishlist.favorite.changeFromList'),
       t('wishlist.favorite.changeFromListMessage')
     );
   }, [t]);

   const handlePriorityChange = useCallback(async (itemId: string, newPriority: number) => {
     // Optimistic update
     if (item) {
       setItem({ ...item, priority: newPriority });
     }

     try {
       await supabase
         .from('wishlist_items')
         .update({ priority: newPriority })
         .eq('id', itemId);
     } catch (error) {
       console.error('Error updating priority:', error);
       // Reload on error
       loadItem();
     }
   }, [item, loadItem]);

   const handleDelete = useCallback(async (itemId: string) => {
     try {
       const { error } = await supabase
         .from('wishlist_items')
         .delete()
         .eq('id', itemId);

       if (error) throw error;

       // Navigate back after successful delete
       router.back();
     } catch (error) {
       console.error('Error deleting item:', error);
       Alert.alert(t('alerts.titles.error'), t('wishlist.failedToDelete'));
     }
   }, [router, t]);

   const isFavorite = useCallback((itemId: string) => {
     return isFavorited;
   }, [isFavorited]);
   ```

7. **Add OptionsSheet component** at end of JSX (inside main View, after ScrollView):
   Only render for owner view:
   ```typescript
   {isOwner && (
     <OptionsSheet
       ref={optionsSheetRef}
       onFavoriteToggle={handleFavoriteToggle}
       onPriorityChange={handlePriorityChange}
       onDelete={handleDelete}
       isFavorite={isFavorite}
     />
   )}
   ```

8. **Add translation keys** for favorite alert (add to en.json and es.json if not exist):
   Check if keys exist first, add if missing:
   - `wishlist.favorite.changeFromList`
   - `wishlist.favorite.changeFromListMessage`

**CRITICAL**: Favorite toggle shows alert directing user to My Wishlist tab (GroupPickerSheet requires full group context).
**CRITICAL**: After delete, navigate back to prevent showing deleted item.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit 2>&1 | grep -E "(\[id\]\.tsx|error)" | head -20`
OptionsSheet imported: `grep "OptionsSheet" app/\(app\)/wishlist/\[id\].tsx`
Header button wired: `grep "optionsSheetRef.*open" app/\(app\)/wishlist/\[id\].tsx`
  </verify>
  <done>
Detail page:
- Imports OptionsSheet
- Creates optionsSheetRef
- Header options button opens sheet for owner view
- Priority change updates item and Supabase
- Delete removes item and navigates back
- Favorite toggle shows helpful alert (requires My Wishlist context)
- OptionsSheet only rendered for owner view
  </done>
</task>

<task type="auto">
  <name>Task 3: Add missing translation keys</name>
  <files>src/i18n/locales/en.json, src/i18n/locales/es.json</files>
  <action>
Add translation keys for:
1. Favorite alert in detail page
2. Edit "coming soon" message (if not already present)

**en.json** - add under wishlist.favorite (create section if needed):
```json
"favorite": {
  "markFavorite": "Mark as Most Wanted",
  "removeFavorite": "Remove Most Wanted",
  "changeFromList": "Change from My Wishlist",
  "changeFromListMessage": "To change your Most Wanted item, go to My Wishlist and tap the heart icon."
}
```

**en.json** - add under wishlist (if not exists):
```json
"editComingSoon": "Edit functionality coming soon"
```

**es.json** - add matching keys:
```json
"favorite": {
  "markFavorite": "Marcar como Mas Deseado",
  "removeFavorite": "Quitar Mas Deseado",
  "changeFromList": "Cambiar desde Mi Lista",
  "changeFromListMessage": "Para cambiar tu articulo mas deseado, ve a Mi Lista y toca el icono de corazon."
}
```

```json
"editComingSoon": "Funcionalidad de edicion proximamente"
```

**IMPORTANT**: Read the files first to find exact location and existing structure. Do NOT overwrite - merge into existing structure.
  </action>
  <verify>
Keys exist in en.json: `grep -E "changeFromList|editComingSoon" src/i18n/locales/en.json`
Keys exist in es.json: `grep -E "changeFromList|editComingSoon" src/i18n/locales/es.json`
  </verify>
  <done>
Translation keys added:
- wishlist.favorite.markFavorite
- wishlist.favorite.removeFavorite
- wishlist.favorite.changeFromList
- wishlist.favorite.changeFromListMessage
- wishlist.editComingSoon
Both en.json and es.json updated
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes for both files
2. Options button in grid opens OptionsSheet
3. Options button in detail header opens OptionsSheet (owner only)
4. Priority changes reflect immediately in UI
5. Delete action removes item and updates list
6. All new strings use translation keys
</verification>

<success_criteria>
- Grid card action button opens OptionsSheet (not navigate to detail)
- Detail page header button opens OptionsSheet for owner
- Priority changes via sheet update item in real-time
- Delete from sheet removes item from list
- Favorite toggle connects to GroupPickerSheet flow (My Wishlist) or shows alert (detail)
- Translation keys present in en.json and es.json
</success_criteria>

<output>
After completion, create `.planning/phases/36-options-sheet-polish/36-02-SUMMARY.md`
</output>
