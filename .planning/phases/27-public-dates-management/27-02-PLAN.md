---
phase: 27-public-dates-management
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - app/(app)/settings/public-dates.tsx
  - app/(app)/settings/_layout.tsx
  - app/(app)/settings/profile.tsx
autonomous: false

must_haves:
  truths:
    - "User can view list of their public dates from profile settings"
    - "User can add a new public date with title, date, and optional description"
    - "User can edit an existing public date"
    - "User can delete a public date with confirmation"
    - "Date picker uses month/day with 'Repeat annually' toggle for year"
  artifacts:
    - path: "app/(app)/settings/public-dates.tsx"
      provides: "Public dates management screen"
      min_lines: 150
    - path: "app/(app)/settings/_layout.tsx"
      provides: "Stack navigation registration for public-dates"
      contains: "public-dates"
    - path: "app/(app)/settings/profile.tsx"
      provides: "Navigation link to public dates"
      contains: "/settings/public-dates"
  key_links:
    - from: "app/(app)/settings/public-dates.tsx"
      to: "lib/publicDates"
      via: "import CRUD functions"
      pattern: "import.*from.*lib/publicDates"
    - from: "app/(app)/settings/public-dates.tsx"
      to: "@react-native-community/datetimepicker"
      via: "date selection"
      pattern: "DateTimePicker"
    - from: "app/(app)/settings/profile.tsx"
      to: "/settings/public-dates"
      via: "router.push navigation"
      pattern: "router\\.push.*public-dates"
---

<objective>
Build the complete public dates management screen with add/edit/delete functionality and integrate into settings navigation.

Purpose: Users can manage their custom dates (anniversaries, special events) that will be visible to friends.
Output: Working public dates screen accessible from profile settings with full CRUD operations.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-public-dates-management/27-RESEARCH.md
@.planning/phases/27-public-dates-management/27-01-SUMMARY.md

# Pattern references
@app/(app)/settings/personal-details.tsx (form screen pattern)
@app/(app)/settings/profile.tsx (settings link pattern)
@app/(app)/settings/_layout.tsx (stack registration)
@app/(onboarding)/index.tsx (DateTimePicker usage pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create public dates management screen</name>
  <files>app/(app)/settings/public-dates.tsx</files>
  <action>
Create app/(app)/settings/public-dates.tsx with list + add/edit functionality:

**1. State management:**
```typescript
const [dates, setDates] = useState<PublicDate[]>([]);
const [loading, setLoading] = useState(true);
const [showForm, setShowForm] = useState(false);
const [editingDate, setEditingDate] = useState<PublicDate | null>(null);
const [showDatePicker, setShowDatePicker] = useState(false);

// Form state
const [title, setTitle] = useState('');
const [description, setDescription] = useState('');
const [selectedDate, setSelectedDate] = useState(new Date());
const [repeatAnnually, setRepeatAnnually] = useState(true);
const [saving, setSaving] = useState(false);
```

**2. Data loading:**
```typescript
const loadDates = async () => {
  try {
    const data = await getMyPublicDates();
    setDates(data);
  } catch (error) {
    console.error('Failed to load dates:', error);
    Alert.alert('Error', 'Failed to load dates');
  } finally {
    setLoading(false);
  }
};

useEffect(() => { loadDates(); }, []);
```

**3. Form handlers:**
- `resetForm()`: Clear all form state, set editingDate to null
- `handleEdit(date)`: Populate form with date values, set editingDate, show form
  - CRITICAL: Use `new Date(2000, date.month - 1, date.day)` for selectedDate
  - Set repeatAnnually = (date.year === null)
- `handleSave()`:
  - Validate title is not empty
  - Extract month/day from selectedDate: `selectedDate.getMonth() + 1`, `selectedDate.getDate()`
  - Set year to null if repeatAnnually, otherwise selectedDate.getFullYear()
  - Call createPublicDate or updatePublicDate based on editingDate
  - Reload dates, reset form, hide form
- `handleDelete(id, title)`:
  - Show Alert.alert with "Delete Date" title and confirmation message
  - On confirm: call deletePublicDate(id), reload dates

**4. DateTimePicker handling (CRITICAL for Android):**
```typescript
const handleDateChange = (event: any, date?: Date) => {
  // Android requires manual dismiss
  if (Platform.OS === 'android') {
    setShowDatePicker(false);
  }
  if (date) {
    setSelectedDate(date);
  }
};
```

**5. UI structure:**
- Header: "Important Dates" heading with Add button (+ icon)
- Loading state: ActivityIndicator centered
- Empty state: "No dates added yet" message with "Add Date" button
- List: FlatList with PublicDateCard items
  - onEdit opens form with date data
  - onDelete shows confirmation

**6. Form section (shown when showForm is true):**
- Modal or inline form (prefer inline collapsible for simplicity)
- Title input (required): Input with placeholder "e.g., Wedding Anniversary"
- Description input (optional): Input with placeholder "Optional notes"
- Date picker:
  - iOS: Inline DateTimePicker with mode="date" display="spinner"
  - Android: Pressable showing current date, opens DateTimePicker on press
- "Repeat annually" Switch/Checkbox toggle
  - When on: year = null (recurring)
  - When off: year = selectedDate.getFullYear()
- Cancel and Save buttons

**7. Imports:**
```typescript
import { useState, useEffect } from 'react';
import { Alert, ScrollView, ActivityIndicator, Platform, FlatList, Switch } from 'react-native';
import { useRouter } from 'expo-router';
import DateTimePicker from '@react-native-community/datetimepicker';
import { format } from 'date-fns';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import { VStack, HStack, Text, Button, ButtonText, Input, InputField, Heading, Box, Pressable } from '@gluestack-ui/themed';
import { getMyPublicDates, createPublicDate, updatePublicDate, deletePublicDate } from '@/lib/publicDates';
import type { PublicDate } from '@/lib/publicDates';
import { PublicDateCard } from '@/components/profile/PublicDateCard';
import { colors, spacing } from '@/constants/theme';
```
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit app/\\(app\\)/settings/public-dates.tsx`
Verify DateTimePicker import: `grep "DateTimePicker" app/\\(app\\)/settings/public-dates.tsx`
Verify CRUD imports: `grep "getMyPublicDates\|createPublicDate\|updatePublicDate\|deletePublicDate" app/\\(app\\)/settings/public-dates.tsx`
  </verify>
  <done>
public-dates.tsx exists with list view, inline add/edit form, DateTimePicker integration, and delete confirmation. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register screen and add navigation link</name>
  <files>app/(app)/settings/_layout.tsx, app/(app)/settings/profile.tsx</files>
  <action>
**1. Update app/(app)/settings/_layout.tsx:**

Add Stack.Screen for public-dates after personal-details:
```typescript
<Stack.Screen
  name="public-dates"
  options={{
    title: 'Important Dates',
  }}
/>
```

**2. Update app/(app)/settings/profile.tsx:**

Add a navigation link to public dates below the Personal Details link (around line 250):

```typescript
{/* Important Dates Link */}
<Pressable
  onPress={() => router.push('/settings/public-dates')}
>
  <Box
    backgroundColor="$white"
    borderRadius="$lg"
    padding="$4"
    borderWidth={1}
    borderColor="$borderLight200"
  >
    <HStack justifyContent="space-between" alignItems="center">
      <VStack>
        <Text fontWeight="$semibold">Important Dates</Text>
        <Text fontSize="$xs" color="$textLight500">
          Anniversaries & special events
        </Text>
      </VStack>
      <HStack alignItems="center" space="sm">
        <MaterialCommunityIcons name="calendar-heart" size={20} color={colors.burgundy[400]} />
        <MaterialCommunityIcons name="chevron-right" size={20} color="#9CA3AF" />
      </HStack>
    </HStack>
  </Box>
</Pressable>
```

Place this right after the Personal Details Pressable block.
  </action>
  <verify>
Verify Stack.Screen registration: `grep "public-dates" app/\\(app\\)/settings/_layout.tsx`
Verify profile link: `grep "public-dates" app/\\(app\\)/settings/profile.tsx`
Run TypeScript check on both files: `npx tsc --noEmit app/\\(app\\)/settings/_layout.tsx app/\\(app\\)/settings/profile.tsx`
  </verify>
  <done>
_layout.tsx has Stack.Screen for "public-dates" with title "Important Dates". profile.tsx has Pressable link to /settings/public-dates with calendar-heart icon. Both compile without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete public dates management feature:
1. Service layer (lib/publicDates.ts) with CRUD operations
2. PublicDateCard component for list display
3. Public dates screen with list, add, edit, delete functionality
4. DateTimePicker for month/day selection with "Repeat annually" toggle
5. Navigation link in profile settings
  </what-built>
  <how-to-verify>
1. Start the app: `npx expo start`
2. Navigate to Profile tab
3. Tap "Edit Profile" (gear icon or similar)
4. Find and tap "Important Dates" link
5. Verify empty state shows "No dates added yet"
6. Tap "Add Date" button
7. Enter title: "Wedding Anniversary"
8. Use date picker to select a date (e.g., June 15)
9. Leave "Repeat annually" toggle ON
10. Tap Save
11. Verify the date appears in the list showing "June 15 (Annual)"
12. Tap the date to edit - verify form populates correctly
13. Change title to "Our Anniversary", tap Save
14. Verify updated title shows in list
15. Tap delete icon on the card
16. Confirm deletion in alert
17. Verify date is removed from list
18. Add another date with "Repeat annually" OFF - verify year shows
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Navigation works: Profile -> Important Dates screen loads
3. CRUD operations work: Add, Edit, Delete with proper database persistence
4. DateTimePicker works on both iOS and Android
5. Annual vs one-time dates handled correctly
6. RLS enforces owner-only write (implicit in service layer)
</verification>

<success_criteria>
- User can access Important Dates from profile settings
- User can add a new date with title, date, optional description
- User can choose "Repeat annually" or one-time event
- User can edit existing dates
- User can delete dates with confirmation
- Dates persist across app restarts
- DateTimePicker works correctly on both platforms
</success_criteria>

<output>
After completion, create `.planning/phases/27-public-dates-management/27-02-SUMMARY.md`
</output>
