---
phase: 27-public-dates-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/publicDates.ts
  - components/profile/PublicDateCard.tsx
autonomous: true

must_haves:
  truths:
    - "Service functions exist for CRUD operations on public_dates"
    - "PublicDateCard displays title, formatted date, and description"
    - "Card provides edit and delete action handlers"
  artifacts:
    - path: "lib/publicDates.ts"
      provides: "Public dates CRUD operations"
      exports: ["PublicDate", "PublicDateInput", "getMyPublicDates", "createPublicDate", "updatePublicDate", "deletePublicDate"]
    - path: "components/profile/PublicDateCard.tsx"
      provides: "Card component for public date display"
      exports: ["PublicDateCard"]
  key_links:
    - from: "lib/publicDates.ts"
      to: "supabase.from('public_dates')"
      via: "database queries"
      pattern: "from\\('public_dates'\\)"
    - from: "components/profile/PublicDateCard.tsx"
      to: "date-fns format"
      via: "date formatting"
      pattern: "format\\("
---

<objective>
Create the service layer and reusable card component for public dates management.

Purpose: Foundation for the public dates CRUD feature - types, database operations, and display component.
Output: lib/publicDates.ts service file and PublicDateCard component ready for screen integration.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-public-dates-management/27-RESEARCH.md

# Pattern references
@lib/friends.ts (service layer pattern)
@components/friends/FriendCard.tsx (card component pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create public dates service library</name>
  <files>lib/publicDates.ts</files>
  <action>
Create lib/publicDates.ts with the following:

1. **Types:**
   - `PublicDate` interface matching database schema:
     - id: string
     - user_id: string
     - title: string
     - description: string | null
     - month: number (1-12)
     - day: number (1-31)
     - year: number | null (null = annual recurring)
     - created_at: string
     - updated_at: string

   - `PublicDateInput` interface for create/update:
     - title: string
     - description?: string
     - month: number
     - day: number
     - year?: number | null

2. **Functions:**
   - `getMyPublicDates(): Promise<PublicDate[]>`
     - Get current user via supabase.auth.getUser()
     - Query public_dates where user_id = current user
     - Order by month ASC, then day ASC
     - Return empty array if not authenticated or error

   - `createPublicDate(input: PublicDateInput): Promise<PublicDate>`
     - Get current user (throw if not authenticated)
     - Insert with user_id, title.trim(), description?.trim() || null, month, day, year ?? null
     - Use .select().single() to return created record
     - Throw on error

   - `updatePublicDate(id: string, input: Partial<PublicDateInput>): Promise<PublicDate>`
     - Update with spread input, set updated_at to now
     - Use .eq('id', id).select().single()
     - RLS ensures only owner can update
     - Throw on error

   - `deletePublicDate(id: string): Promise<void>`
     - Delete with .eq('id', id)
     - RLS ensures only owner can delete
     - Throw on error

3. **Import pattern:** Follow lib/friends.ts - import { supabase } from './supabase'

CRITICAL: Use getMonth() + 1 when storing dates, and month - 1 when creating Date objects for display.
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit lib/publicDates.ts`
Verify exports exist with: `grep -E "^export (interface|async function)" lib/publicDates.ts`
  </verify>
  <done>
lib/publicDates.ts exists with PublicDate type, PublicDateInput type, and four exported async functions (getMyPublicDates, createPublicDate, updatePublicDate, deletePublicDate). TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PublicDateCard component</name>
  <files>components/profile/PublicDateCard.tsx</files>
  <action>
Create components/profile/PublicDateCard.tsx following FriendCard.tsx pattern:

1. **Props interface:**
   - date: PublicDate (from lib/publicDates)
   - onEdit: () => void
   - onDelete: () => void
   - index?: number (for staggered animation)

2. **Display structure:**
   - White card with gold border (matching FriendCard styling)
   - Left side: Calendar icon (MaterialCommunityIcons "calendar-heart" or "calendar")
   - Center column:
     - Title (bold, burgundy)
     - Formatted date: "MMMM d" using date-fns format() with constructed Date(2000, month - 1, day)
     - Append "(Annual)" if year is null, or "(year)" if year is set
     - Description (smaller, gray) if present
   - Right side: Delete button (trash icon, red color)

3. **Styling:**
   - Use colors, spacing, borderRadius, shadows from constants/theme
   - Use MotiView for staggered animation (from: translateX -20, animate: translateX 0)
   - TouchableOpacity wrapper with onPress={onEdit}

4. **Formatting helper:**
   - Use: `format(new Date(2000, date.month - 1, date.day), 'MMMM d')`
   - Note: month - 1 because Date constructor uses 0-indexed months

5. **Imports:**
   - View, Text, TouchableOpacity, Image from react-native
   - MotiView from moti
   - MaterialCommunityIcons from @expo/vector-icons
   - format from date-fns
   - colors, spacing, borderRadius, shadows from constants/theme
   - PublicDate from lib/publicDates
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit components/profile/PublicDateCard.tsx`
Verify component structure: `grep -E "export (function|const) PublicDateCard" components/profile/PublicDateCard.tsx`
  </verify>
  <done>
PublicDateCard.tsx exists and exports PublicDateCard component. It displays title, formatted month/day with year indicator, optional description, and provides onEdit/onDelete handlers. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes for both files: `npx tsc --noEmit lib/publicDates.ts components/profile/PublicDateCard.tsx`
2. Service exports correct functions: `grep "export async function" lib/publicDates.ts` shows 4 functions
3. Component exports correctly: `grep "export" components/profile/PublicDateCard.tsx`
4. Date formatting uses correct month offset: `grep "month - 1" components/profile/PublicDateCard.tsx` finds the format call
</verification>

<success_criteria>
- lib/publicDates.ts exports PublicDate type, PublicDateInput type, and 4 CRUD functions
- components/profile/PublicDateCard.tsx exports functional component with proper typing
- Both files compile without TypeScript errors
- Date formatting correctly handles 1-indexed database months
</success_criteria>

<output>
After completion, create `.planning/phases/27-public-dates-management/27-01-SUMMARY.md`
</output>
