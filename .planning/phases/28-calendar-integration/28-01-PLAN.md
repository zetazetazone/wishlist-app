---
phase: 28-calendar-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/friendDates.ts
  - components/calendar/BirthdayCalendar.tsx
  - app/(app)/(tabs)/calendar.tsx
autonomous: true

must_haves:
  truths:
    - "Friend birthdays appear in the in-app calendar view with teal dots"
    - "Friend public dates appear in the in-app calendar view with teal dots"
    - "Friend dates use distinct teal color (#0D9488) from group dates"
  artifacts:
    - path: "lib/friendDates.ts"
      provides: "Friend dates fetching service"
      exports: ["getFriendDates", "FriendDate", "FRIEND_DATE_COLOR"]
    - path: "components/calendar/BirthdayCalendar.tsx"
      provides: "Calendar component accepting friend dates"
      contains: "friendDates"
  key_links:
    - from: "app/(app)/(tabs)/calendar.tsx"
      to: "lib/friendDates.ts"
      via: "getFriendDates() call"
      pattern: "getFriendDates"
    - from: "components/calendar/BirthdayCalendar.tsx"
      to: "lib/friendDates.ts"
      via: "FriendDate type import"
      pattern: "import.*FriendDate"
---

<objective>
Create friend dates service and integrate into in-app calendar display

Purpose: Enable users to see their friends' birthdays and custom public dates in the calendar with distinct teal-colored markers (FCAL-01, FCAL-02, FCAL-03)

Output: lib/friendDates.ts service, modified BirthdayCalendar accepting friend dates, calendar screen loading and displaying friend dates
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-calendar-integration/28-RESEARCH.md
@lib/birthdays.ts
@lib/friends.ts
@components/calendar/BirthdayCalendar.tsx
@app/(app)/(tabs)/calendar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create friend dates service library</name>
  <files>lib/friendDates.ts</files>
  <action>
Create lib/friendDates.ts with:

1. Constants:
   - `FRIEND_DATE_COLOR = '#0D9488'` (teal) for all friend dates

2. FriendDate interface:
```typescript
export interface FriendDate {
  id: string;                    // 'friend-birthday-{userId}' or 'friend-date-{dateId}'
  source: 'friend';              // Always 'friend' for this type
  type: 'birthday' | 'public_date';
  date: string;                  // YYYY-MM-DD format
  month: number;                 // 1-12 (database format)
  day: number;                   // 1-31
  title: string;                 // Person's name for birthdays, date title for public dates
  friendName: string;            // Friend's display name
  friendId: string;              // Friend's user ID
  avatarUrl: string | null;      // Avatar for birthdays, null for public dates
  color: string;                 // Always FRIEND_DATE_COLOR
}
```

3. getFriendDates() async function:
   - Get current user from supabase.auth.getUser()
   - Return empty array if not authenticated
   - Query friends table with bidirectional OR: `.or(`user_a_id.eq.${user.id},user_b_id.eq.${user.id}`)`
   - Extract friend IDs (the OTHER user in each row)
   - Batch fetch user_profiles for all friend IDs (id, display_name, avatar_url, birthday)
   - Batch fetch public_dates for all friend IDs (id, user_id, title, month, day, year)
   - Create profile lookup Map for efficient access
   - Transform friend birthdays to FriendDate objects:
     - Parse birthday string to extract month/day (use `split('-').map(Number)`)
     - Set source: 'friend', type: 'birthday'
     - Use getAvatarUrl() from lib/storage for avatar URL
   - Transform friend public dates to FriendDate objects:
     - Construct date string using current year for display
     - Handle null year (recurring dates) by using current year
     - Set source: 'friend', type: 'public_date'
     - avatarUrl is null for public dates
   - Return combined array of FriendDate objects

IMPORTANT PITFALL: JavaScript Date months are 0-indexed but database stores 1-12. When parsing birthday strings like "1990-03-15", split and map to Number gives [1990, 3, 15] which is correct for month/day fields.

Export: FRIEND_DATE_COLOR, FriendDate interface, getFriendDates function
  </action>
  <verify>
Check file exists and has correct exports:
- `grep -q 'export const FRIEND_DATE_COLOR' lib/friendDates.ts`
- `grep -q 'export interface FriendDate' lib/friendDates.ts`
- `grep -q 'export async function getFriendDates' lib/friendDates.ts`
- `npx tsc --noEmit lib/friendDates.ts` compiles without errors
  </verify>
  <done>
lib/friendDates.ts exists with FRIEND_DATE_COLOR constant (#0D9488), FriendDate interface, and getFriendDates() function that queries friends table bidirectionally, batch fetches profiles and public_dates, and returns combined FriendDate array
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend BirthdayCalendar to accept friend dates</name>
  <files>components/calendar/BirthdayCalendar.tsx</files>
  <action>
Modify components/calendar/BirthdayCalendar.tsx to support friend dates:

1. Import FriendDate type from lib/friendDates.ts

2. Update BirthdayCalendarProps interface:
```typescript
interface BirthdayCalendarProps {
  birthdays: GroupBirthday[];
  friendDates?: FriendDate[];    // NEW: Optional friend dates
  onDateSelect: (date: string) => void;
  selectedDate: string | null;
}
```

3. Update component to destructure friendDates with default empty array:
```typescript
export default function BirthdayCalendar({
  birthdays,
  friendDates = [],
  onDateSelect,
  selectedDate,
}: BirthdayCalendarProps)
```

4. Modify markedDates useMemo to include friend dates:
   - Add friendDates to dependency array
   - After processing birthdays, process friend dates:
   ```typescript
   friendDates.forEach(friendDate => {
     // Normalize to current year for calendar display
     const dateKey = `${currentYear}-${String(friendDate.month).padStart(2, '0')}-${String(friendDate.day).padStart(2, '0')}`;

     if (!marks[dateKey]) {
       marks[dateKey] = { dots: [] };
     }

     // Add dot for this friend date if not already present
     const existingDot = marks[dateKey].dots?.find(d => d.key === friendDate.id);
     if (!existingDot) {
       marks[dateKey].dots!.push({
         key: friendDate.id,
         color: friendDate.color, // Teal (#0D9488)
       });
     }
   });
   ```

The existing calendar theme and multi-dot rendering will automatically display teal dots for friend dates alongside group date dots.
  </action>
  <verify>
- `grep -q 'friendDates' components/calendar/BirthdayCalendar.tsx`
- `grep -q 'FriendDate' components/calendar/BirthdayCalendar.tsx`
- `npx tsc --noEmit components/calendar/BirthdayCalendar.tsx` compiles without errors
  </verify>
  <done>
BirthdayCalendar component accepts optional friendDates prop and renders teal dots on calendar dates for friend birthdays and public dates alongside existing group birthday dots
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate friend dates into calendar screen</name>
  <files>app/(app)/(tabs)/calendar.tsx</files>
  <action>
Modify app/(app)/(tabs)/calendar.tsx to load and display friend dates:

1. Add imports:
```typescript
import { getFriendDates, type FriendDate, FRIEND_DATE_COLOR } from '../../../lib/friendDates';
```

2. Add state for friend dates:
```typescript
const [friendDates, setFriendDates] = useState<FriendDate[]>([]);
```

3. Extend loadBirthdays to also load friend dates (rename to loadCalendarData):
```typescript
const loadCalendarData = useCallback(async () => {
  try {
    setError(null);
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      setError('Not authenticated');
      return;
    }

    // Load both in parallel for efficiency
    const [birthdaysData, friendDatesData] = await Promise.all([
      getGroupBirthdays(user.id),
      getFriendDates(),
    ]);

    setBirthdays(birthdaysData);
    setFriendDates(friendDatesData);
  } catch (err) {
    console.error('Failed to load calendar data:', err);
    setError(err instanceof Error ? err.message : 'Failed to load calendar');
  } finally {
    setLoading(false);
    setRefreshing(false);
  }
}, []);
```

4. Update all references from loadBirthdays to loadCalendarData

5. Pass friendDates to BirthdayCalendar:
```typescript
<BirthdayCalendar
  birthdays={birthdays}
  friendDates={friendDates}
  onDateSelect={handleDateSelect}
  selectedDate={selectedDate}
/>
```

6. Create helper to filter friend dates for selected date:
```typescript
// Get friend dates for selected date (month-day matching)
const selectedDateFriendDates = useMemo(() => {
  if (!selectedDate) return [];
  const [, month, day] = selectedDate.split('-');
  return friendDates.filter(fd =>
    String(fd.month).padStart(2, '0') === month &&
    String(fd.day).padStart(2, '0') === day
  );
}, [friendDates, selectedDate]);
```

7. Display friend dates in selected date section (after group birthdays):
   - Only show section if selectedDateFriendDates.length > 0
   - Render FriendDate items with teal styling (can reuse similar card layout)
   - For now, use a simple styled view showing title, friendName, and type badge

8. Update empty state to mention friends:
```typescript
<Text style={styles.emptySubtitle}>
  When group members add their birthdays or you add friends, they'll appear here.
</Text>
```

9. Update header badge to include friend date count:
```typescript
const totalUpcoming = upcomingBirthdays.length + friendDates.filter(fd => {
  const days = getDaysUntilDate(fd.month, fd.day);
  return days >= 0 && days <= PLANNING_WINDOW_DAYS;
}).length;
```

Create a simple getDaysUntilDate helper (or reuse countdown utils pattern) that calculates days until a given month/day.
  </action>
  <verify>
- `grep -q 'getFriendDates' app/\\(app\\)/\\(tabs\\)/calendar.tsx`
- `grep -q 'friendDates' app/\\(app\\)/\\(tabs\\)/calendar.tsx`
- `npx tsc --noEmit app/\\(app\\)/\\(tabs\\)/calendar.tsx` compiles without errors
- `npx expo start --no-dev-client` launches without errors (visual verification deferred)
  </verify>
  <done>
Calendar screen loads friend dates in parallel with group birthdays, passes friend dates to BirthdayCalendar for multi-dot display, shows friend dates in selected date section, and updates empty state message to mention friends
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npx tsc --noEmit` - Full TypeScript check passes
2. `npm run lint` - No linting errors (if configured)
3. lib/friendDates.ts exports FRIEND_DATE_COLOR, FriendDate, getFriendDates
4. BirthdayCalendar accepts friendDates prop
5. Calendar screen loads and displays friend dates with teal color
</verification>

<success_criteria>
1. Friend birthdays appear as teal dots on calendar dates
2. Friend public dates appear as teal dots on calendar dates
3. Teal color (#0D9488) is visually distinct from group date colors
4. Selected date shows friend dates when applicable
5. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/28-calendar-integration/28-01-SUMMARY.md`
</output>
