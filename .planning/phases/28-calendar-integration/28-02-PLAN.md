---
phase: 28-calendar-integration
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - components/calendar/CountdownCard.tsx
  - utils/deviceCalendar.ts
  - components/calendar/CalendarSyncButton.tsx
  - app/(app)/(tabs)/calendar.tsx
autonomous: false

must_haves:
  truths:
    - "Calendar countdown cards show source indicator distinguishing Friend from Group"
    - "User can sync friend dates to device calendar alongside group birthdays"
    - "Device calendar events have source-aware titles and notes"
  artifacts:
    - path: "components/calendar/CountdownCard.tsx"
      provides: "Countdown card with source indicator"
      contains: "source"
    - path: "utils/deviceCalendar.ts"
      provides: "Extended device calendar sync supporting friend dates"
      exports: ["syncFriendDateEvent", "syncAllCalendarEvents"]
  key_links:
    - from: "components/calendar/CalendarSyncButton.tsx"
      to: "utils/deviceCalendar.ts"
      via: "syncAllCalendarEvents call"
      pattern: "syncAllCalendarEvents"
    - from: "components/calendar/CountdownCard.tsx"
      to: "lib/friendDates.ts"
      via: "FriendDate type"
      pattern: "FriendDate"
---

<objective>
Add source indicators to calendar events and extend device sync to include friend dates

Purpose: Enable users to distinguish between Friend and Group events in both the in-app calendar cards and device calendar, and sync all dates to their device (FCAL-04, FCAL-05)

Output: CountdownCard with source indicator, extended deviceCalendar supporting friend dates, CalendarSyncButton syncing both types
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-calendar-integration/28-RESEARCH.md
@.planning/phases/28-calendar-integration/28-01-SUMMARY.md
@lib/friendDates.ts
@components/calendar/CountdownCard.tsx
@utils/deviceCalendar.ts
@components/calendar/CalendarSyncButton.tsx
@app/(app)/(tabs)/calendar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add source indicator to CountdownCard</name>
  <files>components/calendar/CountdownCard.tsx</files>
  <action>
Modify components/calendar/CountdownCard.tsx to support both GroupBirthday and FriendDate types with source indicator:

1. Import FriendDate and FRIEND_DATE_COLOR from lib/friendDates:
```typescript
import { type FriendDate, FRIEND_DATE_COLOR } from '../../lib/friendDates';
```

2. Create a union type for the birthday prop:
```typescript
type CalendarEvent = GroupBirthday | FriendDate;

interface CountdownCardProps {
  birthday: CalendarEvent;  // Can be either GroupBirthday or FriendDate
  daysUntil: number;
  onPress?: () => void;
}
```

3. Add type guard helper inside component:
```typescript
const isFriendDate = (event: CalendarEvent): event is FriendDate => {
  return 'source' in event && event.source === 'friend';
};
```

4. Derive display values based on type:
```typescript
const isFromFriend = isFriendDate(birthday);

// Get display name (person's name)
const displayName = isFromFriend
  ? birthday.title
  : birthday.userName;

// Get source label for badge
const sourceLabel = isFromFriend
  ? (birthday.type === 'birthday' ? 'Friend' : birthday.friendName)
  : birthday.groupName;

// Get color for source indicator
const sourceColor = isFromFriend
  ? FRIEND_DATE_COLOR
  : birthday.groupColor;

// Get icon for type
const typeIcon = isFromFriend && birthday.type === 'public_date'
  ? 'calendar-heart'  // Special icon for friend public dates
  : undefined;        // Default icons from status
```

5. Update groupRow section to show source badge with type-aware styling:
```typescript
<View style={styles.groupRow}>
  <View style={[styles.groupDot, { backgroundColor: sourceColor }]} />
  <Text style={styles.groupName} numberOfLines={1}>
    {sourceLabel}
  </Text>
  {isFromFriend && (
    <View style={[styles.sourceBadge, { backgroundColor: `${FRIEND_DATE_COLOR}15` }]}>
      <Text style={[styles.sourceBadgeText, { color: FRIEND_DATE_COLOR }]}>
        {birthday.type === 'birthday' ? 'Birthday' : 'Date'}
      </Text>
    </View>
  )}
</View>
```

6. Update userName display:
```typescript
<Text style={styles.userName} numberOfLines={1}>
  {displayName}
</Text>
```

7. Add styles for source badge:
```typescript
sourceBadge: {
  paddingHorizontal: 6,
  paddingVertical: 2,
  borderRadius: 4,
  marginLeft: 8,
},
sourceBadgeText: {
  fontSize: 10,
  fontWeight: '600',
},
```

The card will now display:
- For GroupBirthday: "[UserName]" with "[GroupName]" and colored dot
- For FriendDate birthday: "[FriendName]" with "Friend" label and "Birthday" badge in teal
- For FriendDate public_date: "[DateTitle]" with "[FriendName]" and "Date" badge in teal
  </action>
  <verify>
- `grep -q 'FriendDate' components/calendar/CountdownCard.tsx`
- `grep -q 'source' components/calendar/CountdownCard.tsx`
- `grep -q 'sourceBadge' components/calendar/CountdownCard.tsx`
- `npx tsc --noEmit components/calendar/CountdownCard.tsx` compiles without errors
  </verify>
  <done>
CountdownCard accepts both GroupBirthday and FriendDate types, displays source indicator badge for friend dates distinguishing "Friend" birthdays from friend public dates, uses teal color for friend-sourced events
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend device calendar sync for friend dates</name>
  <files>utils/deviceCalendar.ts</files>
  <action>
Extend utils/deviceCalendar.ts to support syncing friend dates:

1. Import FriendDate type:
```typescript
import type { FriendDate } from '../lib/friendDates';
```

2. Add re-export for FriendDate:
```typescript
export type { FriendDate } from '../lib/friendDates';
```

3. Create syncFriendDateEvent function:
```typescript
/**
 * Sync a friend date event to the device calendar
 * Creates a yearly recurring event with reminders
 */
export async function syncFriendDateEvent(
  friendDate: FriendDate
): Promise<SyncResult> {
  try {
    const calendarId = await getOrCreateWishlistCalendar();

    // Construct date from month/day using current year
    const currentYear = new Date().getFullYear();
    // IMPORTANT: JavaScript Date months are 0-indexed (0-11)
    const eventDate = getNextOccurrence(friendDate.month, friendDate.day);

    // Format title based on type
    const title = friendDate.type === 'birthday'
      ? `${friendDate.title}'s Birthday`
      : friendDate.title;

    // Format notes with friend context
    const notes = friendDate.type === 'birthday'
      ? `Friend birthday - ${friendDate.friendName} - Wishlist App`
      : `${friendDate.friendName}'s special date - Wishlist App`;

    const eventId = await Calendar.createEventAsync(calendarId, {
      title,
      notes,
      startDate: eventDate,
      endDate: eventDate,
      allDay: true,
      alarms: [
        { relativeOffset: -10080 }, // 1 week before
        { relativeOffset: -1440 },  // 1 day before
      ],
      recurrenceRule: {
        frequency: Calendar.Frequency.YEARLY,
      },
    });

    return { success: true, eventId };
  } catch (error) {
    console.error('Friend date sync failed:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error occurred',
    };
  }
}
```

4. Create helper function for next occurrence from month/day:
```typescript
/**
 * Calculate the next occurrence of a date from month/day
 * Handles Feb 29 leap year edge case
 */
function getNextOccurrence(month: number, day: number): Date {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const currentYear = today.getFullYear();

  // Handle Feb 29 (leap year)
  let nextDate: Date;
  if (month === 2 && day === 29) {
    const isLeapYear = (currentYear % 4 === 0 && currentYear % 100 !== 0) || currentYear % 400 === 0;
    if (isLeapYear) {
      nextDate = new Date(currentYear, 1, 29); // Feb is month 1 (0-indexed)
    } else {
      nextDate = new Date(currentYear, 1, 28);
    }
  } else {
    // month is 1-12 in database, Date constructor uses 0-11
    nextDate = new Date(currentYear, month - 1, day);
  }

  nextDate.setHours(0, 0, 0, 0);

  // If date already passed this year, set to next year
  if (nextDate < today) {
    const nextYear = currentYear + 1;
    if (month === 2 && day === 29) {
      const isNextLeapYear = (nextYear % 4 === 0 && nextYear % 100 !== 0) || nextYear % 400 === 0;
      nextDate = isNextLeapYear
        ? new Date(nextYear, 1, 29)
        : new Date(nextYear, 1, 28);
    } else {
      nextDate = new Date(nextYear, month - 1, day);
    }
  }

  return nextDate;
}
```

5. Create unified sync function for all calendar events:
```typescript
/**
 * Sync all calendar events (group birthdays + friend dates) to device calendar
 * Returns results for each sync attempt
 */
export async function syncAllCalendarEvents(
  birthdays: GroupBirthday[],
  friendDates: FriendDate[]
): Promise<SyncResult[]> {
  const totalEvents = birthdays.length + friendDates.length;
  if (totalEvents === 0) {
    return [];
  }

  const results: SyncResult[] = [];

  // Ensure we have the calendar
  try {
    await getOrCreateWishlistCalendar();
  } catch (error) {
    return Array(totalEvents).fill({
      success: false,
      error: error instanceof Error ? error.message : 'Failed to access calendar',
    });
  }

  // Sync group birthdays
  for (const birthday of birthdays) {
    const result = await syncBirthdayEvent(
      birthday.userName,
      birthday.birthday,
      birthday.groupName
    );
    results.push(result);
  }

  // Sync friend dates
  for (const friendDate of friendDates) {
    const result = await syncFriendDateEvent(friendDate);
    results.push(result);
  }

  return results;
}
```

6. Export new functions at the end of the file.
  </action>
  <verify>
- `grep -q 'syncFriendDateEvent' utils/deviceCalendar.ts`
- `grep -q 'syncAllCalendarEvents' utils/deviceCalendar.ts`
- `grep -q 'FriendDate' utils/deviceCalendar.ts`
- `npx tsc --noEmit utils/deviceCalendar.ts` compiles without errors
  </verify>
  <done>
deviceCalendar.ts exports syncFriendDateEvent for individual friend dates and syncAllCalendarEvents for combined sync of both group birthdays and friend dates, with proper source-aware event titles and notes
  </done>
</task>

<task type="auto">
  <name>Task 3: Update CalendarSyncButton for combined sync</name>
  <files>components/calendar/CalendarSyncButton.tsx, app/(app)/(tabs)/calendar.tsx</files>
  <action>
Update CalendarSyncButton to sync both group birthdays and friend dates:

1. In components/calendar/CalendarSyncButton.tsx:

Update imports:
```typescript
import {
  checkCalendarPermission,
  requestCalendarPermission,
  syncAllCalendarEvents,
  getSyncSummary,
  type GroupBirthday,
  type FriendDate,
  type SyncResult,
} from '../../utils/deviceCalendar';
```

Update CalendarSyncButtonProps interface:
```typescript
interface CalendarSyncButtonProps {
  birthdays: GroupBirthday[];
  friendDates?: FriendDate[];  // NEW: Optional friend dates
  onSyncComplete?: (results: SyncResult[]) => void;
  style?: object;
}
```

Update CalendarSyncButton component:
- Add friendDates to destructuring with default empty array
- Update empty check: `if (birthdays.length === 0 && friendDates.length === 0)`
- Update alert message to mention "calendar events" instead of just "birthdays"
- Replace `syncAllBirthdays(birthdays)` with `syncAllCalendarEvents(birthdays, friendDates)`
- Update success message: `Successfully synced ${summary.success} event${summary.success > 1 ? 's' : ''}`

Update CalendarSyncIconButton similarly:
- Add friendDates prop
- Update empty check and alert messages
- Use syncAllCalendarEvents

2. In app/(app)/(tabs)/calendar.tsx:

Update CalendarSyncIconButton usage to pass friendDates:
```typescript
<CalendarSyncIconButton
  birthdays={birthdays}
  friendDates={friendDates}
  onSyncComplete={(results) => {
    console.log('Calendar sync complete:', results);
  }}
/>
```
  </action>
  <verify>
- `grep -q 'friendDates' components/calendar/CalendarSyncButton.tsx`
- `grep -q 'syncAllCalendarEvents' components/calendar/CalendarSyncButton.tsx`
- `grep -q 'friendDates' app/\\(app\\)/\\(tabs\\)/calendar.tsx | grep -q 'CalendarSyncIconButton'`
- `npx tsc --noEmit components/calendar/CalendarSyncButton.tsx` compiles without errors
  </verify>
  <done>
CalendarSyncButton accepts optional friendDates prop and syncs both group birthdays and friend dates to device calendar, with updated alert messages reflecting "events" instead of "birthdays"
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Visual verification of calendar integration</name>
  <what-built>
Complete calendar integration with:
- Friend dates appearing as teal dots in calendar
- CountdownCard showing source indicator ("Friend" vs group name)
- Device calendar sync including friend dates
  </what-built>
  <how-to-verify>
1. Start the app: `npx expo start`
2. Log in with a test account that has at least one friend with a birthday set
3. Navigate to Calendar tab
4. VERIFY: Friend birthdays show as teal dots on calendar dates
5. VERIFY: Group birthdays show as their group-colored dots
6. VERIFY: Tapping a date with friend birthdays shows them in the selected section
7. VERIFY: CountdownCard for friend dates shows "Friend" label with teal badge
8. VERIFY: CountdownCard for group dates shows group name with group color
9. VERIFY: Tap sync button - both group birthdays AND friend dates are synced to device calendar
10. VERIFY: Check device calendar - events have appropriate titles ("Friend birthday" vs group context)
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npx tsc --noEmit` - Full TypeScript check passes
2. CountdownCard displays source indicator for both GroupBirthday and FriendDate
3. CalendarSyncButton syncs both types to device calendar
4. Device calendar events have source-aware titles and notes
5. Visual verification confirms distinct styling for Friend vs Group events
</verification>

<success_criteria>
1. Calendar events show source indicator distinguishing "Friend" from "Group"
2. Friend dates use teal (#0D9488) color consistently
3. User can sync friend dates to device calendar
4. Device calendar events have clear source identification
5. TypeScript compiles without errors
6. Human verification confirms visual correctness
</success_criteria>

<output>
After completion, create `.planning/phases/28-calendar-integration/28-02-SUMMARY.md`
</output>
