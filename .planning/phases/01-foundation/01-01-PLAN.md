---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260202000001_notifications.sql
  - types/database.types.ts
  - lib/notifications.ts
  - hooks/usePushNotifications.ts
  - supabase/functions/push/index.ts
  - app.json
autonomous: true

must_haves:
  truths:
    - "Push tokens are stored in database when user opens app"
    - "Notifications inserted to user_notifications table trigger Edge Function"
    - "Edge Function sends push via Expo Push Service"
    - "users table has onboarding_completed boolean field"
  artifacts:
    - path: "supabase/migrations/20260202000001_notifications.sql"
      provides: "device_tokens and user_notifications tables with RLS"
      contains: "CREATE TABLE.*device_tokens"
    - path: "lib/notifications.ts"
      provides: "Push token registration and permission utilities"
      exports: ["registerForPushNotificationsAsync", "saveTokenToDatabase"]
    - path: "hooks/usePushNotifications.ts"
      provides: "React hook for push token lifecycle"
      exports: ["usePushNotifications"]
    - path: "supabase/functions/push/index.ts"
      provides: "Edge Function that sends push on notification insert"
      contains: "exp.host.*api/v2/push/send"
  key_links:
    - from: "hooks/usePushNotifications.ts"
      to: "lib/notifications.ts"
      via: "imports registerForPushNotificationsAsync"
      pattern: "import.*from.*notifications"
    - from: "lib/notifications.ts"
      to: "supabase device_tokens table"
      via: "upsert on token save"
      pattern: "from\\('device_tokens'\\)"
---

<objective>
Set up push notification infrastructure including database tables, token registration, and server-side push delivery.

Purpose: Enable the app to receive push notifications, which is foundational for all future notification-based features (birthday reminders, Gift Leader assignments).

Output:
- Database migration with device_tokens and user_notifications tables
- Push token registration hook and utilities
- Supabase Edge Function for push delivery
- Updated TypeScript types
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

# Key research findings to follow:
# - Create Android notification channel BEFORE requesting token (Android 13+)
# - Use Device.isDevice check - push only works on physical devices
# - Track last_active on token upsert for staleness management
# - Development builds required for push testing (not Expo Go SDK 53+)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification database schema</name>
  <files>
    supabase/migrations/20260202000001_notifications.sql
    types/database.types.ts
  </files>
  <action>
Create migration file with:

1. device_tokens table:
   - id UUID primary key
   - user_id UUID references public.users(id) ON DELETE CASCADE
   - expo_push_token TEXT NOT NULL
   - device_type TEXT CHECK ('ios' | 'android')
   - last_active TIMESTAMPTZ DEFAULT NOW()
   - created_at TIMESTAMPTZ DEFAULT NOW()
   - UNIQUE(user_id, expo_push_token)

2. user_notifications table:
   - id UUID primary key
   - user_id UUID references public.users(id) ON DELETE CASCADE
   - title TEXT NOT NULL
   - body TEXT NOT NULL
   - data JSONB DEFAULT '{}'
   - is_read BOOLEAN DEFAULT FALSE
   - created_at TIMESTAMPTZ DEFAULT NOW()

3. Add onboarding_completed BOOLEAN DEFAULT FALSE to users table (ALTER TABLE)

4. RLS policies:
   - device_tokens: Users can INSERT/UPDATE/DELETE own tokens. Service role can SELECT all (for Edge Function).
   - user_notifications: Users can SELECT/UPDATE own. Service role can INSERT.

5. Indexes:
   - idx_device_tokens_user on (user_id)
   - idx_device_tokens_last_active on (last_active)
   - idx_user_notifications_user on (user_id)
   - idx_user_notifications_created on (created_at DESC)

6. Enable realtime for user_notifications: ALTER PUBLICATION supabase_realtime ADD TABLE public.user_notifications;

7. Generate/update TypeScript types:
   - If Supabase CLI is linked to project: run `supabase gen types typescript --local > types/database.types.ts`
   - Otherwise, manually add to types/database.types.ts:
     - DeviceToken interface (id, user_id, expo_push_token, device_type, last_active, created_at)
     - UserNotification interface (id, user_id, title, body, data, is_read, created_at)
     - Add onboarding_completed: boolean to User interface
  </action>
  <verify>
Run `cat supabase/migrations/20260202000001_notifications.sql | head -100` to verify table definitions exist.
Run `grep -l "DeviceToken" types/database.types.ts` to verify type exports.
Run `grep "onboarding_completed" types/database.types.ts` to verify User interface updated.
  </verify>
  <done>
Migration file contains device_tokens and user_notifications tables with proper RLS.
TypeScript types updated with DeviceToken, UserNotification, and User.onboarding_completed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create push notification utilities and hook</name>
  <files>
    lib/notifications.ts
    hooks/usePushNotifications.ts
    app.json
  </files>
  <action>
Create lib/notifications.ts with:

1. registerForPushNotificationsAsync():
   - Check Device.isDevice (return null if not physical device)
   - If Android, create 'default' notification channel FIRST with AndroidImportance.MAX
   - Check existing permissions, request if not granted
   - Return null if permission denied
   - Get Expo push token with projectId from Constants.expoConfig.extra.eas.projectId
   - Return token.data string

2. saveTokenToDatabase(userId: string, token: string):
   - Upsert to device_tokens table
   - Include user_id, expo_push_token, device_type (Platform.OS), last_active: new Date().toISOString()
   - Use onConflict: 'user_id,expo_push_token' for upsert
   - Log errors but don't throw (non-blocking)

Create hooks/usePushNotifications.ts:
1. Export usePushNotifications hook
2. On mount (when authenticated):
   - Call registerForPushNotificationsAsync
   - If token returned, call saveTokenToDatabase with current user ID
3. Set up notification received listener (Notifications.addNotificationReceivedListener)
4. Set up notification response listener (Notifications.addNotificationResponseReceivedListener)
5. Clean up listeners on unmount
6. Return { expoPushToken, notification } state

Update app.json:
- Ensure "expo" object has "extra" with "eas" containing "projectId" (placeholder for now, user will need to run eas init)

Install required packages:
```bash
npx expo install expo-notifications expo-device
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors.
Run `grep -l "registerForPushNotificationsAsync" lib/notifications.ts hooks/usePushNotifications.ts` to verify function exists in both files.
  </verify>
  <done>
lib/notifications.ts exports registerForPushNotificationsAsync and saveTokenToDatabase.
hooks/usePushNotifications.ts exports usePushNotifications hook.
app.json has eas.projectId placeholder in extra config.
expo-notifications and expo-device packages installed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Edge Function for push delivery</name>
  <files>
    supabase/functions/push/index.ts
  </files>
  <action>
Create Supabase Edge Function at supabase/functions/push/index.ts:

1. Import serve from Deno std library
2. Create Supabase client using SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY from environment
3. Define NotificationPayload interface matching database webhook format:
   ```typescript
   interface NotificationPayload {
     type: 'INSERT'
     table: string
     record: {
       id: string
       user_id: string
       title: string
       body: string
       data?: Record<string, unknown>
     }
   }
   ```

4. Handler function:
   - Parse JSON payload from request
   - Query device_tokens table for user_id matching payload.record.user_id
   - If no tokens, return { success: false, reason: 'no_tokens' }
   - Build Expo push messages array:
     - to: each expo_push_token
     - sound: 'default'
     - title: payload.record.title
     - body: payload.record.body
     - data: payload.record.data
   - POST to https://exp.host/--/api/v2/push/send
   - Include Authorization header with Bearer token from EXPO_ACCESS_TOKEN env var
   - Return response from Expo Push Service

5. Add CORS headers for Supabase webhook calls

**Post-Task Manual Setup (Required):**
After Task 3 files are created, the user MUST complete these steps:

1. Deploy Edge Function:
   ```bash
   supabase functions deploy push
   ```

2. Set Expo access token secret:
   ```bash
   supabase secrets set EXPO_ACCESS_TOKEN=<your-expo-access-token>
   ```
   (Get token from: https://expo.dev/accounts/[account]/settings/access-tokens)

3. Create database webhook in Supabase Dashboard:
   - Go to Database > Webhooks
   - Create new webhook:
     - Name: push_notification_trigger
     - Table: user_notifications
     - Events: INSERT
     - URL: Your Edge Function URL (shown after deploy)
   - This wiring enables automatic push delivery on notification insert
  </action>
  <verify>
Run `cat supabase/functions/push/index.ts | grep "exp.host"` to verify Expo Push Service URL.
Run `ls supabase/functions/push/` to verify index.ts exists.
  </verify>
  <done>
Edge Function created at supabase/functions/push/index.ts.
Function queries device_tokens and sends push via Expo Push Service.
  </done>
</task>

</tasks>

<verification>
1. All files created and pass TypeScript compilation
2. Migration SQL is valid (tables, RLS, indexes defined)
3. Edge Function structure matches Supabase conventions
4. Push token registration flow follows research patterns (channel before token on Android)
</verification>

<success_criteria>
- [ ] supabase/migrations/20260202000001_notifications.sql exists with device_tokens and user_notifications tables
- [ ] types/database.types.ts has DeviceToken, UserNotification interfaces and User.onboarding_completed
- [ ] lib/notifications.ts exports registerForPushNotificationsAsync and saveTokenToDatabase
- [ ] hooks/usePushNotifications.ts exports usePushNotifications hook
- [ ] supabase/functions/push/index.ts exists and calls Expo Push Service
- [ ] expo-notifications and expo-device packages in package.json
- [ ] `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
