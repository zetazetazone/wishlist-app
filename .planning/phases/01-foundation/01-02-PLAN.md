---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app/_layout.tsx
  - app/(onboarding)/_layout.tsx
  - app/(onboarding)/index.tsx
  - app/(app)/(tabs)/notifications.tsx
  - app/(app)/(tabs)/_layout.tsx
  - app/profile/[id].tsx
  - lib/storage.ts
  - hooks/useOnboardingStatus.ts
autonomous: false

must_haves:
  truths:
    - "User cannot access app tabs until onboarding is complete"
    - "User can enter display name and birthday during onboarding"
    - "User can optionally upload profile photo during onboarding"
    - "User can view other group members' profile details"
    - "User can view list of past notifications in inbox"
  artifacts:
    - path: "app/(onboarding)/index.tsx"
      provides: "Onboarding screen with name, birthday, photo fields"
      min_lines: 80
    - path: "app/(app)/(tabs)/notifications.tsx"
      provides: "Notification inbox with FlashList"
      contains: "FlashList"
    - path: "app/profile/[id].tsx"
      provides: "Member profile view screen"
      min_lines: 50
    - path: "hooks/useOnboardingStatus.ts"
      provides: "Hook to check onboarding completion"
      exports: ["useOnboardingStatus"]
    - path: "lib/storage.ts"
      provides: "Supabase Storage helpers for avatar upload"
      exports: ["uploadAvatar", "getAvatarUrl"]
  key_links:
    - from: "app/_layout.tsx"
      to: "hooks/useOnboardingStatus.ts"
      via: "import and use for routing decision"
      pattern: "useOnboardingStatus"
    - from: "app/(onboarding)/index.tsx"
      to: "lib/storage.ts"
      via: "calls uploadAvatar on photo selection"
      pattern: "uploadAvatar"
    - from: "app/(app)/(tabs)/notifications.tsx"
      to: "supabase user_notifications table"
      via: "fetch and realtime subscription"
      pattern: "from\\('user_notifications'\\)"
---

<objective>
Implement blocking onboarding flow, profile viewing, and notification inbox screens.

Purpose: Ensure users provide required profile information (birthday, name) before using the app, enable viewing of group member profiles, and provide a notification history inbox.

Output:
- Blocking onboarding flow with birthday, display name, optional photo
- Profile view screen for group members
- Notification inbox screen with realtime updates
- Root layout updated with onboarding guard
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

# Key research findings to follow:
# - Use Stack.Protected for blocking onboarding (handles deep links correctly)
# - expo-image-picker with quality: 0.8 and allowsEditing: true for avatar
# - ArrayBuffer pattern for Supabase Storage upload
# - FlashList for notification inbox (already in project)
# - Realtime subscription for live notification updates
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding status hook and storage utilities</name>
  <files>
    hooks/useOnboardingStatus.ts
    lib/storage.ts
  </files>
  <action>
Create hooks/useOnboardingStatus.ts:
1. Export useOnboardingStatus hook
2. Maintain state: { isComplete: boolean, isLoading: boolean }
3. On mount, check if authenticated user exists
4. If authenticated, query users table for current user's onboarding_completed field
5. Set isComplete based on query result
6. Listen to auth state changes and refetch on user change
7. Return { isComplete, isLoading }

Create lib/storage.ts:
1. uploadAvatar(userId: string): Promise<string | null>
   - Launch ImagePicker.launchImageLibraryAsync with:
     - mediaTypes: ['images']
     - allowsEditing: true
     - aspect: [1, 1]
     - quality: 0.8
   - If canceled or no asset, return null
   - Convert image URI to ArrayBuffer: `await fetch(uri).then(res => res.arrayBuffer())`
   - Extract file extension from URI
   - Create filePath: `${userId}/${Date.now()}.${fileExt}`
   - Upload to 'avatars' bucket with upsert: true
   - Return data.path on success

2. getAvatarUrl(path: string): string
   - Get public URL from 'avatars' bucket
   - Return data.publicUrl

Install expo-image-picker:
```bash
npx expo install expo-image-picker
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors.
Run `grep "onboarding_completed" hooks/useOnboardingStatus.ts` to verify field is checked.
  </verify>
  <done>
useOnboardingStatus hook checks onboarding_completed field from users table.
lib/storage.ts provides uploadAvatar and getAvatarUrl functions.
expo-image-picker package installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create onboarding screens and update root layout</name>
  <files>
    app/(onboarding)/_layout.tsx
    app/(onboarding)/index.tsx
    app/_layout.tsx
  </files>
  <action>
Create app/(onboarding)/_layout.tsx:
1. Simple Stack layout with headerShown: false
2. Contains single screen for onboarding/index

Create app/(onboarding)/index.tsx:
1. State: displayName, birthday (Date | null), avatarPath, isLoading
2. UI structure (use existing theme constants):
   - Header: "Complete Your Profile"
   - Avatar section: Pressable circle, shows image or "Add Photo" placeholder
   - Display Name input: Required, TextInput with theme styling
   - Birthday picker: Use @react-native-community/datetimepicker
   - Continue button: Disabled until name and birthday provided

3. handleAvatarPress:
   - Get current user
   - Call uploadAvatar(user.id)
   - Update avatarPath state

4. handleComplete:
   - Validate name and birthday
   - Update users table with:
     - full_name: displayName.trim()
     - birthday: birthday.toISOString().split('T')[0]
     - avatar_url: avatarPath (if set)
     - onboarding_completed: true
   - Navigate to /(app)/(tabs)/wishlist

5. Style using existing theme (colors, spacing, borderRadius from constants/theme.ts)

Update app/_layout.tsx:
1. Import useOnboardingStatus hook
2. After session check, also check onboarding status
3. Routing logic:
   - No session → auth/login
   - Session but not onboarded → /(onboarding)
   - Session and onboarded → /(app)/(tabs)/wishlist
4. Use conditional rendering based on both session and onboarding status
5. Keep existing providers (GluestackUIProvider, GestureHandlerRootView, SafeAreaProvider)

Install date picker:
```bash
npx expo install @react-native-community/datetimepicker
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors.
Run `ls app/\(onboarding\)/` to verify onboarding directory exists with files.
  </verify>
  <done>
Onboarding screen collects display name, birthday, and optional photo.
Root layout checks onboarding status and routes appropriately.
@react-native-community/datetimepicker installed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create notification inbox and profile screens</name>
  <files>
    app/(app)/(tabs)/notifications.tsx
    app/(app)/(tabs)/_layout.tsx
    app/profile/[id].tsx
  </files>
  <action>
Create app/(app)/(tabs)/notifications.tsx:
1. State: notifications array, isLoading
2. Fetch notifications on mount:
   - Query user_notifications for current user
   - Order by created_at DESC
3. Realtime subscription:
   - Subscribe to postgres_changes on user_notifications
   - On INSERT, prepend to notifications array
4. Render FlashList (already in project):
   - Each item shows: title, body, relative time (use formatDistanceToNow from date-fns)
   - Unread items have subtle background highlight (colors.gold[50] or similar)
   - Pressable to mark as read (update is_read to true)
5. Empty state: "No notifications yet" message
6. Header: "Notifications" with count badge for unread
7. Cleanup subscription on unmount
8. Style using existing theme

Update app/(app)/(tabs)/_layout.tsx:
1. Add new tab for notifications
2. Use bell icon from @expo/vector-icons (Ionicons or MaterialCommunityIcons)
3. Keep existing tabs (wishlist, groups, etc.)

Create app/profile/[id].tsx:
1. Get user ID from route params: useLocalSearchParams()
2. State: user profile data, isLoading
3. Fetch user from users table by ID
4. Display:
   - Avatar (or placeholder)
   - Display name
   - Birthday (formatted nicely, e.g., "March 15")
   - Member since date
5. If viewing own profile, show "Edit Profile" button (functionality in future phase)
6. Use existing theme styling
7. Header with back navigation

Install date-fns for formatting:
```bash
npm install date-fns
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors.
Run `ls app/\(app\)/\(tabs\)/notifications.tsx` to verify notifications screen exists.
Run `ls app/profile/` to verify profile screen exists.
  </verify>
  <done>
Notification inbox screen shows notification history with realtime updates.
Tab bar includes notifications tab with bell icon.
Profile screen displays member information.
date-fns package installed.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 1 Foundation:
- Onboarding flow (collects birthday, name, optional photo)
- Notification inbox screen
- Profile viewing screen
- Push notification infrastructure (from Plan 01)
  </what-built>
  <how-to-verify>
1. Fresh install or clear app data
2. Log in with existing account (or create new one)
3. Verify onboarding screen appears and blocks access to main app
4. Complete onboarding:
   - Enter display name
   - Select birthday from date picker
   - Optionally add profile photo
   - Tap Continue
5. Verify you land on main app (wishlist tab)
6. Navigate to Notifications tab - should show empty state
7. Navigate to a group and tap on a member to view their profile
8. Verify profile shows name, birthday, avatar (if set)

NOTE: Push notifications require development build (not Expo Go).
To test push delivery, you would need to:
1. Run `eas build --profile development`
2. Deploy Edge Function: `supabase functions deploy push`
3. Set EXPO_ACCESS_TOKEN secret
4. Create database webhook in Supabase dashboard
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Onboarding screen blocks access to main app until completed
2. Birthday and display name are required fields
3. Profile photo is optional
4. Notification inbox uses FlashList for performance
5. Profile screen displays member information correctly
6. All new screens follow existing theme patterns
</verification>

<success_criteria>
- [ ] app/(onboarding)/index.tsx exists with name, birthday, photo fields
- [ ] hooks/useOnboardingStatus.ts exports useOnboardingStatus
- [ ] lib/storage.ts exports uploadAvatar and getAvatarUrl
- [ ] app/_layout.tsx routes to onboarding if not completed
- [ ] app/(app)/(tabs)/notifications.tsx shows notification inbox
- [ ] app/(app)/(tabs)/_layout.tsx includes notifications tab
- [ ] app/profile/[id].tsx shows member profile
- [ ] expo-image-picker, @react-native-community/datetimepicker, date-fns in dependencies
- [ ] `npx tsc --noEmit` passes
- [ ] Human verification confirms onboarding flow works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
