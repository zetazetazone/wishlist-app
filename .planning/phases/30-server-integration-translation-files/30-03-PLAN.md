---
phase: 30-server-integration-translation-files
plan: 03
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - supabase/functions/push/index.ts
autonomous: true

must_haves:
  truths:
    - "Push notifications are sent in user's preferred language"
    - "Edge Function queries notification_translations table for templates"
    - "Edge Function falls back to English when user has no preference or template missing"
    - "Variable interpolation works ({{sender_name}}, {{days}}, etc.)"
  artifacts:
    - path: "supabase/functions/push/index.ts"
      provides: "Localized push notification delivery"
      contains: "notification_translations"
  key_links:
    - from: "supabase/functions/push/index.ts"
      to: "public.users.preferred_language"
      via: "language preference query"
      pattern: "from.*users.*preferred_language"
    - from: "supabase/functions/push/index.ts"
      to: "public.notification_translations"
      via: "template lookup"
      pattern: "from.*notification_translations"
---

<objective>
Enhance push Edge Function to send notifications in user's preferred language using database templates.

Purpose: Implements NOTIF-01 (notifications in preferred language) by querying user's language preference and applying localized templates from notification_translations table.

Output: Updated Edge Function that dynamically localizes push notification title and body based on user preference and notification type.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-server-integration-translation-files/30-RESEARCH.md
@supabase/functions/push/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add localization helpers to Edge Function</name>
  <files>supabase/functions/push/index.ts</files>
  <action>
Add helper functions for fetching user language preference and localized notification templates.

1. **Add interface for notification template:**
```typescript
interface NotificationTemplate {
  title_template: string;
  body_template: string;
}
```

2. **Add getUserLanguage helper function:**
```typescript
async function getUserLanguage(
  supabase: SupabaseClient,
  userId: string
): Promise<string> {
  try {
    const { data, error } = await supabase
      .from('users')
      .select('preferred_language')
      .eq('id', userId)
      .single();

    if (error) {
      console.warn('Failed to fetch user language:', error);
      return 'en';
    }

    return data?.preferred_language || 'en';
  } catch (error) {
    console.warn('Error fetching user language:', error);
    return 'en';
  }
}
```

3. **Add getLocalizedNotification helper function:**
```typescript
async function getLocalizedNotification(
  supabase: SupabaseClient,
  notificationType: string,
  languageCode: string,
  variables: Record<string, string>
): Promise<{ title: string; body: string } | null> {
  // Try user's preferred language first
  const { data: template, error } = await supabase
    .from('notification_translations')
    .select('title_template, body_template')
    .eq('notification_type', notificationType)
    .eq('language_code', languageCode)
    .single();

  let finalTemplate: NotificationTemplate | null = template;

  // Fallback to English if preferred language template not found
  if (error || !template) {
    if (languageCode !== 'en') {
      console.log(`Template not found for ${notificationType}/${languageCode}, falling back to English`);
      const { data: fallback } = await supabase
        .from('notification_translations')
        .select('title_template, body_template')
        .eq('notification_type', notificationType)
        .eq('language_code', 'en')
        .single();
      finalTemplate = fallback;
    }
  }

  if (!finalTemplate) {
    console.warn(`No template found for notification type: ${notificationType}`);
    return null;
  }

  // Apply variable interpolation
  let title = finalTemplate.title_template;
  let body = finalTemplate.body_template;

  for (const [key, value] of Object.entries(variables)) {
    const pattern = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
    title = title.replace(pattern, value);
    body = body.replace(pattern, value);
  }

  return { title, body };
}
```

Place these helpers after the interface definitions and before the `serve()` call.
  </action>
  <verify>
File contains:
- `interface NotificationTemplate`
- `async function getUserLanguage`
- `async function getLocalizedNotification`
- `from('users').select('preferred_language')`
- `from('notification_translations')`
- Variable interpolation logic with `\\{\\{${key}\\}\\}`
  </verify>
  <done>
Edge Function has helper functions for:
- Fetching user's preferred_language with 'en' fallback
- Fetching localized template with English fallback
- Applying {{variable}} interpolation to templates
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate localization into notification sending</name>
  <files>supabase/functions/push/index.ts</files>
  <action>
Modify the main serve() handler to use localization when notification_type is available in the payload data.

1. **Update NotificationPayload interface to include notification_type:**
The payload.record.data may contain notification_type and variables. Update the interface comment to reflect this:
```typescript
interface NotificationPayload {
  type: 'INSERT';
  table: string;
  record: {
    id: string;
    user_id: string;
    title: string;  // fallback title from trigger
    body: string;   // fallback body from trigger
    data: Record<string, any>;  // may include notification_type and variables
  };
  schema: string;
}
```

2. **After parsing payload and before building messages, add localization logic:**

Inside the serve() handler, after `const { user_id, title, body, data } = payload.record;`:

```typescript
// Check if we should use localized templates
let finalTitle = title;
let finalBody = body;

const notificationType = data?.notification_type as string | undefined;
if (notificationType) {
  // Get user's language preference
  const userLanguage = await getUserLanguage(supabase, user_id);
  console.log(`User ${user_id} language preference: ${userLanguage}`);

  // Build variables object from data
  const variables: Record<string, string> = {};
  for (const [key, value] of Object.entries(data)) {
    if (key !== 'notification_type' && key !== 'avatar_url' && typeof value === 'string') {
      variables[key] = value;
    }
  }

  // Get localized notification
  const localized = await getLocalizedNotification(
    supabase,
    notificationType,
    userLanguage,
    variables
  );

  if (localized) {
    finalTitle = localized.title;
    finalBody = localized.body;
    console.log(`Using localized template for ${notificationType} in ${userLanguage}`);
  } else {
    console.log(`Using fallback title/body for ${notificationType}`);
  }
}
```

3. **Update the messages array to use finalTitle and finalBody:**

Change from:
```typescript
const messages: ExpoPushMessage[] = tokens.map((token: DeviceToken) => ({
  ...
  title,
  body,
  ...
}));
```

To:
```typescript
const messages: ExpoPushMessage[] = tokens.map((token: DeviceToken) => ({
  to: token.expo_push_token,
  sound: 'default',
  title: finalTitle,
  body: finalBody,
  data: data || {},
  channelId: 'default',
  ...(data?.avatar_url && {
    richContent: {
      image: data.avatar_url
    }
  })
}));
```

Commit with message: `feat(30-03): add localization support to push Edge Function`
  </action>
  <verify>
File contains:
- `let finalTitle = title;`
- `let finalBody = body;`
- `const notificationType = data?.notification_type`
- `await getUserLanguage(supabase, user_id)`
- `await getLocalizedNotification(`
- `title: finalTitle`
- `body: finalBody`
- Git commit exists
  </verify>
  <done>
Edge Function now:
1. Checks for notification_type in payload data
2. Queries user's preferred_language from users table
3. Fetches localized template from notification_translations
4. Falls back to English template if preferred language not found
5. Falls back to original title/body if no template exists (backward compatible)
6. Applies variable interpolation to templates
7. Sends localized push notification
8. Committed to git
  </done>
</task>

</tasks>

<verification>
1. Edge Function has getUserLanguage helper
2. Edge Function has getLocalizedNotification helper
3. Main handler checks for notification_type and localizes
4. Fallback chain: user language template > English template > original title/body
5. Variable interpolation works for all {{variable}} patterns
6. Git commit created
</verification>

<success_criteria>
- [ ] getUserLanguage queries users.preferred_language with 'en' default
- [ ] getLocalizedNotification queries notification_translations table
- [ ] Template not found in preferred language falls back to English
- [ ] No template at all falls back to original title/body (backward compatible)
- [ ] Variable interpolation replaces {{key}} with values from data
- [ ] Committed to git
- [ ] Note: Full E2E testing requires `npx supabase functions deploy push`
</success_criteria>

<output>
After completion, create `.planning/phases/30-server-integration-translation-files/30-03-SUMMARY.md`
</output>
