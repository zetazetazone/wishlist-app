---
phase: 30-server-integration-translation-files
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - lib/language.ts
  - hooks/useLanguage.ts
autonomous: true

must_haves:
  truths:
    - "getLanguagePreference checks server first when userId provided"
    - "setLanguagePreference syncs to Supabase when userId provided"
    - "Language preference loads from server on login (cross-device sync)"
    - "Local cache updated after successful server fetch"
  artifacts:
    - path: "lib/language.ts"
      provides: "Server-synced language preference service"
      exports: ["getLanguagePreference", "setLanguagePreference", "syncLanguageFromServer"]
    - path: "hooks/useLanguage.ts"
      provides: "React hook with server sync support"
      exports: ["useLanguage"]
  key_links:
    - from: "lib/language.ts"
      to: "supabase.from('users')"
      via: "server preference query"
      pattern: "from.*users.*preferred_language"
    - from: "hooks/useLanguage.ts"
      to: "lib/language.ts"
      via: "service layer import"
      pattern: "import.*from.*lib/language"
---

<objective>
Extend language service layer with Supabase server sync for cross-device language preference.

Purpose: Implements PERS-02 (server sync) and PERS-03 (cross-device sync) by adding server read/write to the existing lib/language.ts service.

Output: Enhanced language service that queries server for preference when user is authenticated, syncs changes to Supabase, and maintains local cache for offline use.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-server-integration-translation-files/30-RESEARCH.md
@.planning/phases/29-foundation-tooling/29-02-SUMMARY.md
@lib/language.ts
@hooks/useLanguage.ts
@lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend lib/language.ts with server sync</name>
  <files>lib/language.ts</files>
  <action>
Enhance the existing lib/language.ts to implement the three-tier preference hierarchy:
Server (if authenticated) > Local (AsyncStorage) > Device (expo-localization)

1. **Import supabase client:**
```typescript
import { supabase } from './supabase';
```

2. **Update getLanguagePreference to accept optional userId:**
```typescript
export async function getLanguagePreference(userId?: string): Promise<SupportedLanguage> {
  // Tier 1: Check server (if authenticated)
  if (userId) {
    try {
      const { data, error } = await supabase
        .from('users')
        .select('preferred_language')
        .eq('id', userId)
        .single();

      if (!error && data?.preferred_language && isSupported(data.preferred_language)) {
        // Cache locally for offline use
        await AsyncStorage.setItem(LANGUAGE_KEY, data.preferred_language);
        return data.preferred_language as SupportedLanguage;
      }
    } catch (error) {
      console.warn('[language] Server fetch failed, using local fallback:', error);
    }
  }

  // Tier 2: Check local storage (existing logic)
  try {
    const saved = await AsyncStorage.getItem(LANGUAGE_KEY);
    if (saved && isSupported(saved)) {
      return saved as SupportedLanguage;
    }
  } catch (error) {
    console.warn('[language] Failed to read language preference:', error);
  }

  // Tier 3: Device detection (fallback)
  return getDeviceLanguage();
}
```

3. **Add getDeviceLanguage helper (imported from i18n or inline):**
```typescript
import { getLocales } from 'expo-localization';

function getDeviceLanguage(): SupportedLanguage {
  const locales = getLocales();
  const deviceLang = locales[0]?.languageCode;
  return isSupported(deviceLang || '') ? (deviceLang as SupportedLanguage) : 'en';
}
```

4. **Update setLanguagePreference to accept optional userId for server sync:**
```typescript
export async function setLanguagePreference(
  language: SupportedLanguage,
  userId?: string
): Promise<void> {
  // Validate language code
  if (!isSupported(language)) {
    console.warn(`[language] Invalid language code: ${language}, falling back to 'en'`);
    language = 'en';
  }

  try {
    // 1. Update i18next (triggers UI re-render)
    await i18n.changeLanguage(language);

    // 2. Persist to AsyncStorage (local cache)
    await AsyncStorage.setItem(LANGUAGE_KEY, language);

    // 3. Sync to server if authenticated
    if (userId) {
      const { error } = await supabase
        .from('users')
        .update({ preferred_language: language })
        .eq('id', userId);

      if (error) {
        console.warn('[language] Server sync failed:', error);
        // Don't throw - local preference is set, server can sync later
      }
    }
  } catch (error) {
    console.error('[language] Failed to set language preference:', error);
    throw error;
  }
}
```

5. **Add syncLanguageFromServer helper for explicit sync (e.g., on login):**
```typescript
export async function syncLanguageFromServer(userId: string): Promise<SupportedLanguage> {
  try {
    const { data, error } = await supabase
      .from('users')
      .select('preferred_language')
      .eq('id', userId)
      .single();

    if (error) throw error;

    const serverLang = data?.preferred_language;
    if (serverLang && isSupported(serverLang)) {
      // Update i18next and local cache
      await i18n.changeLanguage(serverLang);
      await AsyncStorage.setItem(LANGUAGE_KEY, serverLang);
      return serverLang as SupportedLanguage;
    }
  } catch (error) {
    console.warn('[language] Server sync failed:', error);
  }

  // Return current language if sync fails
  return i18n.language as SupportedLanguage;
}
```

Preserve all existing exports: LANGUAGE_KEY, SUPPORTED_LANGUAGES, SupportedLanguage, isSupported.
  </action>
  <verify>
File contains:
- Import from './supabase'
- getLanguagePreference accepts optional userId parameter
- setLanguagePreference accepts optional userId parameter
- syncLanguageFromServer function exported
- supabase.from('users').select('preferred_language') pattern
- supabase.from('users').update({ preferred_language: ... }) pattern
  </verify>
  <done>
lib/language.ts extended with:
- Three-tier language preference hierarchy (server > local > device)
- Server read on getLanguagePreference(userId)
- Server write on setLanguagePreference(lang, userId)
- Explicit syncLanguageFromServer(userId) for login flow
- Local cache always updated for offline support
  </done>
</task>

<task type="auto">
  <name>Task 2: Update useLanguage hook for server sync</name>
  <files>hooks/useLanguage.ts</files>
  <action>
Update the useLanguage hook to support server sync by accepting an optional userId parameter.

1. **Update hook signature to accept userId:**
```typescript
export function useLanguage(userId?: string) {
```

2. **Update initialization to pass userId to getLanguagePreference:**
```typescript
useEffect(() => {
  const loadLanguage = async () => {
    try {
      const lang = await getLanguagePreference(userId);
      setCurrentLanguage(lang);
    } catch (error) {
      console.error('[useLanguage] Failed to load language:', error);
    }
  };
  loadLanguage();
}, [userId]); // Re-run when userId changes (login/logout)
```

3. **Update changeLanguage callback to pass userId:**
```typescript
const changeLanguage = useCallback(
  async (language: SupportedLanguage) => {
    setIsLoading(true);
    try {
      await setLanguagePreference(language, userId);
      setCurrentLanguage(language);
    } catch (error) {
      console.error('[useLanguage] Failed to change language:', error);
      throw error;
    } finally {
      setIsLoading(false);
    }
  },
  [userId]
);
```

4. **Add syncFromServer function for explicit sync (called after login):**
```typescript
import { syncLanguageFromServer } from '../lib/language';

const syncFromServer = useCallback(async () => {
  if (!userId) return;
  setIsLoading(true);
  try {
    const lang = await syncLanguageFromServer(userId);
    setCurrentLanguage(lang);
  } catch (error) {
    console.error('[useLanguage] Server sync failed:', error);
  } finally {
    setIsLoading(false);
  }
}, [userId]);
```

5. **Return syncFromServer in hook return value:**
```typescript
return {
  currentLanguage,
  changeLanguage,
  isLoading,
  supportedLanguages: SUPPORTED_LANGUAGES,
  syncFromServer, // NEW
};
```

Commit with message: `feat(30-02): add server sync to language service and hook`
  </action>
  <verify>
File contains:
- `useLanguage(userId?: string)` signature
- `getLanguagePreference(userId)` call
- `setLanguagePreference(language, userId)` call
- `syncFromServer` function
- `syncLanguageFromServer` import
- userId in useEffect dependency array
- Git commit exists
  </verify>
  <done>
useLanguage hook updated to:
- Accept optional userId for server sync
- Re-fetch language preference when userId changes (login/logout)
- Pass userId to service layer for server persistence
- Expose syncFromServer for explicit sync after login
- Committed to git
  </done>
</task>

</tasks>

<verification>
1. lib/language.ts has server sync functions
2. hooks/useLanguage.ts passes userId to service layer
3. Three-tier hierarchy implemented: Server > Local > Device
4. Server failures gracefully fall back to local/device
5. Git commits created
</verification>

<success_criteria>
- [ ] getLanguagePreference queries server when userId provided
- [ ] setLanguagePreference syncs to server when userId provided
- [ ] syncLanguageFromServer function available for login flow
- [ ] useLanguage hook accepts optional userId parameter
- [ ] Hook re-fetches when userId changes (dependency array)
- [ ] Server failures don't break the app (graceful degradation)
- [ ] Committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/30-server-integration-translation-files/30-02-SUMMARY.md`
</output>
