---
phase: 30-server-integration-translation-files
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260214000001_i18n_server_sync.sql
autonomous: true

must_haves:
  truths:
    - "Users table has preferred_language column with 'en' default"
    - "notification_translations table exists with EN/ES templates for all 12 notification types"
    - "user_profiles view includes preferred_language column"
    - "View trigger handles preferred_language updates"
  artifacts:
    - path: "supabase/migrations/20260214000001_i18n_server_sync.sql"
      provides: "Schema for language preference and notification templates"
      contains: "preferred_language"
  key_links:
    - from: "public.users.preferred_language"
      to: "public.notification_translations"
      via: "Edge Function query pattern"
      pattern: "preferred_language.*notification_translations"
---

<objective>
Add database schema for server-side language preference storage and notification translation templates.

Purpose: Enables cross-device language sync (PERS-02, PERS-03) and localized push notifications (NOTIF-01, NOTIF-02) by storing user preference and notification templates in Supabase.

Output: Migration file that adds preferred_language column to users table, creates notification_translations table with EN/ES seed data for all 12 notification types.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-server-integration-translation-files/30-RESEARCH.md
@supabase/migrations/20260201000001_initial_schema.sql
@supabase/migrations/20260202000002_user_profiles_view.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create i18n server sync migration</name>
  <files>supabase/migrations/20260214000001_i18n_server_sync.sql</files>
  <action>
Create a new migration file with:

1. **Add preferred_language column to users table:**
```sql
ALTER TABLE public.users
ADD COLUMN IF NOT EXISTS preferred_language TEXT DEFAULT 'en'
CHECK (preferred_language IN ('en', 'es'));
```

2. **Update user_profiles view to include preferred_language:**
```sql
CREATE OR REPLACE VIEW public.user_profiles AS
SELECT
  id,
  email,
  full_name AS display_name,
  avatar_url,
  birthday,
  preferred_language,
  onboarding_completed,
  created_at,
  updated_at
FROM public.users;
```

3. **Update the user_profiles_update() trigger function to handle preferred_language:**
```sql
CREATE OR REPLACE FUNCTION public.user_profiles_update()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE public.users
  SET
    full_name = COALESCE(NEW.display_name, full_name),
    avatar_url = NEW.avatar_url,
    birthday = COALESCE(NEW.birthday, birthday),
    preferred_language = COALESCE(NEW.preferred_language, preferred_language),
    onboarding_completed = COALESCE(NEW.onboarding_completed, onboarding_completed),
    updated_at = NOW()
  WHERE id = OLD.id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

4. **Create notification_translations table:**
```sql
CREATE TABLE public.notification_translations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  notification_type TEXT NOT NULL,
  language_code TEXT NOT NULL CHECK (language_code IN ('en', 'es')),
  title_template TEXT NOT NULL,
  body_template TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(notification_type, language_code)
);

-- Enable RLS (Edge Functions use service role key, bypasses RLS)
ALTER TABLE public.notification_translations ENABLE ROW LEVEL SECURITY;

-- Read-only policy for authenticated users (for debugging/admin)
CREATE POLICY "Authenticated users can read translations"
  ON public.notification_translations
  FOR SELECT
  TO authenticated
  USING (true);

-- Index for fast lookup
CREATE INDEX idx_notification_translations_lookup
  ON public.notification_translations(notification_type, language_code);
```

5. **Seed notification_translations with all 12 notification types in EN and ES:**

The 12 notification types from codebase analysis (see RESEARCH.md):
- friend_request_received
- friend_request_accepted
- birthday_day_of
- gift_leader_week_reminder
- birthday_reminder
- contribution_reminder
- item_claimed
- split_invite
- split_fully_funded
- split_canceled
- gift_leader_assigned
- gift_leader_reassigned

Use `{{variable}}` interpolation syntax. Spanish translations should use neutral Latin American Spanish (ustedes, not vosotros).

Example seed structure:
```sql
INSERT INTO public.notification_translations (notification_type, language_code, title_template, body_template) VALUES
-- friend_request_received
('friend_request_received', 'en', 'New Friend Request', '{{sender_name}} sent you a friend request'),
('friend_request_received', 'es', 'Nueva solicitud de amistad', '{{sender_name}} te envio una solicitud de amistad'),
-- ... continue for all 12 types x 2 languages = 24 rows
;
```
  </action>
  <verify>
Migration file exists and contains:
- `ALTER TABLE public.users ADD COLUMN.*preferred_language`
- `CREATE TABLE public.notification_translations`
- `INSERT INTO public.notification_translations` with 24 rows (12 types x 2 languages)
- Updated `user_profiles` view with `preferred_language`
- Updated `user_profiles_update()` function
  </verify>
  <done>
Migration file ready for `supabase db reset` or manual application. Contains users.preferred_language column, notification_translations table with RLS and index, and 24 seed rows covering all notification types in EN/ES.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify migration structure and commit</name>
  <files>supabase/migrations/20260214000001_i18n_server_sync.sql</files>
  <action>
Verify the migration file:

1. Check SQL syntax by counting:
   - Exactly 24 INSERT rows in notification_translations (12 types x 2 languages)
   - All {{variable}} placeholders are valid (sender_name, accepter_name, celebrant_name, days, item_name, amount, contributor_name, leader_name)

2. Cross-reference notification types against existing database triggers:
   - grep for notification types in existing migrations
   - Ensure all types that insert into user_notifications have templates

3. Verify the user_profiles view update won't break existing queries:
   - New column is additive (SELECT * will include it)
   - Column has default value so existing rows are valid

Commit with message: `feat(30-01): add i18n server sync schema (preferred_language + notification_translations)`
  </action>
  <verify>
Run validation checks:
- `grep -c "INSERT INTO public.notification_translations" supabase/migrations/20260214000001_i18n_server_sync.sql` returns count including 24 value rows
- `grep "notification_type" supabase/migrations/20260214000001_i18n_server_sync.sql | wc -l` shows correct number of references
- Git commit exists with correct message format
  </verify>
  <done>
Migration verified for:
- 24 notification template rows (all 12 types in EN and ES)
- Correct Spanish translations (neutral Latin American)
- Valid SQL syntax
- Committed to git
  </done>
</task>

</tasks>

<verification>
1. Migration file exists at expected path
2. File contains all required schema changes:
   - users.preferred_language column
   - notification_translations table
   - user_profiles view update
   - user_profiles_update() trigger update
   - 24 seed rows
3. SQL syntax is valid (no obvious errors)
4. Git commit created
</verification>

<success_criteria>
- [ ] Migration file created with correct naming convention
- [ ] users.preferred_language column with 'en' default and ('en', 'es') constraint
- [ ] notification_translations table with unique(notification_type, language_code)
- [ ] All 12 notification types have EN and ES templates (24 total rows)
- [ ] user_profiles view includes preferred_language
- [ ] user_profiles_update() trigger handles preferred_language
- [ ] Committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/30-server-integration-translation-files/30-01-SUMMARY.md`
</output>
