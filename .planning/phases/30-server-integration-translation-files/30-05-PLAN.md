---
phase: 30-server-integration-translation-files
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - app/_layout.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Language preference syncs from server on login/app launch"
    - "User ID from auth session is passed to useLanguage hook"
    - "syncFromServer() is called when user session becomes available"
  artifacts:
    - path: "app/_layout.tsx"
      provides: "useLanguage integration with auth session"
      contains: "useLanguage"
  key_links:
    - from: "app/_layout.tsx"
      to: "hooks/useLanguage.ts"
      via: "import { useLanguage }"
      pattern: "useLanguage\\(.*\\?.*id"
    - from: "app/_layout.tsx"
      to: "syncFromServer"
      via: "useEffect callback"
      pattern: "syncFromServer\\(\\)"
---

<objective>
Wire useLanguage hook into app root layout to sync language preference from server on login

Purpose: Close PERS-03 gap - the useLanguage hook was created but never integrated into app code. Without this wiring, language preference cannot sync across devices when a user logs in.

Output: app/_layout.tsx modified to use useLanguage hook with userId from auth session
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-server-integration-translation-files/30-VERIFICATION.md

# Source files to understand integration pattern
@hooks/useLanguage.ts
@app/_layout.tsx
@src/i18n/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate useLanguage hook with auth session in root layout</name>
  <files>app/_layout.tsx</files>
  <action>
Modify app/_layout.tsx to integrate the useLanguage hook:

1. Add imports at top of file:
   ```typescript
   import { useLanguage } from '../hooks/useLanguage';
   import { initI18n } from '../src/i18n';
   ```

2. Add state for i18n initialization:
   ```typescript
   const [i18nReady, setI18nReady] = useState(false);
   ```

3. Initialize i18n BEFORE using useLanguage (add before existing useEffect):
   ```typescript
   useEffect(() => {
     initI18n().then(() => setI18nReady(true));
   }, []);
   ```

4. Track user session state using existing supabase.auth.getSession() result.
   Extract userId when session exists (session.user.id).

5. Call useLanguage hook with userId:
   ```typescript
   const { syncFromServer } = useLanguage(userId);
   ```

6. Add useEffect to sync language on login (when userId changes from undefined to defined):
   ```typescript
   useEffect(() => {
     if (userId) {
       syncFromServer();
     }
   }, [userId, syncFromServer]);
   ```

7. Guard rendering until i18n is ready:
   - Add early return `if (!i18nReady) return null;` before the JSX return
   - This ensures translations are loaded before any UI renders

IMPORTANT:
- Do NOT create a separate LanguageProvider - the root layout IS the provider context
- The existing supabase.auth.onAuthStateChange already tracks session - reuse that session state
- Store session.user.id in a useState to trigger re-renders when user logs in/out

Pattern to follow:
```typescript
const [userId, setUserId] = useState<string | undefined>(undefined);

// In existing getSession callback:
setUserId(session?.user?.id);

// In existing onAuthStateChange callback:
setUserId(session?.user?.id);
```
  </action>
  <verify>
1. Run `npx tsc --noEmit` - should pass (no new type errors)
2. Search for import: `grep -n "useLanguage" app/_layout.tsx` - should find import and usage
3. Search for syncFromServer call: `grep -n "syncFromServer" app/_layout.tsx` - should find useEffect calling it
  </verify>
  <done>
- app/_layout.tsx imports useLanguage from hooks/useLanguage.ts
- useLanguage called with user ID from auth session
- syncFromServer() called in useEffect when userId becomes available
- i18n initialized before hook usage
- TypeScript compilation passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify integration works with grep checks</name>
  <files>app/_layout.tsx</files>
  <action>
Verify the integration is complete:

1. Confirm no orphaned hook - search all app files for useLanguage imports:
   ```bash
   grep -r "useLanguage" app/ --include="*.tsx" | head -20
   ```
   Should find at least app/_layout.tsx

2. Confirm the wiring pattern:
   ```bash
   grep -A5 "useLanguage" app/_layout.tsx
   ```
   Should show useLanguage(userId) or similar with user ID parameter

3. Confirm syncFromServer is called:
   ```bash
   grep -B2 -A2 "syncFromServer" app/_layout.tsx
   ```
   Should show useEffect calling syncFromServer when userId exists

4. Verify key link exists from root layout to language hook:
   - Pattern: `useLanguage(` with userId parameter
   - Pattern: `syncFromServer()` call in useEffect

If any check fails, update app/_layout.tsx to fix the gap.
  </action>
  <verify>
All grep checks pass showing:
1. useLanguage import exists in app/_layout.tsx
2. useLanguage called with user ID
3. syncFromServer called in useEffect
  </verify>
  <done>
- useLanguage hook is no longer orphaned (imported and used in app code)
- Language preference will sync from server when user logs in
- PERS-03 requirement can now be satisfied
  </done>
</task>

</tasks>

<verification>
- [ ] `grep -n "useLanguage" app/_layout.tsx` returns import and usage lines
- [ ] `grep -n "syncFromServer" app/_layout.tsx` returns useEffect calling syncFromServer
- [ ] `npx tsc --noEmit` passes without new type errors
- [ ] Hook is wired with userId from auth session (not undefined)
</verification>

<success_criteria>
1. useLanguage hook imported and called in app/_layout.tsx
2. userId passed from supabase auth session to useLanguage hook
3. syncFromServer() called when user session becomes available
4. TypeScript compilation passes
5. PERS-03 gap closed - hook no longer orphaned
</success_criteria>

<output>
After completion, create `.planning/phases/30-server-integration-translation-files/30-05-SUMMARY.md`
</output>
