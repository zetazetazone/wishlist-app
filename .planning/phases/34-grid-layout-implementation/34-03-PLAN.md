---
phase: 34-grid-layout
plan: 03
type: execute
wave: 3
depends_on: ["34-02"]
files_modified:
  - app/(app)/(tabs)/wishlist-luxury.tsx
  - app/(app)/celebration/[id].tsx
autonomous: false

must_haves:
  truths:
    - "My Wishlist screen displays items in 2-column masonry grid"
    - "Celebration page displays celebrant's wishlist in 2-column masonry grid"
    - "Grid layout identical between both screens"
    - "Grid scrolls smoothly at 60fps"
    - "Pull-to-refresh works on both screens"
  artifacts:
    - path: "app/(app)/(tabs)/wishlist-luxury.tsx"
      provides: "My Wishlist with WishlistGrid"
      contains: "WishlistGrid"
    - path: "app/(app)/celebration/[id].tsx"
      provides: "Celebration page with WishlistGrid"
      contains: "WishlistGrid"
  key_links:
    - from: "app/(app)/(tabs)/wishlist-luxury.tsx"
      to: "components/wishlist/WishlistGrid.tsx"
      via: "import and render"
      pattern: "WishlistGrid"
    - from: "app/(app)/celebration/[id].tsx"
      to: "components/wishlist/WishlistGrid.tsx"
      via: "import and render"
      pattern: "WishlistGrid"
---

<objective>
Integrate WishlistGrid into My Wishlist and Celebration screens.

Purpose: Replace the current ScrollView + map() pattern with the virtualized WishlistGrid component for 60fps scrolling and consistent layout across both screens.

Output: Updated wishlist-luxury.tsx and celebration/[id].tsx using WishlistGrid
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Plan 01 and 02 outputs
@components/wishlist/WishlistGrid.tsx
@components/wishlist/WishlistGridCard.tsx

# Current screens to modify
@app/(app)/(tabs)/wishlist-luxury.tsx
@app/(app)/celebration/[id].tsx

# Research
@.planning/phases/34-grid-layout-implementation/34-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update My Wishlist screen (wishlist-luxury.tsx)</name>
  <files>app/(app)/(tabs)/wishlist-luxury.tsx</files>
  <action>
Modify `app/(app)/(tabs)/wishlist-luxury.tsx` to use WishlistGrid.

**Changes required:**

1. **Add import:**
```typescript
import { WishlistGrid } from '@/components/wishlist';
```

2. **Add favorite tracking state** (if not already present):
```typescript
const [favoriteItemIds, setFavoriteItemIds] = useState<Set<string>>(new Set());
```

3. **Add handlers:**
```typescript
const handleItemPress = useCallback((item: WishlistItem) => {
  // For Phase 34: Navigate to item detail (placeholder)
  // Phase 35 will add actual detail navigation
  console.log('Item pressed:', item.id);
  // TODO: router.push(`/wishlist/${item.id}`) in Phase 35
}, []);

const handleItemAction = useCallback((item: WishlistItem) => {
  // For Phase 34: Open bottom sheet (existing behavior)
  bottomSheetRef.current?.open(item);
}, []);
```

4. **Replace the items rendering section:**

Find the section that currently maps over items (likely in a ScrollView):
```typescript
// BEFORE (find and replace):
{items.map((item, index) => (
  <LuxuryWishlistCard
    key={item.id}
    item={item}
    // ... props
  />
))}
```

Replace with:
```typescript
// AFTER:
<WishlistGrid
  items={items}
  onItemPress={handleItemPress}
  onItemAction={handleItemAction}
  isOwner={true}
  favoriteItemIds={favoriteItemIds}
  refreshing={refreshing}
  onRefresh={onRefresh}
  ListEmptyComponent={
    <View style={styles.emptyContainer}>
      <MaterialCommunityIcons name="gift-outline" size={64} color={colors.cream[400]} />
      <Text style={styles.emptyTitle}>{t('wishlist.empty.title')}</Text>
      <Text style={styles.emptySubtitle}>{t('wishlist.empty.subtitle')}</Text>
    </View>
  }
/>
```

5. **Remove ScrollView wrapper if present around items:**
   - WishlistGrid (FlashList) handles its own scrolling
   - Keep any header content outside/above the grid
   - The RefreshControl is now inside WishlistGrid

6. **Keep existing functionality:**
   - Keep the LuxuryBottomSheet component (will be used in Phase 36)
   - Keep the header with TakenCounter if present
   - Keep the FAB (floating action button) for adding items

**Do NOT remove:**
- LuxuryWishlistCard import yet (still used by bottom sheet preview)
- LuxuryBottomSheet
- FAB
- Header components
  </action>
  <verify>
```bash
# Check WishlistGrid import
grep "import { WishlistGrid }" app/(app)/(tabs)/wishlist-luxury.tsx || grep "WishlistGrid" app/(app)/(tabs)/wishlist-luxury.tsx

# Check isOwner prop
grep "isOwner={true}" app/(app)/(tabs)/wishlist-luxury.tsx || grep "isOwner" app/(app)/(tabs)/wishlist-luxury.tsx

# TypeScript compiles
npx tsc --noEmit 2>&1 | grep -i "wishlist-luxury" || echo "No wishlist-luxury errors"
```
  </verify>
  <done>
wishlist-luxury.tsx updated with:
- WishlistGrid import and rendering
- isOwner={true} for owner context
- handleItemPress and handleItemAction callbacks
- RefreshControl handled by WishlistGrid
- Empty state component passed to grid
- Existing bottom sheet and FAB preserved
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Celebration screen</name>
  <files>app/(app)/celebration/[id].tsx</files>
  <action>
Modify `app/(app)/celebration/[id].tsx` to use WishlistGrid for the celebrant's wishlist section.

**Changes required:**

1. **Add import:**
```typescript
import { WishlistGrid } from '@/components/wishlist';
```

2. **Add handlers:**
```typescript
const handleWishlistItemPress = useCallback((item: WishlistItem) => {
  // For Phase 34: Navigate to item detail (placeholder)
  // Phase 35 will add actual detail navigation with claim UI
  console.log('Wishlist item pressed:', item.id, 'on celebration');
  // TODO: router.push(`/celebration/${id}/item/${item.id}`) in Phase 35
}, [id]);

const handleWishlistItemAction = useCallback((item: WishlistItem) => {
  // Non-owner action: show claim options or status
  // For Phase 34: Log only
  // Phase 35 will add claim sheet or navigation
  console.log('Wishlist item action:', item.id);
}, []);
```

3. **Find the celebrant wishlist rendering section:**

Look for the section that maps over `celebrantItems` with LuxuryWishlistCard:
```typescript
// BEFORE (find):
{celebrantItems.map((item, index) => (
  <LuxuryWishlistCard
    key={item.id}
    item={item}
    isTaken={...}
    dimmed={...}
    isCelebrant={...}
    // or for non-celebrant:
    claim={...}
    claimable={...}
    // etc.
  />
))}
```

4. **Replace with WishlistGrid:**

Determine the view context:
- If `currentUserId === celebration?.celebrant_id` → celebrant view
- Else → viewer (can claim) view

```typescript
// AFTER:
{celebration && (
  <WishlistGrid
    items={celebrantItems}
    onItemPress={handleWishlistItemPress}
    onItemAction={handleWishlistItemAction}
    isOwner={false}
    isCelebrant={currentUserId === celebration.celebrant_id}
    claimStatuses={claimStatuses}  // Map<string, boolean> for celebrant view
    claims={claimsMap}  // Map<string, ClaimWithUser> for viewer view
    currentUserId={currentUserId}
    favoriteItemIds={celebrantFavoriteId ? new Set([celebrantFavoriteId]) : undefined}
    ListEmptyComponent={
      <View style={styles.emptyWishlist}>
        <MaterialCommunityIcons name="gift-outline" size={48} color={colors.cream[400]} />
        <Text style={styles.emptyWishlistText}>
          {t('celebrations.noWishlistItems')}
        </Text>
      </View>
    }
  />
)}
```

5. **Convert claims array to Map** (if not already):
```typescript
// Add useMemo for claims map
const claimsMap = useMemo(() => {
  const map = new Map<string, ClaimWithUser>();
  claims.forEach(claim => {
    if (claim.wishlist_item_id) {
      map.set(claim.wishlist_item_id, claim);
    }
  });
  return map;
}, [claims]);
```

6. **Adjust layout:**
   - If the wishlist was in a ScrollView, the parent layout may need adjustment
   - WishlistGrid handles its own scrolling
   - May need to give the grid a fixed height or flex: 1 depending on existing layout

**Keep existing functionality:**
- Chat section
- Contribution section
- Gift Leader section
- All other celebration page content
  </action>
  <verify>
```bash
# Check WishlistGrid import
grep "WishlistGrid" app/(app)/celebration/[id].tsx

# Check isOwner={false}
grep "isOwner={false}" app/(app)/celebration/[id].tsx

# Check isCelebrant prop
grep "isCelebrant" app/(app)/celebration/[id].tsx

# TypeScript compiles
npx tsc --noEmit 2>&1 | grep -i "celebration" | head -5 || echo "Check celebration errors manually"
```
  </verify>
  <done>
celebration/[id].tsx updated with:
- WishlistGrid import and rendering
- isOwner={false} for non-owner context
- isCelebrant logic based on currentUserId
- claimStatuses or claims Map passed correctly
- handleWishlistItemPress and handleWishlistItemAction callbacks
- Empty state component passed to grid
- Existing celebration page content preserved
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify grid layout and performance</name>
  <what-built>
WishlistGrid integrated into My Wishlist and Celebration screens with:
- 2-column masonry layout
- expo-image with blur placeholder
- Action buttons on cards
- Consistent layout between screens
  </what-built>
  <how-to-verify>
1. Start development server: `npx expo start`
2. Open app on device/simulator

**My Wishlist verification:**
3. Go to My Wishlist tab
4. Verify items display in 2-column grid
5. Verify images load with blur placeholder then fade in
6. Verify title truncates to 2 lines
7. Verify price displays correctly
8. Verify action button (dots-vertical) appears on each card
9. Pull to refresh - verify it works
10. Scroll up and down quickly - verify 60fps (no jank)
11. Tap a card - verify console.log or navigation

**Celebration page verification:**
12. Navigate to a celebration (from Home or calendar)
13. Scroll to wishlist section
14. Verify items display in same 2-column grid layout
15. Verify claimed items show appropriate indicator
16. If you're the celebrant: verify items show "Taken" badge (not claimer identity)
17. If you're a viewer: verify claimed items show claimer avatar
18. Scroll wishlist - verify smooth scrolling

**Special items verification:**
19. If there are Surprise Me items: verify question mark icon displays
20. If there are Mystery Box items: verify gift icon displays

**Expected behavior:**
- Grid cards are equal width, masonry heights
- Images load progressively with blur
- Scroll is smooth (60fps)
- Layout matches between My Wishlist and celebration page
  </how-to-verify>
  <resume-signal>Type "approved" if grid works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
**Overall plan verification:**

1. Both screens import and use WishlistGrid:
```bash
grep "WishlistGrid" app/(app)/(tabs)/wishlist-luxury.tsx
grep "WishlistGrid" app/(app)/celebration/[id].tsx
```

2. TypeScript compiles:
```bash
npx tsc --noEmit 2>&1 | tail -20
```

3. No ScrollView wrapping items:
```bash
# These checks help verify we're not double-wrapping
grep -A5 "WishlistGrid" app/(app)/(tabs)/wishlist-luxury.tsx
```
</verification>

<success_criteria>
- [ ] wishlist-luxury.tsx uses WishlistGrid with isOwner={true}
- [ ] celebration/[id].tsx uses WishlistGrid with isOwner={false}
- [ ] Both screens pass correct view context (celebrant vs viewer)
- [ ] Empty state renders when no items
- [ ] Refresh works on both screens
- [ ] Grid layout consistent between screens (visual verification)
- [ ] Scrolling is 60fps smooth (manual verification)
- [ ] TypeScript compiles without errors
- [ ] Human verification checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/34-grid-layout-implementation/34-03-SUMMARY.md`
</output>
