---
phase: 06-schema-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260202000011_schema_foundation.sql
  - types/database.types.ts
autonomous: true

must_haves:
  truths:
    - "group_favorites table exists with correct columns"
    - "wishlist_items has item_type column with CHECK constraint"
    - "wishlist_items has mystery_box_tier column with validation"
    - "RLS policies enforce group membership for favorites access"
    - "TypeScript types include new table and columns"
  artifacts:
    - path: "supabase/migrations/20260202000011_schema_foundation.sql"
      provides: "Schema changes for favorites and special items"
      contains: "CREATE TABLE.*group_favorites"
    - path: "types/database.types.ts"
      provides: "Updated TypeScript types"
      contains: "group_favorites"
  key_links:
    - from: "supabase/migrations/20260202000011_schema_foundation.sql"
      to: "public.is_group_member"
      via: "RLS policy uses existing function"
      pattern: "is_group_member"
    - from: "types/database.types.ts"
      to: "supabase/migrations/20260202000011_schema_foundation.sql"
      via: "Generated from schema"
      pattern: "item_type.*standard.*surprise_me.*mystery_box"
---

<objective>
Create database schema foundation for favorites and special item types.

Purpose: Enable Phase 8 (Special Item Types) and Phase 9 (Favorite Marking) by extending the database schema with the required tables, columns, constraints, and RLS policies.

Output:
- SQL migration file extending wishlist_items and creating group_favorites table
- Updated TypeScript types reflecting new schema
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-schema-foundation/06-RESEARCH.md
@supabase/migrations/20260202000003_fix_group_members_recursion.sql
@types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schema foundation migration</name>
  <files>supabase/migrations/20260202000011_schema_foundation.sql</files>
  <action>
Create a new migration file with the following changes:

1. **Extend wishlist_items table** with new columns:
   - `item_type TEXT CHECK (item_type IN ('standard', 'surprise_me', 'mystery_box')) DEFAULT 'standard'`
   - `mystery_box_tier NUMERIC CHECK (mystery_box_tier IN (25, 50, 100))` (nullable)
   - Add cross-column constraint: mystery_box_tier requires item_type='mystery_box'
   - Add optional `surprise_me_budget NUMERIC` column for budget guidance on surprise_me items

2. **Create group_favorites table**:
   ```sql
   CREATE TABLE IF NOT EXISTS public.group_favorites (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     user_id UUID REFERENCES public.user_profiles(id) ON DELETE CASCADE NOT NULL,
     group_id UUID REFERENCES public.groups(id) ON DELETE CASCADE NOT NULL,
     item_id UUID REFERENCES public.wishlist_items(id) ON DELETE CASCADE NOT NULL,
     created_at TIMESTAMPTZ DEFAULT NOW(),
     updated_at TIMESTAMPTZ DEFAULT NOW(),
     UNIQUE(user_id, group_id)  -- Enforces one favorite per user per group
   );
   ```

3. **Enable RLS and create policies** for group_favorites:
   - Enable RLS on table
   - SELECT: Users can view favorites in their groups (use `is_group_member()`)
   - INSERT: Users can insert own favorites in their groups
   - UPDATE: Users can update own favorites
   - DELETE: Users can delete own favorites
   - IMPORTANT: Wrap `auth.uid()` in `(SELECT auth.uid())` for query planner optimization

4. **Create indexes** for performance:
   - `idx_group_favorites_user` on user_id
   - `idx_group_favorites_group` on group_id
   - `idx_group_favorites_item` on item_id
   - `idx_wishlist_items_type` on item_type

5. **Add updated_at trigger** for group_favorites (reuse pattern from celebrations migration)

Follow existing migration patterns from:
- `20260202000005_celebrations.sql` for RLS policy structure
- `20260202000003_fix_group_members_recursion.sql` for is_group_member usage
  </action>
  <verify>
File exists at supabase/migrations/20260202000011_schema_foundation.sql and contains:
- CREATE TABLE group_favorites
- ALTER TABLE wishlist_items ADD COLUMN item_type
- CHECK constraint for item_type values
- ENABLE ROW LEVEL SECURITY
- CREATE POLICY statements using is_group_member
- CREATE INDEX statements
  </verify>
  <done>
Migration file created with:
- group_favorites table with user_id, group_id, item_id, timestamps
- UNIQUE constraint on (user_id, group_id)
- item_type column with CHECK constraint (standard, surprise_me, mystery_box)
- mystery_box_tier column with CHECK constraint (25, 50, 100)
- Cross-column constraint linking mystery_box_tier to item_type
- RLS enabled with 4 policies (SELECT, INSERT, UPDATE, DELETE)
- Indexes on all FK columns and item_type
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply migration and regenerate TypeScript types</name>
  <files>types/database.types.ts</files>
  <action>
1. **Push migration to local Supabase**:
   ```bash
   npx supabase db push
   ```

2. **Regenerate TypeScript types**:
   ```bash
   npx supabase gen types typescript --local > types/database.types.ts
   ```

3. **Verify the generated types include**:
   - `group_favorites` table with Row, Insert, Update types
   - `wishlist_items.item_type: 'standard' | 'surprise_me' | 'mystery_box'`
   - `wishlist_items.mystery_box_tier: 25 | 50 | 100 | null`
   - `wishlist_items.surprise_me_budget: number | null`

4. **If types are malformed** (common with Supabase CLI):
   - Manually adjust the generated types to match existing format in types/database.types.ts
   - Ensure union types are correct (not string literals)
   - Preserve existing interface structure
  </action>
  <verify>
Run these checks:
1. `npx supabase db push` completes without error
2. `grep -q "group_favorites" types/database.types.ts` returns 0
3. `grep -q "item_type" types/database.types.ts` returns 0
4. `grep -q "mystery_box_tier" types/database.types.ts` returns 0
5. `npx tsc --noEmit` passes (no new type errors from these changes)
  </verify>
  <done>
- Migration applied successfully to local Supabase
- TypeScript types regenerated
- types/database.types.ts contains:
  - group_favorites table definition
  - wishlist_items.item_type with union type
  - wishlist_items.mystery_box_tier with union type
  - wishlist_items.surprise_me_budget as nullable number
- No new TypeScript compilation errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify:

1. **Schema exists in database**:
   ```bash
   npx supabase db dump --schema public | grep -A5 "group_favorites"
   ```
   Should show table definition

2. **RLS is enabled**:
   ```bash
   npx supabase db dump --schema public | grep -A1 "ENABLE ROW LEVEL SECURITY" | grep group_favorites
   ```

3. **Constraints work**:
   - INSERT into wishlist_items with item_type='mystery_box' and mystery_box_tier=NULL should FAIL
   - INSERT into wishlist_items with item_type='standard' and mystery_box_tier=50 should FAIL
   - INSERT into group_favorites with duplicate (user_id, group_id) should FAIL

4. **TypeScript compiles**:
   ```bash
   npx tsc --noEmit
   ```
</verification>

<success_criteria>
Phase 6 Success Criteria (from ROADMAP.md):
1. [x] Database supports group_favorites table with proper RLS policies
2. [x] Database supports item_type (standard, surprise_me, mystery_box) - using CHECK constraint
3. [x] Schema migrations apply cleanly without breaking existing data
4. [x] All RLS policies enforce correct access control for new features
</success_criteria>

<output>
After completion, create `.planning/phases/06-schema-foundation/06-01-SUMMARY.md`
</output>
