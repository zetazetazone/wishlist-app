---
phase: 38-url-scraping
plan: 03
type: execute
wave: 3
depends_on: ["38-02"]
files_modified:
  - app/(app)/add-from-url.tsx
  - app/(app)/_layout.tsx
autonomous: false

must_haves:
  truths:
    - "User can paste URL and see extracted metadata within 3 seconds"
    - "User sees loading spinner while scraping is in progress"
    - "User can edit any scraped field before saving"
    - "User can manually fill all fields when scraping fails"
    - "User can save item to their default wishlist"
  artifacts:
    - path: "app/(app)/add-from-url.tsx"
      provides: "Add from URL screen with scraping, editing, and fallback"
      contains: "scrapeUrl"
    - path: "app/(app)/_layout.tsx"
      provides: "Navigation entry to add-from-url screen"
      contains: "add-from-url"
  key_links:
    - from: "app/(app)/add-from-url.tsx"
      to: "lib/urlScraper.ts"
      via: "scrapeUrl import"
      pattern: "import.*scrapeUrl.*urlScraper"
    - from: "app/(app)/add-from-url.tsx"
      to: "wishlist_items table"
      via: "supabase.from('wishlist_items').insert"
      pattern: "from\\(['\"]wishlist_items['\"]\\)"
---

<objective>
Create the Add from URL screen with scraping, loading state, editing, and manual fallback.

Purpose: Users can paste a product URL, see scraped metadata (title, image, price, description), edit any field, and save to their wishlist. When scraping fails, users can manually enter all fields.

Output: Working "Add from URL" screen accessible from wishlist tab, satisfying all SCRAPE-0X requirements.
</objective>

<execution_context>
@/home/zetaz/.claude/get-shit-done/workflows/execute-plan.md
@/home/zetaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-url-scraping/38-RESEARCH.md
@.planning/phases/38-url-scraping/38-01-SUMMARY.md
@.planning/phases/38-url-scraping/38-02-SUMMARY.md

# Existing patterns
@app/(app)/my-wishlist.tsx
@app/(app)/profile.tsx
@lib/urlScraper.ts
@types/scraping.types.ts
@i18n/en.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Add from URL screen</name>
  <files>app/(app)/add-from-url.tsx</files>
  <action>
Create `app/(app)/add-from-url.tsx` following existing screen patterns (e.g., profile.tsx):

**Screen structure:**
1. URL input section at top
   - TextInput for pasting URL
   - "Scrape" button next to input
   - Loading spinner overlays button when scraping

2. Preview/Edit section (shown after scrape or when manually entering)
   - Image preview (if available) with placeholder on failure
   - Title input (TextInput, editable)
   - Price input (TextInput, numeric, editable)
   - Description input (TextInput, multiline, editable)
   - Store/brand display (non-editable, from siteName)

3. Action section
   - "Save to Wishlist" button
   - "Cancel" button

**State management:**
```typescript
const [url, setUrl] = useState('');
const [isLoading, setIsLoading] = useState(false);
const [scrapeError, setScrapeError] = useState<string | null>(null);
const [showManualEntry, setShowManualEntry] = useState(false);

// Editable fields (populated from scrape or manual)
const [title, setTitle] = useState('');
const [description, setDescription] = useState('');
const [imageUrl, setImageUrl] = useState('');
const [price, setPrice] = useState('');
const [siteName, setSiteName] = useState('');
const [sourceUrl, setSourceUrl] = useState('');
```

**Scrape flow:**
1. User pastes URL and taps "Scrape"
2. Set isLoading=true, clear previous error
3. Call `scrapeUrl(url)` from lib/urlScraper.ts
4. On success: populate fields from result.data, set sourceUrl
5. On failure: show error message, offer "Enter Manually" option
6. Set isLoading=false

**Manual entry flow:**
- "Enter Manually" button shows all fields as blank inputs
- No scraping occurs
- User fills in title (required), optional fields

**Save flow:**
1. Validate: title is required
2. Get current user from AuthContext
3. Get user's default wishlist (from wishlists table where is_default=true)
4. Insert into wishlist_items:
   ```typescript
   {
     user_id: user.id,
     wishlist_id: defaultWishlist.id, // from Phase 37
     group_id: null, // will be set when sharing (Phase 42)
     name: title,
     description: description || null,
     price: price ? parseFloat(price) : null,
     image_url: imageUrl || null,
     amazon_url: sourceUrl || null, // legacy column, will be renamed in Phase 41
     priority: 0
   }
   ```
5. Navigate back to my-wishlist on success
6. Show error toast on failure

**UI Guidelines:**
- Use existing ThemedText, ThemedView components
- Use existing button styles from my-wishlist.tsx
- Loading spinner: ActivityIndicator from react-native
- Image preview: Image component with fallback placeholder
- Follow i18n pattern for all user-facing strings

**Localization keys to add:**
```typescript
// Add to i18n/en.ts (and other language files)
addFromUrl: {
  title: 'Add from URL',
  urlPlaceholder: 'Paste product URL...',
  scrapeButton: 'Fetch Details',
  scraping: 'Fetching...',
  itemTitle: 'Title',
  itemTitlePlaceholder: 'Enter item title',
  itemDescription: 'Description',
  itemDescriptionPlaceholder: 'Enter description (optional)',
  itemPrice: 'Price',
  itemPricePlaceholder: '0.00',
  store: 'Store',
  saveButton: 'Add to Wishlist',
  cancelButton: 'Cancel',
  enterManually: 'Enter Manually',
  scrapeFailed: 'Could not fetch details from this URL',
  scrapeFailedHint: 'You can enter the details manually below',
  titleRequired: 'Title is required',
  saved: 'Item added to wishlist!',
  saveFailed: 'Failed to save item',
}
```
  </action>
  <verify>
1. File exists at app/(app)/add-from-url.tsx
2. TypeScript compiles: `npx tsc --noEmit`
3. All imports resolve (urlScraper, ThemedText, etc.)
  </verify>
  <done>
add-from-url.tsx screen exists with URL input, scrape button, loading state, editable preview fields, and save functionality.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add navigation and i18n strings</name>
  <files>app/(app)/_layout.tsx, i18n/en.ts</files>
  <action>
1. Add screen to navigation in `app/(app)/_layout.tsx`:
   - Add Stack.Screen for "add-from-url" route
   - Set header title from i18n

2. Add entry point from my-wishlist.tsx:
   - Add "Add from URL" button/link (can be alongside existing add button)
   - Or modify existing add flow to offer "From URL" option
   - Use router.push('/add-from-url')

3. Add localization strings to all language files:
   - i18n/en.ts (required)
   - i18n/es.ts, i18n/fr.ts, i18n/de.ts, i18n/pt.ts (copy English, mark for translation)

Note: For non-English languages, use English text initially. Translation can be done later. The pattern is to have the keys present in all files.
  </action>
  <verify>
1. Navigation to add-from-url works: open app, navigate to screen
2. i18n keys exist in en.ts
3. No runtime errors on navigation
  </verify>
  <done>
Navigation route exists for add-from-url, screen is accessible from my-wishlist, and i18n strings are added.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete URL scraping flow: paste URL -> scrape metadata -> edit fields -> save to wishlist
  </what-built>
  <how-to-verify>
1. Start Edge Function: `npx supabase functions serve scrape-url --no-verify-jwt`
2. Start Expo: `npx expo start`
3. Open app on device/simulator

**Test 1: Successful scrape**
- Navigate to My Wishlist
- Tap "Add from URL" (or however entry point was implemented)
- Paste: `https://www.amazon.com/dp/B09V3KXJPB`
- Tap "Fetch Details"
- EXPECTED: Loading spinner appears, then title/image/price populate
- Edit the title slightly
- Tap "Add to Wishlist"
- EXPECTED: Navigate back to My Wishlist, item appears

**Test 2: Failed scrape with manual entry**
- Navigate to Add from URL screen
- Paste: `https://localhost:9999/fake` (will fail)
- Tap "Fetch Details"
- EXPECTED: Error message appears, "Enter Manually" option shown
- Tap "Enter Manually"
- Fill in title: "Test Manual Item"
- Tap "Add to Wishlist"
- EXPECTED: Item saved successfully

**Test 3: Loading state visible**
- Paste any URL
- Tap "Fetch Details"
- EXPECTED: Loading spinner visible for at least a moment
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. add-from-url.tsx screen exists and renders
3. Navigation from my-wishlist to add-from-url works
4. Scrape -> Edit -> Save flow completes successfully
5. Manual entry fallback works when scrape fails
6. Loading state visible during scrape
</verification>

<success_criteria>
- [ ] User can paste URL and tap "Fetch Details" to scrape
- [ ] User sees loading spinner while scraping (SCRAPE-07)
- [ ] Scraped title, image, price populate editable fields (SCRAPE-02, 03, 04, 05, 06)
- [ ] User can edit any field before saving (SCRAPE-08)
- [ ] User can manually enter fields when scrape fails (SCRAPE-09)
- [ ] Saved item appears in My Wishlist
- [ ] All user-facing strings use i18n
</success_criteria>

<output>
After completion, create `.planning/phases/38-url-scraping/38-03-SUMMARY.md`
</output>
